# Audit Report

## Title
Ledger Database Directory Created with Insecure Filesystem Permissions Allowing Local Information Disclosure

## Summary
The `ledger_db` directory in AptosDB is created without explicitly setting restrictive filesystem permissions. On Unix systems, this results in world-readable directories (typically 0755 permissions), allowing any unprivileged local user to read critical blockchain ledger data including transaction history, state information, and potentially sensitive validator data.

## Finding Description

The Aptos blockchain stores its ledger data in the `ledger_db` directory, which contains critical blockchain information including all transactions, events, and state commitments. When this directory is created, the codebase does not set explicit Unix filesystem permissions, relying instead on the system's default umask.

**Vulnerable Code Paths:**

1. **RocksDB directory creation via schemadb**: When `LedgerDb::new()` is called, it invokes `DB::open_cf()` which ultimately calls RocksDB's native `open_cf_descriptors()`. [1](#0-0) 

2. **Options configuration without permission settings**: The RocksDB options are configured to create missing directories, but no filesystem permissions are specified. [2](#0-1) 

3. **Explicit directory creation in checkpoint code**: The checkpoint creation explicitly uses `std::fs::create_dir_all()` without setting permissions. [3](#0-2) 

4. **Database generator also uses default permissions**: [4](#0-3) 

**Contrast with Secure File Creation:**

The codebase demonstrates awareness of secure file permissions for sensitive data. The `write_to_user_only_file()` utility explicitly sets mode 0o600 (user-only read/write) for confidential files. [5](#0-4) 

However, this security practice is **not applied** to database directory creation.

**Attack Scenario:**

1. Validator node runs as user `aptos` (UID 6180) on a shared server
2. System umask is 0022 (common default), resulting in directories created with 0755 permissions
3. The `ledger_db` directory at `/opt/aptos/data/db/ledger_db/` becomes readable by all users
4. Malicious local user runs: `ls -la /opt/aptos/data/db/ledger_db/` and reads RocksDB SST files
5. Attacker extracts transaction history, account states, and potentially validator keys if stored in the database

## Impact Explanation

**Severity: Medium** (up to $10,000 per Aptos Bug Bounty)

This vulnerability enables **information disclosure** of critical blockchain data:

- **Transaction History Exposure**: All historical transactions including amounts, sender/receiver addresses, and transaction metadata
- **State Information Leakage**: Current and historical account balances, resource states, and Move module bytecode
- **Validator Data Exposure**: Potentially sensitive validator operational data stored in the ledger

While this does not directly enable fund theft or consensus violations, it breaks the **Access Control** invariant and could facilitate secondary attacks:
- Social engineering using transaction pattern analysis
- Front-running attacks if real-time transaction data is exposed before block commitment
- Reconnaissance for targeted attacks on high-value accounts

The vulnerability is categorized as Medium rather than High because:
- Requires local system access (not remotely exploitable)
- Does not directly compromise cryptographic keys (which are stored separately)
- Production deployments may have OS-level protections (containerization, dedicated servers)

However, the impact is significant for:
- Shared hosting environments
- Development/staging servers with multiple user accounts
- Compromised accounts on validator infrastructure

## Likelihood Explanation

**Likelihood: Medium-High**

The vulnerability will manifest in any deployment where:
1. The system umask is 0022 or more permissive (very common default)
2. Multiple user accounts exist on the same system
3. No additional OS-level access controls (SELinux, AppArmor) are configured

**Factors increasing likelihood:**
- Default Unix umask of 0022 is nearly universal
- Development and staging environments commonly have multiple users
- The vulnerability is present in all code paths that create the `ledger_db` directory

**Factors decreasing likelihood:**
- Production validators typically run on dedicated infrastructure
- Kubernetes deployments use isolated containers with security contexts [6](#0-5) 
- However, these are compensating controls, not a fix for the underlying vulnerability

## Recommendation

Explicitly set restrictive filesystem permissions when creating database directories. Use Unix mode 0700 (rwx------) to ensure only the owner can access the directory.

**Recommended Fix:**

```rust
// In storage/aptosdb/src/ledger_db/mod.rs, replace line 338:
use std::os::unix::fs::DirBuilderExt;

#[cfg(unix)]
{
    let mut builder = std::fs::DirBuilder::new();
    builder.mode(0o700);
    builder.recursive(true);
    builder.create(&cp_ledger_db_folder)?;
}
#[cfg(not(unix))]
{
    std::fs::create_dir_all(&cp_ledger_db_folder)?;
}
```

**Additional Recommendations:**

1. Create a secure directory creation utility similar to `write_to_user_only_file()` for database directories
2. Apply the same fix to all database directory creation paths in `state_merkle_db.rs` and `state_kv_db.rs`
3. Document the required filesystem permissions in deployment guides
4. Consider adding a startup check that validates database directory permissions and warns if too permissive
5. For RocksDB directory creation, investigate if RocksDB options support permission settings or implement pre-creation with proper permissions

## Proof of Concept

**Reproduction Steps:**

```bash
#!/bin/bash
# Demonstrates the vulnerability on a Unix system

# 1. Set up test environment as validator user
sudo useradd -u 6180 -m aptos
sudo -u aptos mkdir -p /tmp/aptos-test/db

# 2. Simulate AptosDB directory creation (mimics actual code behavior)
sudo -u aptos bash -c 'umask 0022; mkdir -p /tmp/aptos-test/db/ledger_db'

# 3. Check permissions - should show drwxr-xr-x (755)
ls -la /tmp/aptos-test/db/

# Output: drwxr-xr-x 2 aptos aptos 4096 ... ledger_db

# 4. Create malicious user
sudo useradd -m attacker

# 5. Attacker can read the directory
sudo -u attacker ls /tmp/aptos-test/db/ledger_db
# SUCCESS - attacker has read access

# 6. If RocksDB files exist, attacker can copy them
sudo -u attacker cp -r /tmp/aptos-test/db/ledger_db /tmp/stolen-data
# SUCCESS - attacker has copied ledger data

# Cleanup
sudo userdel -r aptos
sudo userdel -r attacker
rm -rf /tmp/aptos-test
```

**Expected vs. Secure Behavior:**

With the recommended fix, the permissions would be 0700 (drwx------), preventing the attacker from accessing the directory:

```bash
# After applying the fix
ls -la /tmp/aptos-test/db/
# Output: drwx------ 2 aptos aptos 4096 ... ledger_db

sudo -u attacker ls /tmp/aptos-test/db/ledger_db
# ERROR: Permission denied
```

**Notes:**

This vulnerability represents a defense-in-depth failure. While Kubernetes deployments with proper security contexts may mitigate the issue, the underlying codebase should implement secure-by-default filesystem permissions. The presence of `write_to_user_only_file()` in the codebase demonstrates that the development team understands secure file permissionsâ€”this same principle should be applied to database directory creation.

### Citations

**File:** storage/schemadb/src/lib.rs (L173-173)
```rust
                ReadWrite => DB::open_cf_descriptors(db_opts, path.de_unc(), all_cfds),
```

**File:** storage/rocksdb-options/src/lib.rs (L38-41)
```rust
    if !readonly {
        db_opts.create_if_missing(true);
        db_opts.create_missing_column_families(true);
    }
```

**File:** storage/aptosdb/src/ledger_db/mod.rs (L338-338)
```rust
            std::fs::create_dir_all(&cp_ledger_db_folder).unwrap_or(());
```

**File:** execution/executor-benchmark/src/db_generator.rs (L50-50)
```rust
    fs::create_dir_all(db_dir.as_ref()).unwrap();
```

**File:** crates/aptos/src/common/utils.rs (L224-229)
```rust
pub fn write_to_user_only_file(path: &Path, name: &str, bytes: &[u8]) -> CliTypedResult<()> {
    let mut opts = OpenOptions::new();
    #[cfg(unix)]
    opts.mode(0o600);
    write_to_file_with_opts(path, name, bytes, &mut opts)
}
```

**File:** terraform/helm/aptos-node/templates/validator.yaml (L217-227)
```yaml
      securityContext:
        {{- if $.Values.enablePrivilegedMode }}
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
        {{- else }}
        runAsNonRoot: true
        runAsUser: 6180
        runAsGroup: 6180
        fsGroup: 6180
        {{- end }}
```
