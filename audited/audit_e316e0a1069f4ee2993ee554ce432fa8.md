# Audit Report

## Title
Cloudflare API Key Exposure Through Debug Trait in NFT Metadata Crawler Configuration Logging

## Summary
The `AssetUploaderWorkerConfig` struct containing Cloudflare API credentials is logged at service startup using Debug formatting, which exposes sensitive credentials to JSON-formatted logs that can be harvested by attackers with access to log aggregation systems, monitoring dashboards, or stdout/stderr captures.

## Finding Description

The NFT metadata crawler's asset uploader configuration contains sensitive Cloudflare API credentials that are exposed through logging at service startup. While the security question focuses on the `Serialize` trait, the actual exploitation occurs through the `Debug` trait, though both traits are derived on the same credential-containing struct.

The vulnerability manifests through the following code path:

1. The `AssetUploaderWorkerConfig` struct derives both `Debug` and `Serialize` traits and contains sensitive credentials: [1](#0-0) 

2. This config is embedded in `ServerConfig`, which also derives `Debug` and `Serialize`: [2](#0-1) 

3. The `ServerConfig` is part of `NFTMetadataCrawlerConfig`, which derives `Debug` and `Serialize`: [3](#0-2) 

4. At service startup, the entire configuration is logged using Debug formatting: [4](#0-3) 

5. The logging system is configured to output JSON format by default: [5](#0-4) 

6. The JSON-formatted logs containing the plaintext credentials are written to stdout and can be captured by various log collection systems.

An attacker with access to these logs (through compromised log aggregation systems, monitoring dashboards, container log collectors, or CI/CD pipelines) can extract the `cloudflare_auth_key` and `cloudflare_account_id`, then use them to manipulate NFT assets, delete content, upload malicious files, or incur costs.

## Impact Explanation

This issue meets **Medium severity** criteria per the Aptos bug bounty program as it enables "limited funds loss or manipulation." Specifically:

- **Limited funds loss**: An attacker with the Cloudflare API key can incur costs by uploading large amounts of data to the Cloudflare Images account.
- **Limited manipulation**: The attacker can delete, modify, or replace NFT asset images, potentially breaking NFT metadata for dApps relying on this service.
- **Scope limitation**: The impact is limited to the NFT metadata crawler's Cloudflare integration and does not affect core blockchain operations, consensus, Move VM execution, or validator operations.

While this is peripheral infrastructure rather than core blockchain components, it still represents a credential exposure vulnerability that could impact NFT-related services in the Aptos ecosystem.

## Likelihood Explanation

The likelihood is **HIGH** because:

1. **Automatic triggering**: The credential exposure occurs automatically on every service startup without requiring any special conditions or attacker interaction.
2. **Common log access**: Logs are routinely collected and stored in centralized systems (Datadog, Splunk, CloudWatch, Kubernetes logging) that may have broader access permissions than production systems.
3. **Persistent exposure**: Once logged, credentials remain in log archives, backup systems, and historical data stores.
4. **JSON format increases visibility**: The JSON-formatted output makes credentials easily machine-parseable for automated harvesting.

The primary barrier to exploitation is obtaining read access to the logs, but this is significantly easier than compromising production systems directly.

## Recommendation

Implement credential redaction in the configuration structs to prevent sensitive fields from being exposed through Debug or Serialize traits:

1. **Option 1**: Remove `Debug` and `Serialize` derives from `AssetUploaderWorkerConfig` and implement custom versions that redact sensitive fields:

```rust
use serde::{Deserialize, Serialize};

#[derive(Clone, Deserialize)]
pub struct AssetUploaderWorkerConfig {
    #[serde(skip_serializing)]
    pub cloudflare_auth_key: String,
    pub cloudflare_account_id: String,
}

impl std::fmt::Debug for AssetUploaderWorkerConfig {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_struct("AssetUploaderWorkerConfig")
            .field("cloudflare_auth_key", &"***REDACTED***")
            .field("cloudflare_account_id", &self.cloudflare_account_id)
            .finish()
    }
}

impl Serialize for AssetUploaderWorkerConfig {
    fn serialize<S>(&self, serializer: S) -> Result<S::Ok, S::Error>
    where
        S: serde::Serializer,
    {
        use serde::ser::SerializeStruct;
        let mut state = serializer.serialize_struct("AssetUploaderWorkerConfig", 1)?;
        state.serialize_field("cloudflare_account_id", &self.cloudflare_account_id)?;
        state.end()
    }
}
```

2. **Option 2**: Remove the config logging statement entirely or replace it with a non-Debug version that logs only non-sensitive fields.

3. **Option 3**: Use a secrets management library that automatically redacts sensitive fields (e.g., `secrecy` crate).

## Proof of Concept

**Steps to reproduce:**

1. Create a configuration file for the NFT metadata crawler with Cloudflare credentials:
```yaml
health_check_port: 8080
server_config:
  type: AssetUploaderWorker
  cloudflare_auth_key: "secret_api_key_12345"
  cloudflare_account_id: "account_abc123"
```

2. Run the NFT metadata crawler service:
```bash
cargo run --bin aptos-nft-metadata-crawler -- --config-path config.yaml
```

3. Observe the startup logs (stdout):
```json
{
  "timestamp":"2024-01-15T10:30:45.123456Z",
  "level":"INFO",
  "message":"[NFT Metadata Crawler] Starting with config: NFTMetadataCrawlerConfig { database_url: \"...\", server_port: 8080, server_config: AssetUploaderWorker(AssetUploaderWorkerConfig { cloudflare_auth_key: \"secret_api_key_12345\", cloudflare_account_id: \"account_abc123\" }) }",
  ...
}
```

4. The `cloudflare_auth_key` is visible in plaintext in the JSON log output.

5. An attacker with access to these logs can extract the credentials and use them with the Cloudflare API:
```bash
curl -X GET "https://api.cloudflare.com/client/v4/accounts/account_abc123/images/v1" \
  -H "Authorization: Bearer secret_api_key_12345"
```

This demonstrates successful credential harvesting from logs that can lead to unauthorized access to the Cloudflare Images service.

## Notes

While the security question specifically asked about the `Serialize` trait, the actual vulnerability manifests primarily through the `Debug` trait during logging operations. However, both traits are derived on the same credential-containing struct, creating multiple potential exposure vectors. The presence of `Serialize` on credential-containing structs is still a vulnerability even if not currently exploited, as it enables future exposure through status endpoints, monitoring integrations, or debugging tools.

This vulnerability is in peripheral infrastructure (NFT metadata crawler) rather than core blockchain components (consensus, Move VM, storage, governance), so it does not affect blockchain safety, liveness, or correctness invariants. Nevertheless, it represents a legitimate security concern for the Aptos ecosystem's NFT-related services.

### Citations

**File:** ecosystem/nft-metadata-crawler/src/asset_uploader/worker/config.rs (L7-14)
```rust
#[derive(Clone, Debug, Deserialize, Serialize)]
#[serde(deny_unknown_fields)]
pub struct AssetUploaderWorkerConfig {
    /// Cloudflare API key
    pub cloudflare_auth_key: String,
    /// Cloudflare Account ID provided at the images home page used to authenticate requests
    pub cloudflare_account_id: String,
}
```

**File:** ecosystem/nft-metadata-crawler/src/config.rs (L30-37)
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(tag = "type")]
pub enum ServerConfig {
    Parser(ParserConfig),
    AssetUploaderWorker(AssetUploaderWorkerConfig),
    AssetUploaderApi,
    AssetUploaderThrottler(AssetUploaderThrottlerConfig),
}
```

**File:** ecosystem/nft-metadata-crawler/src/config.rs (L40-46)
```rust
#[derive(Clone, Debug, Deserialize, Serialize)]
#[serde(deny_unknown_fields)]
pub struct NFTMetadataCrawlerConfig {
    pub database_url: String,
    pub server_port: u16,
    pub server_config: ServerConfig,
}
```

**File:** ecosystem/nft-metadata-crawler/src/config.rs (L88-88)
```rust
        info!("[NFT Metadata Crawler] Starting with config: {:?}", self);
```

**File:** ecosystem/indexer-grpc/indexer-grpc-server-framework/src/lib.rs (L179-187)
```rust
    let subscriber = tracing_subscriber::fmt()
        .json()
        .flatten_event(true)
        .with_file(true)
        .with_line_number(true)
        .with_thread_ids(true)
        .with_target(false)
        .with_thread_names(true)
        .with_env_filter(env_filter);
```
