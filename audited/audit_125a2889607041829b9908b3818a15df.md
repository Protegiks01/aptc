# Audit Report

## Title
Test Directory Code Inclusion via --dev Flag in Production Deployments

## Summary
The Move package build system allows test directory code to be included in production deployments when the `--dev` flag is used during publishing. While `#[test_only]` and `#[test]` annotations properly exclude annotated code, any non-annotated Move code in the `tests/` directory will be compiled and deployed on-chain when `aptos move publish --dev` is executed.

## Finding Description

The vulnerability exists in the package compilation flow where the `--dev` flag controls inclusion of test directories: [1](#0-0) 

When a developer uses `aptos move publish --dev`, the build configuration sets `dev_mode` to true: [2](#0-1) 

This causes the compilation process to include files from the `tests/` directory: [3](#0-2) 

The critical issue is that `test_mode` remains false even when `dev` is true: [4](#0-3) 

This means Move code in the `tests/` directory that lacks `#[test_only]` or `#[test]` annotations will be compiled into production bytecode. The documentation explicitly acknowledges this behavior: [5](#0-4) 

However, there are NO warnings or safeguards preventing production deployment with the `--dev` flag enabled.

## Impact Explanation

This issue falls under **High Severity** per Aptos bug bounty criteria as it represents a "Significant protocol violation" - allowing unintended test code execution in production environments.

**However, this vulnerability requires developer operational error** (accidentally using `--dev` in production) and is NOT directly exploitable by an external unprivileged attacker. The threat model is limited to:

1. **Accidental deployment**: Developer mistakenly uses `--dev` flag for production
2. **Insider threat**: Malicious developer intentionally deploys test code containing backdoors

If exploited, the impact could include:
- Exposure of debugging entry functions bypassing normal access controls
- Test helper functions that manipulate state without proper validation
- Backdoor functions that were never intended for production use

## Likelihood Explanation

The likelihood is **MODERATE** because:

**Factors increasing likelihood:**
- No warnings are shown when using `--dev` flag with publish commands
- The flag name `--dev` might be misunderstood as "development environment" rather than "include dev dependencies AND test artifacts"
- Documentation mentions test artifact inclusion but this may be overlooked

**Factors decreasing likelihood:**
- Requires explicit use of `--dev` flag (not default behavior)
- Properly annotated test code (`#[test_only]`) is still excluded correctly
- Standard practice in the Aptos framework shows consistent use of `#[test_only]` annotations [6](#0-5) 

## Recommendation

Add explicit warnings and safeguards to prevent accidental production deployment with `--dev` flag:

1. **Add warning message** when publishing with `--dev`:
```
Warning: --dev flag is enabled. Test directory code will be included.
This should NOT be used for production deployments.
Proceed? (y/N)
```

2. **Add a separate flag** for production deployments that explicitly disables dev mode and fails if set alongside `--dev`

3. **Update documentation** to clearly warn that `--dev` includes test directory code in deployed bytecode

4. **Add CI/CD checks** that fail if packages are published to mainnet with `--dev` flag

## Proof of Concept

**Setup:**
Create a Move package with a vulnerable test file:

```
my_package/
├── Move.toml
├── sources/
│   └── main.move
└── tests/
    └── backdoor.move  # NO #[test_only] annotation
```

**tests/backdoor.move:**
```move
module deployer::backdoor {
    use std::signer;
    
    // This function lacks #[test_only] annotation
    public entry fun dangerous_debug_function(account: &signer) {
        // Bypasses normal access controls
        // Would not be here in production code
    }
}
```

**Exploit:**
```bash
# Developer accidentally uses --dev for production
aptos move publish --dev --assume-yes

# The backdoor module is now deployed on-chain
# and can be called via transaction
```

**Notes**

While this is a valid configuration vulnerability, it does NOT meet the strict validation criteria for the bug bounty program because:

- It requires developer operational error (not exploitable by external attacker)
- The documentation explicitly mentions this behavior
- It's a supply-chain/build process issue rather than a protocol vulnerability
- Properly annotated code is still protected

This represents a **build safety issue** rather than a directly exploitable protocol vulnerability. The primary defense is proper development practices, code review, and operational safeguards around deployment processes.

### Citations

**File:** crates/aptos/src/common/types.rs (L1230-1237)
```rust
    /// Enables dev mode, which uses all dev-addresses and dev-dependencies
    ///
    /// Dev mode allows for changing dependencies and addresses to the preset [dev-addresses] and
    /// [dev-dependencies] fields.  This works both inside and out of tests for using preset values.
    ///
    /// Currently, it also additionally pulls in all test compilation artifacts
    #[clap(long)]
    pub dev: bool,
```

**File:** aptos-move/framework/src/built_package.rs (L250-252)
```rust
        Ok(BuildConfig {
            dev_mode: options.dev,
            additional_named_addresses: options.named_addresses.clone(),
```

**File:** aptos-move/framework/src/built_package.rs (L258-258)
```rust
            test_mode: false,
```

**File:** third_party/move/tools/move-package/src/resolution/resolution_graph.rs (L668-671)
```rust
        if config.dev_mode {
            add_path(SourcePackageLayout::Examples);
            add_path(SourcePackageLayout::Tests);
        }
```

**File:** aptos-move/framework/aptos-framework/tests/aggregator_tests.move (L1-2)
```text
#[test_only]
module aptos_framework::aggregator_tests {
```
