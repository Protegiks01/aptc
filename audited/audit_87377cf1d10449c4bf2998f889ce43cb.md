# Audit Report

## Title
Unvalidated Version Input Causes Panic in Remote Gas Profiler Tool

## Summary
The `remote-gas-profiler` binary accepts any `u64` value for the version argument without validation, causing a panic when the DB backend is used with a non-existent version (e.g., beyond current blockchain height or `u64::MAX`).

## Finding Description

The `remote-gas-profiler.rs` tool accepts a version argument as a `u64` with no validation: [1](#0-0) 

This version is passed directly to `get_committed_transaction_at_version`: [2](#0-1) 

When using the DB backend, if the requested version doesn't exist in the database (e.g., it's beyond the current ledger height), the underlying storage iterator returns empty vectors: [3](#0-2) 

The storage layer only checks if the version is above the minimum pruned version, but does not validate against the maximum ledger height: [4](#0-3) [5](#0-4) 

When empty vectors are returned, the code attempts to `.pop()` from them with an `.expect()`, causing a panic: [6](#0-5) 

## Impact Explanation

This issue causes a **denial-of-service** crash of the debugging tool when invalid input is provided. While the tool itself is classified as a developer utility rather than a production API, the crash represents a robustness failure. According to the Aptos bug bounty severity categories, "API crashes" fall under **High Severity**. However, since this is a local developer tool rather than a network-facing production API, the more appropriate classification is **Medium Severity** as a non-critical implementation bug affecting tool availability.

The impact is limited to:
- Tool crash requiring restart
- Potential confusion for developers using the tool
- No impact on blockchain consensus, funds, or network availability
- No impact on validator nodes or production systems

## Likelihood Explanation

This issue is **highly likely** to occur in normal usage scenarios:
- Developers may accidentally specify versions beyond the current ledger height
- Tab-completion or copy-paste errors could introduce `u64::MAX` or other extreme values
- The tool provides no feedback about valid version ranges before execution
- No documentation warns users about version constraints

## Recommendation

Add validation to check the version against the current ledger height before attempting to retrieve transactions:

```rust
// In remote-gas-profiler.rs main() function, after line 45:
let latest_version = debugger
    .debugger
    .get_latest_ledger_info_version()
    .await?;

if version > latest_version {
    bail!(
        "Version {} exceeds current ledger height {}. Please specify a version <= {}.",
        version,
        latest_version,
        latest_version
    );
}
```

Alternatively, improve the error handling in `get_committed_transaction_at_version` to return a proper error instead of panicking:

```rust
// In aptos_debugger.rs, replace lines 384-390:
let txn = txns.pop().ok_or_else(|| {
    anyhow!("No transaction found at version {}", version)
})?;
let info = info.pop().ok_or_else(|| {
    anyhow!("No transaction info found at version {}", version)
})?;
let aux_info = aux_infos.pop().ok_or_else(|| {
    anyhow!("No auxiliary info found at version {}", version)
})?;
```

## Proof of Concept

```bash
# Assuming a blockchain with current height 1000

# Test 1: Version beyond current height
./remote-gas-profiler --version 999999999 db --path /path/to/db
# Expected: Panic with "there must be exactly 1 txn in the vec"

# Test 2: u64::MAX
./remote-gas-profiler --version 18446744073709551615 db --path /path/to/db
# Expected: Panic with "there must be exactly 1 txn in the vec"

# Test 3: Valid version (should work)
./remote-gas-profiler --version 100 db --path /path/to/db
# Expected: Gas profiling report generated successfully
```

## Notes

While this issue represents a clear robustness failure, it should be noted that:
- The REST backend handles this more gracefully by returning a `VersionNotFound` error from the API
- This is a local developer tool, not a production component affecting blockchain security
- The impact is limited to tool availability, not blockchain consensus or funds
- The classification as Medium severity reflects its nature as a quality-of-implementation issue rather than a critical security vulnerability

### Citations

**File:** aptos-move/aptos-debugger/src/bin/remote-gas-profiler.rs (L26-27)
```rust
    #[clap(long)]
    version: u64,
```

**File:** aptos-move/aptos-debugger/src/bin/remote-gas-profiler.rs (L48-50)
```rust
    let (txn, _txn_info, aux_info) = debugger
        .get_committed_transaction_at_version(version)
        .await?;
```

**File:** aptos-move/aptos-validator-interface/src/storage_interface.rs (L66-85)
```rust
        let txn_iter = self.0.get_transaction_iterator(start, limit)?;
        let txn_info_iter = self.0.get_transaction_info_iterator(start, limit)?;
        let txns = txn_iter
            .map(|res| res.map_err(Into::into))
            .collect::<Result<Vec<_>>>()?;
        let txn_infos = txn_info_iter
            .map(|res| res.map_err(Into::into))
            .collect::<Result<Vec<_>>>()?;

        // Get auxiliary infos using iterator for better performance
        let aux_info_iter = self
            .0
            .get_persisted_auxiliary_info_iterator(start, limit as usize)?;
        let auxiliary_infos = aux_info_iter
            .map(|res| res.map_err(Into::into))
            .collect::<Result<Vec<_>>>()?;

        ensure!(txns.len() == txn_infos.len());
        ensure!(txns.len() == auxiliary_infos.len());
        Ok((txns, txn_infos, auxiliary_infos))
```

**File:** storage/aptosdb/src/db/aptosdb_reader.rs (L477-492)
```rust
    fn get_transaction_iterator(
        &self,
        start_version: Version,
        limit: u64,
    ) -> Result<Box<dyn Iterator<Item = Result<Transaction>> + '_>> {
        gauged_api("get_transaction_iterator", || {
            error_if_too_many_requested(limit, MAX_REQUEST_LIMIT)?;
            self.error_if_ledger_pruned("Transaction", start_version)?;

            let iter = self
                .ledger_db
                .transaction_db()
                .get_transaction_iter(start_version, limit as usize)?;
            Ok(Box::new(iter) as Box<dyn Iterator<Item = Result<Transaction>> + '_>)
        })
    }
```

**File:** storage/aptosdb/src/db/aptosdb_internal.rs (L261-271)
```rust
    pub(super) fn error_if_ledger_pruned(&self, data_type: &str, version: Version) -> Result<()> {
        let min_readable_version = self.ledger_pruner.get_min_readable_version();
        ensure!(
            version >= min_readable_version,
            "{} at version {} is pruned, min available version is {}.",
            data_type,
            version,
            min_readable_version
        );
        Ok(())
    }
```

**File:** aptos-move/aptos-debugger/src/aptos_debugger.rs (L384-390)
```rust
        let txn = txns.pop().expect("there must be exactly 1 txn in the vec");
        let info = info
            .pop()
            .expect("there must be exactly 1 txn info in the vec");
        let aux_info = aux_infos
            .pop()
            .expect("there must be exactly 1 auxiliary info in the vec");
```
