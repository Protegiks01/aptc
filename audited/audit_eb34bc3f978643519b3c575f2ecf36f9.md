# Audit Report

## Title
Network Isolation Failure in Workspace Server Allows Cross-Workspace Data Access and Manipulation

## Summary
The aptos-workspace-server uses a hardcoded, shared Docker network name (`"aptos-workspace"`) for all workspace instances, allowing containers from different workspaces to communicate freely. Combined with passwordless Postgres authentication, this enables complete unauthorized access to other workspaces' blockchain data, including reading, modifying, or destroying their database contents.

## Finding Description

The workspace server creates isolated development environments, each identified by a unique `instance_id` (UUID). However, all workspace instances share the same Docker network, breaking workspace isolation.

**Root Cause - Hardcoded Network Name:** [1](#0-0) 

The network name is hardcoded as `"aptos-workspace"` instead of being unique per instance (e.g., `aptos-workspace-{instance_id}`).

**Network Reuse Pattern:** [2](#0-1) 

When subsequent workspace instances attempt to create the network, the 409 error (network already exists) is caught and the existing shared network is reused.

**Predictable Container Names:**

Containers are named using a predictable pattern with the instance_id:
- Postgres: [3](#0-2) 
- Indexer API: [4](#0-3) 

**Passwordless Authentication:** [5](#0-4) 

Postgres uses `trust` authentication with no password, allowing anyone on the network to connect.

**DNS-Based Discovery:** [6](#0-5) 

Docker's built-in DNS resolves container names within the shared network, enabling cross-workspace connections.

**Attack Scenario:**
1. Workspace A creates instance with ID `aaaa-aaaa-aaaa-aaaa`
2. Workspace B creates instance with ID `bbbb-bbbb-bbbb-bbbb`  
3. Both use the shared `"aptos-workspace"` network
4. From workspace B's containers (or by exec-ing into them), an attacker connects to: `postgres://postgres@aptos-workspace-aaaa-aaaa-aaaa-aaaa-postgres:5432/local-testnet`
5. Full read/write access to workspace A's blockchain data is granted with no authentication

## Impact Explanation

**Severity: High** (Development/Testing Infrastructure)

While this vulnerability exists in a development tool rather than production blockchain components, it has significant security impact in multi-tenant development environments:

1. **Confidentiality Breach**: Complete access to other workspaces' blockchain data, transactions, account information, and potentially test private keys
2. **Integrity Violation**: Ability to modify or corrupt another workspace's database, invalidating their testing results
3. **Availability Impact**: Ability to delete or corrupt data, causing denial of service to other developers
4. **Trust Boundary Violation**: Workspaces are assumed to be isolated, but they share network infrastructure

This affects shared development servers, CI/CD environments, and any scenario where multiple developers or automated systems run concurrent workspace instances on the same Docker host.

## Likelihood Explanation

**Likelihood: High**

- **Attack Complexity**: Very low - simple database connection from within a container
- **Attacker Requirements**: Access to run a workspace instance on the same host
- **Discovery**: Container names follow predictable patterns, easily enumerable
- **Common Scenario**: Shared development servers and CI/CD runners commonly host multiple concurrent workspaces

The vulnerability will occur whenever multiple workspace instances run simultaneously on the same Docker host, which is the expected use case in team development environments.

## Recommendation

**Fix: Use Instance-Specific Network Names**

Modify the network name to be unique per workspace instance:

```rust
// In aptos-move/aptos-workspace-server/src/lib.rs, line 146
let docker_network_name = format!("aptos-workspace-{}", instance_id);
```

This ensures each workspace instance gets its own isolated Docker network, preventing cross-workspace communication.

**Additional Hardening** (optional but recommended):
1. Set `internal: true` in network creation to prevent external access
2. Implement Postgres password authentication for defense-in-depth
3. Add network policies or firewall rules if additional isolation is needed

## Proof of Concept

**Setup:**
```bash
# Terminal 1: Start workspace instance A
cd aptos-core/aptos-move/aptos-workspace-server
cargo run -- run &
# Note the instance_id from logs (e.g., aaaa-aaaa-aaaa-aaaa)

# Terminal 2: Start workspace instance B  
cargo run -- run &
# Note the instance_id from logs (e.g., bbbb-bbbb-bbbb-bbbb)
```

**Exploitation:**
```bash
# From Terminal 2, exec into workspace B's postgres container
docker exec -it aptos-workspace-bbbb-bbbb-bbbb-bbbb-postgres bash

# Inside the container, connect to workspace A's database
psql -h aptos-workspace-aaaa-aaaa-aaaa-aaaa-postgres -U postgres -d local-testnet

# Now you have full access to workspace A's data:
# \dt                    -- List tables
# SELECT * FROM blocks;  -- Read blockchain data
# DELETE FROM blocks;    -- Destroy workspace A's data
```

**Expected Result**: Successful connection to workspace A's Postgres from workspace B's container, with full read/write privileges, demonstrating complete workspace isolation failure.

**Notes**

This vulnerability specifically affects the aptos-workspace-server development tool, not the production Aptos blockchain. However, in shared development environments (development servers, CI/CD infrastructure, collaborative workspaces), this represents a genuine security risk that could lead to data leakage, sabotage, or intellectual property theft between different developers or projects sharing the same infrastructure.

### Citations

**File:** aptos-move/aptos-workspace-server/src/lib.rs (L146-146)
```rust
    let docker_network_name = "aptos-workspace".to_string();
```

**File:** aptos-move/aptos-workspace-server/src/services/docker_common.rs (L47-62)
```rust
        match res {
            Ok(_response) => {
                no_panic_println!("Created docker network {}", name);

                Ok(name)
            },
            Err(err) => match err {
                bollard::errors::Error::DockerResponseServerError {
                    status_code: 409, ..
                } => {
                    no_panic_println!("Docker network {} already exists, not creating it", name);
                    Ok(name)
                },
                err => Err(err.into()),
            },
        }
```

**File:** aptos-move/aptos-workspace-server/src/services/postgres.rs (L65-70)
```rust
pub fn get_postgres_connection_string_within_docker_network(instance_id: Uuid) -> String {
    format!(
        "postgres://{}@aptos-workspace-{}-postgres:{}/{}",
        POSTGRES_USER, instance_id, POSTGRES_DEFAULT_PORT, POSTGRES_DB_NAME
    )
}
```

**File:** aptos-move/aptos-workspace-server/src/services/postgres.rs (L113-117)
```rust
        env: Some(vec![
            // We run postgres without any auth + no password.
            "POSTGRES_HOST_AUTH_METHOD=trust".to_string(),
            format!("POSTGRES_USER={}", POSTGRES_USER),
            format!("POSTGRES_DB={}", POSTGRES_DB_NAME),
```

**File:** aptos-move/aptos-workspace-server/src/services/postgres.rs (L142-145)
```rust
    let options = CreateContainerOptions {
        name: format!("aptos-workspace-{}-postgres", instance_id),
        ..Default::default()
    };
```

**File:** aptos-move/aptos-workspace-server/src/services/indexer_api.rs (L102-105)
```rust
    let options = CreateContainerOptions {
        name: format!("aptos-workspace-{}-indexer-api", instance_id),
        ..Default::default()
    };
```
