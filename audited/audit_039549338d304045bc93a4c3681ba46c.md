# Audit Report

## Title
Information Disclosure via RocksDB Error Messages in Peer Monitoring Service

## Summary
The peer monitoring service exposes internal file system paths through unfiltered RocksDB storage error messages to external network peers, allowing attackers to map internal directory structures.

## Finding Description
The peer monitoring service converts storage errors containing file paths directly into serialized error messages sent to external clients without sanitization. When the service handles requests like `GetNodeInformation`, it accesses storage operations that may fail with RocksDB IO errors containing absolute file paths. [1](#0-0) 

The error flow propagates through multiple layers:

1. RocksDB returns errors with file paths (e.g., "IO error: No such file or directory: /opt/aptos/data/db/ledger_db/CURRENT")
2. These are converted to AptosDbError preserving the full error string: [2](#0-1) 

3. Storage reader converts these to Error::StorageErrorEncountered: [3](#0-2) 

4. The handler converts all non-InvalidRequest errors to InternalError with the full error string: [4](#0-3) 

5. This error is serialized and sent over the network: [5](#0-4) 

The peer monitoring service is registered on ALL network types without access restrictions: [6](#0-5) 

## Impact Explanation
This is classified as **Low Severity** per Aptos bug bounty criteria - a "Minor information leak" worth up to $1,000. The vulnerability exposes:
- Absolute file system paths (e.g., `/opt/aptos/data/db/ledger_db/`)
- Database internal structure and organization
- RocksDB file naming conventions

However, it does NOT directly enable:
- Fund theft or consensus violations
- Remote code execution or privilege escalation
- Denial of service or availability attacks

The leaked information may assist reconnaissance but provides no direct attack vector.

## Likelihood Explanation
**Low likelihood** - requires storage errors which are uncommon in production:
- Database corruption (rare without prior compromise)
- Disk space exhaustion (detectable and preventable)
- Permission errors (only during misconfiguration)
- File system issues (uncommon in properly managed systems)

An attacker cannot reliably trigger these conditions without already having significant system access, limiting practical exploitation.

## Recommendation
Implement error message sanitization before network transmission:

```rust
// In peer-monitoring-service/server/src/lib.rs
match error {
    Error::InvalidRequest(error) => {
        Err(PeerMonitoringServiceError::InvalidRequest(error))
    },
    error => {
        // Sanitize error messages before exposing to clients
        let sanitized_message = match error {
            Error::StorageErrorEncountered(_) => 
                "Storage error encountered".to_string(),
            _ => "Internal error encountered".to_string(),
        };
        Err(PeerMonitoringServiceError::InternalError(sanitized_message))
    },
}
```

Additionally, consider using structured error types without raw string propagation throughout the storage stack.

## Proof of Concept

```rust
// Simulated attack scenario (requires storage error condition)
use peer_monitoring_service_client::PeerMonitoringServiceClient;

#[tokio::test]
async fn test_path_disclosure_via_storage_error() {
    // Setup: Connect to peer monitoring service
    let mut client = PeerMonitoringServiceClient::new(/* network config */);
    
    // Prerequisite: Target node must have storage error
    // (e.g., corrupted database, missing files, permission issues)
    
    // Attack: Send GetNodeInformation request
    let request = PeerMonitoringServiceRequest::GetNodeInformation;
    let response = client.send_request(peer_id, request).await;
    
    // Expected: Error message contains file path
    // "Internal service error: Storage error encountered: 
    //  AptosDB RocksDB Error: IO error: No such file or directory: 
    //  /opt/aptos/data/db/ledger_db/CURRENT"
    
    if let Err(PeerMonitoringServiceError::InternalError(msg)) = response {
        assert!(msg.contains("/opt/aptos/data"));  // Path leaked
        assert!(msg.contains("ledger_db"));        // Structure leaked
    }
}
```

**Notes:**
- This vulnerability requires pre-existing storage errors to exploit
- The default data directory path (`/opt/aptos/data`) is documented and predictable
- No documented invariants from the security model are violated
- Impact is limited to information disclosure without direct security consequences
- Classified as Low severity consistent with the security question's initial assessment

### Citations

**File:** peer-monitoring-service/server/src/error.rs (L7-15)
```rust
#[derive(Clone, Debug, Deserialize, Error, PartialEq, Eq, Serialize)]
pub enum Error {
    #[error("Invalid request received: {0}")]
    InvalidRequest(String),
    #[error("Storage error encountered: {0}")]
    StorageErrorEncountered(String),
    #[error("Unexpected error encountered: {0}")]
    UnexpectedErrorEncountered(String),
}
```

**File:** storage/schemadb/src/lib.rs (L389-408)
```rust
fn to_db_err(rocksdb_err: rocksdb::Error) -> AptosDbError {
    match rocksdb_err.kind() {
        ErrorKind::Incomplete => AptosDbError::RocksDbIncompleteResult(rocksdb_err.to_string()),
        ErrorKind::NotFound
        | ErrorKind::Corruption
        | ErrorKind::NotSupported
        | ErrorKind::InvalidArgument
        | ErrorKind::IOError
        | ErrorKind::MergeInProgress
        | ErrorKind::ShutdownInProgress
        | ErrorKind::TimedOut
        | ErrorKind::Aborted
        | ErrorKind::Busy
        | ErrorKind::Expired
        | ErrorKind::TryAgain
        | ErrorKind::CompactionTooLarge
        | ErrorKind::ColumnFamilyDropped
        | ErrorKind::Unknown => AptosDbError::OtherRocksDbError(rocksdb_err.to_string()),
    }
}
```

**File:** peer-monitoring-service/server/src/storage.rs (L35-41)
```rust
    fn get_latest_ledger_info(&self) -> Result<LedgerInfo, Error> {
        let latest_ledger_info_with_sigs = self
            .storage
            .get_latest_ledger_info()
            .map_err(|err| Error::StorageErrorEncountered(err.to_string()))?;
        Ok(latest_ledger_info_with_sigs.ledger_info().clone())
    }
```

**File:** peer-monitoring-service/server/src/lib.rs (L198-203)
```rust
                match error {
                    Error::InvalidRequest(error) => {
                        Err(PeerMonitoringServiceError::InvalidRequest(error))
                    },
                    error => Err(PeerMonitoringServiceError::InternalError(error.to_string())),
                }
```

**File:** peer-monitoring-service/types/src/lib.rs (L26-32)
```rust
#[derive(Clone, Debug, Deserialize, Error, PartialEq, Eq, Serialize)]
pub enum PeerMonitoringServiceError {
    #[error("Internal service error: {0}")]
    InternalError(String),
    #[error("Invalid service request: {0}")]
    InvalidRequest(String),
}
```

**File:** aptos-node/src/network.rs (L370-378)
```rust
        // Register the peer monitoring service (both client and server) with the network
        let peer_monitoring_service_network_handle = register_client_and_service_with_network(
            &mut network_builder,
            network_id,
            &network_config,
            peer_monitoring_network_configuration(node_config),
            true,
        );
        peer_monitoring_service_network_handles.push(peer_monitoring_service_network_handle);
```
