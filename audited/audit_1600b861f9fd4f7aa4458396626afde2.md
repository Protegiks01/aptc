# Audit Report

## Title
Information Leakage via OpenAPI Specification: /info Endpoint Exposes Sensitive Node Configuration and Network Identity

## Summary
The OpenAPI specification generated by `service.spec()` and `service.spec_yaml()` documents the `/info` endpoint which exposes sensitive internal node configuration and network peer identities without authentication. This information aids attackers in reconnaissance and enables targeted network attacks against validators. [1](#0-0) 

## Finding Description
The `get_spec()` function in `api/src/spec.rs` generates OpenAPI specifications that document all public API endpoints, including the `/info` endpoint defined in `BasicApi`. This endpoint is publicly accessible without any authentication and returns sensitive information including:

1. **State sync configuration** (bootstrapping_mode, continuous_syncing_mode)
2. **Storage configuration** (enable_storage_sharding)
3. **Internal indexer configuration** (complete InternalIndexerDBConfig structure)
4. **Network peer identities** (validator_network_peer_id, fullnode_network_peer_id) [2](#0-1) 

The `/info` endpoint is documented in the OpenAPI spec served at `/v1/spec.yaml` and `/v1/spec.json`, making it trivially discoverable: [3](#0-2) 

The endpoint is mounted in the runtime without any access control: [4](#0-3) 

**Network Peer ID Sensitivity**: The exposed peer IDs are derived from x25519 public keys and serve as cryptographic network identities used in the Noise handshake protocol for peer authentication. Exposing validator peer IDs enables attackers to:
- Map network topology and identify validator nodes
- Target specific validators with network-level attacks
- Correlate on-chain and off-chain data to deanonymize validators

**Inconsistent Security Policy**: The codebase demonstrates awareness that exposing configuration is a security concern. The InspectionService explicitly prevents mainnet validators from exposing configuration through sanitization checks: [5](#0-4) 

However, the REST API's `/info` endpoint lacks similar protections and exposes even more sensitive information (network peer IDs) without any restrictions.

## Impact Explanation
This qualifies as **Medium Severity** information leakage per the Aptos bug bounty criteria because:

1. **Reconnaissance Aid**: Attackers can trivially discover internal node architecture, configuration modes, and network identities by reading the OpenAPI spec or querying `/v1/info`

2. **Targeted Attack Enablement**: Network peer IDs enable targeted attacks against specific validators, potentially affecting validator node availability and network stability

3. **Inconsistent Security Posture**: The codebase explicitly prevents configuration exposure via InspectionService on mainnet validators, but the REST API undermines this security policy

While this doesn't directly cause consensus violations or fund loss, it significantly reduces the security posture by providing attackers with detailed reconnaissance information about validator infrastructure.

## Likelihood Explanation
**Likelihood: High**

- The endpoint is publicly accessible without authentication
- The vulnerability is documented in the OpenAPI specification served at `/v1/spec.yaml` and `/v1/spec.json`
- Any attacker can trivially query the endpoint with a simple HTTP GET request
- No rate limiting or access controls protect this information
- The information is valuable for planning targeted attacks against validators

## Recommendation

**Option 1: Remove Sensitive Fields**
Remove network peer IDs and detailed configuration from the `/info` endpoint. Return only non-sensitive information suitable for public consumption (e.g., chain_id, ledger version).

**Option 2: Add Access Control**
Implement authentication/authorization for the `/info` endpoint, restricting access to authorized operators only. This aligns with the InspectionService's approach of controlling configuration exposure.

**Option 3: Add Configuration Flag**
Add an `expose_node_info` configuration flag to ApiConfig with sanitization similar to InspectionService:

```rust
// In api/src/basic.rs
async fn info(&self) -> Result<Json<HashMap<String, serde_json::Value>>, poem::Error> {
    if !self.context.node_config.api.expose_node_info {
        return Err(poem::Error::from_status(StatusCode::FORBIDDEN));
    }
    // ... existing implementation
}
```

**Recommended Approach**: Combine Options 1 and 3 - remove network peer IDs from the endpoint entirely (they should never be publicly exposed), and add a configuration flag to control whether other configuration details are exposed.

## Proof of Concept

**Step 1: Query the OpenAPI Specification**
```bash
curl -s https://<aptos-node-address>/v1/spec.yaml | grep -A 10 "/info:"
```

Expected output shows the endpoint is documented without authentication requirements.

**Step 2: Query the /info Endpoint**
```bash
curl -s https://<aptos-node-address>/v1/info | jq
```

Expected output includes:
```json
{
  "bootstrapping_mode": "...",
  "continuous_syncing_mode": "...",
  "new_storage_format": true/false,
  "internal_indexer_config": {
    "enable_transaction": true/false,
    "enable_event": true/false,
    "enable_statekeys": true/false,
    "batch_size": 10000
  },
  "validator_network_peer_id": "<peer_id_hex>",
  "fullnode_network_peer_id_<network_id>": "<peer_id_hex>"
}
```

**Step 3: Use Exposed Information for Reconnaissance**
The attacker now knows:
- Whether this is a validator node (has validator_network_peer_id)
- The exact network identities to target in network attacks
- The node's state sync and storage configuration
- Which indexer features are enabled

This information significantly aids in planning targeted attacks against the validator infrastructure.

## Notes

The vulnerability exists at the intersection of the OpenAPI spec generation (`api/src/spec.rs`) and the implementation of the `/info` endpoint (`api/src/basic.rs`). While the spec generation function itself is benign, it faithfully documents all endpoints including those that leak sensitive information. The root cause is the design decision to expose detailed node configuration and network identities through a public, unauthenticated endpoint.

### Citations

**File:** api/src/spec.rs (L14-25)
```rust
pub fn get_spec<T, W>(service: &OpenApiService<T, W>, yaml: bool) -> String
where
    T: OpenApi,
    W: Webhook,
{
    let spec = if yaml {
        service.spec_yaml()
    } else {
        service.spec()
    };
    spec.replace("; charset=utf-8", "")
}
```

**File:** api/src/basic.rs (L68-134)
```rust
    /// Show some basic info of the node.
    #[oai(
        path = "/info",
        method = "get",
        operation_id = "info",
        tag = "ApiTags::General"
    )]
    async fn info(&self) -> Json<HashMap<String, serde_json::Value>> {
        let mut info = HashMap::new();

        // Insert state sync configuration information
        info.insert(
            "bootstrapping_mode".to_string(),
            serde_json::to_value(
                self.context
                    .node_config
                    .state_sync
                    .state_sync_driver
                    .bootstrapping_mode,
            )
            .unwrap(),
        );
        info.insert(
            "continuous_syncing_mode".to_string(),
            serde_json::to_value(
                self.context
                    .node_config
                    .state_sync
                    .state_sync_driver
                    .continuous_syncing_mode,
            )
            .unwrap(),
        );

        // Insert storage configuration information
        info.insert(
            "new_storage_format".to_string(),
            serde_json::to_value(
                self.context
                    .node_config
                    .storage
                    .rocksdb_configs
                    .enable_storage_sharding,
            )
            .unwrap(),
        );
        info.insert(
            "internal_indexer_config".to_string(),
            serde_json::to_value(&self.context.node_config.indexer_db_config).unwrap(),
        );

        // Insert node identity information
        if let Some(validator_network) = &self.context.node_config.validator_network {
            info.insert(
                "validator_network_peer_id".to_string(),
                serde_json::to_value(validator_network.peer_id()).unwrap(),
            );
        }
        for fullnode_network in &self.context.node_config.full_node_networks {
            info.insert(
                format!("fullnode_network_peer_id_{}", fullnode_network.network_id),
                serde_json::to_value(fullnode_network.peer_id()).unwrap(),
            );
        }

        Json(info)
    }
```

**File:** api/doc/spec.yaml (L1867-1880)
```yaml
  /info:
    get:
      tags:
      - General
      summary: Show some basic info of the node.
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                type: object
                additionalProperties: {}
      operationId: info
```

**File:** api/src/runtime.rs (L177-180)
```rust
    let api_service = get_api_service(context.clone());

    let spec_json = spec_endpoint_json(&api_service);
    let spec_yaml = spec_endpoint_yaml(&api_service);
```

**File:** config/src/config/inspection_service_config.rs (L54-65)
```rust
        // Verify that mainnet validators do not expose the configuration
        if let Some(chain_id) = chain_id {
            if node_type.is_validator()
                && chain_id.is_mainnet()
                && inspection_service_config.expose_configuration
            {
                return Err(Error::ConfigSanitizerFailed(
                    sanitizer_name,
                    "Mainnet validators should not expose the node configuration!".to_string(),
                ));
            }
        }
```
