# Audit Report

## Title
Aptos Faucet Metrics Server Default Configuration Violates Least Privilege Principle - Exposes Operational Metrics to All Network Interfaces

## Summary
The `MetricsServerConfig` in the Aptos Faucet service defaults to binding on `0.0.0.0` instead of `127.0.0.1`, exposing operational metrics including account balances, transaction patterns, and rejection statistics to any network actor without authentication. This violates the principle of least privilege and enables reconnaissance attacks.

## Finding Description
The `MetricsServerConfig` struct defines the configuration for the faucet's Prometheus metrics server. [1](#0-0) 

The default listen address is set to `"0.0.0.0"`, which binds to all network interfaces, making the metrics endpoint accessible from any network location. This is a security misconfiguration that violates the principle of least privilege - by default, services should only be accessible locally unless explicitly configured otherwise.

The metrics server exposes a `/metrics` endpoint [2](#0-1)  that returns all Prometheus metrics gathered from the faucet process [3](#0-2)  with no authentication mechanism.

The exposed metrics include sensitive operational data such as:
- Faucet account balances [4](#0-3) 
- Number of outstanding transactions [5](#0-4) 
- Request patterns and latencies [6](#0-5) 
- Rejection reason statistics [7](#0-6) 

An attacker can exploit this by simply accessing `http://<faucet-ip>:9101/metrics` from any network location to gather operational intelligence about the faucet service, including current account balances and transaction processing patterns.

## Impact Explanation
This vulnerability falls under **Low Severity (up to $1,000)** per the Aptos Bug Bounty Program criteria for "Minor information leaks."

While the default configuration exposes operational metrics without authentication, the impact is limited because:
1. The faucet is a test utility service, not a core consensus, execution, or state management component
2. The metrics don't expose private keys, enable direct fund theft, or affect consensus safety
3. The exposed information (balances, request patterns) is operational data rather than cryptographic secrets
4. No direct manipulation of funds, consensus, or availability is possible through this exposure

However, the exposed information could enable reconnaissance for more sophisticated attacks by revealing:
- Current faucet operational capacity
- Rate limiting and security control effectiveness
- Optimal timing for resource exhaustion attempts

## Likelihood Explanation
This vulnerability has **HIGH likelihood** of occurring in production deployments because:
1. The insecure default is baked into the code
2. Many operators deploy services using default configurations
3. No warning or documentation indicates this security implication
4. The configuration is defined through serde defaults [8](#0-7)  which are easily overlooked

## Recommendation
Change the default listen address to bind only to localhost (`127.0.0.1`) to follow the principle of least privilege:

```rust
fn default_listen_address() -> String {
    "127.0.0.1".to_string()
}
```

Additionally, add clear documentation warning operators that exposing metrics publicly requires additional security controls (authentication, firewall rules, etc.).

For production deployments requiring external metrics access, operators should explicitly configure `listen_address: "0.0.0.0"` in their YAML configuration file and implement appropriate network security controls.

## Proof of Concept

**Step 1**: Deploy a faucet instance with default configuration (no explicit `listen_address` set in YAML)

**Step 2**: From any machine on the network, execute:
```bash
curl http://<faucet-host>:9101/metrics
```

**Expected Result**: The endpoint returns Prometheus metrics including:
- `aptos_tap_transfer_funder_account_balance` - Faucet account balance
- `aptos_tap_num_outstanding_transactions` - Transaction queue depth  
- `aptos_tap_requests` - Request latency histograms
- `aptos_tap_rejection_reason_count` - Security control effectiveness

This information is accessible without any authentication or authorization check.

## Notes
While this is a valid security misconfiguration that violates best practices, its classification as Low severity is appropriate given:
- The faucet is not a consensus-critical component
- No direct exploitation path to fund theft or consensus violation exists
- The primary impact is information disclosure enabling reconnaissance
- This is a configuration default issue rather than a code vulnerability in core blockchain logic

The finding is valid and should be addressed, but does not meet the threshold for High or Medium severity under the strict Aptos Bug Bounty criteria focused on consensus, execution, state management, and governance vulnerabilities.

### Citations

**File:** crates/aptos-faucet/metrics-server/src/config.rs (L13-14)
```rust
    #[serde(default = "MetricsServerConfig::default_listen_address")]
    pub listen_address: String,
```

**File:** crates/aptos-faucet/metrics-server/src/config.rs (L26-28)
```rust
    fn default_listen_address() -> String {
        "0.0.0.0".to_string()
    }
```

**File:** crates/aptos-faucet/metrics-server/src/server.rs (L35-39)
```rust
    Server::new(TcpListener::bind((
        config.listen_address.clone(),
        config.listen_port,
    )))
    .run(Route::new().at("/metrics", metrics).with(cors))
```

**File:** crates/aptos-faucet/metrics-server/src/gather_metrics.rs (L15-17)
```rust
pub fn gather_metrics() -> Vec<prometheus::proto::MetricFamily> {
    let metric_families = aptos_metrics_core::gather();
    let mut total: u64 = 0;
```

**File:** crates/aptos-faucet/core/src/middleware/metrics.rs (L11-18)
```rust
pub static HISTOGRAM: Lazy<HistogramVec> = Lazy::new(|| {
    register_histogram_vec!(
        "aptos_tap_requests",
        "Tap requests latency grouped by method, operation_id and status.",
        &["method", "operation_id", "status"]
    )
    .unwrap()
});
```

**File:** crates/aptos-faucet/core/src/middleware/metrics.rs (L29-36)
```rust
static REJECTION_REASONS: Lazy<IntCounterVec> = Lazy::new(|| {
    register_int_counter_vec!(
        "aptos_tap_rejection_reason_count",
        "Number of times the tap has returned the given rejection reason.",
        &["rejection_reason_code"]
    )
    .unwrap()
});
```

**File:** crates/aptos-faucet/core/src/middleware/metrics.rs (L38-44)
```rust
pub static NUM_OUTSTANDING_TRANSACTIONS: Lazy<IntGauge> = Lazy::new(|| {
    register_int_gauge!(
        "aptos_tap_num_outstanding_transactions",
        "Number of transactions we've submitted but have not been processed by the blockchain.",
    )
    .unwrap()
});
```

**File:** crates/aptos-faucet/core/src/middleware/metrics.rs (L47-53)
```rust
pub static TRANSFER_FUNDER_ACCOUNT_BALANCE: Lazy<IntGauge> = Lazy::new(|| {
    register_int_gauge!(
        "aptos_tap_transfer_funder_account_balance",
        "Balance of the account used by the tap instance. Only populated for the TransferFunder.",
    )
    .unwrap()
});
```
