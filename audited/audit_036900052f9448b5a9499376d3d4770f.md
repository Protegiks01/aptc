# Audit Report

## Title
Cross-Workspace Network Isolation Failure in Aptos Workspace Server

## Summary
The Aptos workspace server creates a single shared Docker network (`"aptos-workspace"`) that is reused across all workspace instances, allowing containers from different workspaces to communicate with each other, breaking the intended isolation between test environments.

## Finding Description

The workspace server is designed to enable "multiple local networks to operate simultaneously, enabling testing and development in isolated environments." [1](#0-0) 

However, the implementation violates this isolation guarantee. The Docker network name is hardcoded as `"aptos-workspace"` [2](#0-1)  and created as a permanent network that persists across instances. [3](#0-2) 

When the network already exists, the code simply reuses it instead of creating a new one. [4](#0-3) 

While each workspace instance generates a unique UUID for container naming [5](#0-4) , all containers are attached to the same shared network. [6](#0-5) [7](#0-6) 

The Postgres containers are configured with trust authentication (no password required) [8](#0-7)  and can be accessed from within the Docker network using their container names. [9](#0-8) 

**Attack Path:**
1. Attacker starts workspace A (instance_id_A)
2. Victim starts workspace B (instance_id_B)  
3. From a container in workspace A, attacker connects to: `postgres://postgres@aptos-workspace-{instance_id_B}-postgres:5432/local-testnet`
4. Docker's DNS resolution on the shared network allows this connection
5. No authentication is required due to trust mode
6. Attacker can read, modify, or delete workspace B's database

## Impact Explanation

**IMPORTANT CAVEAT:** The workspace server is a local development/testing tool, NOT a production blockchain component. While this is a legitimate security vulnerability in the code, it does **NOT** affect:
- Production Aptos blockchain consensus
- Production validator nodes
- On-chain funds or state
- The live Aptos network

The impact is limited to local development environments where multiple developers or CI/CD pipelines might run concurrent workspace instances on the same machine. In such scenarios:
- Malicious code in one workspace can access another workspace's data
- Test data corruption or theft between workspaces
- Potential supply chain attacks if malicious dependencies in one workspace affect others
- Violation of development environment isolation expectations

This would be classified as **High severity for development tools** but does NOT meet the Aptos bug bounty criteria, which focus on production blockchain security (consensus violations, fund loss, validator node attacks, etc.).

## Likelihood Explanation

**High likelihood** in multi-tenant development scenarios:
- No special privileges required
- Attack is straightforward with standard Docker networking
- Instance IDs could be enumerated or predicted
- Postgres has no authentication barrier

**Low likelihood** of real-world impact:
- Most developers run single workspace instances
- Development environments typically have limited security requirements
- Not exploitable against production blockchain infrastructure

## Recommendation

Change the network name to be instance-specific by incorporating the UUID:

```rust
let docker_network_name = format!("aptos-workspace-{}", instance_id);
```

This ensures each workspace gets its own isolated Docker network. The network should also be created using `create_docker_network()` (with cleanup) instead of `create_docker_network_permanent()` to ensure proper lifecycle management.

## Proof of Concept

```bash
# Terminal 1: Start workspace A
cd aptos-core
cargo run -p aptos -- workspace run &
# Note the instance_id from logs (or enumerate)

# Terminal 2: Start workspace B  
cargo run -p aptos -- workspace run &

# Terminal 3: From workspace A's postgres container
docker exec -it aptos-workspace-{instance_id_A}-postgres psql -U postgres -h aptos-workspace-{instance_id_B}-postgres -p 5432 -d local-testnet

# Successfully connects to workspace B's database
# Can execute: SELECT * FROM ... to read data
# Can execute: DROP TABLE ... to destroy data
```

---

## Notes

This vulnerability exists in the codebase but **does not meet the Aptos blockchain security audit criteria** as it:
- Does not affect production blockchain consensus, execution, storage, governance, or staking
- Is limited to local development tool isolation
- Does not threaten funds, validator nodes, or network availability
- Falls outside the scope of the Aptos bug bounty program severity categories

While it should be fixed to improve development environment security, it is **not a blockchain security vulnerability**.

### Citations

**File:** aptos-move/aptos-workspace-server/src/lib.rs (L14-15)
```rust
//! The services are bound to unique OS-assigned ports to allow for multiple local networks
//! to operate simultaneously, enabling testing and development in isolated environments.
```

**File:** aptos-move/aptos-workspace-server/src/lib.rs (L97-97)
```rust
    let instance_id = Uuid::new_v4();
```

**File:** aptos-move/aptos-workspace-server/src/lib.rs (L146-146)
```rust
    let docker_network_name = "aptos-workspace".to_string();
```

**File:** aptos-move/aptos-workspace-server/src/lib.rs (L147-151)
```rust
    let fut_docker_network = make_shared(create_docker_network_permanent(
        shutdown.clone(),
        fut_docker.clone(),
        docker_network_name,
    ));
```

**File:** aptos-move/aptos-workspace-server/src/services/docker_common.rs (L53-59)
```rust
            Err(err) => match err {
                bollard::errors::Error::DockerResponseServerError {
                    status_code: 409, ..
                } => {
                    no_panic_println!("Docker network {} already exists, not creating it", name);
                    Ok(name)
                },
```

**File:** aptos-move/aptos-workspace-server/src/services/postgres.rs (L65-70)
```rust
pub fn get_postgres_connection_string_within_docker_network(instance_id: Uuid) -> String {
    format!(
        "postgres://{}@aptos-workspace-{}-postgres:{}/{}",
        POSTGRES_USER, instance_id, POSTGRES_DEFAULT_PORT, POSTGRES_DB_NAME
    )
}
```

**File:** aptos-move/aptos-workspace-server/src/services/postgres.rs (L88-92)
```rust
    let host_config = Some(HostConfig {
        // Bind the container to the network we created in the pre_run. This does
        // not prevent the binary in the container from exposing itself to the host
        // on 127.0.0.1. See more here: https://stackoverflow.com/a/77432636/3846032.
        network_mode: Some(network_name.clone()),
```

**File:** aptos-move/aptos-workspace-server/src/services/postgres.rs (L115-115)
```rust
            "POSTGRES_HOST_AUTH_METHOD=trust".to_string(),
```

**File:** aptos-move/aptos-workspace-server/src/services/indexer_api.rs (L64-68)
```rust
    let host_config = HostConfig {
        // Connect the container to the network we made in the postgres pre_run.
        // This allows the indexer API to access the postgres container without
        // routing through the host network.
        network_mode: Some(network_name),
```
