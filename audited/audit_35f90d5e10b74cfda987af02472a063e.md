# Audit Report

## Title
Faucet Metrics Server Exposes Operational Data Without Authentication via Default 0.0.0.0 Binding

## Summary
The Aptos Faucet metrics server binds to all network interfaces (0.0.0.0) by default and exposes operational metrics including funder account balance without any authentication, allowing unauthorized external actors to scrape sensitive operational intelligence from internet-facing faucet deployments.

## Finding Description

The `MetricsServerConfig` struct defines the default listen address as "0.0.0.0" [1](#0-0) , which binds the metrics server to all network interfaces including public internet if the host is internet-facing.

The metrics server exposes a `/metrics` endpoint [2](#0-1)  that serves Prometheus-formatted metrics without any authentication or authorization checks. The endpoint only implements CORS middleware allowing GET methods [3](#0-2) , but provides no access control.

The metrics exposed include sensitive operational information:
- **Funder account balance** [4](#0-3)  - reveals current funds available in the faucet
- Request latencies grouped by operation and status [5](#0-4) 
- Rejection reason counts [6](#0-5)  - could reveal security controls and rate limit thresholds
- Number of outstanding transactions [7](#0-6) 

The metrics gathering function collects all registered Prometheus metrics [8](#0-7)  from the global registry, making all operational data accessible to unauthenticated requests.

## Impact Explanation

This constitutes **Medium Severity** information disclosure per the Aptos bug bounty criteria. While it doesn't directly enable fund theft or consensus violations, it provides:

1. **Operational Intelligence**: Attackers can monitor faucet balance, transaction volume, and usage patterns to plan targeted attacks
2. **Security Control Reconnaissance**: Rejection reason metrics reveal rate limits, IP blocklists, and other defensive measures, allowing attackers to bypass them
3. **Resource Planning**: Knowledge of outstanding transactions and account balance enables timing of resource exhaustion attacks

The exposure violates the **Access Control** invariant - operational metrics should be restricted to authorized monitoring systems, not publicly accessible. However, since the faucet is a testnet utility service distributing test tokens (not production funds), the severity is limited to Medium rather than High.

## Likelihood Explanation

**High Likelihood** if deployed with default configuration on internet-facing infrastructure. The vulnerability triggers automatically when:
1. Faucet is started with default configuration (no YAML override)
2. Host has a public IP or is deployed without network-level firewalls
3. Port 9101 is accessible from external networks

Production deployments typically use infrastructure-level controls (Kubernetes NetworkPolicies, cloud security groups), but the insecure default creates risk for:
- Development/staging environments
- Quick testnet deployments
- Misconfigured production instances

## Recommendation

Implement defense-in-depth by fixing the default configuration and adding optional authentication:

**1. Change default listen address to localhost:**
```rust
fn default_listen_address() -> String {
    "127.0.0.1".to_string()  // Changed from "0.0.0.0"
}
``` [1](#0-0) 

**2. Add optional bearer token authentication:**
```rust
pub struct MetricsServerConfig {
    pub disable: bool,
    pub listen_address: String,
    pub listen_port: u16,
    pub auth_token: Option<String>,  // Add optional authentication
}
```

**3. Validate token in the metrics handler:**
```rust
#[handler]
fn metrics(req: &Request, config: Data<&MetricsServerConfig>) -> Result<Vec<u8>, poem::Error> {
    if let Some(required_token) = &config.auth_token {
        if let Some(auth_header) = req.headers().get("Authorization") {
            if !auth_header.to_str()?.starts_with(&format!("Bearer {}", required_token)) {
                return Err(poem::Error::from_status(StatusCode::UNAUTHORIZED));
            }
        } else {
            return Err(poem::Error::from_status(StatusCode::UNAUTHORIZED));
        }
    }
    Ok(encode_metrics(TextEncoder))
}
```

**4. Document security best practices in README**, emphasizing that metrics servers should be deployed behind network firewalls or with authentication enabled for production use.

## Proof of Concept

**Prerequisites:**
- Running faucet with default configuration
- Network access to the faucet host

**Exploitation steps:**
```bash
# 1. Start faucet with default configuration (no auth, binds to 0.0.0.0:9101)
cargo run -p aptos-faucet-service -- run-simple \
  --node-url http://127.0.0.1:8080 \
  --chain-id TESTING \
  --key ~/.aptos/testnet/mint.key

# 2. From external network, scrape metrics without authentication
curl http://<faucet-public-ip>:9101/metrics

# Expected output: Full Prometheus metrics including:
# aptos_tap_transfer_funder_account_balance{} 1000000000
# aptos_tap_num_outstanding_transactions{} 5
# aptos_tap_rejection_reason_count{rejection_reason_code="429"} 142
# ... (all operational metrics exposed)
```

**Impact demonstration:**
The attacker now has:
- Real-time faucet balance (can time attacks when funds are low)
- Rejection patterns (can infer rate limit thresholds)
- Transaction load (can identify optimal attack windows)
- Request patterns (can profile legitimate vs. malicious behavior)

## Notes

While this is a legitimate information disclosure vulnerability in the faucet codebase, it's important to note that:

1. **The faucet is a testnet utility service**, not a core blockchain component affecting consensus, Move VM execution, state management, governance, or staking
2. **Production deployments typically use infrastructure-level protections** (Kubernetes NetworkPolicies, cloud security groups, VPC isolation)
3. **The exposed metrics contain operational data**, not cryptographic keys or direct access to funds
4. **Severity is Medium** because it enables reconnaissance but doesn't directly compromise funds or consensus

The vulnerability should be fixed to follow security best practices (secure defaults, defense-in-depth), but the limited scope to a testnet utility service reduces the overall blockchain security impact.

### Citations

**File:** crates/aptos-faucet/metrics-server/src/config.rs (L26-28)
```rust
    fn default_listen_address() -> String {
        "0.0.0.0".to_string()
    }
```

**File:** crates/aptos-faucet/metrics-server/src/server.rs (L26-39)
```rust
#[handler]
fn metrics() -> Vec<u8> {
    encode_metrics(TextEncoder)
}

pub fn run_metrics_server(
    config: MetricsServerConfig,
) -> impl Future<Output = Result<(), std::io::Error>> {
    let cors = Cors::new().allow_methods(vec![Method::GET]);
    Server::new(TcpListener::bind((
        config.listen_address.clone(),
        config.listen_port,
    )))
    .run(Route::new().at("/metrics", metrics).with(cors))
```

**File:** crates/aptos-faucet/core/src/middleware/metrics.rs (L11-18)
```rust
pub static HISTOGRAM: Lazy<HistogramVec> = Lazy::new(|| {
    register_histogram_vec!(
        "aptos_tap_requests",
        "Tap requests latency grouped by method, operation_id and status.",
        &["method", "operation_id", "status"]
    )
    .unwrap()
});
```

**File:** crates/aptos-faucet/core/src/middleware/metrics.rs (L29-36)
```rust
static REJECTION_REASONS: Lazy<IntCounterVec> = Lazy::new(|| {
    register_int_counter_vec!(
        "aptos_tap_rejection_reason_count",
        "Number of times the tap has returned the given rejection reason.",
        &["rejection_reason_code"]
    )
    .unwrap()
});
```

**File:** crates/aptos-faucet/core/src/middleware/metrics.rs (L38-44)
```rust
pub static NUM_OUTSTANDING_TRANSACTIONS: Lazy<IntGauge> = Lazy::new(|| {
    register_int_gauge!(
        "aptos_tap_num_outstanding_transactions",
        "Number of transactions we've submitted but have not been processed by the blockchain.",
    )
    .unwrap()
});
```

**File:** crates/aptos-faucet/core/src/middleware/metrics.rs (L47-53)
```rust
pub static TRANSFER_FUNDER_ACCOUNT_BALANCE: Lazy<IntGauge> = Lazy::new(|| {
    register_int_gauge!(
        "aptos_tap_transfer_funder_account_balance",
        "Balance of the account used by the tap instance. Only populated for the TransferFunder.",
    )
    .unwrap()
});
```

**File:** crates/aptos-faucet/metrics-server/src/gather_metrics.rs (L15-16)
```rust
pub fn gather_metrics() -> Vec<prometheus::proto::MetricFamily> {
    let metric_families = aptos_metrics_core::gather();
```
