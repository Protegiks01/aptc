# Audit Report

## Title
Genesis Configuration Enables Unsupported Transaction Shuffler Types Causing Validator Panic

## Summary
The genesis configuration system allows specifying deprecated/unsupported `TransactionShufflerType` variants (specifically `SenderAwareV2` and `DeprecatedFairness`) in the `on_chain_execution_config` without validation. When validators attempt to start with such a configuration, they panic at the `unreachable!()` macro during epoch initialization, causing total network failure.

## Finding Description

The vulnerability exists in the genesis configuration flow where `OnChainExecutionConfig` is loaded from YAML without validating that the specified features are supported by the validator software.

**Configuration Loading (No Validation):** [1](#0-0) 

The layout file's `on_chain_execution_config` field is directly passed to genesis without any compatibility checks: [2](#0-1) 

**Panic During Epoch Initialization:**

When validators start and initialize their epoch, they retrieve the execution config and create a transaction shuffler: [3](#0-2) 

The `create_transaction_shuffler` function contains `unreachable!()` macros for deprecated types: [4](#0-3) 

**Exploitation Path:**
1. Attacker/misconfigured operator creates a `layout.yaml` with:
```yaml
on_chain_execution_config:
  V7:
    transaction_shuffler_type:
      sender_aware_v2: 32
    # ... other fields
```

2. Genesis transaction is created using this layout
3. Blockchain starts with this configuration stored on-chain
4. When validators initialize the epoch, they call `create_transaction_shuffler(SenderAwareV2(32))`
5. Code hits `unreachable!("SenderAware shuffler is no longer supported.")`
6. Validator panics and crashes
7. All validators experience the same panic, network is non-functional

This breaks the **Deterministic Execution** invariant (all validators must produce identical state) and causes **Total loss of liveness** (network availability).

## Impact Explanation

**Severity: Critical** (up to $1,000,000)

This vulnerability qualifies as **Total loss of liveness/network availability** per the Aptos bug bounty criteria. When triggered:

- **All validator nodes panic** when attempting to initialize the epoch
- **Network cannot process any transactions** as consensus cannot start
- **Requires a hardfork** to recover by replacing the genesis transaction with corrected configuration
- **Complete network unavailability** from genesis, affecting all participants

The enum definition shows these are valid serializable variants: [5](#0-4) 

## Likelihood Explanation

**Likelihood: Medium**

While this requires control over the genesis configuration, it is realistic because:

1. **Testnet/Devnet Deployment**: Any team deploying a testnet or devnet loads genesis config from YAML files
2. **Private Networks**: Organizations running private Aptos networks configure their own genesis
3. **Misconfiguration**: Operators copying old configurations or documentation might inadvertently use deprecated values
4. **No Warning**: The YAML deserialization succeeds without warnings about deprecated types
5. **Delayed Detection**: The issue only manifests when validators start, not during genesis creation

The default configuration is safe: [6](#0-5) 

However, custom configurations are common in testing and private network deployments.

## Recommendation

**Immediate Fix**: Add validation during genesis configuration loading to reject unsupported execution config options:

```rust
// In crates/aptos/src/genesis/mod.rs, after line 272
pub fn fetch_genesis_info(git_options: GitOptions) -> CliTypedResult<GenesisInfo> {
    let client = git_options.get_client()?;
    let layout: Layout = client.get(Path::new(LAYOUT_FILE))?;
    
    // ADD VALIDATION HERE
    validate_execution_config(&layout.on_chain_execution_config)?;
    
    // ... rest of function
}

fn validate_execution_config(config: &OnChainExecutionConfig) -> CliTypedResult<()> {
    match config.transaction_shuffler_type() {
        TransactionShufflerType::SenderAwareV2(_) => {
            return Err(CliError::UnexpectedError(
                "TransactionShufflerType::SenderAwareV2 is not supported".to_string()
            ));
        },
        TransactionShufflerType::DeprecatedFairness => {
            return Err(CliError::UnexpectedError(
                "TransactionShufflerType::DeprecatedFairness is not supported".to_string()
            ));
        },
        _ => Ok(())
    }
}
```

**Long-term Fix**: Remove deprecated enum variants entirely or convert `unreachable!()` to proper error handling with fallback to safe defaults.

## Proof of Concept

**Step 1**: Create a malicious genesis layout file (`malicious_layout.yaml`):

```yaml
chain_id: 4
users:
  - test_user
allow_new_validators: false
epoch_duration_secs: 7200
is_test: true
min_stake: 100000000000000
min_voting_threshold: 100000000000000
max_stake: 100000000000000000
recurring_lockup_duration_secs: 86400
required_proposer_stake: 100000000000000
rewards_apy_percentage: 10
voting_duration_secs: 43200
voting_power_increase_limit: 20

# MALICIOUS CONFIG - Uses deprecated shuffler type
on_chain_execution_config:
  V7:
    transaction_shuffler_type:
      sender_aware_v2: 32
    block_gas_limit_type:
      no_limit: null
    enable_per_block_gas_limit: false
    transaction_deduper_type: txn_hash_and_authenticator_v1
    gas_price_to_burn: 90
    persisted_auxiliary_info_version: 1
```

**Step 2**: Rust test to demonstrate the panic:

```rust
#[test]
#[should_panic(expected = "SenderAware shuffler is no longer supported")]
fn test_genesis_with_unsupported_shuffler_panics() {
    use aptos_types::on_chain_config::{OnChainExecutionConfig, TransactionShufflerType, BlockGasLimitType, TransactionDeduperType};
    use consensus::transaction_shuffler::create_transaction_shuffler;
    
    // Simulate malicious genesis config
    let malicious_config = OnChainExecutionConfig::V7(ExecutionConfigV7 {
        transaction_shuffler_type: TransactionShufflerType::SenderAwareV2(32),
        block_gas_limit_type: BlockGasLimitType::NoLimit,
        enable_per_block_gas_limit: false,
        transaction_deduper_type: TransactionDeduperType::TxnHashAndAuthenticatorV1,
        gas_price_to_burn: 90,
        persisted_auxiliary_info_version: 1,
    });
    
    // This will panic when validators try to initialize
    let _shuffler = create_transaction_shuffler(malicious_config.transaction_shuffler_type());
    // Panic occurs: "SenderAware shuffler is no longer supported."
}
```

**Impact**: All validator nodes attempting to start with this genesis configuration will panic at epoch initialization, rendering the network completely non-functional and requiring a hardfork to recover.

## Notes

The vulnerability also potentially affects the `DeprecatedFairness` shuffler type through the same mechanism. Additionally, while the comments in the code indicate that `use_module_publishing_block_conflict` and `add_block_limit_outcome_onchain` fields are "Currently not supported," the code does actually use `add_block_limit_outcome_onchain`: [7](#0-6) 

This suggests the comments may be outdated, but the transaction shuffler panic is a definite, exploitable vulnerability.

### Citations

**File:** crates/aptos-genesis/src/config.rs (L76-77)
```rust
    #[serde(default = "OnChainExecutionConfig::default_for_genesis")]
    pub on_chain_execution_config: OnChainExecutionConfig,
```

**File:** crates/aptos/src/genesis/mod.rs (L302-303)
```rust
            consensus_config: layout.on_chain_consensus_config,
            execution_config: layout.on_chain_execution_config,
```

**File:** consensus/src/pipeline/execution_client.rs (L560-561)
```rust
        let transaction_shuffler =
            create_transaction_shuffler(onchain_execution_config.transaction_shuffler_type());
```

**File:** consensus/src/transaction_shuffler/mod.rs (L78-83)
```rust
        SenderAwareV2(_) => {
            unreachable!("SenderAware shuffler is no longer supported.")
        },
        DeprecatedFairness => {
            unreachable!("DeprecatedFairness shuffler is no longer supported.")
        },
```

**File:** types/src/on_chain_config/execution_config.rs (L228-240)
```rust
#[derive(Clone, Debug, Deserialize, Eq, PartialEq, Serialize)]
#[serde(rename_all = "snake_case")] // cannot use tag = "type" as nested enums cannot work, and bcs doesn't support it
pub enum TransactionShufflerType {
    NoShuffling,
    DeprecatedSenderAwareV1(u32),
    SenderAwareV2(u32),
    DeprecatedFairness,
    UseCaseAware {
        sender_spread_factor: usize,
        platform_use_case_spread_factor: usize,
        user_use_case_spread_factor: usize,
    },
}
```

**File:** types/src/on_chain_config/execution_config.rs (L243-249)
```rust
    pub fn default_for_genesis() -> Self {
        TransactionShufflerType::UseCaseAware {
            sender_spread_factor: 32,
            platform_use_case_spread_factor: 0,
            user_use_case_spread_factor: 4,
        }
    }
```

**File:** aptos-move/block-executor/src/limit_processor.rs (L44-46)
```rust
        let hot_state_op_accumulator = block_gas_limit_type
            .add_block_limit_outcome_onchain()
            .then(BlockHotStateOpAccumulator::new);
```
