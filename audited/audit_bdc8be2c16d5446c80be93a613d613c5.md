# Audit Report

## Title
Genesis Test Mode Hardcoded: Silent Override Enables Unlimited Token Minting and Protocol Version Manipulation in Non-Production Networks

## Summary
The `generate_genesis_txn()` function in `GenesisInfo` hardcodes `is_test: true` on line 145, silently overriding user configuration. This forces all non-mainnet genesis transactions (testnets, devnets) to enable test-mode capabilities even when operators explicitly set `is_test: false`, creating a `@core_resources` account with unlimited APT minting capability and protocol version manipulation rights. [1](#0-0) 

## Finding Description

The vulnerability exists in the genesis transaction generation flow for non-mainnet networks:

1. **User Configuration Ignored**: When operators create a genesis transaction via the CLI tool `aptos genesis generate-genesis`, they can specify `is_test: false` in the layout file to create a production-like testnet/devnet without test-mode capabilities. [2](#0-1) 

2. **Value Stored But Ignored**: The `GenesisInfo::new()` constructor correctly stores the user's `is_test` value in `self.is_test`. [3](#0-2) 

3. **Silent Override**: However, when `generate_genesis_txn()` constructs the genesis configuration, it **hardcodes** `is_test: true` on line 145, completely ignoring `self.is_test`. [4](#0-3) 

4. **Test Capabilities Enabled**: When `is_test: true`, the underlying VM genesis process creates dangerous test-mode capabilities:

   a) **Unlimited Minting**: Creates `@core_resources` account with `MintCapStore` containing unlimited APT minting capability. [5](#0-4) 

   b) **Maximum APT Pre-minted**: Mints the maximum u64 value (18,446,744,073,709,551,615 APT) to the `@core_resources` account. [6](#0-5) 

   c) **Ongoing Minting Capability**: The `@core_resources` account can call `aptos_coin::mint()` to create arbitrary amounts of APT at any time. [7](#0-6) 

   d) **Protocol Version Manipulation**: The `@core_resources` account receives `SetVersionCapability`, allowing it to manipulate the blockchain protocol version. [8](#0-7) [9](#0-8) 

**Contrast with Mainnet**: The mainnet genesis path explicitly asserts `is_test` must be false and uses a completely different genesis function that does NOT create the `@core_resources` account. [10](#0-9) [11](#0-10) 

**Invariants Broken**:
- **Access Control** (Invariant #8): The `@core_resources` system address gains unauthorized minting and version manipulation capabilities
- **Resource Limits** (Invariant #9): Unlimited token creation bypasses supply constraints
- **Staking Security** (Invariant #6): Unlimited minting can manipulate staking economics and validator rewards

## Impact Explanation

**Critical Severity** - This vulnerability enables **Loss of Funds (minting)** and violates the Aptos bug bounty's Critical Severity criteria:

1. **Unlimited Token Minting**: Any entity with access to the `@core_resources` private key can mint unlimited APT tokens, completely undermining the token's economic model and potentially devaluing all existing tokens on the testnet/devnet.

2. **Protocol Version Manipulation**: The ability to arbitrarily change the protocol version could enable downgrade attacks, disable security features, or cause consensus failures across the network.

3. **Silent Security Downgrade**: Operators who explicitly configure `is_test: false` expecting production-grade security receive a network with test-mode backdoors, creating a false sense of security.

4. **Economic Impact on Testnets**: While testnets are not mainnet, many organizations run economically valuable testnets for testing applications before production deployment. Compromised testnets can lead to:
   - Loss of test tokens with real-world testing value
   - Manipulation of validator rewards during testnet incentive programs
   - Incorrect testing results that don't reflect production behavior

## Likelihood Explanation

**High Likelihood** - This vulnerability will affect:

1. **Every Non-Mainnet Genesis**: Any testnet or devnet created using the `aptos genesis generate-genesis` CLI tool WITHOUT the `--mainnet` flag will have this vulnerability, regardless of the operator's `is_test` configuration.

2. **Builder-Based Local Testnets**: All local testnets created via the `Builder` API will have test mode enabled (though the builder defaults to `is_test: true` anyway). [12](#0-11) 

3. **Attack Requirements**: 
   - **Low Barrier**: Only requires access to the `@core_resources` private key, which is derived from the `core_resources_auth_key` specified in the genesis configuration
   - **No Validation**: The genesis process stores this key without any validation or protection
   - **Persistent**: Once genesis is generated, the vulnerability persists for the entire lifetime of the network

## Recommendation

**Immediate Fix**: Change line 145 in `crates/aptos-genesis/src/lib.rs` to use the configured value:

```rust
// Line 145 - BEFORE (vulnerable):
is_test: true,

// Line 145 - AFTER (fixed):
is_test: self.is_test,
``` [4](#0-3) 

**Additional Recommendations**:

1. **Add Validation**: Add an assertion or warning when `is_test` configuration is overridden:
```rust
if !self.is_test {
    warn!("Genesis configured with is_test=false, but test mode is recommended for non-mainnet networks");
}
```

2. **Documentation**: Clearly document the security implications of `is_test: true` vs `is_test: false` in the genesis configuration guide.

3. **Audit Trail**: Add logging when genesis is generated showing the actual `is_test` value used.

## Proof of Concept

**Demonstration Steps**:

1. Create a layout file with `is_test: false`:
```yaml
    ---
chain_id: 42
is_test: false  # Operator expects production-like security
allow_new_validators: true
# ... other config
```

2. Generate genesis using the CLI:
```bash
aptos genesis generate-genesis --local-repository-dir ./genesis
```

3. Inspect the generated genesis transaction - it will contain:
   - A `@core_resources` account with `MintCapStore`
   - Maximum u64 APT balance
   - `SetVersionCapability` for version manipulation

4. After network launch, anyone with the `@core_resources` private key can:
```move
// Mint arbitrary APT
aptos_coin::mint(core_resources_signer, target_address, 1000000000000);

// Manipulate protocol version  
version::set_version(core_resources_signer, malicious_version);
```

**Expected Behavior**: When `is_test: false` is configured, the genesis should NOT create the `@core_resources` account or any test-mode capabilities.

**Actual Behavior**: The genesis ALWAYS creates test-mode capabilities due to the hardcoded `is_test: true` on line 145.

## Notes

This vulnerability does NOT affect mainnet because mainnet uses a completely separate code path (`MainnetGenesisInfo` and `encode_aptos_mainnet_genesis_transaction`) that explicitly validates `is_test` must be false and does not create the `@core_resources` account. However, all testnets and devnets are affected, and the silent override of user configuration represents a dangerous pattern that could lead to security misconfigurations.

### Citations

**File:** crates/aptos-genesis/src/lib.rs (L86-125)
```rust
    pub fn new(
        chain_id: ChainId,
        root_key: Ed25519PublicKey,
        configs: Vec<ValidatorConfiguration>,
        framework: ReleaseBundle,
        genesis_config: &GenesisConfiguration,
    ) -> anyhow::Result<GenesisInfo> {
        let mut validators = Vec::new();

        for config in configs {
            validators.push(config.try_into()?)
        }

        Ok(GenesisInfo {
            chain_id,
            root_key,
            validators,
            framework,
            genesis: None,
            allow_new_validators: genesis_config.allow_new_validators,
            epoch_duration_secs: genesis_config.epoch_duration_secs,
            is_test: genesis_config.is_test,
            min_stake: genesis_config.min_stake,
            min_voting_threshold: genesis_config.min_voting_threshold,
            max_stake: genesis_config.max_stake,
            recurring_lockup_duration_secs: genesis_config.recurring_lockup_duration_secs,
            required_proposer_stake: genesis_config.required_proposer_stake,
            rewards_apy_percentage: genesis_config.rewards_apy_percentage,
            voting_duration_secs: genesis_config.voting_duration_secs,
            voting_power_increase_limit: genesis_config.voting_power_increase_limit,
            consensus_config: genesis_config.consensus_config.clone(),
            execution_config: genesis_config.execution_config.clone(),
            gas_schedule: genesis_config.gas_schedule.clone(),
            initial_features_override: genesis_config.initial_features_override.clone(),
            randomness_config_override: genesis_config.randomness_config_override.clone(),
            jwk_consensus_config_override: genesis_config.jwk_consensus_config_override.clone(),
            initial_jwks: genesis_config.initial_jwks.clone(),
            keyless_groth16_vk: genesis_config.keyless_groth16_vk.clone(),
        })
    }
```

**File:** crates/aptos-genesis/src/lib.rs (L136-166)
```rust
    fn generate_genesis_txn(&self) -> Transaction {
        aptos_vm_genesis::encode_genesis_transaction(
            self.root_key.clone(),
            &self.validators,
            &self.framework,
            self.chain_id,
            &aptos_vm_genesis::GenesisConfiguration {
                allow_new_validators: self.allow_new_validators,
                epoch_duration_secs: self.epoch_duration_secs,
                is_test: true,
                min_stake: self.min_stake,
                min_voting_threshold: self.min_voting_threshold,
                max_stake: self.max_stake,
                recurring_lockup_duration_secs: self.recurring_lockup_duration_secs,
                required_proposer_stake: self.required_proposer_stake,
                rewards_apy_percentage: self.rewards_apy_percentage,
                voting_duration_secs: self.voting_duration_secs,
                voting_power_increase_limit: self.voting_power_increase_limit,
                employee_vesting_start: 1663456089,
                employee_vesting_period_duration: 5 * 60, // 5 minutes
                initial_features_override: self.initial_features_override.clone(),
                randomness_config_override: self.randomness_config_override.clone(),
                jwk_consensus_config_override: self.jwk_consensus_config_override.clone(),
                initial_jwks: self.initial_jwks.clone(),
                keyless_groth16_vk: self.keyless_groth16_vk.clone(),
            },
            &self.consensus_config,
            &self.execution_config,
            &self.gas_schedule,
        )
    }
```

**File:** crates/aptos/src/genesis/mod.rs (L270-311)
```rust
pub fn fetch_genesis_info(git_options: GitOptions) -> CliTypedResult<GenesisInfo> {
    let client = git_options.get_client()?;
    let layout: Layout = client.get(Path::new(LAYOUT_FILE))?;

    if layout.root_key.is_none() {
        return Err(CliError::UnexpectedError(
            "Layout field root_key was not set.  Please provide a hex encoded Ed25519PublicKey."
                .to_string(),
        ));
    }

    let validators = get_validator_configs(&client, &layout, false).map_err(parse_error)?;
    let framework = client.get_framework()?;
    Ok(GenesisInfo::new(
        layout.chain_id,
        layout.root_key.unwrap(),
        validators,
        framework,
        &GenesisConfiguration {
            allow_new_validators: layout.allow_new_validators,
            epoch_duration_secs: layout.epoch_duration_secs,
            is_test: layout.is_test,
            min_stake: layout.min_stake,
            min_voting_threshold: layout.min_voting_threshold,
            max_stake: layout.max_stake,
            recurring_lockup_duration_secs: layout.recurring_lockup_duration_secs,
            required_proposer_stake: layout.required_proposer_stake,
            rewards_apy_percentage: layout.rewards_apy_percentage,
            voting_duration_secs: layout.voting_duration_secs,
            voting_power_increase_limit: layout.voting_power_increase_limit,
            employee_vesting_start: layout.employee_vesting_start,
            employee_vesting_period_duration: layout.employee_vesting_period_duration,
            consensus_config: layout.on_chain_consensus_config,
            execution_config: layout.on_chain_execution_config,
            gas_schedule: default_gas_schedule(),
            initial_features_override: None,
            randomness_config_override: None,
            jwk_consensus_config_override: layout.jwk_consensus_config_override.clone(),
            initial_jwks: layout.initial_jwks.clone(),
            keyless_groth16_vk: layout.keyless_groth16_vk_override.clone(),
        },
    )?)
```

**File:** aptos-move/vm-genesis/src/lib.rs (L135-143)
```rust
pub fn encode_aptos_mainnet_genesis_transaction(
    accounts: &[AccountBalance],
    employees: &[EmployeePool],
    validators: &[ValidatorWithCommissionRate],
    framework: &ReleaseBundle,
    chain_id: ChainId,
    genesis_config: &GenesisConfiguration,
) -> Transaction {
    assert!(!genesis_config.is_test, "This is mainnet!");
```

**File:** aptos-move/vm-genesis/src/lib.rs (L312-321)
```rust
    if genesis_config.is_test {
        initialize_core_resources_and_aptos_coin(
            &mut session,
            &module_storage,
            &mut traversal_context,
            core_resources_key,
        );
    } else {
        initialize_aptos_coin(&mut session, &module_storage, &mut traversal_context);
    }
```

**File:** aptos-move/vm-genesis/src/lib.rs (L351-352)
```rust
    if genesis_config.is_test {
        allow_core_resources_to_set_version(&mut session, &module_storage, &mut traversal_context);
```

**File:** aptos-move/framework/aptos-framework/sources/aptos_coin.move (L73-89)
```text
    public(friend) fun configure_accounts_for_test(
        aptos_framework: &signer,
        core_resources: &signer,
        mint_cap: MintCapability<AptosCoin>,
    ) {
        system_addresses::assert_aptos_framework(aptos_framework);

        // Mint the core resource account AptosCoin for gas so it can execute system transactions.
        let coins = coin::mint<AptosCoin>(
            18446744073709551615,
            &mint_cap,
        );
        coin::deposit<AptosCoin>(signer::address_of(core_resources), coins);

        move_to(core_resources, MintCapStore { mint_cap });
        move_to(core_resources, Delegations { inner: vector::empty() });
    }
```

**File:** aptos-move/framework/aptos-framework/sources/aptos_coin.move (L93-108)
```text
    public entry fun mint(
        account: &signer,
        dst_addr: address,
        amount: u64,
    ) acquires MintCapStore {
        let account_addr = signer::address_of(account);

        assert!(
            exists<MintCapStore>(account_addr),
            error::not_found(ENO_CAPABILITIES),
        );

        let mint_cap = &borrow_global<MintCapStore>(account_addr).mint_cap;
        let coins_minted = coin::mint<AptosCoin>(amount, mint_cap);
        coin::deposit<AptosCoin>(dst_addr, coins_minted);
    }
```

**File:** aptos-move/framework/aptos-framework/sources/configs/version.move (L81-84)
```text
    fun initialize_for_test(core_resources: &signer) {
        system_addresses::assert_core_resource(core_resources);
        move_to(core_resources, SetVersionCapability {});
    }
```

**File:** crates/aptos-genesis/src/mainnet.rs (L122-131)
```rust
    fn generate_genesis_txn(&self) -> Transaction {
        aptos_vm_genesis::encode_aptos_mainnet_genesis_transaction(
            &self.accounts,
            &self.employee_vesting_accounts,
            &self.validators,
            &self.framework,
            self.chain_id,
            &aptos_vm_genesis::GenesisConfiguration {
                allow_new_validators: true,
                is_test: false,
```

**File:** crates/aptos-genesis/src/builder.rs (L649-683)
```rust
        let mut genesis_config = GenesisConfiguration {
            allow_new_validators: false,
            epoch_duration_secs: ONE_DAY,
            is_test: true,
            min_stake: 0,
            min_voting_threshold: 0,
            max_stake: u64::MAX,
            recurring_lockup_duration_secs: ONE_DAY,
            required_proposer_stake: 0,
            rewards_apy_percentage: 10,
            voting_duration_secs: ONE_DAY / 24,
            voting_power_increase_limit: 50,
            employee_vesting_start: None,
            employee_vesting_period_duration: None,
            consensus_config: OnChainConsensusConfig::default_for_genesis(),
            execution_config: OnChainExecutionConfig::default_for_genesis(),
            gas_schedule: default_gas_schedule(),
            initial_features_override: None,
            randomness_config_override: None,
            jwk_consensus_config_override: None,
            initial_jwks: vec![],
            keyless_groth16_vk: None,
        };
        if let Some(init_genesis_config) = &self.init_genesis_config {
            (init_genesis_config)(&mut genesis_config);
        }

        // Build genesis & waypoint
        let mut genesis_info = GenesisInfo::new(
            ChainId::test(),
            root_key,
            configs,
            self.framework.clone(),
            &genesis_config,
        )?;
```
