# Audit Report

## Title
Peer Score Disclosure via Inspection Service Allows Malicious Peers to Evade Detection

## Summary
The Aptos inspection service exposes peer reputation scores through the `/peer_information` HTTP endpoint without authentication. Malicious peers can query this endpoint to monitor their own scores and calibrate their attacks to stay just above the `IGNORE_PEER_THRESHOLD` (25.0), effectively evading the peer reputation system designed to filter out bad actors.

## Finding Description

The state-sync data client implements a peer reputation system to protect nodes from malicious peers. Peers start with a score of 50.0 and are penalized for bad behavior (invalid data, proof verification failures) while rewarded for successful responses. When a peer's score drops to or below 25.0, they are ignored by the node. [1](#0-0) 

However, the inspection service exposes these scores publicly through the `/peer_information` endpoint when `expose_peer_information` is enabled (which is **true by default**): [2](#0-1) 

The endpoint explicitly displays peer scores without any authentication: [3](#0-2) 

The inspection service binds to all network interfaces (0.0.0.0) by default and has no authentication mechanism. Access control is purely configuration-based through boolean flags: [4](#0-3) 

**Attack Flow:**
1. A malicious peer connects to an Aptos node's state-sync network
2. The peer queries `http://<node-ip>:9101/peer_information` via HTTP GET
3. The response contains all peer scores, including the malicious peer's own score
4. When the score approaches 25.0, the malicious peer temporarily sends valid responses (+1.0 per success) to raise their score
5. Once safely above threshold (e.g., 30.0), the peer resumes malicious behavior (invalid proofs, incorrect data)
6. The peer repeats this cycle indefinitely, evading detection while continuing attacks

The peer ignore mechanism is active by default: [5](#0-4) 

And the threshold check explicitly ignores peers below 25.0: [6](#0-5) 

## Impact Explanation

This vulnerability qualifies as **Medium Severity** under the Aptos bug bounty criteria because it represents a "significant protocol violation" that undermines the peer reputation system. While it doesn't directly cause consensus violations or fund loss, it allows malicious peers to:

- Evade automatic detection and filtering mechanisms
- Continue sending malicious data (invalid proofs, incorrect state information)
- Undermine the security guarantees of the state-sync system
- Potentially participate in coordinated attacks while avoiding consequences

The impact is limited to state-sync security rather than core consensus, preventing this from being High or Critical severity.

## Likelihood Explanation

This vulnerability has **HIGH likelihood** of exploitation because:

1. **Default Configuration**: `expose_peer_information` is `true` by default
2. **No Authentication**: The inspection service has no authentication mechanism
3. **Public Binding**: The service binds to `0.0.0.0:9101` (all interfaces) by default
4. **Testnet/Devnet Exposure**: The config optimizer automatically enables this endpoint on non-mainnet networks: [7](#0-6) 

5. **Known Threshold**: The `IGNORE_PEER_THRESHOLD` value (25.0) is hardcoded and visible in the codebase
6. **Simple Exploitation**: Requires only HTTP GET requests, no special tools or access

## Recommendation

**Immediate Fix:**
1. **Remove score disclosure** from the `/peer_information` endpoint entirely, or move it to a separate authenticated admin endpoint
2. **Change default configuration** to set `expose_peer_information: false` by default
3. **Add authentication** to the inspection service using the same pattern as the admin service

**Code Fix:**

In `peer_information.rs`, remove score disclosure:

```rust
// Remove or comment out the score display
// let peer_score = peer_state_entry.get_score();
peer_information_output.push(format!(
    "\t- Peer: {}, bucket ID: {}",
    peer, peer_bucket_id
));
```

In `inspection_service_config.rs`, change the default:

```rust
fn default() -> InspectionServiceConfig {
    InspectionServiceConfig {
        address: "127.0.0.1".to_string(), // Bind to localhost only
        port: 9101,
        expose_configuration: false,
        expose_identity_information: false,
        expose_peer_information: false, // Change to false
        expose_system_information: false,
    }
}
```

**Long-term Recommendations:**
- Implement authentication for the inspection service
- Add randomization/jitter to the threshold to make it harder to calibrate
- Consider making the threshold configurable and node-specific
- Add rate limiting to prevent score probing

## Proof of Concept

**Step 1: Start an Aptos node with default configuration** (inspection service enabled on port 9101)

**Step 2: Query the peer information endpoint:**
```bash
curl http://localhost:9101/peer_information
```

**Step 3: Observe output containing peer scores:**
```
State sync metadata for each peer:
    - Peer: 00000000000000000000000000000000/vfn, score: 50.0, bucket ID: 0
    - Advertised storage summary: ...
```

**Step 4: Malicious peer exploitation script (pseudocode):**
```python
import requests
import time

NODE_URL = "http://<target-node-ip>:9101/peer_information"
MY_PEER_ID = "malicious_peer_id"
THRESHOLD = 25.0
SAFE_ZONE = 30.0

while True:
    # Query peer information
    response = requests.get(NODE_URL)
    my_score = extract_my_score(response.text, MY_PEER_ID)
    
    if my_score < SAFE_ZONE:
        # Send valid responses to increase score
        send_valid_responses_until_score_above(SAFE_ZONE)
    else:
        # Resume malicious behavior
        send_invalid_proofs()
        send_corrupted_data()
    
    time.sleep(60)  # Check every minute
```

This demonstrates how a malicious peer can use the exposed score information to calibrate attacks and evade detection indefinitely.

## Notes

- The vulnerability is present in the default configuration and is automatically enabled for all non-mainnet networks
- There is no sanitizer preventing this exposure on mainnet validators (unlike the `expose_configuration` flag)
- The inspection service was likely intended for debugging/monitoring, but the security implications of score exposure were not considered
- This is distinct from the log messages that only indicate threshold crossings without revealing exact scores

### Citations

**File:** state-sync/aptos-data-client/src/peer_states.rs (L32-43)
```rust
/// Scores for peer rankings based on preferences and behavior.
const MAX_SCORE: f64 = 100.0;
const MIN_SCORE: f64 = 0.0;
const STARTING_SCORE: f64 = 50.0;
/// Add this score on a successful response.
const SUCCESSFUL_RESPONSE_DELTA: f64 = 1.0;
/// Not necessarily a malicious response, but not super useful.
const NOT_USEFUL_MULTIPLIER: f64 = 0.95;
/// Likely to be a malicious response.
const MALICIOUS_MULTIPLIER: f64 = 0.8;
/// Ignore a peer when their score dips below this threshold.
const IGNORE_PEER_THRESHOLD: f64 = 25.0;
```

**File:** state-sync/aptos-data-client/src/peer_states.rs (L152-160)
```rust
    fn is_ignored(&self) -> bool {
        // Only ignore peers if the config allows it
        if !self.data_client_config.ignore_low_score_peers {
            return false;
        }

        // Otherwise, ignore peers with a low score
        self.score <= IGNORE_PEER_THRESHOLD
    }
```

**File:** config/src/config/inspection_service_config.rs (L26-36)
```rust
impl Default for InspectionServiceConfig {
    fn default() -> InspectionServiceConfig {
        InspectionServiceConfig {
            address: "0.0.0.0".to_string(),
            port: 9101,
            expose_configuration: false,
            expose_identity_information: true,
            expose_peer_information: true,
            expose_system_information: true,
        }
    }
```

**File:** config/src/config/inspection_service_config.rs (L81-104)
```rust
        // Enable all endpoints for non-mainnet nodes (to aid debugging)
        let mut modified_config = false;
        if let Some(chain_id) = chain_id {
            if !chain_id.is_mainnet() {
                if local_inspection_config_yaml["expose_configuration"].is_null() {
                    inspection_service_config.expose_configuration = true;
                    modified_config = true;
                }

                if local_inspection_config_yaml["expose_identity_information"].is_null() {
                    inspection_service_config.expose_identity_information = true;
                    modified_config = true;
                }

                if local_inspection_config_yaml["expose_peer_information"].is_null() {
                    inspection_service_config.expose_peer_information = true;
                    modified_config = true;
                }

                if local_inspection_config_yaml["expose_system_information"].is_null() {
                    inspection_service_config.expose_system_information = true;
                    modified_config = true;
                }
            }
```

**File:** crates/aptos-inspection-service/src/server/peer_information.rs (L21-37)
```rust
pub fn handle_peer_information_request(
    node_config: &NodeConfig,
    aptos_data_client: AptosDataClient,
    peers_and_metadata: Arc<PeersAndMetadata>,
) -> (StatusCode, Body, String) {
    // Only return peer information if the endpoint is enabled
    let (status_code, body) = if node_config.inspection_service.expose_peer_information {
        let peer_information = get_peer_information(aptos_data_client, peers_and_metadata);
        (StatusCode::OK, Body::from(peer_information))
    } else {
        (
            StatusCode::FORBIDDEN,
            Body::from(PEER_INFO_DISABLED_MESSAGE),
        )
    };

    (status_code, body, CONTENT_TYPE_TEXT.into())
```

**File:** crates/aptos-inspection-service/src/server/peer_information.rs (L243-250)
```rust
            let peer_score = peer_state_entry.get_score();
            let peer_storage_summary = peer_state_entry.get_storage_summary();

            // Display the peer states
            peer_information_output.push(format!(
                "\t- Peer: {}, score: {}, bucket ID: {}",
                peer, peer_score, peer_bucket_id
            ));
```

**File:** config/src/config/state_sync_config.rs (L460-467)
```rust
impl Default for AptosDataClientConfig {
    fn default() -> Self {
        Self {
            enable_transaction_data_v2: true,
            data_poller_config: AptosDataPollerConfig::default(),
            data_multi_fetch_config: AptosDataMultiFetchConfig::default(),
            ignore_low_score_peers: true,
            latency_filtering_config: AptosLatencyFilteringConfig::default(),
```
