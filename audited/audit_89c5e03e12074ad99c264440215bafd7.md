# Audit Report

## Title
URL Join Vulnerability Enables Open Redirects in Aptos REST Client

## Summary
The Aptos REST client contains a URL join vulnerability that allows malicious base URLs or version path bases to redirect API requests to attacker-controlled servers. This occurs due to insufficient validation when paths starting with `//` are joined using RFC 3986 semantics, which treats them as network-path references.

## Finding Description

The vulnerability exists in two attack vectors within the REST client:

**Vector 1: Malicious base_url extraction** [1](#0-0) 

When `get_version_path_with_base()` extracts the path from a base URL, it doesn't validate whether the path starts with `//`. If a base URL like `http://api.mainnet.aptoslabs.com//attacker.com/v1/` is provided, the extracted path `//attacker.com/v1/` is stored as `version_path_base`.

**Vector 2: Direct version_path_base injection** [2](#0-1) 

The `version_path_base()` method only validates that the input ends with `/` but doesn't check if it starts with `//`. An attacker can call `.version_path_base("//attacker.com/")` on a client instance.

**Exploitation in build_path()** [3](#0-2) 

When `build_path()` joins URLs, it performs: `base_url.join(&version_path_base)?.join(path)`. According to RFC 3986, when joining with a path starting with `//`, Rust's URL parser interprets it as a network-path reference (protocol-relative URL), causing the domain to change.

**Example exploit flow:**
1. Attacker provides base_url: `http://api.mainnet.aptoslabs.com//evil.com/v1/`
2. `get_version_path_with_base()` returns: `//evil.com/v1/`
3. When `build_path("accounts/0x1")` is called:
   - `http://api.mainnet.aptoslabs.com//evil.com/v1/`.join(`//evil.com/v1/`) → `http://evil.com/v1/`
   - `http://evil.com/v1/`.join(`accounts/0x1`) → `http://evil.com/v1/accounts/0x1`
4. All API requests are redirected to `evil.com`

## Impact Explanation

This vulnerability is classified as **Medium Severity** because:

1. **Data Interception**: Attackers can capture sensitive transaction data, account information, and API keys sent to their servers
2. **Fake Blockchain State**: Malicious servers can return fabricated balances, transaction statuses, or smart contract states
3. **Infrastructure Compromise**: Services using this client (faucets, transaction emitters, indexers) could be compromised

The impact is limited compared to Critical/High severity because:
- It requires the attacker to control or influence the `base_url` configuration (via config files, CLI arguments, or environment variables)
- It's a client-side vulnerability, not a core blockchain protocol issue
- It doesn't directly affect consensus, state storage, or on-chain execution

However, it can still cause significant harm in scenarios where:
- Aptos infrastructure services use user-provided or configuration-file URLs
- Attackers gain access to configuration through other vulnerabilities
- Social engineering tricks operators into using malicious URLs

## Likelihood Explanation

**Likelihood: Medium**

Exploitation requires:
1. Attacker must influence the `base_url` through configuration files, environment variables, or CLI arguments
2. OR attacker must convince a developer to call `.version_path_base()` with a malicious value

Real-world exploitation scenarios:
- **Supply chain attacks**: Malicious dependencies or build scripts injecting environment variables
- **Configuration file tampering**: If config files are modifiable by untrusted users
- **Social engineering**: Tricking administrators to use "test" URLs that redirect traffic
- **CLI injection**: Applications that pass user input to the CLI `--url` flag

The likelihood is not "High" because most production deployments use hardcoded predefined networks (Mainnet, Devnet, Testnet) rather than custom URLs. However, development environments, testing infrastructure, and private deployments commonly use custom URLs.

## Recommendation

Add validation to prevent paths starting with `//` from being used in URL joins:

**Fix for `get_version_path_with_base()`:**
```rust
pub fn get_version_path_with_base(base_url: Url) -> Result<String, anyhow::Error> {
    let path = match base_url.path() {
        "/" => DEFAULT_VERSION_PATH_BASE.to_string(),
        path => {
            if !path.ends_with('/') {
                format!("{}/", path)
            } else {
                path.to_string()
            }
        },
    };
    
    // Validate the extracted path doesn't start with //
    if path.starts_with("//") {
        return Err(anyhow!("Invalid path in base_url: paths cannot start with '//' as they would be interpreted as network-path references"));
    }
    
    Ok(path)
}
```

**Fix for `Client::version_path_base()`:**
```rust
pub fn version_path_base(mut self, version_path_base: String) -> AptosResult<Self> {
    if !version_path_base.ends_with('/') {
        return Err(anyhow!("version_path_base must end with '/', e.g. 'v1/'").into());
    }
    if version_path_base.starts_with("//") {
        return Err(anyhow!("version_path_base cannot start with '//' as it would be interpreted as a network-path reference").into());
    }
    self.version_path_base = version_path_base;
    Ok(self)
}
```

**Additional hardening:**
- Add URL validation in `ClientBuilder::base_url()` to reject URLs with suspicious paths
- Log warnings when non-standard base URLs are used in production
- Consider allowlisting acceptable URL patterns for production deployments

## Proof of Concept

```rust
// Add to crates/aptos-rest-client/src/lib.rs for testing
#[cfg(test)]
mod url_join_vulnerability_tests {
    use super::*;
    use url::Url;

    #[test]
    fn test_url_redirect_via_malicious_base_url() {
        // Create a client with a malicious base URL containing //
        let malicious_url = Url::parse("http://legitimate.com//attacker.com/v1/").unwrap();
        let client = Client::new(malicious_url);
        
        // Try to build a path to accounts endpoint
        let built_url = client.build_path("accounts/0x1").unwrap();
        
        // The URL should NOT redirect to attacker.com, but currently it does
        println!("Built URL: {}", built_url);
        assert!(built_url.host_str() == Some("legitimate.com"), 
                "URL was redirected to: {}", built_url.host_str().unwrap_or("none"));
    }

    #[test]
    fn test_url_redirect_via_version_path_base() {
        // Create a normal client
        let base_url = Url::parse("http://api.mainnet.aptoslabs.com").unwrap();
        let client = Client::new(base_url);
        
        // Set a malicious version_path_base
        let client = client.version_path_base("//attacker.com/".to_string()).unwrap();
        
        // Try to build a path
        let built_url = client.build_path("accounts/0x1").unwrap();
        
        // The URL should NOT redirect to attacker.com, but currently it does
        println!("Built URL: {}", built_url);
        assert!(built_url.host_str() == Some("api.mainnet.aptoslabs.com"),
                "URL was redirected to: {}", built_url.host_str().unwrap_or("none"));
    }

    #[test]
    fn test_get_version_path_with_base_extracts_malicious_path() {
        let malicious_url = Url::parse("http://api.mainnet.aptoslabs.com//evil.com/api/").unwrap();
        let extracted = get_version_path_with_base(malicious_url);
        
        println!("Extracted path: {}", extracted);
        assert!(!extracted.starts_with("//"), 
                "Extracted path starts with //: {}", extracted);
    }
}
```

Run with: `cargo test -p aptos-rest-client url_join_vulnerability_tests`

**Expected behavior**: All tests should FAIL, demonstrating the vulnerability exists.
**After fix**: All tests should PASS, confirming the validation prevents URL redirects.

## Notes

This vulnerability is specific to the REST client library and does not directly affect blockchain consensus, execution, or storage. However, it can compromise infrastructure services, development tools, and monitoring systems that rely on this client. The severity is Medium because exploitation requires configuration access or social engineering, but the impact on data integrity and confidentiality can be significant in affected systems.

### Citations

**File:** crates/aptos-rest-client/src/lib.rs (L147-153)
```rust
    pub fn version_path_base(mut self, version_path_base: String) -> AptosResult<Self> {
        if !version_path_base.ends_with('/') {
            return Err(anyhow!("version_path_base must end with '/', e.g. 'v1/'").into());
        }
        self.version_path_base = version_path_base;
        Ok(self)
    }
```

**File:** crates/aptos-rest-client/src/lib.rs (L155-157)
```rust
    pub fn build_path(&self, path: &str) -> AptosResult<Url> {
        Ok(self.base_url.join(&self.version_path_base)?.join(path)?)
    }
```

**File:** crates/aptos-rest-client/src/lib.rs (L1927-1938)
```rust
pub fn get_version_path_with_base(base_url: Url) -> String {
    match base_url.path() {
        "/" => DEFAULT_VERSION_PATH_BASE.to_string(),
        path => {
            if !path.ends_with('/') {
                format!("{}/", path)
            } else {
                path.to_string()
            }
        },
    }
}
```
