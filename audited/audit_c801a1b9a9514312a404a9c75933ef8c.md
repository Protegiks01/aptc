# Audit Report

## Title
Insecure Default Listen Address in Aptos Faucet Service Enables Accidental Public Exposure

## Summary
The Aptos faucet service defaults to binding on all network interfaces (`0.0.0.0`) instead of localhost (`127.0.0.1`), creating a security risk when developers run the service in misconfigured environments. When combined with the lack of default authentication in `run-simple` mode, this violates secure-by-default design principles and exposes the service to network-based abuse.

## Finding Description

The faucet service's `default_listen_address()` function unconditionally returns `"0.0.0.0"`, binding to all network interfaces: [1](#0-0) 

The `RunSimple` command, intended for local development, also defaults to `"0.0.0.0"`: [2](#0-1) 

When using `run-simple` mode, the configuration builder sets empty arrays for security checkers and bypassers, meaning **no authentication or rate limiting** is enabled by default: [3](#0-2) 

This contrasts sharply with the security-conscious design found elsewhere in the Aptos codebase. The local testnet implementation conditionally binds to `127.0.0.1` for security when not running in containers: [4](#0-3) 

Other Aptos services that default to `0.0.0.0` enforce authentication requirements on mainnet through configuration sanitizers: [5](#0-4) 

**Attack Scenario:**

1. Developer runs `cargo run -p aptos-faucet-service -- run-simple --key <key> --node-url <url> --chain-id TESTING` on their laptop connected to public WiFi at a conference
2. The faucet binds to `0.0.0.0:8081` with no authentication
3. Attacker on the same network discovers the open port via scanning
4. Attacker floods the faucet with funding requests, draining test tokens and causing resource exhaustion
5. If the faucet uses `MintFunder` with minting capabilities, the attacker can deplete the faucet's ability to serve legitimate users

## Impact Explanation

This issue represents a **High severity** vulnerability based on the following:

1. **Significant Protocol Violation**: Violates the secure-by-default principle that should be foundational to all Aptos services
2. **Service Abuse**: Enables unauthorized access and resource exhaustion of faucet services
3. **Developer Security**: Creates a footgun for developers who may inadvertently expose internal services

While the faucet dispenses test tokens without real-world value, the security impact includes:
- **Service disruption** on test networks affecting development workflows
- **Resource exhaustion** through unlimited minting/transfer requests
- **Precedent for insecure defaults** in the codebase that could be replicated elsewhere

The issue maps to the bug bounty's **High Severity** category: "API crashes" and "Significant protocol violations" - the exposed faucet API can be abused leading to service degradation, and the insecure default violates secure design protocols.

## Likelihood Explanation

**Likelihood: Medium to High**

This vulnerability is highly likely to be exploited in practice because:

1. **Common Developer Pattern**: Developers frequently test locally and may run the faucet on networks without proper firewall configuration
2. **No Warning**: The system provides no warning when binding to `0.0.0.0` without authentication
3. **Default Behavior**: The insecure configuration is the *default*, not an opt-in
4. **Low Attacker Barrier**: Network scanning tools readily identify open ports; no sophisticated exploit required

The documentation encourages use of `run-simple` for local testing [6](#0-5) , making this scenario realistic.

## Recommendation

Implement the same security-conscious binding logic used in the local testnet code:

**Option 1: Context-Aware Default (Recommended)**
```rust
fn default_listen_address() -> String {
    // Check if running in container environment
    let running_inside_container = std::path::Path::new("/.dockerenv").exists();
    if running_inside_container {
        "0.0.0.0".to_string()
    } else {
        "127.0.0.1".to_string() // Secure default for local development
    }
}
```

**Option 2: Explicit Localhost Default**
```rust
fn default_listen_address() -> String {
    "127.0.0.1".to_string()
}
```

Additionally, add a warning when binding to `0.0.0.0` without authentication: [7](#0-6) 

After this section, add:
```rust
// Warn if binding to all interfaces without authentication
if self.server_config.listen_address == "0.0.0.0" 
    && self.checker_configs.is_empty() {
    warn!("⚠️  WARNING: Faucet is binding to all network interfaces (0.0.0.0) without authentication. \
           This exposes the service to potential abuse. Consider using --listen-address 127.0.0.1 \
           for local development or enable checkers for production deployments.");
}
```

## Proof of Concept

**Reproduction Steps:**

1. On a machine with no firewall, run:
```bash
cargo run -p aptos -- node run-local-testnet --force-restart --assume-yes
cargo run -p aptos-faucet-service -- run-simple \
  --key ~/.aptos/testnet/mint.key \
  --node-url http://127.0.0.1:8080 \
  --chain-id TESTING
```

2. From another machine on the same network (or using the machine's external IP), execute:
```bash
# Replace <VICTIM_IP> with the external IP of the machine running the faucet
for i in {1..1000}; do
  curl -H 'Content-Type: application/json' \
    -X POST \
    -d '{"amount": 100000000000, "address": "0x'$(openssl rand -hex 32)'"}' \
    http://<VICTIM_IP>:8081/fund &
done
```

3. Observe that all requests succeed, draining faucet resources and demonstrating the lack of access control.

**Expected Result**: The faucet accepts all requests from the external network without authentication.

**Secure Behavior**: With `127.0.0.1` as default, the external requests would fail with connection refused, limiting exposure to the local machine only.

## Notes

While the faucet is designed for test networks and dispenses tokens without real-world value, the insecure default pattern represents a broader security concern. The Aptos codebase demonstrates security-conscious design in its local testnet implementation [8](#0-7) , and this same principle should be consistently applied to all developer-facing services to prevent accidental public exposure. The lack of alignment between different parts of the codebase creates inconsistent security posture and increases the risk of configuration errors.

### Citations

**File:** crates/aptos-faucet/core/src/server/server_args.rs (L22-24)
```rust
    fn default_listen_address() -> String {
        "0.0.0.0".to_string()
    }
```

**File:** crates/aptos-faucet/core/src/server/run.rs (L195-199)
```rust
        let listener = TcpListener::bind((
            self.server_config.listen_address.clone(),
            self.server_config.listen_port,
        ))
        .await?;
```

**File:** crates/aptos-faucet/core/src/server/run.rs (L276-277)
```rust
            bypasser_configs: vec![],
            checker_configs: vec![],
```

**File:** crates/aptos-faucet/core/src/server/run.rs (L358-360)
```rust
    /// What address to listen on.
    #[clap(long, default_value = "0.0.0.0")]
    pub listen_address: String,
```

**File:** crates/aptos/src/node/local_testnet/mod.rs (L269-284)
```rust
        // If the CLI is running inside a container, bind services not running inside a
        // container to 0.0.0.0 (so they can be accessed from outside the container).
        // Otherwise bind them to 127.0.0.1. This is necessary because Windows
        // complains about services binding to 0.0.0.0 sometimes.
        let running_inside_container = Path::new(".dockerenv").exists();
        let bind_to = match self.bind_to {
            Some(bind_to) => bind_to,
            None => {
                if running_inside_container {
                    Ipv4Addr::new(0, 0, 0, 0)
                } else {
                    Ipv4Addr::new(127, 0, 0, 1)
                }
            },
        };
        info!("Binding host services to {}", bind_to);
```

**File:** config/src/config/admin_service_config.rs (L67-76)
```rust
        if node_config.admin_service.enabled == Some(true) {
            if let Some(chain_id) = chain_id {
                if chain_id.is_mainnet()
                    && node_config.admin_service.authentication_configs.is_empty()
                {
                    return Err(Error::ConfigSanitizerFailed(
                        sanitizer_name,
                        "Must enable authentication for AdminService on mainnet.".into(),
                    ));
                }
```

**File:** crates/aptos-faucet/README.md (L32-35)
```markdown
To run the faucet, the simplest way to start is with this command:
```
cargo run -p aptos-faucet-service -- run-simple --key <private_key> --node-url <api_url> --chain-id TESTING
```
```
