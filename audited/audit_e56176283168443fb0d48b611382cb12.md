# Audit Report

## Title
Azure SAS Token Exposure in Process Command Lines via Bash Variable Expansion

## Summary
The CommandAdapterConfig for Azure Blob Storage backup operations exposes sensitive SAS (Shared Access Signature) tokens in process command lines through bash environment variable expansion. When backup commands are executed, the SAS token embedded in URLs becomes visible in process listings accessible to all system users, enabling credential theft.

## Finding Description

The CommandAdapterConfig implementation uses shell commands to interact with cloud storage providers. For Azure Blob Storage, the configuration stores SAS tokens as environment variables and references them in command strings that construct azcopy URLs. [1](#0-0) 

The SAS token is then used directly in the command URL: [2](#0-1) 

When commands are executed, the process flow is:

1. Command strings with variable references (e.g., `$SAS`) are created [3](#0-2) 

2. These commands are executed via `bash -c` with environment variables set [4](#0-3) 

3. Bash expands environment variables (`$SAS`, `$ACCOUNT`, etc.) before spawning child processes
4. The `azcopy` process receives the **expanded URL** containing the plaintext SAS token as a command-line argument
5. This expanded command line is visible in process listings (`ps aux`, `/proc/<pid>/cmdline`) to **all users** on the system

**Attack Scenario:**
```bash
# Attacker with any user account runs:
ps aux | grep azcopy

# Output reveals:
azcopy cp --from-to PipeBlob "https://aptos-backup.blob.core.windows.net/backup-1/e1/file?sv=2020-08-04&ss=b&srt=sco&sp=rwdlac&se=2024-12-31T23:59:59Z&st=2024-01-01T00:00:00Z&spr=https&sig=<SENSITIVE_SIGNATURE>"
```

This contrasts with the AWS S3 implementation, which uses environment variables (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY) that are passed to the `aws` CLI tool without appearing in command arguments: [5](#0-4) 

The production deployment configuration confirms this vulnerability exists in live systems: [6](#0-5) 

## Impact Explanation

**Severity: HIGH** (per Aptos Bug Bounty Program)

This vulnerability enables **unauthorized access to blockchain backup data** through credential theft:

1. **Backup Data Sensitivity**: Backups contain the complete blockchain history, including all transactions, state data, and potentially sensitive system information
2. **SAS Token Capabilities**: Depending on permissions, stolen SAS tokens could allow attackers to:
   - Read all backup data (privacy violation, competitive intelligence)
   - Modify or delete backups (data integrity, availability impact)
   - Upload malicious data to backup storage (supply chain attack vector)

3. **Attack Surface**: Process listings are accessible to:
   - Any local user account (multi-tenant environments)
   - Compromised containers or services on the same node
   - Security monitoring tools that collect process information
   - System administrators (insider threat)

4. **Persistence**: SAS tokens typically have extended validity periods (hours to months), allowing prolonged unauthorized access after theft

While this doesn't directly violate consensus safety or cause immediate fund loss, it represents a **significant protocol violation** and **API security failure**, placing it firmly in the HIGH severity category.

## Likelihood Explanation

**Likelihood: MEDIUM-HIGH**

**Favorable Conditions for Exploitation:**
- Process listings are accessible to all users on Unix-like systems (no privilege escalation required)
- Backup operations run continuously/frequently, providing multiple opportunities for observation
- Commands execute for extended periods during large data transfers (seconds to minutes)
- Multi-tenant Kubernetes environments are common deployment scenarios
- Security monitoring and logging systems routinely capture process information

**Realistic Attack Vectors:**
1. **Compromised Co-Tenant**: In shared infrastructure, an attacker compromising one service can observe processes of other services
2. **Insider Threat**: System operators with legitimate access can easily capture credentials
3. **Container Escape**: An attacker escaping container isolation gains host-level process visibility
4. **Log Aggregation**: Centralized logging systems may inadvertently capture and expose command lines
5. **Security Scanning**: Automated security tools may collect and report process information

The only barrier is obtaining any level of system access, which is significantly easier than exploiting memory corruption or consensus bugs.

## Recommendation

**Immediate Fix:** Modify the Azure configuration to avoid passing SAS tokens in URL arguments. Use azcopy's environment variable support:

```yaml
env_vars:
  - key: "ACCOUNT"
    value: "aptos-backup"
  - key: "CONTAINER"
    value: "backup-1"
  - key: "SUB_DIR"
    value: "e1"
  - key: "AZCOPY_SAS_TOKEN"  # azcopy reads SAS from this env var
    value: "?sv=2020-08-04&ss=b&..."
    
commands:
  create_for_write: |
    FILE_HANDLE="$BACKUP_HANDLE/$FILE_NAME"
    echo "$FILE_HANDLE"
    exec 1>&-
    # Remove $SAS from URL - azcopy uses AZCOPY_SAS_TOKEN env var
    gzip -c | azcopy cp --from-to PipeBlob "https://$ACCOUNT.blob.core.windows.net/$CONTAINER/$SUB_DIR/$FILE_HANDLE" > /dev/null
```

**Alternative Approach:** Use Azure Managed Identity or Azure CLI authentication instead of SAS tokens:

```yaml
commands:
  create_for_write: |
    FILE_HANDLE="$BACKUP_HANDLE/$FILE_NAME"
    echo "$FILE_HANDLE"
    exec 1>&-
    # Use Azure CLI authentication (credentials from environment/MSI)
    az storage blob upload --account-name "$ACCOUNT" --container-name "$CONTAINER" \
      --name "$SUB_DIR/$FILE_HANDLE" --file - --auth-mode login
```

**Code-Level Enhancement:** Add validation in CommandAdapterConfig to detect and warn about potential credential exposure patterns:

```rust
// In config.rs, add validation method
impl CommandAdapterConfig {
    pub fn validate_security(&self) -> Result<Vec<String>> {
        let mut warnings = Vec::new();
        
        // Check for potential credential exposure in command strings
        let sensitive_patterns = ["SAS", "TOKEN", "KEY", "SECRET", "PASSWORD"];
        for pattern in &sensitive_patterns {
            if self.commands.create_for_write.contains(&format!("${}", pattern)) {
                warnings.push(format!(
                    "WARNING: Command contains ${} which may expose credentials in process listings. \
                    Consider using tool-specific environment variables instead.",
                    pattern
                ));
            }
        }
        
        Ok(warnings)
    }
}
```

## Proof of Concept

**Demonstration of Vulnerability:**

1. **Setup Azure backup configuration:**
```yaml
# azure-test.yaml
env_vars:
  - key: "ACCOUNT"
    value: "testaccount"
  - key: "CONTAINER"
    value: "testcontainer"
  - key: "SAS"
    value: "?sv=2020-08-04&ss=b&srt=sco&sp=rwdlac&se=2024-12-31&sig=SENSITIVE_SECRET_SIGNATURE_HERE"
    
commands:
  create_for_write: |
    FILE_HANDLE="$BACKUP_HANDLE/$FILE_NAME"
    echo "$FILE_HANDLE"
    exec 1>&-
    sleep 30  # Simulate long-running operation
    gzip -c | azcopy cp --from-to PipeBlob "https://$ACCOUNT.blob.core.windows.net/$CONTAINER/$FILE_HANDLE$SAS"
```

2. **Terminal 1 - Start backup process:**
```bash
$ cargo run -p backup-cli -- backup continuously --command-adapter-config azure-test.yaml
```

3. **Terminal 2 - Attacker observes process listings:**
```bash
$ while true; do 
    ps aux | grep -E "(azcopy|bash.*SAS)" | grep -v grep
    sleep 1
done

# Output will show:
user  12345  0.0  0.1  bash -c set -o nounset -o errexit -o pipefail; sleep 30; gzip -c | azcopy cp --from-to PipeBlob "https://testaccount.blob.core.windows.net/testcontainer/file?sv=2020-08-04&ss=b&srt=sco&sp=rwdlac&se=2024-12-31&sig=SENSITIVE_SECRET_SIGNATURE_HERE"
```

4. **Alternative: Read from /proc:**
```bash
$ find /proc -maxdepth 2 -name cmdline 2>/dev/null | while read f; do
    cat "$f" 2>/dev/null | tr '\0' ' ' | grep -i sas && echo "Found in: $f"
done
```

**Result:** The sensitive SAS token is fully visible to any user on the system, demonstrating the credential exposure vulnerability.

## Notes

This vulnerability specifically affects Azure Blob Storage configurations. The AWS S3 and GCP configurations properly use environment variables for credentials without exposing them in command-line arguments. The fix should align the Azure implementation with these secure patterns while maintaining backward compatibility through configuration migration guidance.

### Citations

**File:** storage/backup/backup-cli/src/storage/command_adapter/sample_configs/azure.sample.yaml (L8-9)
```yaml
  - key: "SAS"
    value: "?a=blah&b=blah&c=blah"
```

**File:** storage/backup/backup-cli/src/storage/command_adapter/sample_configs/azure.sample.yaml (L22-22)
```yaml
    gzip -c | azcopy cp --from-to PipeBlob "https://$ACCOUNT.blob.core.windows.net/$CONTAINER/$SUB_DIR/$FILE_HANDLE$SAS" > /dev/null
```

**File:** storage/backup/backup-cli/src/storage/command_adapter/command.rs (L31-36)
```rust
    pub fn new(raw_cmd: &str, param_env_vars: Vec<EnvVar>, config_env_vars: Vec<EnvVar>) -> Self {
        Self {
            cmd_str: format!("set -o nounset -o errexit -o pipefail; {}", raw_cmd),
            param_env_vars,
            config_env_vars,
        }
```

**File:** storage/backup/backup-cli/src/storage/command_adapter/command.rs (L65-79)
```rust
    pub fn spawn(command: Command) -> Result<Self> {
        debug!("Spawning {:?}", command);

        let mut cmd = tokio::process::Command::new("bash");
        cmd.args(["-c", &command.cmd_str]);
        cmd.stdin(Stdio::piped())
            .stdout(Stdio::piped())
            .stderr(Stdio::inherit());
        for v in command
            .config_env_vars
            .iter()
            .chain(command.param_env_vars.iter())
        {
            cmd.env(&v.key, &v.value);
        }
```

**File:** storage/backup/backup-cli/src/storage/command_adapter/sample_configs/s3.sample.yaml (L18-18)
```yaml
    gzip -c | aws s3 cp - "s3://$BUCKET/$SUB_DIR/$FILE_HANDLE"
```

**File:** terraform/helm/fullnode/templates/_backup.tpl (L20-21)
```text
- name: SAS
  value: {{ .config.azure.sas }}
```
