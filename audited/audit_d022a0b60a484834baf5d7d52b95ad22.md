# Audit Report

## Title
IoPricingV1 Resource Creation Undercharging via legacy_resource_creation_as_modification Bug

## Summary
In gas feature versions 0-2, resource creations are incorrectly categorized as modifications due to the `legacy_resource_creation_as_modification` flag, causing IoPricingV1 to undercharge by 1,280,000 gas per resource creation. This allows attackers to create storage items at a significant discount, bypassing the per_new_item overhead charge entirely.

## Finding Description

IoPricingV1 has a two-tier gas charging model for write operations: [1](#0-0) 

The `write_data_per_new_item` charge (1,280,000 gas) is only applied to Creation operations (line 69), while Modification operations only pay the per_op overhead and per-byte costs (line 73).

However, in gas feature versions 0-2, a critical bug causes resource creations to be incorrectly categorized as modifications: [2](#0-1) 

When this flag is true, the WriteOpConverter converts resource creations into legacy modifications: [3](#0-2) 

This flag is used when processing resource changes: [4](#0-3) 

**Attack Path:**
1. Attacker submits transaction to create resources (via `move_to<T>`) on network with gas_feature_version < 3
2. MoveVM generates `MoveStorageOp::New` for the resource creation
3. `WriteOpConverter::convert_resource` is called with `legacy_resource_creation_as_modification=true`
4. Due to the bug, the operation is converted to `WriteOp::legacy_modification` instead of `WriteOp::legacy_creation`
5. IoPricingV1 charges for Modification: per_op (89,568) + per_byte costs
6. **Missing charge**: per_new_item (1,280,000 gas) is not applied
7. Attacker saves 1,280,000 gas per resource creation (~93% discount on per-item overhead)

## Impact Explanation

**Severity: Medium** per Aptos bug bounty criteria.

This vulnerability enables "Limited funds loss or manipulation" through undercharging of gas fees. Specifically:

- **Economic Impact**: Attackers can create resources at 1,280,000 gas discount per item
- **Storage Spam**: Enables cheaper storage spam attacks, as the fixed per-item overhead is not charged
- **Limited Scope**: Per-byte costs still apply, so total discount is limited for large items
- **Network Impact**: Could accelerate state bloat by making storage operations artificially cheap

The gas parameter value is from: [5](#0-4) 

## Likelihood Explanation

**Historical Likelihood: High** (for affected versions)
**Current Likelihood: None** (mainnet runs feature version 45)

This bug was **already fixed** at gas_feature_version 3 as documented in the code comments. The vulnerability only affects:
- Networks running gas_feature_version 0-2
- Private testnets or forks using legacy feature versions
- Historical transactions before the fix

Modern Aptos mainnet runs on feature version 45: [6](#0-5) 

The legacy code exists for backward compatibility only.

## Recommendation

**Status: Already Fixed**

The fix was implemented at gas_feature_version 3. The `legacy_resource_creation_as_modification` flag returns false for version 3+, causing resource creations to be correctly categorized as Creation operations.

For any networks still running feature version < 3:
1. Upgrade to gas_feature_version 3 or higher immediately
2. Apply the V3 changelog changes that distinguish between new and existing resources [7](#0-6) 

## Proof of Concept

**Note**: This PoC would only work on a network with gas_feature_version < 3.

```rust
// This is a conceptual PoC - would require a test network with feature_version < 3
// 
// 1. Deploy a Move module with resource type:
module 0x1::exploit {
    struct MyResource has key {
        data: vector<u8>
    }
    
    public entry fun create_many_resources(account: &signer) {
        // Create 1000 resources
        let i = 0;
        while (i < 1000) {
            move_to(account, MyResource { data: vector::empty() });
            i = i + 1;
        };
    }
}

// 2. Execute transaction on feature_version < 3 network
// Expected: Each resource creation charged as Modification (~89,568 gas)
// Should be: Each resource creation charged as Creation (~1,369,568 gas)
// Savings: ~1,280,000 gas per resource = 1,280,000,000 total for 1000 resources
```

**Notes:**
- This vulnerability is **documented and fixed** in the codebase
- Affects only legacy networks with gas_feature_version < 3  
- Mainnet is not vulnerable (runs feature version 45)
- The IoPricingV1 code remains for backward compatibility with historical state
- Security question specifically asked about IoPricingV1's legacy_write_data_per_new_item behavior, which led to discovery of this categorization bug

### Citations

**File:** aptos-move/aptos-vm-types/src/storage/io_pricing.rs (L58-79)
```rust
    fn io_gas_per_write(&self, key: &StateKey, op_size: &WriteOpSize) -> InternalGas {
        use aptos_types::write_set::WriteOpSize::*;

        let mut cost = self.write_data_per_op * NumArgs::new(1);

        if self.write_data_per_byte_in_key > 0.into() {
            cost += self.write_data_per_byte_in_key * NumBytes::new(key.encoded().len() as u64);
        }

        match op_size {
            Creation { write_len } => {
                cost += self.write_data_per_new_item * NumArgs::new(1)
                    + self.write_data_per_byte_in_val * NumBytes::new(*write_len);
            },
            Modification { write_len } => {
                cost += self.write_data_per_byte_in_val * NumBytes::new(*write_len);
            },
            Deletion => (),
        }

        cost
    }
```

**File:** aptos-move/aptos-vm-types/src/storage/change_set_configs.rs (L59-66)
```rust
    pub fn legacy_resource_creation_as_modification(&self) -> bool {
        // Bug fixed at gas_feature_version 3 where (non-group) resource creation was converted to
        // modification.
        // Modules and table items were not affected (https://github.com/aptos-labs/aptos-core/pull/4722/commits/7c5e52297e8d1a6eac67a68a804ab1ca2a0b0f37).
        // Resource groups and state values with metadata were not affected because they were
        // introduced later than feature_version 3 on all networks.
        self.gas_feature_version < 3
    }
```

**File:** aptos-move/aptos-vm/src/move_vm_ext/write_op_converter.rs (L249-256)
```rust
            (None, New(data)) => match &self.new_slot_metadata {
                None => {
                    if legacy_creation_as_modification {
                        WriteOp::legacy_modification(data)
                    } else {
                        WriteOp::legacy_creation(data)
                    }
                },
```

**File:** aptos-move/aptos-vm/src/move_vm_ext/session/mod.rs (L454-458)
```rust
                let op = woc.convert_resource(
                    &state_key,
                    blob_and_layout_op,
                    legacy_resource_creation_as_modification,
                )?;
```

**File:** aptos-move/aptos-gas-schedule/src/gas_schedule/transaction.rs (L118-121)
```rust
            legacy_write_data_per_new_item: InternalGasPerArg,
            {0..=9 => "write_data.new_item"},
            1_280_000,
        ],
```

**File:** aptos-move/aptos-gas-schedule/src/ver.rs (L64-69)
```rust
/// - V3
///   - Add memory quota
///   - Storage charges:
///     - Distinguish between new and existing resources
///     - One item write comes with 1K free bytes
///     - abort with STORAGE_WRITE_LIMIT_REACHED if WriteOps or Events are too large
```

**File:** aptos-move/aptos-gas-schedule/src/ver.rs (L76-112)
```rust
pub const LATEST_GAS_FEATURE_VERSION: u64 = gas_feature_versions::RELEASE_V1_41;

pub mod gas_feature_versions {
    pub const RELEASE_V1_8: u64 = 11;
    pub const RELEASE_V1_9_SKIPPED: u64 = 12;
    pub const RELEASE_V1_9: u64 = 13;
    pub const RELEASE_V1_10: u64 = 15;
    pub const RELEASE_V1_11: u64 = 16;
    pub const RELEASE_V1_12: u64 = 17;
    pub const RELEASE_V1_13: u64 = 18;
    pub const RELEASE_V1_14: u64 = 19;
    pub const RELEASE_V1_15: u64 = 20;
    pub const RELEASE_V1_16: u64 = 21;
    pub const RELEASE_V1_18: u64 = 22;
    pub const RELEASE_V1_19: u64 = 23;
    pub const RELEASE_V1_20: u64 = 24;
    pub const RELEASE_V1_21: u64 = 25;
    pub const RELEASE_V1_22: u64 = 26;
    pub const RELEASE_V1_23: u64 = 27;
    pub const RELEASE_V1_24: u64 = 28;
    pub const RELEASE_V1_26: u64 = 30;
    pub const RELEASE_V1_27: u64 = 31;
    pub const RELEASE_V1_28: u64 = 32;
    pub const RELEASE_V1_29: u64 = 33;
    pub const RELEASE_V1_30: u64 = 34;
    pub const RELEASE_V1_31: u64 = 35;
    pub const RELEASE_V1_32: u64 = 36;
    pub const RELEASE_V1_33: u64 = 37;
    pub const RELEASE_V1_34: u64 = 38;
    pub const RELEASE_V1_35: u64 = 39;
    pub const RELEASE_V1_36: u64 = 40;
    pub const RELEASE_V1_37: u64 = 41;
    pub const RELEASE_V1_38: u64 = 42;
    pub const RELEASE_V1_39: u64 = 43;
    pub const RELEASE_V1_40: u64 = 44;
    pub const RELEASE_V1_41: u64 = 45;
}
```
