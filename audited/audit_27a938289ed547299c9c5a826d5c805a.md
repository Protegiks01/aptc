# Audit Report

## Title
Windows File Permission Weakness in Genesis Layout Template Generation Allows Parameter Tampering

## Summary
The `GenerateLayoutTemplate` command creates a genesis layout file with platform-specific file permissions. On Unix systems, the file is correctly restricted to user-only access (mode 0o600), but on Windows, the permission setting is skipped entirely due to a conditional compilation directive, leaving the file with default Windows permissions that may allow unauthorized modification by other users.

## Finding Description

The vulnerability exists in the file permission handling when creating genesis layout files. The `write_to_user_only_file` function is used to create the layout.yaml file with restricted permissions: [1](#0-0) 

The critical issue is that the `.mode(0o600)` call that sets user-only read/write permissions is wrapped in a `#[cfg(unix)]` conditional compilation directive. This means on Windows systems, this line is not compiled at all, and the file is created with default Windows ACL permissions inherited from the parent directory.

The `GenerateLayoutTemplate` command uses this function to create the layout file: [2](#0-1) 

The Layout struct contains critical genesis parameters that directly affect blockchain initialization: [3](#0-2) 

These parameters include:
- `chain_id` - Network identifier
- `min_stake`, `max_stake` - Validator staking economics  
- `rewards_apy_percentage` - Reward distribution
- `voting_duration_secs`, `min_voting_threshold` - Governance parameters
- `epoch_duration_secs` - Chain timing
- `on_chain_consensus_config` - Consensus behavior
- `on_chain_execution_config` - Execution parameters

When the genesis blob is generated, these layout parameters are read and directly incorporated into the genesis configuration: [4](#0-3) 

**Attack Scenario:**
1. Genesis operator runs `aptos genesis generate-layout-template` on a Windows system
2. The layout.yaml file is created with default Windows permissions (not restricted to user-only)
3. Another user with access to the directory (common in corporate Windows networks with shared drives) modifies the layout.yaml file
4. Attacker changes critical parameters such as `min_stake: 1`, `rewards_apy_percentage: 100`, or `chain_id`
5. Operator runs `aptos genesis generate-genesis` which reads the tampered layout file without any integrity verification
6. Modified parameters are embedded in the genesis block
7. The blockchain launches with attacker-controlled economic, governance, or consensus parameters

There is no integrity verification (checksums, signatures) performed on the layout file between creation and use.

## Impact Explanation

This vulnerability qualifies as **Medium Severity** per Aptos bug bounty criteria: "State inconsistencies requiring intervention."

The impact includes:
- **Economic Manipulation**: Attacker could set `min_stake: 1` to allow validators with minimal stake, or `rewards_apy_percentage: 100` to hyperinflate rewards
- **Governance Compromise**: Modifying `min_voting_threshold` or `voting_duration_secs` could enable governance takeover or deadlock
- **Chain Incompatibility**: Changing `chain_id` would make the chain incompatible with expected network configurations
- **Consensus Issues**: Tampering with `epoch_duration_secs` or `on_chain_consensus_config` could cause consensus failures or network splits

While this doesn't directly cause loss of funds or consensus violations at the protocol level, it fundamentally compromises the genesis initialization process, requiring intervention to fix once discovered. The blockchain would need to restart genesis with correct parameters.

## Likelihood Explanation

**Likelihood: Medium**

Factors increasing likelihood:
- Windows is commonly used in corporate environments and by developers for testing/development setups
- Multi-user Windows systems often have shared directories with permissive ACLs by default
- Genesis operators may not be aware of this platform-specific security issue
- No documentation warns about Windows-specific security considerations for genesis setup
- Default Windows file permissions often allow read/write access to other users in the same group or on network shares

Factors decreasing likelihood:
- Production genesis ceremonies are typically performed on Linux systems
- Genesis is usually done by trusted operators in controlled environments
- The time window between layout file creation and genesis generation may be short
- Many genesis setups use isolated, single-user environments

However, the combination of Windows usage for development/testing and the lack of integrity verification creates a realistic attack surface.

## Recommendation

Implement platform-specific file permission controls for Windows:

```rust
pub fn write_to_user_only_file(path: &Path, name: &str, bytes: &[u8]) -> CliTypedResult<()> {
    let mut opts = OpenOptions::new();
    #[cfg(unix)]
    opts.mode(0o600);
    
    #[cfg(windows)]
    {
        use std::os::windows::fs::OpenOptionsExt;
        use windows_sys::Win32::Storage::FileSystem::FILE_ATTRIBUTE_READONLY;
        // Set file as read-only initially, then we'll update ACL after creation
        opts.attributes(FILE_ATTRIBUTE_READONLY);
    }
    
    let result = write_to_file_with_opts(path, name, bytes, &mut opts);
    
    #[cfg(windows)]
    if result.is_ok() {
        // After file creation, set restrictive ACLs to current user only
        set_windows_user_only_acl(path)?;
    }
    
    result
}

#[cfg(windows)]
fn set_windows_user_only_acl(path: &Path) -> CliTypedResult<()> {
    // Use Windows API to set ACL allowing only current user
    // This requires using winapi/windows-sys crate and calling
    // SetNamedSecurityInfo or similar Windows API functions
    // Implementation details omitted for brevity
    Ok(())
}
```

**Additional recommendations:**
1. Add integrity verification for layout files (checksums or signatures)
2. Document that genesis setup should be performed on Unix systems or with proper Windows ACL configuration
3. Add a warning when running genesis commands on Windows about potential security implications
4. Consider adding a `--verify-layout` flag that validates the layout file hasn't been modified

## Proof of Concept

**Demonstration on Windows:**

1. Create a layout file on Windows:
```bash
aptos genesis generate-layout-template --output-file layout.yaml
```

2. Check file permissions (PowerShell):
```powershell
Get-Acl layout.yaml | Format-List
# Shows inherited permissions, not restricted to current user
```

3. As another user with directory access, modify the file:
```powershell
# Edit layout.yaml as different user
$content = Get-Content layout.yaml
$content = $content -replace 'min_stake: 100000000000000', 'min_stake: 1'
$content = $content -replace 'rewards_apy_percentage: 10', 'rewards_apy_percentage: 100'
Set-Content layout.yaml $content
```

4. Generate genesis with tampered parameters:
```bash
aptos genesis generate-genesis --output-dir ./
# Genesis blob now contains attacker-controlled parameters
```

**Comparison on Unix:**

1. Create layout file on Unix:
```bash
aptos genesis generate-layout-template --output-file layout.yaml
```

2. Verify permissions:
```bash
ls -l layout.yaml
# Shows: -rw------- (0600), user-only access
stat -c "%a" layout.yaml
# Shows: 600
```

3. Attempt to read as another user:
```bash
su otheruser
cat layout.yaml
# Permission denied
```

This demonstrates the platform-specific security difference where Unix systems are protected but Windows systems are vulnerable to layout file tampering.

### Citations

**File:** crates/aptos/src/common/utils.rs (L224-229)
```rust
pub fn write_to_user_only_file(path: &Path, name: &str, bytes: &[u8]) -> CliTypedResult<()> {
    let mut opts = OpenOptions::new();
    #[cfg(unix)]
    opts.mode(0o600);
    write_to_file_with_opts(path, name, bytes, &mut opts)
}
```

**File:** crates/aptos/src/genesis/keys.rs (L293-297)
```rust
        write_to_user_only_file(
            self.output_file.as_path(),
            &self.output_file.display().to_string(),
            to_yaml(&layout)?.as_bytes(),
        )
```

**File:** crates/aptos-genesis/src/config.rs (L30-90)
```rust
pub struct Layout {
    /// Root key for the blockchain only for test chains
    #[serde(default)]
    pub root_key: Option<Ed25519PublicKey>,
    /// List of usernames or identifiers
    pub users: Vec<String>,
    /// ChainId for the target network
    pub chain_id: ChainId,
    /// Whether to allow new validators to join the set after genesis
    ///
    /// Ignored for mainnet
    #[serde(default)]
    pub allow_new_validators: bool,
    /// Duration of an epoch
    pub epoch_duration_secs: u64,
    /// Whether this is a test network or not
    ///
    /// Ignored for mainnet
    #[serde(default)]
    pub is_test: bool,
    /// Minimum stake to be in the validator set
    pub min_stake: u64,
    /// Minimum number of votes to consider a proposal valid.
    pub min_voting_threshold: u128,
    /// Maximum stake to be in the validator set
    pub max_stake: u64,
    /// Minimum number of seconds to lockup staked coins
    pub recurring_lockup_duration_secs: u64,
    /// Required amount of stake to create proposals.
    pub required_proposer_stake: u64,
    /// Percentage of stake given out as rewards a year (0-100%).
    pub rewards_apy_percentage: u64,
    /// Voting duration for a proposal in seconds.
    pub voting_duration_secs: u64,
    /// % of current epoch's total voting power that can be added in this epoch.
    pub voting_power_increase_limit: u64,
    /// Total supply of coins
    pub total_supply: Option<u64>,
    /// Timestamp (in seconds) when employee vesting starts.
    pub employee_vesting_start: Option<u64>,
    /// Duration of each vesting period (in seconds).
    pub employee_vesting_period_duration: Option<u64>,
    /// Onchain Consensus Config
    #[serde(default = "OnChainConsensusConfig::default_for_genesis")]
    pub on_chain_consensus_config: OnChainConsensusConfig,
    /// Onchain Execution Config
    #[serde(default = "OnChainExecutionConfig::default_for_genesis")]
    pub on_chain_execution_config: OnChainExecutionConfig,

    /// An optional JWK consensus config to use, instead of `default_for_genesis()`.
    #[serde(default)]
    pub jwk_consensus_config_override: Option<OnChainJWKConsensusConfig>,

    /// JWKs to patch in genesis.
    #[serde(default)]
    pub initial_jwks: Vec<IssuerJWK>,

    /// Keyless Groth16 verification key to install in genesis.
    #[serde(default)]
    pub keyless_groth16_vk_override: Option<Groth16VerificationKey>,
}
```

**File:** crates/aptos/src/genesis/mod.rs (L288-301)
```rust
        &GenesisConfiguration {
            allow_new_validators: layout.allow_new_validators,
            epoch_duration_secs: layout.epoch_duration_secs,
            is_test: layout.is_test,
            min_stake: layout.min_stake,
            min_voting_threshold: layout.min_voting_threshold,
            max_stake: layout.max_stake,
            recurring_lockup_duration_secs: layout.recurring_lockup_duration_secs,
            required_proposer_stake: layout.required_proposer_stake,
            rewards_apy_percentage: layout.rewards_apy_percentage,
            voting_duration_secs: layout.voting_duration_secs,
            voting_power_increase_limit: layout.voting_power_increase_limit,
            employee_vesting_start: layout.employee_vesting_start,
            employee_vesting_period_duration: layout.employee_vesting_period_duration,
```
