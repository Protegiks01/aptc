# Audit Report

## Title
Unauthenticated Forge Metrics Endpoint Exposes Comprehensive Validator State Information

## Summary
The `/forge_metrics` endpoint in the inspection service lacks authentication and cannot be disabled via configuration flags. If production validators enable the metrics port for monitoring purposes, this endpoint becomes publicly accessible, leaking comprehensive internal metrics including consensus state, network topology, and performance data that could aid attackers in reconnaissance and attack planning.

## Finding Description

The `handle_forge_metrics()` function exposes all node metrics without any authentication mechanism. [1](#0-0) 

This endpoint is unconditionally registered in the inspection service routing logic and cannot be disabled: [2](#0-1) 

Unlike other sensitive endpoints like `/configuration`, `/identity_information`, `/peer_information`, and `/system_information`, the `/forge_metrics` endpoint has no corresponding configuration flag in the `InspectionServiceConfig` structure: [3](#0-2) 

Other sensitive endpoints implement access control through configuration flags. For example, the configuration endpoint checks `expose_configuration` before returning data: [4](#0-3) 

The inspection service binds to `0.0.0.0` by default, making it accessible from any network interface: [5](#0-4) 

In production Kubernetes deployments, when operators enable the metrics port via `service.validator.enableMetricsPort: true`, it becomes publicly accessible through a LoadBalancer service: [6](#0-5) 

The HAProxy configuration proxies the metrics endpoint to external port 9102: [7](#0-6) 

The exposed metrics include sensitive information such as consensus state, validator voting power, network peer connections, and performance metrics: [8](#0-7) 

Network topology information including peer IDs and connection states is also exposed: [9](#0-8) 

**Attack Path:**
1. Validator operator enables metrics port for legitimate monitoring purposes (`enableMetricsPort: true`)
2. LoadBalancer service exposes port 9101 publicly
3. Attacker accesses `http://<validator-public-ip>:9101/forge_metrics` without authentication
4. Attacker receives comprehensive JSON dump of all node metrics via the inspection client pattern: [10](#0-9) 
5. Attacker uses metrics for reconnaissance: network topology mapping, consensus participation tracking, performance profiling, and attack planning

## Impact Explanation

This issue constitutes a **Medium Severity** information disclosure vulnerability:

- **Information Disclosure**: Comprehensive validator metrics are exposed without authentication, including consensus participation, network connections, performance characteristics, and operational state
- **Reconnaissance Enabler**: Attackers can monitor validator behavior, map network topology, identify performance bottlenecks, and track consensus patterns
- **Privacy Violation**: Validators' operational details and peer relationships become observable to any network adversary
- **Strategic Attack Planning**: Exposed metrics could inform targeted DoS attacks, network partition strategies, or consensus manipulation attempts

While this doesn't directly cause loss of funds or consensus violations, it significantly reduces the security posture of validators by providing adversaries with comprehensive internal state information. Per the Aptos bug bounty program, this qualifies as more than a "minor information leak" (Low Severity) due to the comprehensiveness of exposed data and its utility for attack planning, but doesn't reach High Severity as it doesn't directly cause node slowdowns or protocol violations.

## Likelihood Explanation

**Moderate Likelihood:**
- Validator operators may legitimately enable the metrics port for monitoring and observability
- The default configuration has `enableMetricsPort: false`, providing defense-in-depth: [11](#0-10) 
- However, operators focused on debugging or monitoring might enable this without understanding the security implications
- The endpoint name "forge_metrics" suggests testing usage, potentially leading operators to underestimate production risk
- No warnings exist in the configuration about the unauthenticated nature of this endpoint

## Recommendation

Implement one of the following security controls:

**Option 1: Add Configuration Flag (Recommended)**
Add an `expose_forge_metrics` boolean field to `InspectionServiceConfig` (defaulting to `false`), and modify the request handler to check this flag before serving metrics, returning `StatusCode::FORBIDDEN` when disabled, consistent with other sensitive endpoints.

**Option 2: Add Authentication**
Implement JWT-based authentication for the forge metrics endpoint, similar to the telemetry service's authenticated endpoints that use `authorize_jwt()` for access control.

**Option 3: Remove from Production**
If the endpoint is truly only needed for Forge testing, remove it from production builds or gate it behind a compile-time feature flag.

**Additional Recommendations:**
- Document the security implications of enabling `service.validator.enableMetricsPort` in deployment guides
- Consider adding authentication requirements to all inspection service endpoints when exposed publicly
- Implement rate limiting on metrics endpoints to prevent abuse

## Proof of Concept

**Exploitation Steps:**

1. Deploy a validator with metrics port enabled in `values.yaml`:
```yaml
service:
  validator:
    enableMetricsPort: true
    external:
      type: LoadBalancer
```

2. Access the exposed endpoint:
```bash
curl http://<validator-lb-ip>:9101/forge_metrics
```

3. Observe the comprehensive JSON response containing all node metrics without authentication

**Expected Result:** Complete metrics dump including consensus rounds, peer connections, voting power, transaction counts, and performance statistics.

**Verification:** The test suite confirms the endpoint is always accessible: [12](#0-11) 

## Notes

- This vulnerability requires operator configuration to manifest (enabling the metrics port), making it a deployment security issue rather than a pure code vulnerability
- The default secure configuration (`enableMetricsPort: false`) provides protection, but security should not rely solely on configuration
- The inconsistency between this endpoint and other sensitive endpoints (which have disable flags) indicates an architectural oversight
- The endpoint name suggests testing usage but exists in production code without appropriate safeguards
- Network-level protection (firewalls, `loadBalancerSourceRanges`) can mitigate this issue but should be considered defense-in-depth, not primary security controls

### Citations

**File:** aptos-core-096/crates/aptos-inspection-service/src/server/metrics.rs (L50-64)
```rust

```

**File:** aptos-core-096/crates/aptos-inspection-service/src/server/mod.rs (L122-126)
```rust

```

**File:** aptos-core-096/config/src/config/inspection_service_config.rs (L15-24)
```rust

```

**File:** aptos-core-096/config/src/config/inspection_service_config.rs (L26-37)
```rust

```

**File:** aptos-core-096/crates/aptos-inspection-service/src/server/configuration.rs (L13-26)
```rust

```

**File:** aptos-core-096/terraform/helm/aptos-node/templates/haproxy.yaml (L39-43)
```yaml

```

**File:** aptos-core-096/terraform/helm/aptos-node/files/haproxy.cfg (L92-108)
```text

```

**File:** aptos-core-096/consensus/src/counters.rs (L78-103)
```rust

```

**File:** aptos-core-096/network/framework/src/counters.rs (L86-106)
```rust

```

**File:** aptos-core-096/crates/aptos-inspection-service/src/inspection_client.rs (L85-107)
```rust

```

**File:** aptos-core-096/terraform/helm/aptos-node/values.yaml (L156-159)
```yaml

```

**File:** aptos-core-096/crates/aptos-inspection-service/src/server/tests.rs (L62-75)
```rust

```
