# Audit Report

## Title
Unauthenticated Tokio Console Debug Interface Exposed to Network When Accidentally Enabled in Production

## Summary
When the `tokio_console_port` configuration is accidentally left enabled in production builds (compiled with the `tokio-console` feature flag), the tokio-console debugging server binds to `0.0.0.0` (all network interfaces) without any authentication mechanism, exposing validator operational details to potential attackers on the network.

## Finding Description

The `LoggerConfig` struct contains a `tokio_console_port` field that, when set to a non-None value, enables the tokio-console debugging interface. [1](#0-0) 

The default value is correctly set to `None` (disabled): [2](#0-1) 

However, when this feature is accidentally enabled (either through explicit configuration or the optimizer default of port 6669), the tokio-console server binds to all network interfaces (`0.0.0.0`) without any authentication: [3](#0-2) 

The tokio-console protocol exposes:
- **Task names**: Including consensus-related tasks like "quorum_store_coordinator", "batch_generator", and other operational components [4](#0-3) 
- **Task execution states**: Whether tasks are idle, running, or blocked
- **Timing information**: Poll durations, wake patterns, and execution timings
- **Resource usage**: Wakers, semaphores, and other async runtime details
- **Call stack traces**: When tasks are blocked or waiting

An attacker with network access to the validator node could:
1. Connect to the exposed port using the tokio-console client
2. Observe real-time consensus task execution patterns
3. Identify timing patterns for block proposals, voting, and round transitions
4. Potentially use this information for timing attacks or to predict validator behavior
5. Gain operational intelligence about the validator's internal state machine

While the codebase shows awareness of security through localhost-only binding for other sensitive services [5](#0-4) , the tokio-console implementation unconditionally binds to `0.0.0.0`, violating this security pattern.

## Impact Explanation

This vulnerability falls under **Medium Severity** according to the Aptos Bug Bounty criteria for the following reasons:

1. **Information Disclosure**: While not directly causing loss of funds or consensus violations, it exposes operational details that could aid more sophisticated attacks. This exceeds the "minor information leaks" category of Low severity because it provides real-time visibility into consensus operations.

2. **Attack Surface Expansion**: Creates an unauthenticated network service on validator nodes that should not exist in production, violating the principle of minimal attack surface.

3. **Operational Security**: Could reveal timing patterns, task execution sequences, and internal state that attackers could use to:
   - Identify optimal timing for network-level attacks
   - Understand consensus round progression
   - Detect validator performance characteristics
   - Map internal architecture and task dependencies

4. **No Direct Impact on Consensus**: Does not break consensus safety, cause fund loss, or enable direct exploitation of protocol vulnerabilities, preventing it from reaching High or Critical severity.

## Likelihood Explanation

**Likelihood: Low-to-Medium**

For this vulnerability to be exploitable:

1. **Compilation Requirement**: The `tokio-console` feature flag must be enabled during compilation [6](#0-5) 
2. **Configuration Requirement**: The `tokio_console_port` must be set to a non-None value
3. **Network Access**: Attacker must have network connectivity to the validator node on the configured port

**Mitigation Factors**:
- Default configuration has `tokio_console_port = None` (disabled)
- Config sanitizer validates feature flag consistency [7](#0-6) 
- Production builds typically don't include the `tokio-console` feature flag

**Risk Factors**:
- If enabled "temporarily" for debugging and forgotten
- If feature flag is accidentally included in production builds
- Default port 6669 is well-known and easily scanned [8](#0-7) 
- No runtime warnings or alerts when tokio-console is active in production

## Recommendation

**Immediate Fix**: Bind tokio-console server to localhost only:

```rust
// In crates/aptos-logger/src/logger.rs, line 58
let console_layer = console_subscriber::ConsoleLayer::builder()
    .server_addr(([127, 0, 0, 1], tokio_console_port))  // Changed from [0, 0, 0, 0]
    .spawn();
```

**Additional Hardening**:

1. **Add Runtime Warning**: Log a critical warning when tokio-console is enabled:
```rust
#[cfg(feature = "tokio-console")]
{
    if let Some(tokio_console_port) = tokio_console_port {
        error!("⚠️  SECURITY WARNING: tokio-console is ENABLED on port {}. This should NEVER be enabled in production!", tokio_console_port);
        // Consider: panic if not in test mode
    }
}
```

2. **Strengthen Config Sanitizer**: Add production environment check in `ConfigSanitizer`:
```rust
if is_tokio_console_enabled() && !cfg!(test) {
    return Err(Error::ConfigSanitizerFailed(
        sanitizer_name,
        "tokio-console feature MUST NOT be enabled in production builds!".into(),
    ));
}
```

3. **Documentation**: Add clear warnings in configuration documentation that this feature is for local debugging only.

## Proof of Concept

**Step 1**: Build aptos-node with tokio-console feature:
```bash
cargo build --release --features tokio-console
```

**Step 2**: Create a configuration file with tokio_console_port enabled:
```yaml
# node_config.yaml
logger:
  tokio_console_port: 6669
```

**Step 3**: Start the validator node with this configuration:
```bash
./target/release/aptos-node -f node_config.yaml
```

**Step 4**: From another machine on the network, connect using tokio-console client:
```bash
# Install tokio-console client
cargo install tokio-console

# Connect to the exposed validator (replace with actual IP)
tokio-console http://VALIDATOR_IP:6669
```

**Expected Result**: The attacker gains real-time visibility into:
- All named async tasks running on the validator
- Task execution states and timing
- Consensus-related task names like "quorum_store_coordinator", "batch_generator"
- Poll counts, wake patterns, and resource utilization

This demonstrates that the debug interface is accessible from the network without authentication, exposing operational details that should remain private to validator operators.

**Notes**:
- The vulnerability requires the specific misconfiguration described (feature flag + port setting)
- Primary security concern is information disclosure, not direct protocol exploitation
- Fix should prioritize binding to localhost while maintaining functionality for legitimate local debugging
- Consider adding feature-gated compile-time checks to prevent accidental production deployment

### Citations

**File:** config/src/config/logger_config.rs (L17-17)
```rust
const DEFAULT_TOKIO_CONSOLE_PORT: u16 = 6669;
```

**File:** config/src/config/logger_config.rs (L36-37)
```rust
    /// Tokio console port for local debugging
    pub tokio_console_port: Option<u16>,
```

**File:** config/src/config/logger_config.rs (L50-55)
```rust

            // This is the default port used by tokio-console.
            // Setting this to None will disable tokio-console
            // even if the "tokio-console" feature is enabled.
            tokio_console_port: None,
        }
```

**File:** config/src/config/logger_config.rs (L79-91)
```rust
        if is_tokio_console_enabled() && logger_config.tokio_console_port.is_none() {
            return Err(Error::ConfigSanitizerFailed(
                sanitizer_name,
                "The tokio-console feature is enabled but the tokio console port is not set!"
                    .into(),
            ));
        } else if !is_tokio_console_enabled() && logger_config.tokio_console_port.is_some() {
            return Err(Error::ConfigSanitizerFailed(
                sanitizer_name,
                "The tokio-console feature is not enabled but the tokio console port is set!"
                    .into(),
            ));
        }
```

**File:** crates/aptos-logger/src/logger.rs (L56-59)
```rust
        if let Some(tokio_console_port) = tokio_console_port {
            let console_layer = console_subscriber::ConsoleLayer::builder()
                .server_addr(([0, 0, 0, 0], tokio_console_port))
                .spawn();
```

**File:** consensus/src/quorum_store/quorum_store_builder.rs (L295-298)
```rust
        spawn_named!(
            "quorum_store_coordinator",
            quorum_store_coordinator.start(coordinator_rx)
        );
```

**File:** crates/aptos/src/node/local_testnet/mod.rs (L1-50)
```rust
// Copyright (c) Aptos Foundation
// Licensed pursuant to the Innovation-Enabling Source Code License, available at https://github.com/aptos-labs/aptos-core/blob/main/LICENSE

mod logging;
mod postgres;
mod ready_server;
mod utils;

// This is to allow external crates to use the localnode.
pub mod docker;
pub mod faucet;
pub mod health_checker;
pub mod indexer_api;
pub mod node;
pub mod processors;
pub mod traits;

use self::{
    faucet::FaucetArgs,
    indexer_api::IndexerApiArgs,
    logging::ThreadNameMakeWriter,
    node::NodeArgs,
    postgres::PostgresArgs,
    processors::ProcessorArgs,
    ready_server::ReadyServerArgs,
    traits::{PostHealthyStep, ServiceManager},
};
use crate::{
    common::{
        types::{CliCommand, CliError, CliTypedResult, ConfigSearchMode, PromptOptions},
        utils::prompt_yes_with_override,
    },
    config::GlobalConfig,
    node::local_testnet::{
        faucet::FaucetManager, indexer_api::IndexerApiManager, node::NodeManager,
        processors::ProcessorManager, ready_server::ReadyServerManager, traits::ShutdownStep,
    },
};
use anyhow::{Context, Result};
use aptos_indexer_grpc_server_framework::setup_logging;
use async_trait::async_trait;
use clap::Parser;
pub use health_checker::HealthChecker;
use std::{
    collections::HashSet,
    fs::{create_dir_all, remove_dir_all},
    net::Ipv4Addr,
    path::{Path, PathBuf},
    pin::Pin,
};
```

**File:** aptos-node/Cargo.toml (L97-97)
```text
tokio-console = ["aptos-logger/tokio-console", "aptos-config/tokio-console"]
```
