# Audit Report

## Title
Supply Chain Attack Vector: Build-Time Feature Flag Injection Enables Zero-Cost Transactions via Compromised Genesis

## Summary
A supply chain attack on the Aptos build system can inject the `testing` feature flag during genesis creation, permanently setting the minimum gas price to 0 in the on-chain gas schedule. This enables unlimited free transactions, completely breaking the blockchain's economic security model and resource metering invariants.

## Finding Description

The Aptos codebase contains a critical vulnerability in how gas pricing constants are compiled into the genesis transaction. The `aptos-global-constants` crate uses conditional compilation to set different gas price values for testing versus production environments. [1](#0-0) 

The `testing` feature flag is defined in the crate's Cargo.toml: [2](#0-1) 

This constant is used as the initial value for `min_price_per_gas_unit` in the transaction gas parameters: [3](#0-2) 

During genesis creation, the gas schedule is initialized using these hardcoded Rust constants: [4](#0-3) 

The resulting gas schedule is serialized into the genesis transaction and becomes the permanent on-chain configuration. At runtime, validators enforce this minimum gas price during transaction validation: [5](#0-4) 

**Attack Path:**

1. Attacker compromises the CI/CD pipeline or build environment for genesis creation
2. Modifies build commands to include `--features testing` or `--all-features` flag
3. The genesis transaction is built with `GAS_UNIT_PRICE = 0`
4. Genesis is deployed to production validators
5. The on-chain gas schedule permanently has `min_price_per_gas_unit = 0`
6. All transactions with `gas_unit_price = 0` are accepted by validators
7. Network is flooded with free transactions, causing DoS and economic breakdown

Critically, there are no validation checks in the Move code to prevent a gas schedule with zero minimum price: [6](#0-5) 

The TODO comment at line 47 explicitly notes this missing validation: "TODO(Gas): check if gas schedule is consistent".

## Impact Explanation

This vulnerability qualifies as **Critical Severity** under the Aptos Bug Bounty program for multiple reasons:

1. **Total Loss of Economic Security**: The blockchain's economic model depends on gas fees to prevent spam and resource exhaustion. With zero minimum gas price, this protection is completely eliminated.

2. **Network DoS**: Attackers can submit unlimited transactions at zero cost, overwhelming validator nodes with computational and storage load, leading to total network unavailability.

3. **Consensus/Safety Violation**: The Resource Limits invariant (#9) is permanently broken: "All operations must respect gas, storage, and computational limits."

4. **Requires Hardfork**: Since the gas schedule is baked into genesis and stored on-chain, fixing this requires either a governance proposal (if governance is functional) or a hardfork with new genesis, qualifying as "non-recoverable network partition."

5. **Deterministic Execution Violation**: Different genesis builds could produce different gas schedules, causing validators to have different state roots, violating invariant #1.

## Likelihood Explanation

**Likelihood: Medium-High**

While this requires compromising the build system, supply chain attacks are increasingly common:

- **Real-world precedent**: SolarWinds, Codecov, UA-Parser-JS attacks demonstrate build pipeline compromise is realistic
- **Single point of failure**: Only requires compromising the genesis build process once
- **Subtle injection**: Adding a feature flag to build commands is less obvious than code modification
- **Detection difficulty**: Standard code review wouldn't catch build script modifications
- **High impact justifies effort**: Complete network compromise motivates sophisticated attackers

The feature flag propagation chain increases attack surface: [7](#0-6) 

## Recommendation

**Immediate Mitigations:**

1. **Remove conditional compilation for critical security constants:**

```rust
// In config/global-constants/src/lib.rs
// Remove #[cfg] attributes and hardcode production values
pub const GAS_UNIT_PRICE: u64 = 100;
pub const MAX_GAS_AMOUNT: u64 = 2_000_000;
```

2. **Add genesis gas schedule validation:**

```move
// In aptos-move/framework/aptos-framework/sources/configs/gas_schedule.move
public(friend) fun initialize(aptos_framework: &signer, gas_schedule_blob: vector<u8>) {
    system_addresses::assert_aptos_framework(aptos_framework);
    assert!(!vector::is_empty(&gas_schedule_blob), error::invalid_argument(EINVALID_GAS_SCHEDULE));
    
    let gas_schedule: GasScheduleV2 = from_bytes(gas_schedule_blob);
    
    // Validate minimum gas price is non-zero for production
    validate_gas_schedule_parameters(&gas_schedule);
    
    move_to<GasScheduleV2>(aptos_framework, gas_schedule);
}

fun validate_gas_schedule_parameters(schedule: &GasScheduleV2) {
    // Ensure min_price_per_gas_unit >= 100 (production minimum)
    // Add validation for other critical parameters
}
```

3. **Build system hardening:**
   - Implement reproducible builds with hash verification
   - Add automated checks for unexpected feature flags in release builds
   - Require multi-party approval for genesis transaction creation
   - Monitor CI/CD pipelines for unauthorized modifications

4. **Separate testing constants into test-only crates** that cannot be linked into production binaries.

## Proof of Concept

**Step 1: Build genesis with testing feature enabled**

```bash
# In aptos-core repository
cd aptos-move/vm-genesis

# Build with testing feature (simulating supply chain attack)
cargo build --release --features testing

# This will compile GAS_UNIT_PRICE = 0 into the genesis binary
```

**Step 2: Verify the compiled constant**

```bash
# Check the compiled value
strings target/release/aptos-genesis | grep -A 5 "min_price_per_gas_unit"
# Will show value: 0 instead of 100
```

**Step 3: Create genesis transaction**

```rust
// The default_gas_schedule() function will use the compiled constant
let genesis = encode_aptos_mainnet_genesis_transaction(
    &accounts,
    &employees,
    &validators,
    &framework,
    chain_id,
    &genesis_config,
);

// Resulting genesis has min_price_per_gas_unit = 0
```

**Step 4: Submit zero-cost transaction**

```rust
// After network starts with compromised genesis
let txn = RawTransaction::new(
    sender,
    sequence_number,
    payload,
    max_gas_amount,
    0, // gas_unit_price = 0 (FREE!)
    expiration_timestamp,
    chain_id,
);

// Transaction passes validation at line 178-192 of aptos-vm/src/gas.rs
// because min_price_per_gas_unit is 0
```

**Verification:** Deploy test network with compromised genesis and confirm transactions with `gas_unit_price = 0` are accepted, while a network with proper genesis rejects them with `GAS_UNIT_PRICE_BELOW_MIN_BOUND` error.

## Notes

The vulnerability is particularly severe because:

1. **Permanent damage**: Once genesis is deployed with zero minimum gas price, it becomes the canonical on-chain configuration
2. **No runtime override**: Client-side defaults don't matter; validators enforce the on-chain schedule
3. **Multiple TODOs acknowledge risk**: The codebase contains comments like "TODO(Gas): should probably change this to something > 0" and "TODO(Gas): check if gas schedule is consistent", indicating awareness of potential issues
4. **Feature flag chain**: The `testing` feature propagates through multiple crates (`aptos-gas-schedule` â†’ `aptos-global-constants`), creating multiple injection points

This finding demonstrates how build-time configuration can create critical vulnerabilities in blockchain systems where genesis state is immutable.

### Citations

**File:** config/global-constants/src/lib.rs (L23-26)
```rust
#[cfg(any(test, feature = "testing"))]
pub const GAS_UNIT_PRICE: u64 = 0;
#[cfg(not(any(test, feature = "testing")))]
pub const GAS_UNIT_PRICE: u64 = 100;
```

**File:** config/global-constants/Cargo.toml (L15-17)
```text
[features]
default = []
testing = []
```

**File:** aptos-move/aptos-gas-schedule/src/gas_schedule/transaction.rs (L59-65)
```rust
        // The minimum gas price that a transaction can be submitted with.
        // TODO(Gas): should probably change this to something > 0
        [
            min_price_per_gas_unit: FeePerGasUnit,
            "min_price_per_gas_unit",
            aptos_global_constants::GAS_UNIT_PRICE
        ],
```

**File:** aptos-move/vm-genesis/src/lib.rs (L128-133)
```rust
pub fn default_gas_schedule() -> GasScheduleV2 {
    GasScheduleV2 {
        feature_version: LATEST_GAS_FEATURE_VERSION,
        entries: AptosGasParameters::initial().to_on_chain_gas_schedule(LATEST_GAS_FEATURE_VERSION),
    }
}
```

**File:** aptos-move/aptos-vm/src/gas.rs (L174-192)
```rust
    // The submitted gas price is less than the minimum gas unit price set by the VM.
    // NB: MIN_PRICE_PER_GAS_UNIT may equal zero, but need not in the future. Hence why
    // we turn off the clippy warning.
    #[allow(clippy::absurd_extreme_comparisons)]
    let below_min_bound = txn_metadata.gas_unit_price() < txn_gas_params.min_price_per_gas_unit;
    if below_min_bound {
        speculative_warn!(
            log_context,
            format!(
                "[VM] Gas unit error; min {}, submitted {}",
                txn_gas_params.min_price_per_gas_unit,
                txn_metadata.gas_unit_price()
            ),
        );
        return Err(VMStatus::error(
            StatusCode::GAS_UNIT_PRICE_BELOW_MIN_BOUND,
            None,
        ));
    }
```

**File:** aptos-move/framework/aptos-framework/sources/configs/gas_schedule.move (L42-50)
```text
    /// Only called during genesis.
    public(friend) fun initialize(aptos_framework: &signer, gas_schedule_blob: vector<u8>) {
        system_addresses::assert_aptos_framework(aptos_framework);
        assert!(!vector::is_empty(&gas_schedule_blob), error::invalid_argument(EINVALID_GAS_SCHEDULE));

        // TODO(Gas): check if gas schedule is consistent
        let gas_schedule: GasScheduleV2 = from_bytes(gas_schedule_blob);
        move_to<GasScheduleV2>(aptos_framework, gas_schedule);
    }
```

**File:** aptos-move/aptos-gas-schedule/Cargo.toml (L22-23)
```text
[features]
testing = ["aptos-global-constants/testing"]
```
