# Audit Report

## Title
Undisclosed Third-Party Data Sharing: Validator Operational Data Sent to Google Analytics Without Explicit Operator Consent

## Summary
The Aptos node telemetry system sends validator operational data to Google Analytics (GA4) when the telemetry service is not configured for a particular chain ID, without explicit disclosure in validator deployment documentation. This creates a transparency gap where validator operators may be unaware their node's operational metrics are shared with a third-party service.

## Finding Description

The telemetry system in Aptos has a fallback mechanism that sends operational data to Google Analytics when validators run on chains not explicitly configured in the telemetry service. [1](#0-0) 

When the chain ID is not configured for the telemetry service, the code creates a separate sender specifically for GA4: [2](#0-1) 

The data sent to Google Analytics includes sensitive validator operational information:

**Core Metrics** (sent every 30 seconds): [3](#0-2) 

**Network Metrics** (sent every 60 seconds): [4](#0-3) 

**System Information** (sent every 5 minutes): [5](#0-4) 

**Complete Node Configuration** (sent every 60 minutes): [6](#0-5) 

The telemetry can be disabled via environment variable, but this is not documented in validator setup guides: [7](#0-6) 

The Helm chart deployment documentation mentions a `force_enable_telemetry` flag but provides no information about Google Analytics data sharing: [8](#0-7) 

Neither the AWS nor GCP validator deployment guides mention telemetry or data sharing with third parties.

## Impact Explanation
This is classified as **Low Severity** per the Aptos bug bounty program criteria as it constitutes a minor information leak and transparency issue. While it does not affect consensus safety, transaction execution, or fund security, it represents:

1. **Privacy concerns**: Validator operators may not consent to sharing operational metrics with Google
2. **Regulatory compliance**: Some jurisdictions may require explicit consent for third-party data sharing
3. **Competitive intelligence**: Operational metrics could reveal validator performance characteristics
4. **Trust implications**: Undisclosed data sharing undermines operator trust

The data shared includes peer IDs, consensus rounds, network topology information, and system specifications that validators may consider sensitive.

## Likelihood Explanation
This affects **all validators** running on chains where the telemetry service is not explicitly configured, unless they proactively set `APTOS_DISABLE_TELEMETRY=true`. Given that:

1. The environment variable is not documented in deployment guides
2. Telemetry is enabled by default
3. The fallback to GA4 is not disclosed
4. Many smaller chains/testnets may not have telemetry service configured

The likelihood of validators unknowingly sharing data with Google is **high**.

## Recommendation

1. **Add explicit disclosure** in all validator deployment documentation (AWS, GCP, Helm) about telemetry data collection and third-party sharing
2. **Document the opt-out mechanism** prominently in setup guides
3. **Consider requiring explicit opt-in** for GA4 telemetry rather than making it the default fallback
4. **Provide a privacy policy** linked from documentation explaining what data is collected and where it's sent
5. **Add startup logging** that clearly indicates when data is being sent to Google Analytics

Example documentation addition:
```markdown
## Telemetry and Privacy

By default, Aptos nodes send operational telemetry data including consensus 
metrics, network statistics, and system information to analytics services. 
For chains without dedicated telemetry infrastructure, this data is sent to 
Google Analytics.

To disable telemetry, set:
```bash
export APTOS_DISABLE_TELEMETRY=true
```

For more information, see our [Privacy Policy](link).
```

## Proof of Concept

Deploy a validator on a testnet without telemetry service configuration:

```bash
# Deploy validator without setting APTOS_DISABLE_TELEMETRY
helm install my-validator aptos-node/

# Monitor network traffic - you'll observe HTTPS requests to:
# https://www.google-analytics.com/mp/collect?measurement_id=G-ZX4L6WPCFZ&api_secret=...

# The requests contain validator operational data in JSON format including:
# - Peer ID
# - Chain ID  
# - Consensus metrics (rounds, proposals, timeouts)
# - Network connections and traffic
# - System specifications
# - Node configuration
```

To verify the data flow:
1. Deploy validator without disabling telemetry
2. Check logs for "Sent telemetry event" messages
3. Capture network traffic to observe GA4 requests
4. Set `APTOS_DISABLE_TELEMETRY=true` and verify traffic stops

## Notes

- This is a **transparency and documentation issue**, not a protocol vulnerability
- No consensus, execution, or state management invariants are broken
- The telemetry system itself is functioning as designed
- The issue is the lack of disclosure to validator operators
- Validators can opt out by setting the environment variable, but this mechanism is undocumented in deployment guides
- The hardcoded GA4 credentials in the code suggest this is intentional infrastructure, but lacks corresponding operator notification

### Citations

**File:** crates/aptos-telemetry/src/constants.rs (L7-7)
```rust
pub(crate) const ENV_APTOS_DISABLE_TELEMETRY: &str = "APTOS_DISABLE_TELEMETRY";
```

**File:** crates/aptos-telemetry/src/constants.rs (L30-30)
```rust
pub(crate) const GA4_URL: &str = "https://www.google-analytics.com/mp/collect";
```

**File:** crates/aptos-telemetry/src/service.rs (L170-196)
```rust
    if !force_enable_telemetry() && !telemetry_sender.check_chain_access(chain_id).await {
        warn!(
                "Aptos telemetry is not sent to the telemetry service because the service is not configured for chain ID {}",
                chain_id
            );
        // Spawn the custom event sender to send to GA4 only.
        // This is a temporary workaround while we deprecate and remove GA4 completely.
        let peer_id = fetch_peer_id(&node_config);
        let handle = tokio::spawn(custom_event_sender(
            None,
            peer_id,
            chain_id,
            node_config.clone(),
            build_info.clone(),
        ));
        info!("Telemetry service for GA4 started!");

        // Check for chain access periodically in case the service is configured later
        let mut interval = time::interval(Duration::from_secs(CHAIN_ACCESS_CHECK_FREQ_SECS));
        loop {
            interval.tick().await;
            if telemetry_sender.check_chain_access(chain_id).await {
                handle.abort();
                info!("Aptos telemetry service is now configured for Chain ID {}. Starting telemetry service...", chain_id);
                break;
            }
        }
```

**File:** crates/aptos-telemetry/src/service.rs (L372-396)
```rust
async fn send_node_config(
    peer_id: String,
    chain_id: String,
    node_config: &NodeConfig,
    telemetry_sender: Option<TelemetrySender>,
) {
    let node_config: BTreeMap<String, String> = serde_json::to_value(node_config)
        .map(|value| {
            value
                .as_object()
                .map(|obj| {
                    obj.into_iter()
                        .map(|(k, v)| (k.clone(), v.to_string()))
                        .collect::<BTreeMap<String, String>>()
                })
                .unwrap_or_default()
        })
        .unwrap_or_default();

    let telemetry_event = TelemetryEvent {
        name: APTOS_NODE_CONFIG_EVENT_NAME.into(),
        params: node_config,
    };
    prepare_and_send_telemetry_event(peer_id, chain_id, telemetry_sender, telemetry_event).await;
}
```

**File:** crates/aptos-telemetry/src/core_metrics.rs (L15-31)
```rust
const CONSENSUS_LAST_COMMITTED_ROUND: &str = "consensus_last_committed_round";
const CONSENSUS_PROPOSALS_COUNT: &str = "consensus_proposals_count";
const CONSENSUS_TIMEOUT_COUNT: &str = "consensus_timeout_count";
const MEMPOOL_CORE_MEMPOOL_INDEX_SIZE: &str = "mempool_core_mempool_index_size";
const REST_RESPONSE_COUNT: &str = "rest_response_count";
const ROLE_TYPE: &str = "role_type";
const STATE_SYNC_BOOTSTRAP_MODE: &str = "state_sync_bootstrap_mode";
const STATE_SYNC_CODE_VERSION: &str = "state_sync_code_version";
const STATE_SYNC_CONTINUOUS_SYNC_MODE: &str = "state_sync_continuous_sync_mode";
const STATE_SYNC_SYNCED_VERSION: &str = "state_sync_synced_version";
const STATE_SYNC_SYNCED_EPOCH: &str = "state_sync_synced_epoch";
const STORAGE_LEDGER_VERSION: &str = "storage_ledger_version";
const STORAGE_MIN_READABLE_LEDGER_VERSION: &str = "storage_min_readable_ledger_version";
const STORAGE_MIN_READABLE_STATE_MERKLE_VERSION: &str = "storage_min_readable_state_merkle_version";
const STORAGE_MIN_READABLE_STATE_KV_VERSION: &str = "storage_min_readable_state_kv_version";
const TELEMETRY_FAILURE_COUNT: &str = "telemetry_failure_count";
const TELEMETRY_SUCCESS_COUNT: &str = "telemetry_success_count";
```

**File:** crates/aptos-telemetry/src/network_metrics.rs (L12-18)
```rust
/// Network metric keys
const NETWORK_INBOUND_CONNECTIONS: &str = "network_inbound_connections";
const NETWORK_INBOUND_MESSAGE_SUM: &str = "network_inbound_message_sum";
const NETWORK_INBOUND_TRAFFIC_SUM: &str = "network_inbound_traffic_sum";
const NETWORK_OUTBOUND_CONNECTIONS: &str = "network_outbound_connections";
const NETWORK_OUTBOUND_MESSAGE_SUM: &str = "network_outbound_message_sum";
const NETWORK_OUTBOUND_TRAFFIC_SUM: &str = "network_outbound_traffic_sum";
```

**File:** crates/aptos-telemetry/src/system_information.rs (L14-33)
```rust
/// System information keys
const CPU_BRAND: &str = "cpu_brand";
const CPU_COUNT: &str = "cpu_count";
const CPU_CORE_COUNT: &str = "cpu_core_count";
const CPU_FREQUENCY: &str = "cpu_frequency";
const CPU_NAME: &str = "cpu_name";
const CPU_VENDOR_ID: &str = "cpu_vendor_id";
const DISK_AVAILABLE_SPACE: &str = "disk_available_space";
const DISK_COUNT: &str = "disk_count";
const DISK_FILE_SYSTEM: &str = "disk_file_system";
const DISK_NAME: &str = "disk_name";
const DISK_TOTAL_SPACE: &str = "disk_total_space";
const DISK_TYPE: &str = "disk_type";
const MEMORY_AVAILABLE: &str = "memory_available";
const MEMORY_TOTAL: &str = "memory_total";
const MEMORY_USED: &str = "memory_used";
const SYSTEM_HOST_NAME: &str = "system_host_name";
const SYSTEM_KERNEL_VERSION: &str = "system_kernel_version";
const SYSTEM_NAME: &str = "system_name";
const SYSTEM_OS_VERSION: &str = "system_os_version";
```

**File:** terraform/helm/aptos-node/values.yaml (L83-84)
```yaml
  # -- Flag to force enable telemetry service (useful for forge tests)
  force_enable_telemetry: false
```
