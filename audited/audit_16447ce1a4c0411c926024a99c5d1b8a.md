# Audit Report

## Title
Delegation Pool Partial Governance Voting Feature Flag Bypass Allows Voting Under Disabled Feature

## Summary
The on-chain Move code for delegation pools does not enforce the global `DELEGATION_POOL_PARTIAL_GOVERNANCE_VOTING` feature flag when enabling partial governance voting or executing voting operations. This allows delegation pools to enable and use partial governance voting functionality even when the feature flag is globally disabled, bypassing the intended governance safety mechanism.

## Finding Description

The delegation pool implementation contains a critical feature flag enforcement gap that breaks the **Governance Integrity** invariant:

**Off-chain check (CLI only):**
The CLI tool checks if the feature flag is enabled before allowing delegation pool governance operations. [1](#0-0) 

**On-chain enforcement failure:**

1. **Pool initialization always enables partial governance voting without checking the feature flag:** [2](#0-1) 

The comment states "once the feature flag is enabled" but the code doesn't actually check it.

2. **The `enable_partial_governance_voting()` function is permissionless and doesn't check the feature flag:** [3](#0-2) 

3. **Voting functions only check if `GovernanceRecords` exists, not the global feature flag:** [4](#0-3) [5](#0-4) 

4. **The global feature flag exists but is never checked on-chain:** [6](#0-5) 

**Attack Scenarios:**

1. **Pool creation when feature is disabled:** An attacker creates a delegation pool when `DELEGATION_POOL_PARTIAL_GOVERNANCE_VOTING` is disabled, but `initialize_delegation_pool()` unconditionally enables partial governance voting.

2. **Manual enablement bypass:** Anyone can call the permissionless `enable_partial_governance_voting(pool_address)` function even when the feature flag is globally disabled.

3. **Post-disable exploitation:** If the feature flag is disabled due to discovery of a critical bug in partial governance voting logic, pools that previously enabled it can continue to exploit the vulnerability because the on-chain code never re-checks the global feature flag.

## Impact Explanation

**Severity: Critical**

This vulnerability qualifies as **Critical** severity under the Aptos bug bounty program because it constitutes a **Governance/Safety violation**:

1. **Feature Flag Bypass:** Feature flags are the primary mechanism for emergency disabling of problematic features. This bypass renders that safety mechanism ineffective for delegation pool governance.

2. **Governance Integrity Violation:** Pools can vote on proposals using functionality that has been intentionally disabled at the protocol level, violating the "Governance Integrity" invariant.

3. **Inability to Mitigate Discovered Bugs:** If a critical security vulnerability is discovered in the partial governance voting implementation, disabling the feature flag would not prevent exploitation by pools that have already enabled it.

4. **Consensus Safety Risk:** If the buggy partial governance voting code causes consensus divergence (e.g., different validators computing different voting power), and the feature flag is disabled to prevent this, the pools can still trigger consensus splits.

## Likelihood Explanation

**Likelihood: High**

1. **Easy to Exploit:** Any user can create a delegation pool at any time, and the vulnerability triggers automatically during pool creation. The `enable_partial_governance_voting()` function is also permissionless.

2. **No Special Privileges Required:** Does not require validator access, governance permissions, or any special capabilities.

3. **Persistent Vulnerability:** Once a pool has enabled partial governance voting, there is no mechanism to disable it, even if the global feature flag is turned off.

4. **Real Operational Risk:** Feature flags are frequently toggled during mainnet operations when bugs are discovered or during phased rollouts. This vulnerability would be triggered in any such scenario.

## Recommendation

**Fix 1: Add feature flag check to `enable_partial_governance_voting()`:**

```move
public entry fun enable_partial_governance_voting(
    pool_address: address,
) acquires DelegationPool, GovernanceRecords, BeneficiaryForOperator, NextCommissionPercentage {
    assert_delegation_pool_exists(pool_address);
    // Add this check:
    assert!(
        features::delegation_pool_partial_governance_voting_enabled(),
        error::invalid_state(EDELEGATION_POOL_PARTIAL_GOVERNANCE_VOTING_NOT_SUPPORTED)
    );
    
    synchronize_delegation_pool(pool_address);
    // ... rest of function
}
```

**Fix 2: Add feature flag check to voting functions:**

```move
fun assert_partial_governance_voting_enabled(pool_address: address) {
    assert_delegation_pool_exists(pool_address);
    // Add global feature flag check:
    assert!(
        features::delegation_pool_partial_governance_voting_enabled(),
        error::invalid_state(EDELEGATION_POOL_PARTIAL_GOVERNANCE_VOTING_DISABLED)
    );
    assert!(
        partial_governance_voting_enabled(pool_address),
        error::invalid_state(EPARTIAL_GOVERNANCE_VOTING_NOT_ENABLED)
    );
}
```

**Fix 3: Modify `initialize_delegation_pool()` to conditionally enable:**

```move
// At the end of initialize_delegation_pool:
if (features::delegation_pool_partial_governance_voting_enabled()) {
    enable_partial_governance_voting(pool_address);
};
```

## Proof of Concept

```move
#[test_only]
module aptos_framework::delegation_pool_feature_flag_bypass_test {
    use aptos_framework::delegation_pool;
    use aptos_framework::account;
    use std::features;
    use std::signer;
    
    #[test(aptos_framework = @aptos_framework, owner = @0x123)]
    fun test_pool_enables_voting_when_feature_disabled(
        aptos_framework: &signer,
        owner: &signer,
    ) {
        // Setup: Initialize framework with feature flag DISABLED
        features::change_feature_flags_for_testing(
            aptos_framework, 
            vector[], // enable nothing
            vector[features::get_delegation_pool_partial_governance_voting()] // disable this
        );
        
        // Verify feature flag is disabled
        assert!(!features::delegation_pool_partial_governance_voting_enabled(), 1);
        
        // Create delegation pool - this should fail but doesn't!
        delegation_pool::initialize_delegation_pool(
            owner,
            0, // 0% commission
            b"seed"
        );
        
        let pool_address = delegation_pool::get_owned_pool_address(signer::address_of(owner));
        
        // VULNERABILITY: Pool has partial governance voting enabled 
        // even though the global feature flag is disabled!
        assert!(delegation_pool::partial_governance_voting_enabled(pool_address), 2);
        
        // Pool can now vote on proposals bypassing the disabled feature flag
    }
    
    #[test(anyone = @0x456)]
    fun test_permissionless_enable_bypasses_feature_flag(anyone: &signer) {
        // Setup: Feature flag disabled, pool exists
        // ...
        
        // VULNERABILITY: Anyone can enable partial governance voting
        // even when the feature flag is disabled
        delegation_pool::enable_partial_governance_voting(existing_pool_address);
        
        assert!(delegation_pool::partial_governance_voting_enabled(existing_pool_address), 1);
    }
}
```

**Notes**

This vulnerability represents a fundamental breakdown in the feature flag safety mechanism. The discrepancy between the off-chain CLI checks and on-chain enforcement creates a false sense of security. Feature flags in blockchain systems must be enforced at the consensus layer (on-chain) to be effective, as off-chain checks can be bypassed by submitting transactions directly to the network.

The comment at line 919 explicitly states the intended behavior ("once the feature flag is enabled") but the implementation fails to enforce this, suggesting this is an implementation bug rather than an intentional design decision.

### Citations

**File:** crates/aptos/src/governance/delegation_pool.rs (L187-191)
```rust
    if !is_delegation_pool_partial_governance_voting_enabled(client).await? {
        return Err(CliError::CommandArgumentError(
            "Delegation pool partial governance voting feature flag is not enabled".to_string(),
        ));
    };
```

**File:** aptos-move/framework/aptos-framework/sources/delegation_pool.move (L536-540)
```text
    #[view]
    /// Return whether a delegation pool has already enabled partial governance voting.
    public fun partial_governance_voting_enabled(pool_address: address): bool {
        exists<GovernanceRecords>(pool_address) && stake::get_delegated_voter(pool_address) == pool_address
    }
```

**File:** aptos-move/framework/aptos-framework/sources/delegation_pool.move (L919-920)
```text
        // All delegation pool enable partial governance voting by default once the feature flag is enabled.
        enable_partial_governance_voting(pool_address);
```

**File:** aptos-move/framework/aptos-framework/sources/delegation_pool.move (L933-938)
```text
    /// Enable partial governance voting on a stake pool. The voter of this stake pool will be managed by this module.
    /// The existing voter will be replaced. The function is permissionless.
    public entry fun enable_partial_governance_voting(
        pool_address: address,
    ) acquires DelegationPool, GovernanceRecords, BeneficiaryForOperator, NextCommissionPercentage {
        assert_delegation_pool_exists(pool_address);
```

**File:** aptos-move/framework/aptos-framework/sources/delegation_pool.move (L1098-1104)
```text
    fun assert_partial_governance_voting_enabled(pool_address: address) {
        assert_delegation_pool_exists(pool_address);
        assert!(
            partial_governance_voting_enabled(pool_address),
            error::invalid_state(EPARTIAL_GOVERNANCE_VOTING_NOT_ENABLED)
        );
    }
```

**File:** aptos-move/framework/move-stdlib/sources/configs/features.move (L209-217)
```text
    /// Whether enable paritial governance voting on delegation_pool.
    /// Lifetime: transient
    const DELEGATION_POOL_PARTIAL_GOVERNANCE_VOTING: u64 = 21;

    public fun get_delegation_pool_partial_governance_voting(): u64 { DELEGATION_POOL_PARTIAL_GOVERNANCE_VOTING }

    public fun delegation_pool_partial_governance_voting_enabled(): bool acquires Features {
        is_enabled(DELEGATION_POOL_PARTIAL_GOVERNANCE_VOTING)
    }
```
