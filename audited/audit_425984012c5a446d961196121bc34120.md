# Audit Report

## Title
Event Spam Attack: Zero Storage Fees Enable Massive Event Emission at Negligible Cost

## Summary
The Aptos blockchain charges only 89 internal gas units per byte for event emission (IO cost) with ZERO storage fees when the `REFUNDABLE_BYTES` feature is enabled (default configuration). This allows attackers to emit up to 10 MB of events per transaction for approximately 0.00093 APT (~$0.01 USD), enabling sustained storage bloat attacks that can exhaust validator disk space and degrade network performance at extremely low cost.

## Finding Description
The vulnerability exists in the gas pricing model for event storage, specifically in how storage fees are calculated when `DiskSpacePricing::V2` is active. [1](#0-0) 

The `storage_io_per_event_byte_write` parameter is set to only 89 internal gas units per byte for IO operations. However, the critical issue is that storage fees for events are completely waived under the V2 pricing model: [2](#0-1) 

The `REFUNDABLE_BYTES` feature flag is enabled by default in the genesis configuration: [3](#0-2) 

This creates a severe pricing asymmetry. An attacker can emit the maximum 10 MB of events per transaction at the following cost:

**Cost Calculation:**
- Max event size per transaction: 10,485,760 bytes (10 MB) [4](#0-3) 

- IO gas cost: 10,485,760 bytes × 89 gas/byte = 933,232,640 internal gas units
- External gas units: 933,232,640 ÷ 1,000,000 (scaling factor) = 933.23 gas units
- Cost in octas: 933.23 × 100 = 93,323 octas ≈ 0.00093 APT

**Storage Impact:**
Events are stored with a default pruning window of 90 million versions: [5](#0-4) 

At 5,000 TPS, this represents approximately 5 hours of transaction history. An attacker sustaining 10 TPS (0.2% of network capacity) would create:
- Transactions in window: 10 TPS × 18,000 seconds = 180,000 transactions
- Total event storage: 180,000 × 10 MB = **1.8 TB of event data**
- Total cost: 180,000 × 0.00093 APT ≈ **168 APT (~$1,680 at $10/APT)**

This represents approximately **$0.93 per GB of storage for 5 hours**, which is orders of magnitude cheaper than state writes and can easily overwhelm validator disk capacity.

**Attack Execution:**
1. Attacker creates transactions that emit 10 MB of events each
2. Events must not exceed per-event (1 MB) and per-transaction (10 MB) limits: [6](#0-5) 

3. IO gas limit validation allows up to 1 billion internal gas units: [7](#0-6) 

4. Events are charged via `io_gas_per_event` with only per-byte IO cost: [8](#0-7) 

## Impact Explanation
This vulnerability qualifies as **High Severity** per Aptos bug bounty criteria ("Validator node slowdowns") with potential escalation to storage exhaustion:

**Immediate Impact:**
- **Validator Disk Exhaustion**: Sustained attacks can fill validator disk space within hours, potentially causing node failures
- **Database Bloat**: Even with pruning, continuous spam maintains large database sizes (multi-TB)
- **Sync Performance Degradation**: New nodes must download and process all events within the pruning window, significantly slowing sync times
- **I/O Pressure**: Large event databases strain disk I/O, degrading validator performance

**Network-Wide Impact:**
- Multiple coordinated attackers could amplify the effect by orders of magnitude
- Affects all validators simultaneously as events are replicated across the network
- Could trigger cascading failures if validators exhaust disk space

**Broken Invariant:**
This violates **Critical Invariant #9**: "Resource Limits: All operations must respect gas, storage, and computational limits." The gas cost (0.00093 APT) is disproportionately low compared to the storage burden imposed (10 MB), enabling resource exhaustion attacks.

## Likelihood Explanation
**Likelihood: High**

**Attack Feasibility:**
- Requires minimal resources: ~$2,000 can create 1.8 TB of storage load for 5 hours
- No special permissions or validator access required
- Simple to execute: standard transaction submission with large event payloads
- Can be automated for sustained attacks
- Multiple attackers can coordinate for amplified impact

**Barriers:**
- Attacker must sustain transaction submissions (but mempool selection is probabilistic)
- Network may throttle spam transactions (but with sufficient gas payment, transactions will be included)
- Cost increases linearly with attack duration

**Real-World Scenarios:**
- Malicious actor targeting network disruption
- Accidental misconfiguration in dApp causing event spam
- Economic griefing attacks against validators

## Recommendation
Implement a multi-layered fix:

**1. Restore Storage Fees for Events in V2 Pricing:**
Modify `DiskSpacePricing::legacy_storage_fee_per_event` to charge storage fees even under V2 pricing:

```rust
// In aptos-move/aptos-vm-types/src/storage/space_pricing.rs
pub fn legacy_storage_fee_per_event(
    &self,
    params: &TransactionGasParameters,
    event: &ContractEvent,
) -> Fee {
    match self {
        Self::V1 => {
            NumBytes::new(event.size() as u64) * params.legacy_storage_fee_per_event_byte
        },
        Self::V2 => {
            // FIX: Charge storage fees for events even in V2
            NumBytes::new(event.size() as u64) * params.storage_fee_per_state_byte
        },
    }
}
```

**2. Increase IO Gas Cost:**
Raise `storage_io_per_event_byte_write` from 89 to at least 500-1000 gas per byte to better reflect actual storage costs:

```rust
// In aptos-move/aptos-gas-schedule/src/gas_schedule/transaction.rs
[
    storage_io_per_event_byte_write: InternalGasPerByte,
    { RELEASE_V1_11.. => "storage_io_per_event_byte_write" },
    500,  // Increased from 89
],
```

**3. Reduce Per-Transaction Event Limit:**
Lower `max_bytes_all_events_per_transaction` from 10 MB to 1-2 MB:

```rust
[
    max_bytes_all_events_per_transaction: NumBytes,
    { 5.. => "max_bytes_all_events_per_transaction"},
    2 << 20, // 2MB instead of 10MB
],
```

**4. Consider Dynamic Event Pricing:**
Implement storage-based pricing that scales with total event storage size, similar to state storage refund mechanisms.

## Proof of Concept

```move
// File: event_spam_attack.move
// Demonstrates event spam attack emitting 10 MB per transaction

module attacker::event_spam {
    use std::vector;
    use aptos_framework::event;

    struct LargeEvent has drop, store {
        data: vector<u8>,
    }

    public entry fun spam_events(account: &signer) {
        // Emit 10 events, each 1 MB (max per event)
        let i = 0;
        while (i < 10) {
            // Create 1 MB of data (1,048,576 bytes)
            let large_data = vector::empty<u8>();
            let j = 0;
            while (j < 1048576) {
                vector::push_back(&mut large_data, 0xFF);
                j = j + 1;
            };
            
            event::emit(LargeEvent { data: large_data });
            i = i + 1;
        };
        // Total: 10 MB of events emitted
        // Cost: ~0.00093 APT per transaction
        // Impact: 10 MB added to every validator's event database
    }
}
```

**Execution Steps:**
1. Deploy the module to the blockchain
2. Submit transactions calling `spam_events` at 10 TPS
3. Monitor validator disk usage growth: ~60 GB/hour with 10 TPS
4. Observe performance degradation as database grows
5. After 5 hours at 5000 TPS, events begin pruning but continuous spam maintains bloat

**Expected Result:**
- Each transaction costs ~0.00093 APT but creates 10 MB of persistent storage
- Validators experience disk space consumption at ~$0.93 per GB for 5-hour retention
- Database sizes grow to multi-TB scale under sustained attack
- Sync times for new nodes increase proportionally with event database size

## Notes

The vulnerability stems from a design decision in the `REFUNDABLE_BYTES` feature (V2 pricing) that eliminated storage fees for events entirely while keeping IO gas costs extremely low. While events are eventually pruned (90M version window), the combination of zero storage fees and minimal IO cost creates an exploitable pricing asymmetry.

This issue is particularly concerning because:
1. It affects the entire validator network simultaneously
2. The attack cost-to-impact ratio is extremely favorable for attackers
3. No special privileges are required to execute the attack
4. The impact persists for hours even after the attack stops (pruning window)
5. Multiple attackers can coordinate to amplify the effect

The recommended fixes restore proper economic incentives while maintaining the benefits of the V2 pricing model for legitimate use cases.

### Citations

**File:** aptos-move/aptos-gas-schedule/src/gas_schedule/transaction.rs (L133-136)
```rust
            storage_io_per_event_byte_write: InternalGasPerByte,
            { RELEASE_V1_11.. => "storage_io_per_event_byte_write" },
            89,
        ],
```

**File:** aptos-move/aptos-gas-schedule/src/gas_schedule/transaction.rs (L169-172)
```rust
            max_bytes_all_events_per_transaction: NumBytes,
            { 5.. => "max_bytes_all_events_per_transaction"},
            10 << 20, // all events from a single transaction are 10MB max
        ],
```

**File:** aptos-move/aptos-gas-schedule/src/gas_schedule/transaction.rs (L221-224)
```rust
            max_io_gas: InternalGas,
            { 7.. => "max_io_gas" },
            1_000_000_000, // 100ms of IO at 10k gas per ms
        ],
```

**File:** aptos-move/aptos-vm-types/src/storage/space_pricing.rs (L57-69)
```rust
    /// Calculates the storage fee for an event.
    pub fn legacy_storage_fee_per_event(
        &self,
        params: &TransactionGasParameters,
        event: &ContractEvent,
    ) -> Fee {
        match self {
            Self::V1 => {
                NumBytes::new(event.size() as u64) * params.legacy_storage_fee_per_event_byte
            },
            Self::V2 => 0.into(),
        }
    }
```

**File:** types/src/on_chain_config/aptos_features.rs (L171-222)
```rust
    pub fn default_features() -> Vec<Self> {
        vec![
            FeatureFlag::CODE_DEPENDENCY_CHECK,
            FeatureFlag::TREAT_FRIEND_AS_PRIVATE,
            FeatureFlag::SHA_512_AND_RIPEMD_160_NATIVES,
            FeatureFlag::APTOS_STD_CHAIN_ID_NATIVES,
            // Feature flag V6 is used to enable metadata v1 format and needs to stay on, even
            // if we enable a higher version.
            FeatureFlag::VM_BINARY_FORMAT_V6,
            FeatureFlag::VM_BINARY_FORMAT_V7,
            FeatureFlag::MULTI_ED25519_PK_VALIDATE_V2_NATIVES,
            FeatureFlag::BLAKE2B_256_NATIVE,
            FeatureFlag::RESOURCE_GROUPS,
            FeatureFlag::MULTISIG_ACCOUNTS,
            FeatureFlag::DELEGATION_POOLS,
            FeatureFlag::CRYPTOGRAPHY_ALGEBRA_NATIVES,
            FeatureFlag::BLS12_381_STRUCTURES,
            FeatureFlag::ED25519_PUBKEY_VALIDATE_RETURN_FALSE_WRONG_LENGTH,
            FeatureFlag::STRUCT_CONSTRUCTORS,
            FeatureFlag::PERIODICAL_REWARD_RATE_DECREASE,
            FeatureFlag::PARTIAL_GOVERNANCE_VOTING,
            FeatureFlag::_SIGNATURE_CHECKER_V2,
            FeatureFlag::STORAGE_SLOT_METADATA,
            FeatureFlag::CHARGE_INVARIANT_VIOLATION,
            FeatureFlag::DELEGATION_POOL_PARTIAL_GOVERNANCE_VOTING,
            FeatureFlag::APTOS_UNIQUE_IDENTIFIERS,
            FeatureFlag::GAS_PAYER_ENABLED,
            FeatureFlag::BULLETPROOFS_NATIVES,
            FeatureFlag::SIGNER_NATIVE_FORMAT_FIX,
            FeatureFlag::MODULE_EVENT,
            FeatureFlag::EMIT_FEE_STATEMENT,
            FeatureFlag::STORAGE_DELETION_REFUND,
            FeatureFlag::SIGNATURE_CHECKER_V2_SCRIPT_FIX,
            FeatureFlag::AGGREGATOR_V2_API,
            FeatureFlag::SAFER_RESOURCE_GROUPS,
            FeatureFlag::SAFER_METADATA,
            FeatureFlag::SINGLE_SENDER_AUTHENTICATOR,
            FeatureFlag::SPONSORED_AUTOMATIC_ACCOUNT_V1_CREATION,
            FeatureFlag::FEE_PAYER_ACCOUNT_OPTIONAL,
            FeatureFlag::AGGREGATOR_V2_DELAYED_FIELDS,
            FeatureFlag::CONCURRENT_TOKEN_V2,
            FeatureFlag::LIMIT_MAX_IDENTIFIER_LENGTH,
            FeatureFlag::OPERATOR_BENEFICIARY_CHANGE,
            FeatureFlag::BN254_STRUCTURES,
            FeatureFlag::RESOURCE_GROUPS_SPLIT_IN_VM_CHANGE_SET,
            FeatureFlag::COMMISSION_CHANGE_DELEGATION_POOL,
            FeatureFlag::WEBAUTHN_SIGNATURE,
            FeatureFlag::KEYLESS_ACCOUNTS,
            FeatureFlag::FEDERATED_KEYLESS,
            FeatureFlag::KEYLESS_BUT_ZKLESS_ACCOUNTS,
            FeatureFlag::JWK_CONSENSUS,
            FeatureFlag::REFUNDABLE_BYTES,
```

**File:** config/src/config/storage_config.rs (L387-395)
```rust
impl Default for LedgerPrunerConfig {
    fn default() -> Self {
        LedgerPrunerConfig {
            enable: true,
            prune_window: 90_000_000,
            batch_size: 5_000,
            user_pruning_window_offset: 200_000,
        }
    }
```

**File:** aptos-move/aptos-vm-types/src/storage/change_set_configs.rs (L115-125)
```rust
        let mut total_event_size = 0;
        for event in change_set.events_iter() {
            let size = event.event_data().len() as u64;
            if size > self.max_bytes_per_event {
                return storage_write_limit_reached(None);
            }
            total_event_size += size;
            if total_event_size > self.max_bytes_all_events_per_transaction {
                return storage_write_limit_reached(None);
            }
        }
```

**File:** aptos-move/aptos-vm-types/src/storage/io_pricing.rs (L296-301)
```rust
    pub fn io_gas_per_event(
        &self,
        event: &ContractEvent,
    ) -> impl GasExpression<VMGasParameters, Unit = InternalGasUnit> + use<> {
        STORAGE_IO_PER_EVENT_BYTE_WRITE * NumBytes::new(event.size() as u64)
    }
```
