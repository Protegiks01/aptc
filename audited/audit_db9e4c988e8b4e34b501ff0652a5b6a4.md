# Audit Report

## Title
Path Traversal Vulnerability in Move CLI New Command Allows Arbitrary File Creation

## Summary
The `move new` command in the Move CLI does not validate project names or paths, allowing attackers to exploit path traversal sequences to create Move packages and files in arbitrary filesystem locations accessible to the user.

## Finding Description

The Move CLI's `New` command accepts project names without any validation for path traversal sequences or malicious characters. [1](#0-0) 

When a project is created, the name is used directly as a filesystem path without sanitization: [2](#0-1) 

The code then creates directories and files using this unvalidated path: [3](#0-2) 

An attacker can provide a project name containing path traversal sequences (e.g., `../../../tmp/malicious`), causing the tool to create directories and files outside the intended location.

**Attack Flow:**
1. Attacker convinces user to run: `move new ../../../tmp/malicious` or provides this in a tutorial/script
2. The CLI creates `../../../tmp/malicious/sources/` directory
3. The CLI creates `../../../tmp/malicious/Move.toml` file
4. Files are created in attacker-controlled locations relative to the user's current directory

Additionally, the project name is written directly into the `Move.toml` file without escaping: [4](#0-3) 

This allows TOML structure injection if the name contains quotes and newlines, though the PackageName validation during parsing would later reject malformed names: [5](#0-4) 

## Impact Explanation

This vulnerability does **not** meet the Aptos Bug Bounty severity criteria because:

1. **No blockchain impact**: This is a client-side development tool vulnerability that does not affect on-chain operations, consensus, Move VM execution, or state management
2. **No funds at risk**: Cannot cause loss, theft, or minting of tokens
3. **No protocol violations**: Does not affect validator operations or network security
4. **Local scope only**: Impact limited to the developer's local filesystem

While path traversal vulnerabilities are generally serious in security contexts, this specific instance:
- Requires user interaction (running a malicious command)
- Is constrained by the user's filesystem permissions
- Does not compromise the Aptos blockchain or any validator nodes
- Cannot affect deployed Move modules or on-chain state

The vulnerability is real but **does not qualify under Aptos Bug Bounty categories** which focus on blockchain security, not development tool security.

## Likelihood Explanation

Exploitation requires social engineering to convince a developer to:
- Copy and run a malicious `move new` command from an untrusted source
- Execute a script containing the malicious command

This is moderately unlikely as developers typically:
- Create projects with simple, valid names
- Don't copy commands from untrusted sources
- Work in isolated development environments

## Recommendation

Add validation to reject project names containing path traversal sequences or invalid characters:

```rust
pub fn execute(
    self,
    path: Option<PathBuf>,
    version: &str,
    deps: impl IntoIterator<Item = (impl Display, impl Display)>,
    addrs: impl IntoIterator<Item = (impl Display, impl Display)>,
    custom: &str,
) -> anyhow::Result<()> {
    let Self { name } = self;
    
    // Validate package name early
    PackageName::new(&name)?;
    
    // Prevent path traversal
    if name.contains("..") || name.contains('/') || name.contains('\\') {
        anyhow::bail!("Package name cannot contain path separators or traversal sequences");
    }
    
    let p: PathBuf;
    let path: &Path = match path {
        Some(mut path) => {
            // Canonicalize to prevent traversal in -p flag
            path = path.canonicalize()
                .unwrap_or_else(|_| path);
            p = path;
            &p
        },
        None => Path::new(&name),
    };
    
    // ... rest of function
}
```

## Proof of Concept

```bash
# Create a test directory
mkdir /tmp/move-cli-test
cd /tmp/move-cli-test

# Demonstrate path traversal
move new ../../tmp/malicious-project

# Verify files created outside intended location
ls -la ../../tmp/malicious-project/
# Expected: sources/ directory and Move.toml exist

# Demonstrate that the path traversal succeeded
cat ../../tmp/malicious-project/Move.toml
# Shows the generated manifest file
```

---

**Note:** While this is a legitimate path traversal vulnerability in the Move CLI codebase, it does not meet the Aptos Bug Bounty criteria as it is a development tool issue with no impact on blockchain consensus, on-chain execution, validator operations, or fund security. The vulnerability should be fixed for general security hygiene, but it does not constitute a blockchain security vulnerability under the stated evaluation criteria.

### Citations

**File:** third_party/move/tools/move-cli/src/base/new.rs (L27-28)
```rust
    pub name: String,
}
```

**File:** third_party/move/tools/move-cli/src/base/new.rs (L50-58)
```rust
        let Self { name } = self;
        let p: PathBuf;
        let path: &Path = match path {
            Some(path) => {
                p = path;
                &p
            },
            None => Path::new(&name),
        };
```

**File:** third_party/move/tools/move-cli/src/base/new.rs (L59-60)
```rust
        create_dir_all(path.join(SourcePackageLayout::Sources.path()))?;
        let mut w = std::fs::File::create(path.join(SourcePackageLayout::Manifest.path()))?;
```

**File:** third_party/move/tools/move-cli/src/base/new.rs (L61-68)
```rust
        writeln!(
            &mut w,
            "[package]
name = \"{name}\"
version = \"{version}\"

[dependencies]"
        )?;
```

**File:** third_party/move/tools/move-package-manifest/src/package_name.rs (L58-67)
```rust
fn is_valid_package_name(s: &str) -> bool {
    let mut chars = s.chars();

    match chars.next() {
        Some(c) if c.is_ascii_alphabetic() || c == '_' => (),
        _ => return false,
    }

    chars.all(|c| c.is_ascii_alphanumeric() || c == '-' || c == '_')
}
```
