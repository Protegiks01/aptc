# Audit Report

## Title
Legacy `/mint` Endpoint Bypasses Rejection Metrics Collection Enabling Monitoring Blind Spot

## Summary
The legacy `/mint` endpoint in the Aptos faucet service bypasses the `bump_rejection_reason_counters()` function call, causing all rejection reasons (rate limiting, IP blocklisting, captcha failures, etc.) from this endpoint to be excluded from Prometheus metrics. This creates a monitoring blind spot where abuse patterns targeting `/mint` cannot be detected through the `aptos_tap_rejection_reason_count` metric system.

## Finding Description
The Aptos faucet exposes two endpoints for funding accounts: the modern `/fund` endpoint and the legacy `/mint` endpoint for backwards compatibility. Both endpoints execute identical validation logic through the same `fund_inner()` function, running checkers that produce `RejectionReason` objects when requests should be denied.

However, these endpoints handle errors differently:

**Modern `/fund` endpoint flow:** [1](#0-0) 

Returns `Result<Json<FundResponse>, AptosTapErrorResponse>`, which triggers the `From<AptosTapError> for AptosTapErrorResponse` trait conversion: [2](#0-1) 

This conversion calls `bump_rejection_reason_counters()` which increments Prometheus counters: [3](#0-2) 

**Legacy `/mint` endpoint flow:** [4](#0-3) 

Returns `Result<MintResponse>` and converts errors directly to `poem::Error` bypassing the trait conversion: [5](#0-4) 

The `/mint` endpoint is actively registered and exposed: [6](#0-5) 

**Attack Scenario:**
1. Attacker discovers both `/fund` and `/mint` endpoints exist
2. Attacker targets `/mint` endpoint for abuse attempts
3. Rate limiting, IP blocklisting, and captcha checks still function correctly
4. Requests are properly rejected with HTTP 403/429 status codes
5. However, `bump_rejection_reason_counters()` is never called
6. Metrics `aptos_tap_rejection_reason_count` do not increment
7. Operators monitoring Prometheus dashboards see no rejection patterns for `/mint` abuse
8. Sustained abuse attempts remain invisible in monitoring systems

The rejection reason codes that go untracked include: [7](#0-6) 

## Impact Explanation
This is a **monitoring and observability gap** rather than a direct security bypass. The security controls (rate limiting, IP blocklisting, captcha validation) continue to function correctly and reject malicious requests. However, operators lose visibility into abuse patterns specifically targeting the legacy `/mint` endpoint.

According to the strict Aptos bug bounty criteria provided:
- **Not Critical**: No fund loss, consensus violation, or network partition
- **Not High**: No API crashes or validator slowdowns  
- **Not Medium**: No fund loss/manipulation or state inconsistencies requiring intervention

This issue constitutes an operational monitoring deficiency that **does not meet the defined Medium severity threshold** despite being labeled as "(Medium)" in the original security question. The security mechanisms remain effective; only their observability is compromised.

## Likelihood Explanation
**Likelihood: High** - The vulnerability is trivially exploitable:
- No authentication or special permissions required
- Endpoint is publicly exposed and documented for backwards compatibility
- Attackers need only target `/mint` instead of `/fund`
- The metrics gap affects 100% of rejections from this endpoint

## Recommendation
Modify the `/mint` endpoint error handling to properly track rejection metrics:

```rust
// In fund.rs mint() handler, replace lines 405-411 with:
let txns = fund_api_components
    .0
    .fund_inner(fund_request, source_ip, header_map, false, None)
    .await
    .map_err(|e| {
        // Convert to AptosTapErrorResponse first to trigger metrics
        let response: AptosTapErrorResponse = e.into();
        // Then extract status and message for legacy format
        let (status, _) = match &response {
            AptosTapErrorResponse::Default(s, _, _) => (*s, ()),
        };
        poem::Error::from((status, anyhow::anyhow!("Request failed")))
    })?;
```

However, the cleanest solution is to **deprecate and remove the legacy `/mint` endpoint** entirely, forcing all clients to use the modern `/fund` endpoint with proper OpenAPI specification and metrics.

## Proof of Concept

**Step 1**: Send rejection-triggering requests to `/fund` endpoint:
```bash
# Request that will be rejected (e.g., rate limit exhausted)
curl -X POST http://faucet/fund \
  -H "Content-Type: application/json" \
  -d '{"address":"0x1234..."}'
  
# Check metrics - rejection counter increments
curl http://faucet/metrics | grep aptos_tap_rejection_reason_count
# Shows: aptos_tap_rejection_reason_count{rejection_reason_code="101"} 1
```

**Step 2**: Send identical rejection-triggering requests to `/mint` endpoint:
```bash
# Same rejection condition via legacy endpoint  
curl -X POST http://faucet/mint?address=0x1234...

# Check metrics - NO increment despite rejection
curl http://faucet/metrics | grep aptos_tap_rejection_reason_count  
# Still shows: aptos_tap_rejection_reason_count{rejection_reason_code="101"} 1
```

**Step 3**: Verification in code:
The `/mint` handler at line 409-411 converts `AptosTapError` directly to `poem::Error` without going through `AptosTapErrorResponse::from()`, thus bypassing the metrics call at errors.rs:105.

---

## Notes
While this represents a legitimate implementation inconsistency causing metrics gaps, it **does not constitute a security vulnerability** under the strict Aptos bug bounty criteria that require actual fund loss, state corruption, or system compromise. The security controls remain fully functional; only their observability is affected. This would be more appropriately classified as an operational/monitoring issue rather than a security finding eligible for bounty rewards.

### Citations

**File:** crates/aptos-faucet/core/src/endpoints/fund.rs (L111-111)
```rust
    ) -> poem::Result<Json<FundResponse>, AptosTapErrorResponse> {
```

**File:** crates/aptos-faucet/core/src/endpoints/fund.rs (L394-394)
```rust
) -> poem::Result<MintResponse> {
```

**File:** crates/aptos-faucet/core/src/endpoints/fund.rs (L409-411)
```rust
        .map_err(|e| {
            poem::Error::from((e.status_and_retry_after().0, anyhow::anyhow!(e.message)))
        })?;
```

**File:** crates/aptos-faucet/core/src/endpoints/errors.rs (L100-109)
```rust
impl From<AptosTapError> for AptosTapErrorResponse {
    fn from(error: AptosTapError) -> Self {
        // We use this opportunity to bump metrics based on the specifics of
        // this response, since this function is only called right when we're
        // about to return this error to the client.
        bump_rejection_reason_counters(&error.rejection_reasons);
        let (status, retry_after) = error.status_and_retry_after();
        Self::Default(status, Json(error), retry_after)
    }
}
```

**File:** crates/aptos-faucet/core/src/endpoints/errors.rs (L235-267)
```rust
#[derive(Copy, Clone, Debug, Enum, Eq, Hash, PartialEq)]
#[repr(u32)]
pub enum RejectionReasonCode {
    /// Intentionally unhelpful reason code.
    Hehe = 1,

    /// Account already has funds.
    AccountAlreadyExists = 100,

    /// Key (IP / Firebase UID) has exhausted its usage limit.
    UsageLimitExhausted = 101,

    /// IP is in the blocklist.
    IpInBlocklist = 102,

    /// The origin of the request is from a VPN.
    RequestFromVpn = 103,

    /// The origin of the request is a cloud.
    RequestFromCloud = 104,

    /// The request did not contain the required magic header.
    MagicHeaderIncorrect = 105,

    /// The captcha was missing or incorrect.
    CaptchaInvalid = 106,

    /// Auth token was not given, is invalid, or is not allowed by the server.
    AuthTokenInvalid = 107,

    /// Referer was in the blocklist.
    RefererBlocklisted = 108,
}
```

**File:** crates/aptos-faucet/core/src/middleware/metrics.rs (L55-61)
```rust
pub fn bump_rejection_reason_counters(rejection_reasons: &[RejectionReason]) {
    for rejection_reason in rejection_reasons {
        REJECTION_REASONS
            .with_label_values(&[&format!("{}", rejection_reason.get_code() as u32)])
            .inc();
    }
}
```

**File:** crates/aptos-faucet/core/src/server/run.rs (L217-217)
```rust
                .at("/mint", poem::post(mint.data(fund_api_components)))
```
