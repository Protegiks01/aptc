# Audit Report

## Title
Metrics Endpoint in Test Mode Exposes Sensitive Validator Voting Patterns and Peer Connection Information Without Authentication

## Summary
The `/metrics` endpoint exposed by `start_test_environment_node()` leaks sensitive validator information including per-validator voting patterns, consensus participation status, and network peer connections without any authentication or access control, making it accessible to any network observer when test nodes are deployed on cloud infrastructure.

## Finding Description
The inspection service in test mode exposes a Prometheus metrics endpoint that collects and serves all registered metrics across the codebase. This endpoint has no authentication mechanism and binds to `0.0.0.0` by default, making it accessible from any network interface. [1](#0-0) 

The metrics gathering mechanism collects all Prometheus metrics without filtering: [2](#0-1) 

The following sensitive consensus metrics are exposed with validator-specific labels:

**Voting Pattern Metrics:** [3](#0-2) [4](#0-3) [5](#0-4) [6](#0-5) 

**Peer Connection Metrics:** [7](#0-6) 

These metrics expose:
- Which specific validators (`peer_id`) voted in each round
- What block hash they voted for (`hash_index` label)
- When they last voted (epoch and round numbers)
- Their voting power distribution
- Complete network topology (which peers are connected to which)

An attacker can query the metrics endpoint with a simple HTTP GET request and extract this information to:
1. Map the validator network topology
2. Track individual validator voting behavior over time
3. Identify validators with unusual voting patterns
4. Plan targeted network attacks based on connection patterns
5. Perform timing analysis on consensus participation

## Impact Explanation
This represents a **Medium severity** information disclosure vulnerability. While it does not directly result in fund loss or consensus violation, it exposes sensitive validator operational data that violates validator privacy and operational security.

The leaked information enables reconnaissance for more sophisticated attacks:
- Network topology mapping for eclipse attacks
- Validator behavior profiling for targeted social engineering
- Identification of lagging validators for targeted DoS
- Analysis of consensus participation patterns to find attack windows

Although this affects test nodes rather than production validators, developers commonly run test nodes on cloud infrastructure for integration testing, making these metrics publicly accessible. The default binding to `0.0.0.0` exacerbates this issue. [8](#0-7) 

## Likelihood Explanation
**Likelihood: Medium**

While the function warns "WARNING: Entering test mode! This should never be used in production!", developers frequently:
1. Run test nodes on cloud servers for development/testing
2. Use test mode for local testnet deployments
3. Deploy test nodes for integration testing in CI/CD pipelines
4. Run long-lived development nodes for dApp testing

The metrics endpoint is automatically exposed with no authentication required. Unlike other sensitive endpoints that have explicit configuration flags, the `/metrics` endpoint is always enabled: [9](#0-8) 

Note that other potentially sensitive endpoints like `/peer_information` have explicit configuration flags, but `/metrics` does not: [10](#0-9) 

## Recommendation

**1. Add authentication to the metrics endpoint** or **2. Bind to localhost by default in test mode**

### Option 1: Add Metrics Authentication
Add a configuration flag to control metrics endpoint access:

```yaml
# In InspectionServiceConfig
expose_metrics: bool  // default: false in test mode
require_metrics_auth: bool  // default: true
```

Modify the metrics handler to check authentication before serving metrics.

### Option 2: Bind to Localhost (Preferred for Test Mode)
Change the default inspection service address for test mode to bind to localhost only:

```rust
// In create_single_node_test_config or start_test_environment_node
node_config.inspection_service.address = "127.0.0.1".to_string();
```

### Option 3: Filter Sensitive Metrics in Test Mode
Create a separate filtered metrics endpoint that excludes peer-identifying labels, or strip sensitive labels before export.

The simplest and most effective fix for test mode is **Option 2**: binding to localhost by default, requiring developers to explicitly expose the endpoint if needed.

## Proof of Concept

```bash
# Start a test node
aptos-node --test --test-dir ./test-data

# From another terminal or machine (if node is on cloud server):
# Query the metrics endpoint
curl http://<node-ip>:9101/metrics | grep -E "(aptos_consensus_last_voted_round|aptos_network_peer_connected|aptos_consensus_current_round_voted_power)"

# Example output showing sensitive information:
# aptos_consensus_last_voted_round{peer_id="a1b2c3..."} 1234
# aptos_consensus_last_voted_round{peer_id="d4e5f6..."} 1233
# aptos_network_peer_connected{role_type="validator",network_id="validator",peer_id="a1b2c3...",remote_peer_id="d4e5f6..."} 1
# aptos_consensus_current_round_voted_power{peer_id="a1b2c3...",hash_index="0"} 100
```

The attacker can now see:
- Which validators (by peer_id) are connected to which
- Which validators voted in which rounds
- What they voted for (hash_index)
- Voting power distribution across validators

**Notes:**
- This vulnerability is specific to test mode where metrics are automatically exposed
- The issue is exacerbated by the default `0.0.0.0` binding making the endpoint network-accessible
- While test nodes are not meant for production, they are commonly deployed on cloud infrastructure during development
- The lack of authentication or access control on the metrics endpoint is the root cause
- Other inspection service endpoints have explicit `expose_*` configuration flags, but `/metrics` does not

### Citations

**File:** aptos-node/src/lib.rs (L359-362)
```rust
    println!(
        "\tMetrics endpoint: http://{}:{}/metrics",
        &config.inspection_service.address, &config.inspection_service.port
    );
```

**File:** crates/aptos-inspection-service/src/server/utils.rs (L49-51)
```rust
/// A simple utility function that returns all metric families
fn get_metric_families() -> Vec<MetricFamily> {
    let metric_families = aptos_metrics_core::gather();
```

**File:** consensus/src/counters.rs (L538-545)
```rust
pub static ALL_VALIDATORS_VOTING_POWER: Lazy<IntGaugeVec> = Lazy::new(|| {
    register_int_gauge_vec!(
        "aptos_all_validators_voting_power",
        "Voting power for all validators in current epoch",
        &["peer_id"]
    )
    .unwrap()
});
```

**File:** consensus/src/counters.rs (L557-564)
```rust
pub static CONSENSUS_CURRENT_ROUND_VOTED_POWER: Lazy<GaugeVec> = Lazy::new(|| {
    register_gauge_vec!(
        "aptos_consensus_current_round_voted_power",
        "Counter for consensus participation status, 0 means no participation and 1 otherwise",
        &["peer_id", "hash_index"]
    )
    .unwrap()
});
```

**File:** consensus/src/counters.rs (L577-584)
```rust
pub static CONSENSUS_LAST_VOTE_EPOCH: Lazy<IntGaugeVec> = Lazy::new(|| {
    register_int_gauge_vec!(
        "aptos_consensus_last_voted_epoch",
        "for each peer_id, last epoch we've seen consensus vote",
        &["peer_id"]
    )
    .unwrap()
});
```

**File:** consensus/src/counters.rs (L587-594)
```rust
pub static CONSENSUS_LAST_VOTE_ROUND: Lazy<IntGaugeVec> = Lazy::new(|| {
    register_int_gauge_vec!(
        "aptos_consensus_last_voted_round",
        "for each peer_id, last round we've seen consensus vote",
        &["peer_id"]
    )
    .unwrap()
});
```

**File:** network/framework/src/counters.rs (L86-106)
```rust
pub static APTOS_NETWORK_PEER_CONNECTED: Lazy<IntGaugeVec> = Lazy::new(|| {
    register_int_gauge_vec!(
        "aptos_network_peer_connected",
        "Indicates if we are connected to a particular peer",
        &["role_type", "network_id", "peer_id", "remote_peer_id"]
    )
    .unwrap()
});

pub fn peer_connected(network_context: &NetworkContext, remote_peer_id: &PeerId, v: i64) {
    if network_context.network_id().is_validator_network() {
        APTOS_NETWORK_PEER_CONNECTED
            .with_label_values(&[
                network_context.role().as_str(),
                network_context.network_id().as_str(),
                network_context.peer_id().short_str().as_str(),
                remote_peer_id.short_str().as_str(),
            ])
            .set(v)
    }
}
```

**File:** config/src/config/inspection_service_config.rs (L15-24)
```rust
#[derive(Clone, Debug, Deserialize, PartialEq, Eq, Serialize)]
#[serde(default, deny_unknown_fields)]
pub struct InspectionServiceConfig {
    pub address: String,
    pub port: u16,
    pub expose_configuration: bool,
    pub expose_identity_information: bool,
    pub expose_peer_information: bool,
    pub expose_system_information: bool,
}
```

**File:** config/src/config/inspection_service_config.rs (L28-30)
```rust
        InspectionServiceConfig {
            address: "0.0.0.0".to_string(),
            port: 9101,
```

**File:** crates/aptos-inspection-service/src/server/mod.rs (L142-146)
```rust
        METRICS_PATH => {
            // /metrics
            // Exposes text encoded metrics
            metrics::handle_metrics_request()
        },
```
