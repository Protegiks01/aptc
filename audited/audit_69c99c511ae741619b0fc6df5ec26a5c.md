# Audit Report

## Title
Symlink Path Traversal Vulnerability in Move Formatter Allows Arbitrary File Access Outside Package Sandbox

## Summary
The `aptos move fmt` command follows symbolic links when discovering Move source files within package directories (sources/, scripts/, tests/, examples/), allowing an attacker to craft a malicious Move package that causes the formatter to read and potentially modify files outside the intended package boundary.

## Finding Description

The vulnerability exists in the file discovery mechanism used by the Move formatter. When formatting a Move package, the formatter constructs paths for standard package directories and uses `find_move_filenames()` to discover Move files within them. [1](#0-0) 

The `find_move_filenames()` function calls `find_filenames()`, which uses the `walkdir` crate with `follow_links(true)` enabled: [2](#0-1) 

This configuration causes the directory traversal to follow symbolic links. An attacker can exploit this by:

1. Creating a malicious Move package with a valid `Move.toml` manifest
2. Placing symbolic links within the `sources/`, `scripts/`, `tests/`, or `examples/` directories that point to files outside the package
3. When a victim runs `aptos move fmt --package-path=malicious_package`, the formatter follows these symlinks
4. External files with `.move` extensions are discovered and processed by the formatter
5. With default settings (emit mode = overwrite), the formatter modifies these external files

The vulnerability bypasses the package sandbox because:
- While the root package path is canonicalized on line 152, this happens BEFORE subdirectories are joined
- Individual file paths discovered during walkdir traversal are not validated to ensure they remain within the package boundary
- No symlink detection or prevention is implemented [3](#0-2) 

## Impact Explanation

**Severity Assessment: High (Local Security Issue)**

This vulnerability allows:

1. **Arbitrary File Read**: The formatter reads file contents to determine formatting, exposing sensitive information
2. **Arbitrary File Modification**: With default overwrite mode, the formatter modifies discovered files, potentially corrupting Move source code in other packages or system files
3. **Path Traversal**: No limit on symlink targets - can reach any file the user has permissions to access

While this does not directly impact the blockchain consensus, validator nodes, or on-chain state (which would qualify for Critical severity in the Aptos bug bounty), it represents a significant security risk to developer workstations and build infrastructure. An attacker could:

- Corrupt legitimate Move packages on the victim's system
- Exfiltrate sensitive Move source code through error messages or output
- Modify critical development files if the formatter is run with elevated privileges
- Compromise CI/CD pipelines that automatically format Move packages

Under the Aptos bug bounty criteria, this falls into **High severity** as it constitutes a "Significant protocol violation" in the developer toolchain, though it does not affect validator nodes or the blockchain runtime directly.

## Likelihood Explanation

**Likelihood: Medium to High**

Attack prerequisites:
- Attacker must convince victim to download a malicious Move package (via social engineering, malicious dependency, compromised repository)
- Victim must run `aptos move fmt` on the malicious package
- Target files must have `.move` extension for the default predicate to accept them

The attack is realistic because:
- Developers regularly download and format Move packages from various sources
- The formatter is commonly used in development workflows and CI/CD pipelines
- The attack leaves no obvious traces unless the victim inspects symlinks before formatting
- The default behavior (overwrite) makes the attack immediately effective

## Recommendation

**Immediate Fix**: Disable symlink following in the file discovery mechanism.

Modify `find_filenames()` in `third_party/move/move-command-line-common/src/files.rs`:

```rust
for entry in walkdir::WalkDir::new(path)
    .follow_links(false)  // Changed from true to false
    .into_iter()
    .filter_map(|e| e.ok())
```

**Additional Hardening**:

1. Add path validation in `fmt.rs` to verify discovered files are within the package boundary:
   ```rust
   // After find_move_filenames call
   for file in &files_to_format {
       let canonical_file = fs::canonicalize(file)?;
       if !canonical_file.starts_with(&root_package_path) {
           return Err(CliError::UnexpectedError(format!(
               "File {} is outside package boundary", 
               file.display()
           )));
       }
   }
   ```

2. Consider adding a `--allow-symlinks` flag for legitimate use cases where symlinks are needed, but make it opt-in rather than default

3. Apply the same fix to other instances of `follow_links(true)` in the codebase, particularly in `digest.rs`: [4](#0-3) 

## Proof of Concept

**Setup Steps:**

1. Create a malicious Move package:
```bash
mkdir malicious_package
cd malicious_package
cat > Move.toml << 'EOF'
[package]
name = "Malicious"
version = "1.0.0"

[addresses]
std = "0x1"
EOF

mkdir sources
echo 'module 0x1::legitimate { }' > sources/legitimate.move

# Create target file outside package
cd ..
echo 'module 0x1::victim { fun target() { } }' > victim_file.move

# Create symlink inside package sources
cd malicious_package/sources
ln -s ../../victim_file.move evil_link.move
cd ../..
```

2. Run the formatter:
```bash
aptos move fmt --package-path=malicious_package
```

**Expected Vulnerable Behavior:**
- The formatter discovers `malicious_package/sources/evil_link.move`
- Follows the symlink to `../../victim_file.move`
- Processes and modifies `victim_file.move` (outside the package)
- Output shows: "Formatting file: malicious_package/sources/evil_link.move"

**Expected Secure Behavior (after fix):**
- The formatter skips symlinks
- Only `legitimate.move` is formatted
- `victim_file.move` remains untouched

**Verification:**
```bash
# Check if victim file was modified
ls -la malicious_package/sources/
stat victim_file.move
```

## Notes

- This vulnerability affects all users of the `aptos move fmt` command, including developers and CI/CD systems
- The same `follow_links(true)` pattern appears in package digest computation, which could allow symlink-based attacks on package integrity verification
- The issue is not specific to the Aptos toolchain but is a general security anti-pattern when processing untrusted directory structures
- Modern security guidance recommends treating symlinks as potential security boundaries and requiring explicit opt-in to follow them

### Citations

**File:** crates/aptos/src/move_tool/fmt.rs (L167-183)
```rust
                let sources_path = root_package_path.join(SourcePackageLayout::Sources.path());
                if sources_path.exists() {
                    path_vec.push(sources_path.clone());
                }
                let scripts_path = root_package_path.join(SourcePackageLayout::Scripts.path());
                if scripts_path.exists() {
                    path_vec.push(scripts_path.clone());
                }
                let tests_path = root_package_path.join(SourcePackageLayout::Tests.path());
                if tests_path.exists() {
                    path_vec.push(tests_path.clone());
                }
                let examples_path = root_package_path.join(SourcePackageLayout::Examples.path());
                if examples_path.exists() {
                    path_vec.push(examples_path.clone());
                }
                find_move_filenames(&path_vec, false)
```

**File:** crates/aptos/src/move_tool/fmt.rs (L203-206)
```rust
        for file in &files_to_format {
            let mut cur_cmd = create_cmd();
            cur_cmd.arg(format!("--file-path={}", file.display()));
            let out = cur_cmd.output().map_err(to_cli_error)?;
```

**File:** third_party/move/move-command-line-common/src/files.rs (L80-84)
```rust
        for entry in walkdir::WalkDir::new(path)
            .follow_links(true)
            .into_iter()
            .filter_map(|e| e.ok())
        {
```

**File:** third_party/move/tools/move-package/src/resolution/digest.rs (L30-31)
```rust
            for entry in walkdir::WalkDir::new(path)
                .follow_links(true)
```
