# Audit Report

## Title
Configuration Sanitizer Bypass via Malicious node.yaml in Test Mode

## Summary
The `load_node_config` function in `aptos-node/src/lib.rs` loads node configuration files from user-controlled directories without validating them before checking the `skip_config_sanitizer` flag. An attacker who controls the `test_dir` parameter can provide a malicious `node.yaml` file that sets `node_startup.skip_config_sanitizer: true`, completely bypassing all security validation checks including mutual authentication requirements, safety rules verification, and network configuration validation.

## Finding Description

The vulnerability exists in the configuration loading flow:

1. **Entry Point**: When `aptos-node` is run with `--test --test-dir <path>`, the user-controlled path is passed to `setup_test_environment_and_start_node` [1](#0-0) 

2. **Config Loading**: The `load_node_config` function checks if `test_dir/0/node.yaml` exists and directly loads it if present [2](#0-1) 

3. **Sanitizer Bypass**: The loaded config is processed through `NodeConfig::sanitize()`, which immediately returns if `skip_config_sanitizer` is set to true [3](#0-2) 

4. **Attack Vector**: An attacker creates a malicious config file at `<controlled_dir>/0/node.yaml` containing:
```yaml
node_startup:
  skip_config_sanitizer: true
base:
  role: Validator
validator_network:
  network_id: Validator
  mutual_authentication: false  # Bypasses security check
  # ... malicious network config
```

This bypasses all security validations including:
- Mutual authentication enforcement for validator networks [4](#0-3) 
- Safety rules backend validation for mainnet [5](#0-4) 
- Execution paranoid verification requirements
- Admin service authentication requirements
- Network configuration validation

**Important Context**: In the specific workspace server implementation mentioned in the question, `test_dir` is created by `tempfile::tempdir()` and is NOT attacker-controlled [6](#0-5) , making that specific usage NOT vulnerable. However, the `aptos-node` CLI directly accepts user-controlled `--test-dir` parameter [7](#0-6) , creating an exploitable attack surface.

## Impact Explanation

**Severity: Medium**

While the vulnerability allows complete bypass of security validation, its impact is limited by requiring test mode execution, which explicitly warns "This should never be used in production!" [8](#0-7) 

Potential impacts if exploited:
- **Network Position Attacks**: Attacker can configure node with malicious peer connections, disabled mutual authentication, intercepting or manipulating network traffic
- **Security Feature Bypass**: All mainnet safety requirements can be disabled including safety rules validation, paranoid verification
- **State Manipulation**: Custom genesis and waypoint configuration could create divergent blockchain state

This meets **Medium Severity** criteria as it enables "State inconsistencies requiring intervention" and protocol violations, but requires specific preconditions (test mode usage).

## Likelihood Explanation

**Likelihood: Low to Medium**

The vulnerability is exploitable only when:
1. A user runs `aptos-node --test --test-dir <attacker-controlled-path>`
2. The attacker can pre-populate the directory with malicious config

While test mode is intended only for development/testing, potential exploitation scenarios include:
- Developers or operators mistakenly using test mode for demos or local testing with shared/writable directories
- CI/CD pipelines using test mode with predictable or writable test directories
- Misconfigured testing environments that allow directory manipulation

The explicit production warning reduces likelihood, but the vulnerability's simplicity (just a YAML file) and the existence of a user-controlled parameter in production code (CLI flag) maintain moderate risk.

## Recommendation

**Fix 1: Remove the ability to skip sanitization from loaded configs**

Modify `NodeConfig::sanitize()` to ignore the `skip_config_sanitizer` flag when the config was loaded from disk (only honor it for programmatically constructed configs):

```rust
impl ConfigSanitizer for NodeConfig {
    fn sanitize(
        node_config: &NodeConfig,
        node_type: NodeType,
        chain_id: Option<ChainId>,
    ) -> Result<(), Error> {
        // Never allow loaded configs to skip sanitization
        // Only programmatically-created configs in tests should skip
        
        // Sanitize all sub-configs...
        AdminServiceConfig::sanitize(node_config, node_type, chain_id)?;
        // ... rest of sanitization
    }
}
```

**Fix 2: Validate configs before reading skip flag**

In `load_and_sanitize_config`, perform mandatory security checks before processing any config-controlled flags:

```rust
pub fn load_and_sanitize_config(&self) -> Result<NodeConfig, Error> {
    let mut node_config = NodeConfig::load_config(&self.node_config_path)?;
    
    // Force sanitization for disk-loaded configs
    let original_skip = node_config.node_startup.skip_config_sanitizer;
    node_config.node_startup.skip_config_sanitizer = false;
    
    // ... rest of loading and sanitization
    
    // Restore original value only after validation
    node_config.node_startup.skip_config_sanitizer = original_skip;
    
    Ok(node_config)
}
```

**Fix 3: Prevent test mode from accepting arbitrary test_dir paths**

Require test_dir to be within a controlled location or remove the `--test-dir` parameter entirely, always using system-created temporary directories.

## Proof of Concept

1. Create malicious config at `/tmp/malicious_node/0/node.yaml`:
```yaml
node_startup:
  skip_config_sanitizer: true
base:
  role: Validator
  waypoint:
    from_config: "0:0000000000000000000000000000000000000000000000000000000000000000"
validator_network:
  network_id: Validator
  mutual_authentication: false
  listen_address: "/ip4/0.0.0.0/tcp/6180"
  identity:
    type: "from_config"
    key: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    peer_id: "0x1"
consensus:
  safety_rules:
    backend:
      type: "in_memory_storage"
    test:
      # Enable test config that should be blocked
      author: "0x1"
```

2. Run aptos-node:
```bash
aptos-node --test --test-dir /tmp/malicious_node
```

3. Observe that the node starts with the malicious configuration without any security validation errors, despite having:
   - `mutual_authentication: false` (should be rejected)
   - `in_memory_storage` safety backend (should be rejected for mainnet)
   - Test safety rules config (should be rejected for mainnet)

All security checks are bypassed due to the `skip_config_sanitizer: true` flag in the attacker-controlled config file.

## Notes

- The workspace server's `start_node()` function is NOT vulnerable in its current implementation because it uses system-created temporary directories
- The vulnerability exists in the broader `aptos-node` CLI when test mode is used with user-controlled directories
- The root cause is a design flaw where security-critical flags can be controlled by untrusted config files
- This represents a defense-in-depth violation: even "test-only" code should maintain security boundaries

### Citations

**File:** aptos-node/src/lib.rs (L68-69)
```rust
    #[clap(long, value_parser, requires("test"))]
    test_dir: Option<PathBuf>,
```

**File:** aptos-node/src/lib.rs (L137-137)
```rust
            println!("WARNING: Entering test mode! This should never be used in production!");
```

**File:** aptos-node/src/lib.rs (L154-164)
```rust
            setup_test_environment_and_start_node(
                &self.config,
                &self.test_config_override,
                None,
                self.test_dir,
                self.random_ports,
                self.lazy,
                self.performance,
                &genesis_framework,
                rng,
            )
```

**File:** aptos-node/src/lib.rs (L308-312)
```rust
    let validator_config_path = test_dir.join("0").join("node.yaml");

    let config = if validator_config_path.exists() {
        NodeConfig::load_from_path(&validator_config_path)
            .map_err(|error| anyhow!("Unable to load config: {:?}", error))?
```

**File:** config/src/config/config_sanitizer.rs (L45-48)
```rust
        // If config sanitization is disabled, don't do anything!
        if node_config.node_startup.skip_config_sanitizer {
            return Ok(());
        }
```

**File:** config/src/config/config_sanitizer.rs (L192-196)
```rust
        if !validator_network_config.mutual_authentication {
            return Err(Error::ConfigSanitizerFailed(
                sanitizer_name,
                "Mutual authentication must be enabled for the validator network!".into(),
            ));
```

**File:** config/src/config/safety_rules_config.rs (L86-95)
```rust
            // Verify that the secure backend is appropriate for mainnet validators
            if chain_id.is_mainnet()
                && node_type.is_validator()
                && safety_rules_config.backend.is_in_memory()
            {
                return Err(Error::ConfigSanitizerFailed(
                    sanitizer_name,
                    "The secure backend should not be set to in memory storage in mainnet!"
                        .to_string(),
                ));
```

**File:** aptos-move/aptos-workspace-server/src/lib.rs (L93-94)
```rust
    let test_dir = tempfile::tempdir()?;
    let test_dir = test_dir.path();
```
