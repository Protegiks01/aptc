# Audit Report

## Title
Panic in Security-Critical Logging Due to Unhandled Debug Formatting Errors

## Summary
The `JsonVisitor::visit_pair()` method in the Aptos logger uses `format!("{:?}", d)` to format debug values, which panics if the Debug implementation returns an error. This can crash validator nodes during security-critical logging operations, causing a denial-of-service vulnerability.

## Finding Description

While `KeysAndValues::fmt()` correctly handles errors from `visitor.finish()` by returning them, [1](#0-0)  the critical vulnerability exists in how these errors are subsequently handled in the logging pipeline.

In `LogEntry::new()`, when processing structured log key-value pairs, a `JsonVisitor` is used to convert values into JSON. [2](#0-1)  When handling `Value::Debug(d)` values, the code uses the `format!()` macro to format the debug representation: [3](#0-2) 

The `format!()` macro panics if the underlying Debug implementation returns `fmt::Error`. This is problematic because `Value::Debug` implementation can fail when formatting `Value::Serde` variants that cannot be serialized to JSON: [4](#0-3) 

**Attack Scenario:**
1. Attacker triggers logging of malformed data during consensus operations (e.g., via malicious transaction payloads or network messages)
2. The data contains a value that fails JSON serialization when formatted as Debug
3. The `format!("{:?}", d)` call at line 171 panics
4. The validator node crashes, affecting consensus participation and network liveness

## Impact Explanation

This qualifies as **Medium Severity** per Aptos bug bounty criteria:
- **Validator node crashes** during logging operations, leading to temporary node unavailability
- **State inconsistencies** may occur if nodes crash during critical consensus operations
- Not Critical severity because it requires specific triggering conditions and doesn't directly cause fund loss or permanent consensus failures
- However, repeated exploitation could cause persistent liveness issues across the network

## Likelihood Explanation

**Moderate to High Likelihood:**
- The vulnerable code path is executed during normal logging operations throughout the codebase
- Many consensus, mempool, and state sync operations use structured logging
- An attacker can potentially trigger logging of malformed data through transaction payloads or network messages
- The panic is deterministic once triggered with failing Debug implementations

## Recommendation

Replace the panic-inducing `format!()` macro with proper error handling:

```rust
impl Visitor for JsonVisitor<'_> {
    fn visit_pair(&mut self, key: Key, value: Value<'_>) {
        let v = match value {
            Value::Debug(d) => {
                // Use write! instead of format! to catch errors
                use std::fmt::Write;
                let mut buf = String::new();
                match write!(&mut buf, "{:?}", d) {
                    Ok(_) => serde_json::Value::String(
                        TruncatedLogString::from(buf).into()
                    ),
                    Err(e) => {
                        eprintln!("error formatting debug value for key {:?}: {}", key, e);
                        return; // Skip the value
                    }
                }
            },
            // ... rest of the match arms unchanged
```

Alternatively, catch potential panics or use `std::fmt::format` with explicit error checking before the `format!()` call.

## Proof of Concept

```rust
#[cfg(test)]
mod test_format_panic {
    use super::*;
    use crate::{Event, Key, KeyValue, Metadata, Value, Schema, Visitor};

    // Create a type with a Debug impl that always fails
    struct FailingDebug;
    
    impl std::fmt::Debug for FailingDebug {
        fn fmt(&self, _: &mut std::fmt::Formatter) -> std::fmt::Result {
            Err(std::fmt::Error)
        }
    }

    #[test]
    #[should_panic(expected = "formatting failed")]
    fn test_logging_panic_on_debug_error() {
        // This demonstrates the panic when logging a value with failing Debug
        let failing = FailingDebug;
        
        // Attempting to log this as Value::Debug will panic in JsonVisitor
        let val = Value::from_debug(&failing);
        
        // This simulates what happens in LogEntry::new() -> JsonVisitor::visit_pair()
        let formatted = format!("{:?}", val); // This will panic!
    }
}
```

The test demonstrates that any type with a failing Debug implementation will cause a panic when logged, crashing the validator node during security-critical operations.

## Notes

The root cause is the use of `format!()` which is designed to panic on formatting failures. The contrast with how `Value::Serde` errors are handled [5](#0-4)  (gracefully catching and logging errors) demonstrates that proper error handling is possible and should be applied consistently to all value types.

### Citations

**File:** crates/aptos-logger/src/event.rs (L56-62)
```rust
    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {
        let mut visitor = f.debug_map();
        for key_value in self.0 {
            key_value.visit(&mut visitor);
        }
        visitor.finish()
    }
```

**File:** crates/aptos-logger/src/aptos_logger.rs (L170-172)
```rust
                    Value::Debug(d) => serde_json::Value::String(
                        TruncatedLogString::from(format!("{:?}", d)).into(),
                    ),
```

**File:** crates/aptos-logger/src/aptos_logger.rs (L176-183)
```rust
                    Value::Serde(s) => match serde_json::to_value(s) {
                        Ok(value) => value,
                        Err(e) => {
                            // Log and skip the value that can't be serialized
                            eprintln!("error serializing structured log: {} for key {:?}", e, key);
                            return;
                        },
                    },
```

**File:** crates/aptos-logger/src/aptos_logger.rs (L236-239)
```rust
        let mut data = BTreeMap::new();
        for schema in event.keys_and_values() {
            schema.visit(&mut JsonVisitor(&mut data));
        }
```

**File:** crates/aptos-logger/src/kv.rs (L48-50)
```rust
            Value::Serde(s) => {
                fmt::Debug::fmt(&serde_json::to_value(s).map_err(|_| fmt::Error)?, f)
            },
```
