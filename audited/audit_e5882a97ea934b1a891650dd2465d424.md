# Audit Report

## Title
GenesisInfo Public Field Mutation After Genesis Caching Leading to Stale Transaction

## Summary
The `GenesisInfo` struct exposes numerous critical configuration fields as public, allowing external mutation after the genesis transaction has been cached. This creates a data consistency vulnerability where the cached genesis transaction can become stale and inconsistent with the current `GenesisInfo` state.

## Finding Description

The `GenesisInfo` struct in `crates/aptos-genesis/src/lib.rs` contains a caching mechanism for the genesis transaction that is vulnerable to state inconsistency. [1](#0-0) 

The struct declares 19 public fields (lines 54-82) that directly influence genesis transaction generation, including critical staking parameters (`min_stake`, `max_stake`), governance settings (`voting_duration_secs`, `required_proposer_stake`), consensus configuration, and execution configuration. [2](#0-1) 

The `get_genesis()` method implements a lazy caching pattern: it checks if `self.genesis` contains a cached transaction, and if not, generates one by calling `generate_genesis_txn()`. Critically, once cached, the transaction is never regenerated even if the public fields that determine its contents are mutated. [3](#0-2) 

The `generate_genesis_txn()` method reads all the public fields to construct a `GenesisConfiguration` and passes them to `encode_genesis_transaction()`. This means any mutation to public fields after the first `get_genesis()` call will NOT be reflected in subsequent calls.

**Attack Scenario:**
1. Genesis ceremony participant creates a `GenesisInfo` object with initial parameters (e.g., `min_stake = 1_000_000`)
2. Calls `get_genesis()` which caches the genesis transaction with those parameters
3. Due to programming error or malicious intent, mutates `genesis_info.min_stake = 1` 
4. Calls `get_genesis()` again or passes the object to `generate_waypoint()` which internally calls `get_genesis()`
5. The stale cached genesis (with `min_stake = 1_000_000`) is used, but the `GenesisInfo` object now claims `min_stake = 1`
6. If different nodes or tools use the object at different stages, they may have inconsistent views of genesis parameters

This breaks the **Deterministic Execution** invariant: if different validators end up with different genesis transactions due to this inconsistency, they will produce different state roots from block 0.

## Impact Explanation

This vulnerability falls under **Medium Severity** per the Aptos bug bounty criteria: "State inconsistencies requiring intervention."

While this does not directly cause fund loss or immediate consensus failure, it creates a critical configuration integrity issue:

- **Genesis Parameter Manipulation**: Critical staking parameters (`min_stake`, `max_stake`, `rewards_apy_percentage`) could differ between the cached genesis and the in-memory object
- **Consensus Configuration Desynchronization**: Changes to `consensus_config` after caching would not be reflected in the genesis
- **Governance Parameter Inconsistency**: Voting thresholds and durations could be inconsistent

If this leads to different validators using genesis transactions generated at different mutation states, it would cause:
- Network launch failures requiring restart
- Potential hard fork to resolve inconsistencies  
- Validator disagreement on initial state

However, it does not reach Critical severity because:
- No direct fund theft mechanism
- No exploitation of running network (only affects genesis)
- Requires access to genesis ceremony process

## Likelihood Explanation

**Likelihood: Low to Medium**

This vulnerability requires one of the following scenarios:

1. **Programming Error**: A future code change introduces field mutation between `get_genesis()` calls
2. **Genesis Ceremony Bug**: Tools used in genesis ceremony accidentally mutate fields after initial genesis generation
3. **Malicious Insider**: Genesis ceremony participant intentionally creates inconsistent genesis transactions (though this actor is typically considered trusted)

Current codebase inspection shows:
- `builder.rs` does not mutate fields between `generate_waypoint()` and `get_genesis()` calls [4](#0-3) 
- `genesis/mod.rs` uses `clone()` before `get_genesis()`, preventing mutation issues [5](#0-4) 

However, the API design makes this bug easy to introduce in future refactorings or new genesis tools.

## Recommendation

**Immediate Fix**: Make all configuration fields private and remove external mutability:

```rust
pub struct GenesisInfo {
    chain_id: ChainId,
    root_key: Ed25519PublicKey,
    validators: Vec<Validator>,
    framework: ReleaseBundle,
    genesis: Option<Transaction>,
    
    // All fields should be private (remove 'pub')
    allow_new_validators: bool,
    epoch_duration_secs: u64,
    is_test: bool,
    min_stake: u64,
    // ... etc for all fields
}
```

**Alternative Fix**: Invalidate cache on mutation by:
1. Making `genesis` field private
2. Adding a `set_*` method for each configuration parameter that clears the cache
3. Or implementing `DerefMut` with cache invalidation

**Best Practice Fix**: Make `GenesisInfo` immutable after construction:
```rust
pub struct GenesisInfo {
    // ... private fields
}

impl GenesisInfo {
    pub fn new(...) -> Self { /* existing constructor */ }
    
    // No public setters - only getters
    pub fn min_stake(&self) -> u64 { self.min_stake }
    // ... other getters
}
```

This enforces the invariant that genesis parameters cannot change after object creation.

## Proof of Concept

```rust
#[cfg(test)]
mod test {
    use super::*;
    use aptos_types::chain_id::ChainId;
    use aptos_crypto::ed25519::Ed25519PrivateKey;
    use aptos_keygen::KeyGen;
    
    #[test]
    fn test_genesis_mutation_staleness() {
        // Create genesis info with initial min_stake
        let mut keygen = KeyGen::from_os_rng();
        let root_key = keygen.generate_ed25519_private_key().public_key();
        let framework = ReleaseBundle::default(); // simplified
        let genesis_config = GenesisConfiguration {
            min_stake: 1_000_000,
            // ... other fields
        };
        
        let mut genesis_info = GenesisInfo::new(
            ChainId::test(),
            root_key,
            vec![], // no validators for this test
            framework,
            &genesis_config,
        ).unwrap();
        
        // Get genesis with min_stake = 1_000_000
        let genesis_v1 = genesis_info.get_genesis().clone();
        
        // Mutate min_stake after caching
        genesis_info.min_stake = 1;
        
        // Get genesis again - should regenerate with min_stake = 1, 
        // but BUG: returns cached version with min_stake = 1_000_000
        let genesis_v2 = genesis_info.get_genesis().clone();
        
        // These should be different if cache was invalidated
        // But they're the same - proving the bug
        assert_eq!(genesis_v1, genesis_v2); // Bug: they're equal when they shouldn't be
        
        // The in-memory object says min_stake = 1
        assert_eq!(genesis_info.min_stake, 1);
        
        // But the cached genesis was generated with min_stake = 1_000_000
        // This inconsistency could cause validators to have mismatched genesis
    }
}
```

## Notes

While the current codebase does not exhibit exploitable instances of this bug, the public API design creates a significant footgun for future development. The genesis ceremony is a critical one-time operation that establishes the foundation of the entire blockchain network. Any inconsistency in genesis parameters could have catastrophic consequences requiring network restart or hard fork.

This issue represents a violation of the principle of least privilege in API design - configuration fields should not be publicly mutable after the object is constructed, especially when caching is involved. The fix is straightforward and should be implemented as a defensive measure to prevent future bugs.

### Citations

**File:** crates/aptos-genesis/src/lib.rs (L39-83)
```rust
/// Holder object for all pieces needed to generate a genesis transaction
#[derive(Clone)]
pub struct GenesisInfo {
    /// ChainId for identifying the network
    chain_id: ChainId,
    /// Key used for minting tokens
    root_key: Ed25519PublicKey,
    /// Set of configurations for validators on the network
    validators: Vec<Validator>,
    /// Released framework packages
    framework: ReleaseBundle,
    /// The genesis transaction, once it's been generated
    genesis: Option<Transaction>,

    /// Whether to allow new validators to join the set after genesis
    pub allow_new_validators: bool,
    /// Duration of an epoch
    pub epoch_duration_secs: u64,
    pub is_test: bool,
    /// Minimum stake to be in the validator set
    pub min_stake: u64,
    /// Minimum number of votes to consider a proposal valid.
    pub min_voting_threshold: u128,
    /// Maximum stake to be in the validator set
    pub max_stake: u64,
    /// Minimum number of seconds to lockup staked coins
    pub recurring_lockup_duration_secs: u64,
    /// Required amount of stake to create proposals.
    pub required_proposer_stake: u64,
    /// Percentage of stake given out as rewards a year (0-100%).
    pub rewards_apy_percentage: u64,
    /// Voting duration for a proposal in seconds.
    pub voting_duration_secs: u64,
    /// Percent of current epoch's total voting power that can be added in this epoch.
    pub voting_power_increase_limit: u64,

    pub consensus_config: OnChainConsensusConfig,
    pub execution_config: OnChainExecutionConfig,
    pub gas_schedule: GasScheduleV2,
    pub initial_features_override: Option<Features>,
    pub randomness_config_override: Option<OnChainRandomnessConfig>,
    pub jwk_consensus_config_override: Option<OnChainJWKConsensusConfig>,
    pub initial_jwks: Vec<IssuerJWK>,
    pub keyless_groth16_vk: Option<Groth16VerificationKey>,
}
```

**File:** crates/aptos-genesis/src/lib.rs (L127-134)
```rust
    pub fn get_genesis(&mut self) -> &Transaction {
        if let Some(ref genesis) = self.genesis {
            genesis
        } else {
            self.genesis = Some(self.generate_genesis_txn());
            self.genesis.as_ref().unwrap()
        }
    }
```

**File:** crates/aptos-genesis/src/lib.rs (L136-166)
```rust
    fn generate_genesis_txn(&self) -> Transaction {
        aptos_vm_genesis::encode_genesis_transaction(
            self.root_key.clone(),
            &self.validators,
            &self.framework,
            self.chain_id,
            &aptos_vm_genesis::GenesisConfiguration {
                allow_new_validators: self.allow_new_validators,
                epoch_duration_secs: self.epoch_duration_secs,
                is_test: true,
                min_stake: self.min_stake,
                min_voting_threshold: self.min_voting_threshold,
                max_stake: self.max_stake,
                recurring_lockup_duration_secs: self.recurring_lockup_duration_secs,
                required_proposer_stake: self.required_proposer_stake,
                rewards_apy_percentage: self.rewards_apy_percentage,
                voting_duration_secs: self.voting_duration_secs,
                voting_power_increase_limit: self.voting_power_increase_limit,
                employee_vesting_start: 1663456089,
                employee_vesting_period_duration: 5 * 60, // 5 minutes
                initial_features_override: self.initial_features_override.clone(),
                randomness_config_override: self.randomness_config_override.clone(),
                jwk_consensus_config_override: self.jwk_consensus_config_override.clone(),
                initial_jwks: self.initial_jwks.clone(),
                keyless_groth16_vk: self.keyless_groth16_vk.clone(),
            },
            &self.consensus_config,
            &self.execution_config,
            &self.gas_schedule,
        )
    }
```

**File:** crates/aptos-genesis/src/builder.rs (L677-686)
```rust
        let mut genesis_info = GenesisInfo::new(
            ChainId::test(),
            root_key,
            configs,
            self.framework.clone(),
            &genesis_config,
        )?;
        let waypoint = genesis_info.generate_waypoint()?;
        let genesis = genesis_info.get_genesis();

```

**File:** crates/aptos/src/genesis/mod.rs (L122-125)
```rust
            let mut test_genesis = fetch_genesis_info(self.git_options)?;
            let genesis_bytes = bcs::to_bytes(test_genesis.clone().get_genesis())
                .map_err(|e| CliError::BCS(GENESIS_FILE, e))?;
            (genesis_bytes, test_genesis.generate_waypoint()?)
```
