# Audit Report

## Title
Information Disclosure via Debug Logging of Sensitive Node Configuration Data

## Summary
The `BaselineConfiguration` struct derives the `Debug` trait and is logged at INFO level during node-checker startup, exposing sensitive internal network topology (URLs, ports) and cryptographic public keys to anyone with access to production logs. [1](#0-0) 

## Finding Description
The node-checker service logs the entire baseline configuration at INFO level during startup, which is enabled by default in production. The `BaselineConfiguration` struct contains a `node_address` field of type `Option<NodeAddress>`, which itself contains sensitive operational data including internal network URLs, service ports (API, metrics, noise), and x25519 public keys used for validator communication. [2](#0-1) 

The default logging level is set to INFO: [3](#0-2) 

The `NodeAddress` struct exposes: [4](#0-3) 

Aptos infrastructure sends logs to centralized telemetry services (Humio/Loki) where they can be queried. An attacker who gains access to these logs through compromised credentials, misconfigured access controls, or log aggregation system vulnerabilities can extract:
- Internal network topology and service endpoints
- Port configurations for API, metrics, and validator communication
- x25519 public keys used in the noise protocol for validator authentication

## Impact Explanation
This is a **Medium severity** information disclosure vulnerability. While it doesn't directly cause funds loss or consensus violations, it provides attackers with valuable reconnaissance information about the network infrastructure that can facilitate more sophisticated attacks:

1. **Network Topology Discovery**: Attackers learn internal URLs and service architecture
2. **Attack Surface Mapping**: Knowledge of which ports run which services enables targeted attacks
3. **Cryptographic Material Exposure**: Public keys can be used to identify validators and plan targeted network-level attacks

The exposure goes beyond "minor information leaks" (Low severity) because it reveals operational security details of validator infrastructure.

## Likelihood Explanation
**High likelihood** of occurrence:
- The vulnerability exists in production code with INFO logging enabled by default
- Logs are automatically generated at every node-checker service startup
- Logs are transmitted to centralized aggregation systems, increasing the attack surface
- Access depends on attacker obtaining credentials to log systems, which is feasible through phishing, insider threats, or misconfigured access controls

## Recommendation
Implement custom `Debug` formatting that redacts sensitive fields:

```rust
impl std::fmt::Debug for NodeAddress {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_struct("NodeAddress")
            .field("url", &"<redacted>")
            .field("api_port", &self.api_port)
            .field("metrics_port", &self.metrics_port)
            .field("noise_port", &self.noise_port)
            .field("public_key", &"<redacted>")
            .finish()
    }
}
```

Alternatively, remove the `Debug` derive from `BaselineConfiguration` and `NodeAddress`, or reduce the logging verbosity to only log the `configuration_id` instead of the full configuration object.

## Proof of Concept

Create a baseline configuration file `test_config.yaml`:
```yaml
node_address:
  url: "http://internal-validator-01.aptos.internal"
  api_port: 8080
  metrics_port: 9101
  noise_port: 6180
  public_key: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
configuration_id: "mainnet_validator"
configuration_name: "Mainnet Validator"
runner_config:
  num_retries: 3
  retry_delay_secs: 2
provider_configs: {}
checkers: []
```

Run the node-checker server:
```bash
cargo run --bin aptos-node-checker -- server run --baseline-config-paths test_config.yaml --listen-address 127.0.0.1 --listen-port 8080
```

Observe the logs which will output:
```
INFO Running with the following configuration: {
    "mainnet_validator": BaselineConfigurationRunner {
        configuration: BaselineConfiguration {
            node_address: Some(NodeAddress {
                url: Url { scheme: "http", host: Some(Domain("internal-validator-01.aptos.internal")), ... },
                api_port: Some(8080),
                metrics_port: Some(9101),
                noise_port: Some(6180),
                public_key: Some(PublicKey(...)),
                ...
            }),
            ...
        }
    }
}
```

This log entry exposes internal network topology and cryptographic material that should not be accessible to unauthorized parties with log access.

## Notes
The vulnerability also exists in the validate command where configurations are logged at DEBUG level, though this is less severe as DEBUG logging is typically disabled in production. The primary concern is the INFO-level logging during normal service startup. [5](#0-4)

### Citations

**File:** ecosystem/node-checker/src/configuration/types.rs (L9-15)
```rust
#[derive(Clone, Debug, Deserialize, Serialize)]
#[serde(deny_unknown_fields)]
pub struct BaselineConfiguration {
    /// The address of the baseline node to use for this configuration. This is
    /// only necessary if this baseline configuration uses a Checker that
    /// requires information from a baseline node to operate.
    pub node_address: Option<NodeAddress>,
```

**File:** ecosystem/node-checker/src/server/run.rs (L36-39)
```rust
    info!(
        "Running with the following configuration: {:#?}",
        baseline_configurations.0
    );
```

**File:** ecosystem/node-checker/src/bin/aptos-node-checker.rs (L28-30)
```rust
    aptos_logger::Logger::builder()
        .level(aptos_logger::Level::Info)
        .build();
```

**File:** ecosystem/node-checker/src/configuration/node_address.rs (L13-35)
```rust
#[derive(Clone, Debug, Deserialize, Serialize)]
pub struct NodeAddress {
    /// Target URL. This should include a scheme (e.g. http://). If there is no
    /// scheme, we will prepend http://.
    pub url: Url,

    /// API port.
    api_port: Option<u16>,

    /// Metrics port.
    metrics_port: Option<u16>,

    /// Validator communication port.
    noise_port: Option<u16>,

    /// Public key for the node. This is used for the HandshakeChecker.
    /// If that Checker is not enabled, this is not necessary.
    public_key: Option<x25519::PublicKey>,

    // Cookie store.
    #[serde(skip)]
    cookie_store: Arc<Jar>,
}
```

**File:** ecosystem/node-checker/src/configuration/validate.rs (L20-20)
```rust
    debug!("Validated configuration: {:#?}", configuration);
```
