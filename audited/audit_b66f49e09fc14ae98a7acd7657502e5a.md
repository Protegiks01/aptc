# Audit Report

## Title
Rosetta Client Lacks Gas Price Validation Enabling Malicious Server to Cause Fund Loss Through Overpayment

## Summary
The Rosetta client in `submit_operations()` does not validate gas prices returned by the Rosetta server against blockchain-enforced bounds (100 to 10,000,000,000 octas). When `gas_unit_price` is `None`, a malicious or compromised Rosetta server can suggest an arbitrarily high gas price within the maximum bound, causing users to sign and submit transactions that result in massive overpayment of gas fees, leading to permanent loss of funds.

## Finding Description
When a user calls `submit_operations()` with `gas_unit_price: None`, the client delegates gas price determination entirely to the Rosetta server without any validation: [1](#0-0) 

The server returns a `ConstructionMetadataResponse` containing `gas_price_per_unit`. The client performs only a consistency check: [2](#0-1) 

This validation merely ensures that `max_gas_amount * gas_price_per_unit >= suggested_fee`, but both values come from the same potentially malicious server. There is **no validation** that `gas_price_per_unit` is within the blockchain's enforced bounds.

The blockchain enforces gas price bounds during transaction validation: [3](#0-2) 

With maximum bound defined as: [4](#0-3) 

**Attack Path**:
1. User connects to malicious/compromised Rosetta server
2. User calls `submit_operations()` with `gas_unit_price: None`
3. Malicious server returns `gas_price_per_unit: 9_000_000_000` (just below 10B maximum)
4. Server also returns `suggested_fee` that matches the calculation
5. Client validation passes (line 681-684)
6. Transaction is built with inflated gas price: [5](#0-4) 

7. User signs the transaction unknowingly
8. Blockchain accepts transaction (9B < 10B max bound)
9. User pays up to 18 quadrillion octas (180,000 APT) vs typical 100-1,000 APT
10. Funds are permanently lost

## Impact Explanation
This vulnerability enables **Loss of Funds** through gas fee overpayment, qualifying as **Critical Severity** under the Aptos bug bounty program. A single transaction could result in loss of up to 180,000 APT (with `gas_price_per_unit=9_000_000_000` and `max_gas_amount=2_000_000`), representing approximately 90,000,000x overpayment compared to normal gas prices of ~100 octas/unit. This breaks the **Resource Limits** invariant that all operations must respect gas limits and pricing constraints.

## Likelihood Explanation
The likelihood is **Medium to High** because:
- Requires user to connect to malicious/compromised Rosetta server
- Exploitation is trivial once server is malicious (just return high gas price)
- No special privileges or complex attack chain required
- Affects any user who doesn't explicitly provide `gas_unit_price` parameter
- Vulnerable to server compromise, MITM attacks, or users misconfiguring server URLs
- No client-side protection mechanism exists

## Recommendation
Implement client-side validation of gas prices against blockchain bounds before transaction construction:

```rust
// In submit_operations() after line 671, add validation:
let gas_price = metadata.metadata.gas_price_per_unit.0;

// Validate against blockchain gas price bounds
const MIN_GAS_PRICE: u64 = 100; // aptos_global_constants::GAS_UNIT_PRICE
const MAX_GAS_PRICE: u64 = 10_000_000_000; // from transaction.rs

if gas_price < MIN_GAS_PRICE {
    return Err(anyhow!(
        "Gas price {} below minimum bound {}",
        gas_price,
        MIN_GAS_PRICE
    ));
}

if gas_price > MAX_GAS_PRICE {
    return Err(anyhow!(
        "Gas price {} exceeds maximum bound {}",
        gas_price,
        MAX_GAS_PRICE
    ));
}

// Optional: Warn if gas price is unusually high (e.g., > 10,000)
if gas_price > 10_000 {
    eprintln!(
        "WARNING: Gas price {} is unusually high. Normal range is 100-1000.",
        gas_price
    );
}
```

Additionally, import the actual constants from the gas schedule module rather than hardcoding them.

## Proof of Concept

```rust
use aptos_rosetta::client::RosettaClient;
use aptos_rosetta::types::*;
use url::Url;

#[tokio::test]
async fn test_gas_price_manipulation() {
    // 1. Start a malicious Rosetta server that returns inflated gas prices
    let malicious_server = start_malicious_rosetta_server().await;
    
    // 2. Create client pointing to malicious server
    let client = RosettaClient::new(Url::parse(&malicious_server.url()).unwrap());
    
    // 3. Attempt transfer with gas_unit_price=None (delegate to server)
    let network = NetworkIdentifier { /* ... */ };
    let private_key = Ed25519PrivateKey::generate_for_testing();
    let receiver = AccountAddress::random();
    
    // This will use the malicious server's inflated gas price
    let result = client.transfer(
        &network,
        &private_key,
        receiver,
        1000, // amount
        expiry_time,
        None, // sequence_number
        None, // max_gas
        None, // gas_unit_price - DELEGATING TO SERVER
        native_coin(),
    ).await;
    
    // 4. Verify that transaction was built with inflated gas price
    // by examining the signed transaction
    assert!(result.is_ok());
    
    // 5. Parse the transaction and check gas_unit_price
    // Expected: gas_price = 9_000_000_000 (from malicious server)
    // Actual cost: 18 quadrillion octas instead of typical 200 million
}

async fn start_malicious_rosetta_server() -> MaliciousServer {
    // Mock Rosetta server that returns:
    // - gas_price_per_unit: 9_000_000_000 
    // - suggested_fee: matching calculation
    // - max_gas_amount: 2_000_000
    MaliciousServer::new(/* ... */)
}
```

**Notes**

The vulnerability exists because the Rosetta client treats the server as fully trusted for gas price determination without implementing defense-in-depth validation. Even though users may typically run their own Rosetta servers, the client should validate all security-critical parameters against blockchain bounds to protect against server compromise, bugs, MITM attacks, and user misconfiguration. The minimum gas price bound is defined as 100 octas/unit in production builds [6](#0-5) , and validation should enforce both bounds at the client layer before requesting user signatures.

### Citations

**File:** crates/aptos-rosetta/src/client.rs (L646-671)
```rust
    async fn submit_operations(
        &self,
        sender: AccountAddress,
        network_identifier: NetworkIdentifier,
        keys: &HashMap<AccountAddress, &Ed25519PrivateKey>,
        operations: Vec<Operation>,
        expiry_time_secs: u64,
        sequence_number: Option<u64>,
        max_gas: Option<u64>,
        gas_unit_price: Option<u64>,
        // Parsed operations won't match given operations
        parse_not_same: bool,
    ) -> anyhow::Result<TransactionIdentifier> {
        // Retrieve txn metadata
        let (metadata, public_keys) = self
            .metadata_for_ops(
                sender,
                network_identifier.clone(),
                operations.clone(),
                max_gas,
                gas_unit_price,
                expiry_time_secs,
                sequence_number,
                keys,
            )
            .await?;
```

**File:** crates/aptos-rosetta/src/client.rs (L673-684)
```rust
        // Should have a fee in the native coin
        let suggested_fee = metadata.suggested_fee.first().expect("Expected fee");
        let expected_fee = u64::from_str(&suggested_fee.value).expect("Expected u64 for fee");
        assert_eq!(
            suggested_fee.currency,
            native_coin(),
            "Fee should always be the native coin"
        );
        assert!(
            metadata.metadata.max_gas_amount.0 * metadata.metadata.gas_price_per_unit.0
                >= expected_fee
        );
```

**File:** aptos-move/aptos-vm/src/gas.rs (L194-208)
```rust
    // The submitted gas price is greater than the maximum gas unit price set by the VM.
    if txn_metadata.gas_unit_price() > txn_gas_params.max_price_per_gas_unit {
        speculative_warn!(
            log_context,
            format!(
                "[VM] Gas unit error; max {}, submitted {}",
                txn_gas_params.max_price_per_gas_unit,
                txn_metadata.gas_unit_price()
            ),
        );
        return Err(VMStatus::error(
            StatusCode::GAS_UNIT_PRICE_ABOVE_MAX_BOUND,
            None,
        ));
    }
```

**File:** aptos-move/aptos-gas-schedule/src/gas_schedule/transaction.rs (L66-71)
```rust
        // The maximum gas unit price that a transaction can be submitted with.
        [
            max_price_per_gas_unit: FeePerGasUnit,
            "max_price_per_gas_unit",
            10_000_000_000
        ],
```

**File:** crates/aptos-rosetta/src/construction.rs (L1386-1388)
```rust
    let transaction_factory = TransactionFactory::new(server_context.chain_id)
        .with_gas_unit_price(metadata.gas_price_per_unit.0)
        .with_max_gas_amount(metadata.max_gas_amount.0);
```

**File:** config/global-constants/src/lib.rs (L23-26)
```rust
#[cfg(any(test, feature = "testing"))]
pub const GAS_UNIT_PRICE: u64 = 0;
#[cfg(not(any(test, feature = "testing")))]
pub const GAS_UNIT_PRICE: u64 = 100;
```
