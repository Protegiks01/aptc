# Audit Report

## Title
Genesis Initialization Panic Due to Missing NetworkId::Public Assumption in ValidatorConfiguration Conversion

## Summary
The `TryFrom<&ValidatorNodeConfig> for ValidatorConfiguration` implementation assumes that a `NetworkId::Public` network always exists in the `full_node_networks` configuration and calls `.unwrap()` on the find result. This causes a panic during genesis initialization when custom network configurations omit the Public network, breaking the genesis process for private networks and custom testnets.

## Finding Description
The vulnerability exists in the conversion function that transforms a `ValidatorNodeConfig` into a `ValidatorConfiguration` during genesis initialization. [1](#0-0) 

This code uses `.unwrap()` after searching for a network with `NetworkId::Public`, making a hard assumption that such a network must exist. However, this assumption is violated by legitimate configuration scenarios:

**Attack Vector:**
1. An operator creates a custom validator configuration for a private network or testnet
2. Following the official validator.yaml template, they configure only a VFN (Validator Full Node) network without a Public network [2](#0-1) 
3. The configuration is loaded via `OverrideNodeConfig::load_config()` [3](#0-2) 
4. During genesis ceremony, the conversion is attempted [4](#0-3) 
5. The `.unwrap()` call panics because no Public network exists, terminating the genesis process

This breaks the deterministic error handling invariantâ€”the function returns a `Result` type but panics instead of returning an error, preventing proper error handling and making debugging difficult.

## Impact Explanation
This qualifies as **Medium Severity** under the Aptos bug bounty criteria: "State inconsistencies requiring intervention."

**Specific Impact:**
- **Genesis Initialization Failure**: Custom networks cannot complete genesis when using configurations without a Public network
- **Operational Disruption**: Private networks, alternative testnets, and custom deployments fail to start
- **Poor Error Handling**: The panic provides no helpful error message, making diagnosis difficult for operators
- **Configuration Fragility**: Valid configuration files based on official templates cause unexpected failures

The impact is limited to network initialization and doesn't affect running networks or mainnet deployments that use the standard Builder path, which always creates both Public and VFN networks. [5](#0-4) 

## Likelihood Explanation
**Likelihood: Medium-High for custom deployments**

The vulnerability is highly likely to occur in the following scenarios:
1. **Custom Network Deployments**: Operators setting up private networks or internal testnets may intentionally omit public fullnode networks
2. **Template-Based Configuration**: The official validator.yaml test data file demonstrates this exact scenario, serving as a template that users might follow
3. **Configuration Modularity**: The `OverrideNodeConfig` abstraction allows loading arbitrary configurations from YAML files, making this scenario straightforward to trigger

However, it's unlikely to affect:
- Standard mainnet/testnet deployments using the default Builder
- Networks initialized through the standard `Builder::build()` path

The existence of validator.yaml as an official configuration example increases the likelihood that operators will create configurations that trigger this issue.

## Recommendation
Replace the `.unwrap()` call with proper error handling that returns a descriptive error when the Public network is missing:

**Recommended Fix:**
```rust
let full_node_host = match config
    .config
    .override_config()
    .full_node_networks
    .iter()
    .find(|network| network.network_id == NetworkId::Public)
{
    Some(network) => Some((&network.listen_address).try_into()?),
    None => {
        // For custom networks without public fullnode networks, this is acceptable
        // Return None instead of panicking
        None
    }
};
```

Alternatively, if Public network is truly required, return a clear error:
```rust
let public_network = config
    .config
    .override_config()
    .full_node_networks
    .iter()
    .find(|network| network.network_id == NetworkId::Public)
    .ok_or_else(|| anyhow::anyhow!(
        "ValidatorConfiguration requires a Public fullnode network, but none was found in full_node_networks"
    ))?;

let full_node_host = Some((&public_network.listen_address).try_into()?);
```

This change should be applied to the conversion implementation. [6](#0-5) 

## Proof of Concept
```rust
#[cfg(test)]
mod test {
    use super::*;
    use aptos_config::config::{NetworkConfig, NodeConfig, OverrideNodeConfig};
    use aptos_config::network_id::NetworkId;
    use std::path::PathBuf;

    #[test]
    #[should_panic(expected = "called `Option::unwrap()` on a `None` value")]
    fn test_validator_config_conversion_panics_without_public_network() {
        // Create a ValidatorNodeConfig with only a VFN network, no Public network
        let mut node_config = NodeConfig::default();
        node_config.base.role = aptos_config::config::RoleType::Validator;
        
        // Configure only VFN network (similar to validator.yaml test data)
        let vfn_network = NetworkConfig {
            network_id: NetworkId::Vfn,
            listen_address: "/ip4/0.0.0.0/tcp/6181".parse().unwrap(),
            ..Default::default()
        };
        node_config.full_node_networks = vec![vfn_network];
        
        // Configure validator network
        let validator_network = NetworkConfig {
            network_id: NetworkId::Validator,
            listen_address: "/ip4/0.0.0.0/tcp/6180".parse().unwrap(),
            ..Default::default()
        };
        node_config.validator_network = Some(validator_network);
        
        let override_config = OverrideNodeConfig::new_with_default_base(node_config);
        
        let mut validator_config = ValidatorNodeConfig {
            name: "test_validator".to_string(),
            index: 0,
            config: override_config,
            dir: PathBuf::from("/tmp/test"),
            account_private_key: None,
            genesis_stake_amount: 100000,
            commission_percentage: 0,
        };
        
        // Initialize keys to populate private_identity
        validator_config.init_keys(Some([0u8; 32])).unwrap();
        
        // This conversion will panic because no Public network exists
        let _validator_configuration: ValidatorConfiguration = 
            (&validator_config).try_into().unwrap();
    }
}
```

**To run this test:**
```bash
cd crates/aptos-genesis
cargo test test_validator_config_conversion_panics_without_public_network -- --nocapture
```

The test will panic with "called `Option::unwrap()` on a `None` value", demonstrating the vulnerability.

## Notes
This vulnerability only affects genesis initialization for custom network configurations. Standard deployments using the `Builder::generate_validator_config()` method are not affected as they always create both Public and VFN networks. However, the existence of the validator.yaml test data file without a Public network suggests this is a valid configuration scenario that should be properly supported or explicitly rejected with a clear error message rather than a panic.

### Citations

**File:** crates/aptos-genesis/src/builder.rs (L192-241)
```rust
impl TryFrom<&ValidatorNodeConfig> for ValidatorConfiguration {
    type Error = anyhow::Error;

    fn try_from(config: &ValidatorNodeConfig) -> Result<Self, Self::Error> {
        let (_, _, private_identity, _) = config.get_key_objects(None)?;
        let validator_host = (&config
            .config
            .override_config()
            .validator_network
            .as_ref()
            .unwrap()
            .listen_address)
            .try_into()?;
        let full_node_host = Some(
            (&config
                .config
                .override_config()
                .full_node_networks
                .iter()
                .find(|network| network.network_id == NetworkId::Public)
                .unwrap()
                .listen_address)
                .try_into()?,
        );
        Ok(ValidatorConfiguration {
            owner_account_address: private_identity.account_address.into(),
            owner_account_public_key: private_identity.account_private_key.public_key(),
            operator_account_address: private_identity.account_address.into(),
            operator_account_public_key: private_identity.account_private_key.public_key(),
            voter_account_address: private_identity.account_address.into(),
            voter_account_public_key: private_identity.account_private_key.public_key(),
            consensus_public_key: Some(private_identity.consensus_private_key.public_key()),
            proof_of_possession: Some(bls12381::ProofOfPossession::create(
                &private_identity.consensus_private_key,
            )),
            validator_network_public_key: Some(
                private_identity.validator_network_private_key.public_key(),
            ),
            validator_host: Some(validator_host),
            full_node_network_public_key: Some(
                private_identity.full_node_network_private_key.public_key(),
            ),
            full_node_host,
            stake_amount: config.genesis_stake_amount,
            commission_percentage: config.commission_percentage,
            // Default to joining the genesis validator set.
            join_during_genesis: true,
        })
    }
}
```

**File:** crates/aptos-genesis/src/builder.rs (L597-615)
```rust
        let fullnode_network = NetworkConfig {
            listen_address: fullnode_network_listen_address,
            network_id: NetworkId::Public,
            max_outbound_connections: 0,
            discovery_method: DiscoveryMethod::Onchain,
            identity: Identity::from_file(vfn_identity_path.clone()),
            ..Default::default()
        };

        // VFN has the same credentials as the public full node identity
        let vfn_network = NetworkConfig {
            listen_address: aptos_config::utils::get_available_port_in_multiaddr(true),
            network_id: NetworkId::Vfn,
            max_outbound_connections: 0,
            identity: Identity::from_file(vfn_identity_path),
            ..Default::default()
        };

        config.full_node_networks = vec![fullnode_network, vfn_network];
```

**File:** crates/aptos-genesis/src/builder.rs (L645-647)
```rust
        for validator in validators.iter() {
            configs.push(validator.try_into()?);
        }
```

**File:** config/src/config/test_data/validator.yaml (L24-38)
```yaml
full_node_networks:
    - listen_address: "/ip4/0.0.0.0/tcp/6181"
      max_outbound_connections: 0
      identity:
          type: "from_storage"
          key_name: "fullnode_network"
          peer_id_name: "owner_account"
          backend:
              type: "vault"
              server: "https://127.0.0.1:8200"
              ca_certificate: "/full/path/to/certificate"
              token:
                  from_disk: "/full/path/to/token"
      network_id:
          private: "vfn"
```

**File:** config/src/config/override_node_config.rs (L137-140)
```rust
    fn load_config<P: AsRef<Path>>(path: P) -> Result<Self, Error> {
        let config = NodeConfig::load_config(path)?;
        Ok(Self::new_with_default_base(config))
    }
```
