# Audit Report

## Title
Insecure File Permissions on Genesis Blob and Waypoint Files During Generation

## Summary
The `write_to_file()` function used to create `genesis.blob` and `waypoint.txt` does not set explicit restrictive file permissions, resulting in world-readable files (typically 0644 on Unix systems). This creates an information disclosure vulnerability during the genesis generation phase and inconsistency with how other sensitive files are protected in the codebase.

## Finding Description

The genesis generation process uses the `write_to_file()` function to create critical blockchain initialization files: [1](#0-0) 

This function is implemented without explicit file permission settings: [2](#0-1) 

The underlying implementation creates files with default permissions based on the user's umask: [3](#0-2) 

With a typical umask of 0022, files are created with 0644 permissions (rw-r--r--), making them readable by all users on the system.

**Critical Inconsistency**: The codebase provides a secure alternative `write_to_user_only_file()` that sets restrictive 0600 permissions: [4](#0-3) 

This secure function is used for private keys, validator identity files, and other sensitive data: [5](#0-4) 

However, genesis.blob and waypoint.txt—which contain the entire initial blockchain state including validator configurations, stake amounts, and cryptographic waypoints—are written using the insecure function.

## Impact Explanation

**Medium Severity** - State inconsistencies requiring intervention:

1. **Information Disclosure**: During genesis generation, any local user can read these files before official publication, potentially enabling:
   - Premature access to validator addresses and stake configurations
   - Early knowledge of genesis state allowing preparation of targeted attacks
   - Front-running of network launch activities

2. **Integrity Risk**: While default 0644 permissions prevent direct modification by non-owners, the lack of restrictive permissions increases the attack surface for:
   - Directory-level attacks if parent directory has loose permissions
   - Race conditions during the critical window between file creation and upload to Kubernetes secrets
   - Symbolic link attacks in certain deployment scenarios

3. **Operational Security Gap**: In the containerized deployment model shown in the genesis script, files are temporarily stored on disk before being uploaded to secure storage, creating an exposure window where improper permissions matter most. [6](#0-5) 

## Likelihood Explanation

**Medium Likelihood**: 
- Genesis generation is a time-limited but critical operation performed during network initialization
- Multi-user systems, shared CI/CD environments, and containerized deployments increase exposure
- The vulnerability is deterministic—it occurs every time genesis is generated
- Attack requires local access during generation window, limiting but not eliminating the threat

## Recommendation

Use `write_to_user_only_file()` instead of `write_to_file()` for genesis artifacts to match the security posture of other sensitive files:

```rust
// In crates/aptos/src/genesis/mod.rs, replace lines 127-132:
write_to_user_only_file(genesis_file.as_path(), GENESIS_FILE, &genesis_bytes)?;
write_to_user_only_file(
    waypoint_file.as_path(),
    WAYPOINT_FILE,
    waypoint.to_string().as_bytes(),
)?;
```

This ensures files are created with 0600 permissions (owner read/write only), consistent with the protection applied to private keys and validator identity files.

## Proof of Concept

```rust
use std::fs;
use std::os::unix::fs::PermissionsExt;
use std::path::PathBuf;
use tempfile::tempdir;

#[test]
fn test_genesis_file_permissions_vulnerability() {
    // Create temporary directory
    let temp_dir = tempdir().unwrap();
    let genesis_file = temp_dir.path().join("genesis.blob");
    let waypoint_file = temp_dir.path().join("waypoint.txt");
    
    // Simulate genesis generation using write_to_file
    let test_data = b"genesis_data";
    std::fs::write(&genesis_file, test_data).unwrap();
    std::fs::write(&waypoint_file, b"waypoint").unwrap();
    
    // Check permissions
    let genesis_perms = fs::metadata(&genesis_file).unwrap().permissions();
    let waypoint_perms = fs::metadata(&waypoint_file).unwrap().permissions();
    
    // On Unix, default umask 0022 results in 0644 permissions
    let mode = genesis_perms.mode() & 0o777;
    println!("Genesis file permissions: {:o}", mode);
    
    // Verify files are world-readable (security issue)
    assert_eq!(mode & 0o004, 0o004, "Genesis file is world-readable");
    
    // Compare with secure alternative
    use std::fs::OpenOptions;
    let secure_file = temp_dir.path().join("secure.blob");
    let mut opts = OpenOptions::new();
    opts.mode(0o600);
    opts.write(true).create(true).truncate(true);
    let mut file = opts.open(&secure_file).unwrap();
    use std::io::Write;
    file.write_all(test_data).unwrap();
    
    let secure_perms = fs::metadata(&secure_file).unwrap().permissions();
    let secure_mode = secure_perms.mode() & 0o777;
    println!("Secure file permissions: {:o}", secure_mode);
    
    // Secure file should not be world-readable
    assert_eq!(secure_mode, 0o600, "Secure file has restricted permissions");
    assert_ne!(mode, secure_mode, "Genesis uses less secure permissions than available");
}
```

**Notes**

This vulnerability represents a security best practice violation where critical blockchain initialization files are created with overly permissive file permissions. While the files are eventually made public for network distribution, they should be protected during the sensitive genesis generation phase. The inconsistent use of secure file writing functions elsewhere in the codebase (for private keys and validator identities) indicates this is an oversight rather than intentional design.

### Citations

**File:** crates/aptos/src/genesis/mod.rs (L127-132)
```rust
        write_to_file(genesis_file.as_path(), GENESIS_FILE, &genesis_bytes)?;
        write_to_file(
            waypoint_file.as_path(),
            WAYPOINT_FILE,
            waypoint.to_string().as_bytes(),
        )?;
```

**File:** crates/aptos/src/common/utils.rs (L218-221)
```rust
/// Write a `&[u8]` to a file
pub fn write_to_file(path: &Path, name: &str, bytes: &[u8]) -> CliTypedResult<()> {
    write_to_file_with_opts(path, name, bytes, &mut OpenOptions::new())
}
```

**File:** crates/aptos/src/common/utils.rs (L223-229)
```rust
/// Write a User only read / write file
pub fn write_to_user_only_file(path: &Path, name: &str, bytes: &[u8]) -> CliTypedResult<()> {
    let mut opts = OpenOptions::new();
    #[cfg(unix)]
    opts.mode(0o600);
    write_to_file_with_opts(path, name, bytes, &mut opts)
}
```

**File:** crates/aptos/src/common/utils.rs (L232-246)
```rust
pub fn write_to_file_with_opts(
    path: &Path,
    name: &str,
    bytes: &[u8],
    opts: &mut OpenOptions,
) -> CliTypedResult<()> {
    let mut file = opts
        .write(true)
        .create(true)
        .truncate(true)
        .open(path)
        .map_err(|e| CliError::IO(name.to_string(), e))?;
    file.write_all(bytes)
        .map_err(|e| CliError::IO(name.to_string(), e))
}
```

**File:** crates/aptos/src/genesis/keys.rs (L82-97)
```rust
        write_to_user_only_file(
            private_keys_file.as_path(),
            PRIVATE_KEYS_FILE,
            to_yaml(&private_identity)?.as_bytes(),
        )?;
        write_to_user_only_file(
            public_keys_file.as_path(),
            PUBLIC_KEYS_FILE,
            to_yaml(&public_identity)?.as_bytes(),
        )?;
        write_to_user_only_file(
            validator_file.as_path(),
            VALIDATOR_FILE,
            to_yaml(&validator_blob)?.as_bytes(),
        )?;
        write_to_user_only_file(vfn_file.as_path(), VFN_FILE, to_yaml(&vfn_blob)?.as_bytes())?;
```

**File:** terraform/helm/genesis/files/genesis.sh (L132-133)
```shellscript
aptos genesis generate-genesis --local-repository-dir ${WORKSPACE} --output-dir ${WORKSPACE}

```
