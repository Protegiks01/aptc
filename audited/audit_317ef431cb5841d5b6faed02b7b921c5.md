# Audit Report

## Title
Indexer Monitoring Metric Not Reset During Rollback Causing Incorrect Progress Tracking

## Summary
The `LATEST_PROCESSED_VERSION` Prometheus gauge metric is not properly initialized or decremented when the indexer must rollback and reprocess transactions. When using Prometheus Pushgateway in production deployments, stale metric values persist after restart, causing monitoring dashboards to display incorrect indexer progress during rollback scenarios.

## Finding Description
The indexer's `LATEST_PROCESSED_VERSION` metric tracks the highest transaction version successfully processed by each processor. This metric is defined as an `IntGaugeVec` [1](#0-0)  and is only updated when batch processing succeeds via the `update_status_success()` method [2](#0-1) .

When the indexer must rollback and reprocess transactions (e.g., due to data corruption, manual intervention via `starting_version` config, or database state reset), the following sequence occurs:

1. The indexer previously processed transactions up to version 1,000,000, with `LATEST_PROCESSED_VERSION` gauge set to 1,000,000
2. In production, metrics are pushed to Prometheus Pushgateway every 15 seconds [3](#0-2) , which persists these values
3. An operator sets `starting_version: 500000` in configuration [4](#0-3)  and restarts the indexer
4. During startup, `run_forever()` retrieves the starting version from database or config [5](#0-4)  and sets the fetcher to begin from version 500,000 [6](#0-5) 
5. **No code exists to reset or initialize `LATEST_PROCESSED_VERSION` to reflect the rollback**
6. The Pushgateway retains the stale value of 1,000,000
7. When metrics are pushed [7](#0-6) , the gauge hasn't been set for this processor label yet, so the Pushgateway keeps the old value
8. Only after the first batch completes (500,000-500,499) and `update_status_success()` sets the gauge to 500,499 does the metric become accurate

This creates a window of 30-60+ seconds (restart time + batch processing + push interval) where monitoring dashboards show the indexer at version 1,000,000 when it's actually processing from version 500,000.

## Impact Explanation
This issue falls under **operational monitoring concerns** rather than the critical security categories defined in the Aptos bug bounty program. It does **not** cause:
- Loss of funds or token minting
- Consensus safety violations  
- State corruption or blockchain integrity issues
- Transaction execution errors
- Protocol security violations

The indexer is an off-chain component used for data querying and does not participate in consensus or validation. Incorrect metrics during rollback scenarios affect operational visibility but do not compromise blockchain security or user funds.

While this is a legitimate bug that should be fixed for operational excellence, it does not meet the severity thresholds (Critical/High/Medium) defined in the Aptos bug bounty program, which focus on consensus, execution, and funds safety.

## Likelihood Explanation
Rollback scenarios occur occasionally in production when:
- Data corruption is detected requiring reprocessing
- Database maintenance requires resetting to earlier state
- Manual intervention to fix indexer issues

However, the operational impact is limited to monitoring accuracy, not security.

## Recommendation
Initialize the `LATEST_PROCESSED_VERSION` metric on startup to reflect the actual starting version. After determining `start_version` in `runtime.rs`, add:

```rust
// After line 185 in crates/indexer/src/runtime.rs
use crate::counters::LATEST_PROCESSED_VERSION;

LATEST_PROCESSED_VERSION
    .with_label_values(&[processor_name.as_str()])
    .set(start_version.saturating_sub(1) as i64);
```

This ensures the metric accurately represents indexer state from the moment processing begins.

## Proof of Concept
This is a monitoring/operational bug rather than an exploitable security vulnerability. A PoC would require:
1. Running an indexer with Prometheus Pushgateway configured
2. Processing transactions to version 10,000
3. Restarting with `STARTING_VERSION=5000` environment variable set
4. Observing the Pushgateway metric remains at 10,000 until first batch completes

However, since this doesn't constitute a security vulnerability under the bug bounty criteria, no exploitation PoC is applicable.

---

**Note:** While this is a legitimate operational bug that affects monitoring accuracy, it does **not** meet the security vulnerability criteria for the Aptos bug bounty program. The indexer is a read-only off-chain component, and incorrect metrics do not affect consensus, execution, state integrity, or funds safety. This should be tracked as a feature improvement for operational excellence rather than a security issue.

### Citations

**File:** crates/indexer/src/counters.rs (L77-84)
```rust
pub static LATEST_PROCESSED_VERSION: Lazy<IntGaugeVec> = Lazy::new(|| {
    register_int_gauge_vec!(
        "indexer_processor_latest_version",
        "Latest version a processor has fully consumed",
        &["processor_name"]
    )
    .unwrap()
});
```

**File:** crates/indexer/src/indexer/transaction_processor.rs (L112-131)
```rust
    fn update_status_success(&self, processing_result: &ProcessingResult) {
        aptos_logger::debug!(
            "[{}] Marking processing version OK from versions {} to {}",
            self.name(),
            processing_result.start_version,
            processing_result.end_version
        );
        PROCESSOR_SUCCESSES.with_label_values(&[self.name()]).inc();
        LATEST_PROCESSED_VERSION
            .with_label_values(&[self.name()])
            .set(processing_result.end_version as i64);
        let psms = ProcessorStatusModel::from_versions(
            self.name(),
            processing_result.start_version,
            processing_result.end_version,
            true,
            None,
        );
        self.apply_processor_status(&psms);
    }
```

**File:** crates/aptos-push-metrics/src/lib.rs (L24-24)
```rust
const DEFAULT_PUSH_FREQUENCY_SECS: u64 = 15;
```

**File:** crates/aptos-push-metrics/src/lib.rs (L44-44)
```rust
        if let Err(e) = TextEncoder::new().encode(&aptos_metrics_core::gather(), &mut buffer) {
```

**File:** config/src/config/indexer_config.rs (L43-47)
```rust
    /// If set, will ignore database contents and start processing from the specified version.
    /// This will not delete any database contents, just transactions as it reprocesses them.
    /// Alternatively can set the `STARTING_VERSION` env var
    #[serde(default, skip_serializing_if = "Option::is_none")]
    pub starting_version: Option<u64>,
```

**File:** crates/indexer/src/runtime.rs (L163-176)
```rust
    let starting_version_from_db_short = tailer
        .get_start_version(&processor_name)
        .unwrap_or_else(|e| panic!("Failed to get starting version: {:?}", e))
        .unwrap_or_else(|| {
            info!(
                processor_name = processor_name,
                "No starting version from db so starting from version 0"
            );
            0
        }) as u64;
    let start_version = match config.starting_version {
        None => starting_version_from_db_short,
        Some(version) => version,
    };
```

**File:** crates/indexer/src/runtime.rs (L185-185)
```rust
    tailer.set_fetcher_version(start_version).await;
```
