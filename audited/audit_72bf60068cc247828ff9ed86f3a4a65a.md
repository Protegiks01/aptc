# Audit Report

## Title
Information Leakage Through Verbose Error Messages in Block API Endpoint

## Summary
The `render_bcs_block()` function exposes detailed internal error messages to API clients when `render_transactions_sequential()` fails. The error formatting uses the alternate display format `{:#}` on `anyhow::Error`, which includes the complete error chain with internal database errors, file paths, BCS deserialization details, and other implementation-specific information.

## Finding Description

When the `/blocks/by_height/:block_height` or `/blocks/by_version/:version` endpoints are called, the `render_bcs_block()` function attempts to convert transaction data to API format. [1](#0-0) 

The `render_transactions_sequential()` function processes transactions and collects errors using `anyhow::Error`, adding context with `.context("Failed to convert transaction data from storage")`. [2](#0-1) 

These errors are then converted to API responses using `internal_with_code()`, which calls `AptosError::new_with_error_code()`. [3](#0-2) 

The critical issue is in how the error message is formatted. The `new_with_error_code()` function uses `format!("{:#}", error)` to create the error message. [4](#0-3) 

The `{:#}` format specifier on `anyhow::Error` produces the **full error chain**, including all underlying causes and contexts. This can expose:

- **Database internal errors**: RocksDB-specific error messages like "IO error: No such file or directory" with potential file paths [5](#0-4) 
- **BCS deserialization details**: Specific byte offsets and data structure information [6](#0-5) 
- **Internal state information**: Module loading errors, resource access patterns, table lookup failures

The error is then returned in a JSON response with the `message` field containing all these internal details. [7](#0-6) 

## Impact Explanation

This issue falls under **Low Severity** per the Aptos bug bounty program's "Minor information leaks" category. The vulnerability does not:
- Compromise funds or enable theft
- Violate consensus safety
- Allow unauthorized state modification
- Cause denial of service

However, it does leak implementation details that could help an attacker:
- Understand the internal database structure
- Map out the storage layer architecture
- Identify potential areas for deeper exploitation
- Gain knowledge about error handling paths

## Likelihood Explanation

**Likelihood: Medium**

This issue occurs whenever transaction rendering fails, which can happen due to:
- Pruned ledger data (legitimate scenario)
- Corrupted database entries (rare but possible)
- BCS deserialization failures
- Module/resource lookup errors

An unprivileged attacker can trigger this by:
1. Querying blocks at the edge of pruned data
2. Requesting blocks during database maintenance
3. Finding blocks with unusual transaction types

The attack requires no special permissionsâ€”just API access.

## Recommendation

Replace the alternate format specifier `{:#}` with the standard format `{}` to limit error chain exposure, or implement a sanitization layer that filters sensitive information before exposing errors to API clients.

**Suggested fix in `api/types/src/error.rs`:**

```rust
pub fn new_with_error_code<ErrorType: std::fmt::Display>(
    error: ErrorType,
    error_code: AptosErrorCode,
) -> AptosError {
    Self {
        // Use {} instead of {:#} to avoid exposing full error chain
        message: format!("{}", error),
        error_code,
        vm_error_code: None,
    }
}
```

Alternatively, implement a sanitization function that removes sensitive paths, internal error codes, and implementation details before constructing the `AptosError`.

## Proof of Concept

**Setup:**
1. Run an Aptos node with the REST API enabled
2. Ensure some blocks are pruned or trigger a database error condition

**Attack Steps:**
```bash
# Query a block at the pruning boundary or during error conditions
curl -X GET "http://localhost:8080/v1/blocks/by_height/1?with_transactions=true" \
  -H "Accept: application/json"
```

**Expected vulnerable response:**
```json
{
  "message": "Failed to convert transaction data from storage: AptosDB RocksDB Error: IO error: No such file or directory: /var/lib/aptos/db/ledger_db/...",
  "error_code": "internal_error",
  "vm_error_code": null
}
```

This response exposes the internal database path structure and RocksDB implementation details.

## Notes

This is correctly categorized as **Low severity** information leakage. While it doesn't directly compromise system security, it violates the security principle of least information exposure by revealing internal implementation details that should remain opaque to external API consumers. The fix is straightforward and should be implemented as part of general API hardening efforts.

### Citations

**File:** api/src/blocks.rs (L148-152)
```rust
                    Some(self.context.render_transactions_sequential(
                        &latest_ledger_info,
                        inner,
                        bcs_block.block_timestamp,
                    )?)
```

**File:** api/src/context.rs (L761-765)
```rust
            .collect::<Result<_, anyhow::Error>>()
            .context("Failed to convert transaction data from storage")
            .map_err(|err| {
                E::internal_with_code(err, AptosErrorCode::InternalError, ledger_info)
            })?;
```

**File:** api/src/response.rs (L175-176)
```rust
                let error = aptos_api_types::AptosError::new_with_error_code(err, error_code);
                let payload = poem_openapi::payload::Json(Box::new(error));
```

**File:** api/types/src/error.rs (L12-17)
```rust
pub struct AptosError {
    /// A message describing the error
    pub message: String,
    pub error_code: AptosErrorCode,
    /// A code providing VM error details when submitting transactions to the VM
    pub vm_error_code: Option<u64>,
```

**File:** api/types/src/error.rs (L33-34)
```rust
        Self {
            message: format!("{:#}", error),
```

**File:** storage/storage-interface/src/errors.rs (L23-26)
```rust
    #[error("AptosDB RocksDb Error: {0}")]
    RocksDbIncompleteResult(String),
    #[error("AptosDB RocksDB Error: {0}")]
    OtherRocksDbError(String),
```

**File:** storage/storage-interface/src/errors.rs (L27-28)
```rust
    #[error("AptosDB bcs Error: {0}")]
    BcsError(String),
```
