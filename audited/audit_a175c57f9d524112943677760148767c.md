# Audit Report

## Title
Missing Database Index on user_transactions.timestamp Field Enables Resource Exhaustion Attacks on Indexer API

## Summary
The `user_transactions` table in the Aptos indexer database lacks an index on the `timestamp` field, causing all timestamp-based queries to perform full table scans. This allows unprivileged attackers to trigger expensive database operations via the publicly accessible Hasura GraphQL API, potentially causing indexer service degradation or unavailability.

## Finding Description

The `user_transactions` table is created with only two indexes: [1](#0-0) 

The `timestamp` field itself has no index: [2](#0-1) 

However, the table is exposed via Hasura GraphQL with anonymous access allowing queries on the timestamp field: [3](#0-2) 

Dashboard queries demonstrate timestamp-based filtering is actively used: [4](#0-3) 

**Attack Path:**
1. Attacker sends GraphQL queries to the public Hasura endpoint with timestamp range filters
2. Each query triggers a sequential scan of the entire `user_transactions` table (millions of rows on mainnet)
3. Repeated queries exhaust database connection pool and CPU resources
4. Indexer API becomes slow or unresponsive for legitimate users

## Impact Explanation

This issue does **NOT** meet Critical, High, or Medium severity criteria because:

- **No funds at risk**: The indexer is a read-only analytics service
- **No consensus impact**: Validators do not depend on the indexer for block production
- **No blockchain availability impact**: Core blockchain operations continue unaffected even if indexer fails
- **Only indexer API availability affected**: This is an auxiliary service, not core infrastructure

Per Aptos bug bounty categories, this qualifies as **Low Severity**: "Non-critical implementation bugs" - a performance optimization issue that could degrade indexer service quality but doesn't threaten blockchain security.

## Likelihood Explanation

**Likelihood: High** - The attack is trivial to execute as the GraphQL endpoint is publicly accessible and requires no authentication. However, the **impact is limited** to indexer performance degradation, not blockchain functionality.

## Recommendation

Add a B-tree index on the `timestamp` column to enable efficient time-range queries:

```sql
CREATE INDEX ut_timestamp_index ON user_transactions (timestamp);
```

This should be added to a new migration file or included in the optimize_queries migration.

## Proof of Concept

**GraphQL Query (triggers full table scan):**
```graphql
query TimestampRangeQuery {
  user_transactions(
    where: {
      timestamp: {_gte: "2024-01-01T00:00:00", _lte: "2024-01-31T23:59:59"}
    }
    limit: 100
  ) {
    version
    sender
    timestamp
  }
}
```

Without the timestamp index, PostgreSQL must scan all rows in `user_transactions` to find matching timestamps, causing O(n) complexity instead of O(log n + k) with an index.

---

**Note:** While this is a valid performance and availability concern for the indexer service, it does **not** constitute a security vulnerability affecting the Aptos blockchain's core security guarantees (consensus safety, deterministic execution, fund security, etc.). The indexer is an auxiliary analytics service, and its degradation does not impact blockchain operations.

### Citations

**File:** crates/indexer/migrations/2022-08-08-043603_core_tables/up.sql (L164-164)
```sql
  "timestamp" TIMESTAMP NOT NULL,
```

**File:** crates/indexer/migrations/2022-08-08-043603_core_tables/up.sql (L172-173)
```sql
CREATE INDEX ut_sender_seq_index ON user_transactions (sender, sequence_number);
CREATE INDEX ut_insat_index ON user_transactions (inserted_at);
```

**File:** crates/aptos-localnet/src/hasura_metadata.json (L2387-2410)
```json
            "select_permissions": [
              {
                "role": "anonymous",
                "permission": {
                  "columns": [
                    "block_height",
                    "entry_function_id_str",
                    "entry_function_contract_address",
                    "entry_function_module_name",
                    "entry_function_function_name",
                    "epoch",
                    "expiration_timestamp_secs",
                    "gas_unit_price",
                    "max_gas_amount",
                    "parent_signature_type",
                    "sender",
                    "sequence_number",
                    "timestamp",
                    "version"
                  ],
                  "filter": {},
                  "limit": 100
                }
              }
```

**File:** dashboards/overview.json (L726-726)
```json
          "rawSql": "\nselect\n  ds, count(*) as count\nfrom\n  (\n    select\n      *,\n      DATE(timestamp, \"America/Los_Angeles\") as ds\n    from\n      `indexer_mainnet_gcp.user_transactions`\n  )\ngroup by\n  1\norder by\n  1 desc\nlimit\n  10",
```
