# Audit Report

## Title
Unauthenticated Hasura Metadata API Access in Aptos Localnet Indexer

## Summary
The Hasura GraphQL engine in Aptos localnet runs without admin authentication, allowing anyone with network access to the indexer API endpoint to modify metadata, potentially causing API crashes and service disruption.

## Finding Description
The `make_hasura_metadata_request()` function in the localnet indexer API implementation sends unauthenticated HTTP requests to Hasura's `/v1/metadata` endpoint. [1](#0-0) 

The Hasura container is configured without the `HASURA_GRAPHQL_ADMIN_SECRET` environment variable in both implementations:
- [2](#0-1) 
- [3](#0-2) 

This allows an attacker with network access to call administrative operations like `replace_metadata` [4](#0-3)  without authentication, potentially:
- Replacing the entire GraphQL schema and permissions structure
- Corrupting metadata causing the API to crash or malfunction
- Modifying data access permissions to bypass intended restrictions
- Exporting sensitive schema information

## Impact Explanation
This qualifies as **High Severity** per Aptos bug bounty criteria under "API crashes" category. While localnet is a development tool, the vulnerability allows unauthorized metadata manipulation that can cause:
- Complete indexer API service disruption
- Malicious schema modifications requiring manual recovery
- Potential information disclosure if permissions are modified

The impact is amplified if users port-forward the service or if this pattern is copied to production environments.

## Likelihood Explanation
**Medium Likelihood**. The default configuration binds to 127.0.0.1 [5](#0-4)  limiting network exposure. However, likelihood increases if:
- Users forward ports for remote development access
- Malicious processes run on the same machine
- Other containers on the Docker network exploit this
- Developers copy this pattern for production deployments

## Recommendation
Add `HASURA_GRAPHQL_ADMIN_SECRET` to the Hasura container environment variables and include the corresponding `x-hasura-admin-secret` header in API requests:

```rust
// In container configuration, add:
format!("HASURA_GRAPHQL_ADMIN_SECRET={}", generate_random_secret()),

// In make_hasura_metadata_request(), add header:
let response = client
    .post(url)
    .header("x-hasura-admin-secret", admin_secret)
    .json(&payload)
    .send()
    .await?;
```

Store the admin secret securely and pass it through the configuration chain.

## Proof of Concept
```bash
# Start aptos localnet with indexer API
aptos node run-localnet --with-indexer-api

# Wait for service to start on port 8090
# Attempt to export metadata without authentication (succeeds)
curl -X POST http://127.0.0.1:8090/v1/metadata \
  -H "Content-Type: application/json" \
  -d '{"type":"export_metadata","args":{}}'

# Attempt to replace metadata with malicious payload (succeeds)
curl -X POST http://127.0.0.1:8090/v1/metadata \
  -H "Content-Type: application/json" \
  -d '{"type":"replace_metadata","args":{"metadata":{"version":3,"sources":[]}}}'

# Result: API becomes non-functional, metadata corrupted
```

## Notes
This vulnerability is specific to the localnet/workspace development tools and does not directly affect the core Aptos blockchain consensus, Move VM execution, or validator operations. The default 127.0.0.1 binding provides partial mitigation for network-based attacks. However, it represents a significant security gap for the auxiliary indexer API service that could be exploited in local or forwarded network scenarios.

### Citations

**File:** crates/aptos-localnet/src/indexer_api.rs (L36-36)
```rust
        make_hasura_metadata_request(url, "replace_metadata", Some(metadata_json)).await?;
```

**File:** crates/aptos-localnet/src/indexer_api.rs (L115-115)
```rust
    let response = client.post(url).json(&payload).send().await?;
```

**File:** crates/aptos/src/node/local_testnet/indexer_api.rs (L208-209)
```rust
                    host_ip: Some("127.0.0.1".to_string()),
                    host_port: Some(self.indexer_api_port.to_string()),
```

**File:** crates/aptos/src/node/local_testnet/indexer_api.rs (L227-240)
```rust
            env: Some(vec![
                format!("PG_DATABASE_URL={}", postgres_connection_string),
                format!(
                    "HASURA_GRAPHQL_METADATA_DATABASE_URL={}",
                    postgres_connection_string
                ),
                format!("INDEXER_V2_POSTGRES_URL={}", postgres_connection_string),
                "HASURA_GRAPHQL_DEV_MODE=true".to_string(),
                "HASURA_GRAPHQL_ENABLE_CONSOLE=true".to_string(),
                // See the docs for the image, this is a magic path inside the
                // container where they have already bundled in the UI assets.
                "HASURA_GRAPHQL_CONSOLE_ASSETS_DIR=/srv/console-assets".to_string(),
                format!("HASURA_GRAPHQL_SERVER_PORT={}", self.indexer_api_port),
            ]),
```

**File:** aptos-move/aptos-workspace-server/src/services/indexer_api.rs (L85-98)
```rust
        env: Some(vec![
            format!("PG_DATABASE_URL={}", postgres_connection_string),
            format!(
                "HASURA_GRAPHQL_METADATA_DATABASE_URL={}",
                postgres_connection_string
            ),
            format!("INDEXER_V2_POSTGRES_URL={}", postgres_connection_string),
            "HASURA_GRAPHQL_DEV_MODE=true".to_string(),
            "HASURA_GRAPHQL_ENABLE_CONSOLE=true".to_string(),
            // See the docs for the image, this is a magic path inside the
            // container where they have already bundled in the UI assets.
            "HASURA_GRAPHQL_CONSOLE_ASSETS_DIR=/srv/console-assets".to_string(),
            format!("HASURA_GRAPHQL_SERVER_PORT={}", HASURA_DEFAULT_PORT),
        ]),
```
