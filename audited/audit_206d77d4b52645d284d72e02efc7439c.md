# Audit Report

## Title
Missing Voter Address Uniqueness Validation in Genesis Configuration Weakens Separation of Duties

## Summary
The genesis validator configuration validation in `crates/aptos/src/genesis/mod.rs` fails to check that the `voter_account_address` is distinct from the `owner_account_address` and `operator_account_address`. This allows validators to use the same public key (and thus the same address) for the voter role and either the owner or operator role, directly violating the high-criticality owner-operator-voter separation of duties security model documented in the Aptos formal specifications.

## Finding Description
The Aptos staking system implements a separation of duties model where three distinct roles exist:
- **Owner**: Controls the stake pool via `OwnerCapability`, can withdraw funds
- **Operator**: Manages validator operations (consensus keys, network addresses)  
- **Voter**: Participates in on-chain governance

The formal specifications explicitly state this separation is "crucial to prevent the compromise of the StakePool" and mark it as "High criticality". [1](#0-0) 

During genesis validation, the code validates that `owner_account_address != operator_account_address` by tracking both in a `unique_accounts` set: [2](#0-1) 

However, the validation completely omits checking the `voter_account_address` against this uniqueness constraint. While the voter address is verified to exist in the balances file, it is never inserted into `unique_accounts` and thus can be identical to either the owner or operator address: [3](#0-2) 

This creates an **inconsistent security enforcement** where:
- ✅ Owner ≠ Operator is enforced
- ❌ Owner ≠ Voter is NOT enforced  
- ❌ Operator ≠ Voter is NOT enforced
- ❌ Voter uniqueness across validators is NOT enforced

The same public key can be used for `owner_account_public_key` and `voter_account_public_key` (or `operator_account_public_key` and `voter_account_public_key`), allowing genesis to proceed with a weakened security configuration: [4](#0-3) 

When the same key is used for multiple roles, if that single key is compromised (e.g., through social engineering, malware, or server breach), the attacker gains control over multiple critical capabilities simultaneously rather than just one isolated role.

## Impact Explanation
This qualifies as **High Severity** because:

1. **Violates Documented High-Criticality Security Requirements**: The formal specifications explicitly mandate separation and mark it as high criticality for stake pool security.

2. **Inconsistent Security Enforcement**: The code validates some key separations (owner vs operator, validator vs fullnode network keys) but omits voter validation, showing this is an oversight rather than intentional design. [5](#0-4) 

3. **Systemic Risk Amplification**: If multiple validators adopt this weak configuration (due to inadequate tooling guidance or convenience), the blast radius of any governance key compromise expands dramatically, potentially affecting staking funds across multiple validators.

4. **Defeats Security Model Intent**: The entire owner-operator-voter architecture exists to enable cold storage of owner keys while keeping operator/voter keys hot. Allowing key reuse defeats this fundamental security boundary.

While this doesn't directly enable fund theft without first compromising the shared key, it creates a **configuration vulnerability** that significantly amplifies the impact of any subsequent key compromise event—transforming a governance-only breach into a funds-loss scenario.

## Likelihood Explanation
**Medium-High Likelihood**:
- Validators setting up genesis configurations may inadvertently reuse keys due to inadequate documentation or tooling
- Social engineering attacks targeting governance operations would gain unexpected owner-level access
- The validation code's inconsistency suggests this scenario wasn't considered during security reviews
- No runtime enforcement exists to prevent this configuration post-genesis

## Recommendation
Add voter address uniqueness validation consistent with the existing owner/operator checks:

```rust
// After line 691 in crates/aptos/src/genesis/mod.rs
unique_accounts.insert(validator.operator_account_address.into());

// Add voter uniqueness check:
if unique_accounts.contains(&validator.voter_account_address.into()) {
    errors.push(CliError::UnexpectedError(format!(
        "Voter '{}' in validator {} has already been seen elsewhere",
        validator.voter_account_address, name
    )));
}
unique_accounts.insert(validator.voter_account_address.into());
```

Additionally, add explicit validation that the three addresses are distinct within a single validator:

```rust
// After line 659 in crates/aptos/src/genesis/mod.rs
if validator.owner_account_address == validator.voter_account_address {
    errors.push(CliError::UnexpectedError(format!(
        "Validator {} uses the same address for owner and voter, violating separation of duties",
        name
    )));
}
if validator.operator_account_address == validator.voter_account_address {
    errors.push(CliError::UnexpectedError(format!(
        "Validator {} uses the same address for operator and voter, violating separation of duties",
        name
    )));
}
```

## Proof of Concept
Create a test genesis configuration with reused voter address:

```yaml
# owner.yaml
owner_account_address: "0x123..."
owner_account_public_key: "0xAABB..."  # Key A
operator_account_address: "0x456..."
operator_account_public_key: "0xCCDD..."  # Key B
voter_account_address: "0x123..."  # SAME as owner!
voter_account_public_key: "0xAABB..."  # SAME Key A
stake_amount: "100000000000000"
```

Run genesis generation:
```bash
aptos genesis generate-genesis --local-repository-dir ./genesis-config
```

**Expected**: Validation error due to voter address collision  
**Actual**: Genesis generation succeeds, creating a validator with compromised separation of duties

The current validation in `validate_validators()` will only check that owner ≠ operator, but will allow voter to equal either, enabling the security-weakening configuration to pass validation.

---

**Notes**
This is a **missing security guardrail** rather than a directly exploitable vulnerability. However, it represents a HIGH severity issue because it:
- Violates documented high-criticality security requirements
- Creates inconsistent enforcement of the separation of duties model
- Enables configurations that significantly amplify the impact of key compromise events
- Contradicts the security model's fundamental design intent

The validation should be added to enforce the documented security model consistently across all three roles.

### Citations

**File:** aptos-move/framework/aptos-framework/sources/staking_proxy.spec.move (L18-24)
```text
    /// Requirement: The operator and voter of a Vesting Contract should only be updated by the owner of the contract.
    /// Criticality: High
    /// Implementation: The owner-operator-voter model, as defined in the documentation, grants distinct abilities to
    /// each role. Therefore, it's crucial to ensure that only the owner has the authority to modify the operator or
    /// voter, to prevent the compromise of the StakePool.
    /// Enforcement: Audited that it ensures the signer owns the AdminStore resource and that the operator or voter
    /// intended for the update actually exists.
```

**File:** crates/aptos/src/genesis/mod.rs (L371-404)
```rust
    let owner_account_public_key = parse_required_option(
        &owner_config.owner_account_public_key,
        owner_file,
        "owner_account_public_key",
        |str| parse_key(ED25519_PUBLIC_KEY_LENGTH, str),
    )?;

    let operator_account_address: AccountAddress = parse_required_option(
        &owner_config.operator_account_address,
        owner_file,
        "operator_account_address",
        AccountAddressWithChecks::from_str,
    )?
    .into();
    let operator_account_public_key = parse_required_option(
        &owner_config.operator_account_public_key,
        owner_file,
        "operator_account_public_key",
        |str| parse_key(ED25519_PUBLIC_KEY_LENGTH, str),
    )?;

    let voter_account_address: AccountAddress = parse_required_option(
        &owner_config.voter_account_address,
        owner_file,
        "voter_account_address",
        AccountAddressWithChecks::from_str,
    )?
    .into();
    let voter_account_public_key = parse_required_option(
        &owner_config.voter_account_public_key,
        owner_file,
        "voter_account_public_key",
        |str| parse_key(ED25519_PUBLIC_KEY_LENGTH, str),
    )?;
```

**File:** crates/aptos/src/genesis/mod.rs (L654-659)
```rust
        if !initialized_accounts.contains_key(&validator.voter_account_address.into()) {
            errors.push(CliError::UnexpectedError(format!(
                "Voter {} in validator {} is not in the balances.yaml file",
                validator.voter_account_address, name
            )));
        }
```

**File:** crates/aptos/src/genesis/mod.rs (L677-691)
```rust
        if unique_accounts.contains(&validator.owner_account_address.into()) {
            errors.push(CliError::UnexpectedError(format!(
                "Owner '{}' in validator {} has already been seen elsewhere",
                validator.owner_account_address, name
            )));
        }
        unique_accounts.insert(validator.owner_account_address.into());

        if unique_accounts.contains(&validator.operator_account_address.into()) {
            errors.push(CliError::UnexpectedError(format!(
                "Operator '{}' in validator {} has already been seen elsewhere",
                validator.operator_account_address, name
            )));
        }
        unique_accounts.insert(validator.operator_account_address.into());
```

**File:** crates/aptos/src/genesis/mod.rs (L809-815)
```rust
                    if validator_network_public_key == full_node_network_public_key {
                        errors.push(CliError::UnexpectedError(format!(
                            "Validator {} has a validator and a full node network public key that are the same {}",
                            name,
                            validator_network_public_key
                        )));
                    }
```
