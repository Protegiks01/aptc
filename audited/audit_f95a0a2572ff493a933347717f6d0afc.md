# Audit Report

## Title
Path Injection Vulnerability in Move CLI Docgen Command Allows Arbitrary File Write

## Summary
The Move CLI's `docgen` command accepts an unsanitized `--output-directory` parameter that is directly used to construct file paths for documentation generation. This allows an attacker to write documentation files to arbitrary filesystem locations, potentially overwriting critical system files or creating malicious files in sensitive directories.

## Finding Description

The vulnerability exists in the Move CLI's documentation generation workflow. When a user invokes the `docgen` command, they can specify an output directory via the `--output-directory` flag. This parameter is accepted without any validation or sanitization. [1](#0-0) 

The unsanitized output directory is directly assigned to the docgen options: [2](#0-1) 

The docgen generator then constructs file paths by concatenating this user-controlled directory with filenames: [3](#0-2) 

Finally, these unsanitized paths are used to create directories and write files without any validation: [4](#0-3) 

Additionally, when generating dependency diagrams, the code constructs paths for image files using the same unsanitized output directory: [5](#0-4) 

**Attack Vector**: An attacker can exploit this in multiple ways:
1. Direct CLI usage: `move docgen --output-directory /etc` to write files to system directories
2. Path traversal: `move docgen --output-directory ../../.ssh` to escape intended directories  
3. Malicious Move packages: Distribute packages with build scripts that invoke docgen with malicious parameters
4. CI/CD exploitation: Target automated build systems that run docgen on untrusted code

## Impact Explanation

This vulnerability is classified as **High Severity** because it enables arbitrary file write operations on systems running the Move CLI tool. While this is not a direct blockchain protocol vulnerability, it poses significant security risks:

**Validator Node Compromise**: If validator operators use the Move CLI tool for development or documentation purposes and process untrusted Move packages, an attacker could:
- Overwrite SSH authorized_keys to gain remote access
- Modify validator configuration files
- Write malicious scripts to auto-start directories
- Replace critical binaries or libraries

This could lead to **Remote Code Execution on validator nodes**, which is a Critical severity impact per the Aptos bug bounty program.

**Developer Environment Compromise**: Developers building or auditing third-party Move packages could have their systems compromised through:
- Overwriting shell configuration files (~/.bashrc, ~/.zshrc)
- Modifying VS Code or other editor plugins
- Writing malicious files to system startup locations

**CI/CD Pipeline Compromise**: Automated build systems processing Move packages could be compromised, leading to supply chain attacks affecting downstream users.

## Likelihood Explanation

The likelihood of exploitation is **MODERATE to HIGH**:

**High Likelihood Factors**:
- The vulnerability requires no special privileges to exploit
- The Move CLI is commonly used by developers in the Aptos ecosystem
- No validation or warnings are present when using absolute paths
- Supply chain attacks via malicious Move packages are a realistic threat vector

**Moderate Factors**:
- Exploitation requires convincing a user to run docgen with a malicious output directory parameter
- Most users would use default or relative paths in normal operation
- Validator operators may not regularly use the Move CLI tool on production nodes

However, the risk increases significantly in scenarios involving:
- Automated documentation generation in CI/CD pipelines
- Developers reviewing or building third-party Move packages
- Any validator operator performing development activities on production infrastructure

## Recommendation

Implement path validation and sanitization for the `--output-directory` parameter:

1. **Validate output directory is within allowed bounds**: Reject absolute paths and paths containing `..` components
2. **Canonicalize paths**: Use `std::fs::canonicalize()` to resolve the absolute path and ensure it's within an expected directory
3. **Add security warnings**: Warn users when using absolute paths
4. **Implement allowlist**: Only permit output to explicitly safe directories

The fix should be implemented in the `Docgen::execute()` function before passing the output directory to the generator. Path validation should reject:
- Absolute paths (starting with `/` or drive letters on Windows)
- Paths containing `..` components for directory traversal
- Paths resolving to sensitive system directories

Example validation logic:
```rust
// In third_party/move/tools/move-cli/src/base/docgen.rs
if let Some(ref output_dir) = self.output_directory {
    // Reject absolute paths
    let path = std::path::Path::new(output_dir);
    if path.is_absolute() {
        return Err(anyhow::anyhow!(
            "Absolute paths are not allowed for security reasons. Use relative paths only."
        ));
    }
    
    // Check for directory traversal
    if output_dir.contains("..") {
        return Err(anyhow::anyhow!(
            "Path traversal sequences (..) are not allowed."
        ));
    }
}
```

## Proof of Concept

**Setup**: Create a test Move package with a simple module.

**Exploitation Steps**:

```bash
# Step 1: Create a test Move package
mkdir test_package
cd test_package
move new TestModule

# Step 2: Attempt to write documentation to /tmp (or any arbitrary location)
move docgen --output-directory /tmp/malicious_docs

# Expected Result: Documentation files are created in /tmp/malicious_docs/
# including:
# - /tmp/malicious_docs/TestModule.md
# - /tmp/malicious_docs/img/*.svg (if dependency diagrams are enabled)

# Step 3: Verify arbitrary file write
ls -la /tmp/malicious_docs/

# Step 4: Demonstrate overwrite capability
echo "important data" > /tmp/existing_file.md
move docgen --output-directory /tmp
# This would overwrite /tmp/TestModule.md if it exists
```

**Advanced Attack Scenario**:
```bash
# An attacker distributes a malicious Move package with a build script that runs:
move docgen --output-directory ~/.ssh --output-file authorized_keys

# Or in a CI/CD environment:
move docgen --output-directory /etc/cron.d --output-file malicious_job
```

The vulnerability is confirmed by the absence of any path validation in the code paths examined above.

## Notes

While this vulnerability is in the Move CLI development tool rather than the core blockchain protocol, it poses a significant security risk to the Aptos ecosystem through:

1. **Validator Security**: Validator operators who use development tools on production infrastructure could be compromised
2. **Supply Chain Attacks**: Malicious Move packages could exploit this to compromise developer systems
3. **CI/CD Security**: Automated build systems are vulnerable to exploitation

The vulnerability should be patched with strict path validation to prevent arbitrary file writes. Additionally, security guidelines should be updated to warn against running Move CLI tools on untrusted packages or on production validator infrastructure.

### Citations

**File:** third_party/move/tools/move-cli/src/base/docgen.rs (L38-39)
```rust
    #[clap(long = "output-directory", value_name = "PATH")]
    pub output_directory: Option<String>,
```

**File:** third_party/move/tools/move-cli/src/base/docgen.rs (L96-98)
```rust
        if self.output_directory.is_some() {
            options.output_directory = self.output_directory.unwrap();
        }
```

**File:** third_party/move/tools/move-cli/src/base/docgen.rs (L111-116)
```rust
        for (file, content) in generator.r#gen() {
            let path = PathBuf::from(&file);
            fs::create_dir_all(path.parent().unwrap())?;
            fs::write(path.as_path(), content)?;
            println!("Generated {:?}", path);
        }
```

**File:** third_party/move/move-prover/move-docgen/src/docgen.rs (L531-540)
```rust
    fn make_file_in_out_dir(&self, name: &str) -> String {
        if self.options.compile_relative_to_output_dir {
            name.to_string()
        } else {
            let mut path = PathBuf::from(&self.options.output_directory);
            path.push(name);

            self.path_to_string(path.as_path())
        }
    }
```

**File:** third_party/move/move-prover/move-docgen/src/docgen.rs (L1027-1040)
```rust
        let out_file_path = PathBuf::from(&self.options.output_directory)
            .join("img")
            .join(format!(
                "{}_{}_dep.svg",
                module_name,
                if is_forward { "forward" } else { "backward" }
            ));

        self.gen_svg_file(&out_file_path, &dot_src_lines.join("\n"));
    }

    /// Execute the external tool "dot" with doc_src as input to generate a .svg image file.
    fn gen_svg_file(&self, out_file_path: &Path, dot_src: &str) {
        if let Err(e) = fs::create_dir_all(out_file_path.parent().unwrap()) {
```
