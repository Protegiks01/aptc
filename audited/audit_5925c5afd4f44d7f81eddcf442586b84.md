# Audit Report

## Title
Mainnet Genesis Omits JWK Consensus Config Initialization, Disabling Keyless Features

## Summary
The `encode_aptos_mainnet_genesis_transaction` function completely omits initialization of JWK consensus configuration and related resources, causing production mainnet networks to deploy without keyless account support even when operators explicitly provide configuration overrides.

## Finding Description

The mainnet genesis generation path has a critical omission that breaks keyless account functionality. There are two genesis generation functions with divergent behavior:

**Function 1: `encode_genesis_change_set` (used for testnets)** [1](#0-0) 

This function properly extracts `jwk_consensus_config_override` from `GenesisConfiguration` and initializes the JWK consensus config resource.

**Function 2: `encode_aptos_mainnet_genesis_transaction` (used for production mainnet)** [2](#0-1) 

This function **never calls** `initialize_jwk_consensus_config`, `initialize_jwks_resources`, or `initialize_keyless_accounts`, despite receiving `genesis_config` with a `jwk_consensus_config_override` field.

**The Override Mechanism Exists But Is Ignored:** [3](#0-2) 

Mainnet operators can provide `jwk_consensus_config_override`, but it's silently ignored.

**Runtime Fallback Behavior:**

When nodes start with uninitialized JWK config, they attempt a fallback: [4](#0-3) 

The fallback tries to fetch deprecated `SupportedOIDCProviders` resource: [5](#0-4) 

However, since `initialize_jwks_resources` was never called, `SupportedOIDCProviders` also doesn't exist: [6](#0-5) 

The result is an empty OIDC provider list, identical to `default_for_genesis()`: [7](#0-6) 

**Impact:** Keyless accounts using OIDC providers (e.g., Google OAuth) cannot function because no providers are configured in the genesis state.

## Impact Explanation

This qualifies as **High Severity** per Aptos bug bounty criteria:
- **Significant protocol violation**: Keyless accounts are a core protocol feature that becomes completely non-functional on mainnet
- **State inconsistency requiring intervention**: Requires post-genesis governance proposal to initialize missing resources
- **Service disruption**: All users attempting to use keyless accounts will experience failures

This breaks the **Deterministic Execution** invariant - testnet validators have functional keyless accounts while mainnet validators do not, despite using the "same" codebase with different genesis functions.

## Likelihood Explanation

**Likelihood: HIGH**

This will affect **every** mainnet deployment using the standard genesis generation CLI: [8](#0-7) 

The CLI passes `jwk_consensus_config_override: None`, and even if operators modify it to provide the correct config, the override is completely ignored by the genesis function.

## Recommendation

Modify `encode_aptos_mainnet_genesis_transaction` to include JWK consensus initialization logic:

```rust
// After line 212 in encode_aptos_mainnet_genesis_transaction
let jwk_consensus_config = genesis_config
    .jwk_consensus_config_override
    .clone()
    .unwrap_or_else(OnChainJWKConsensusConfig::default_enabled); // Use default_enabled for mainnet

initialize_jwk_consensus_config(
    &mut session,
    &module_storage,
    &mut traversal_context,
    &jwk_consensus_config,
);

initialize_jwks_resources(&mut session, &module_storage, &mut traversal_context);

initialize_keyless_accounts(
    &mut session,
    &module_storage,
    &mut traversal_context,
    chain_id,
    genesis_config.initial_jwks.clone(),
    genesis_config.keyless_groth16_vk.clone(),
);
```

Note: Use `default_enabled()` (with Google provider) for mainnet instead of `default_for_genesis()` (empty provider list).

## Proof of Concept

**Step 1:** Generate mainnet genesis with the CLI:
```rust
// This calls encode_aptos_mainnet_genesis_transaction
let genesis_info = MainnetGenesisInfo::new(
    chain_id,
    accounts,
    employees,
    validators,
    framework,
    &genesis_config, // Contains jwk_consensus_config_override
);
let genesis_txn = genesis_info.get_genesis();
```

**Step 2:** After genesis, query on-chain state:
```rust
// Try to fetch JWKConsensusConfig - returns None (resource doesn't exist)
let jwk_config = storage.fetch_config::<OnChainJWKConsensusConfig>();
assert!(jwk_config.is_none());

// Try to fetch SupportedOIDCProviders - also returns None
let oidc_providers = storage.fetch_config::<SupportedOIDCProviders>();
assert!(oidc_providers.is_none());
```

**Step 3:** Validator startup attempts keyless transaction:
```rust
// Fallback constructs empty provider config
let jwk_config = OnChainJWKConsensusConfig::from((Some(features), None));
// Result: OnChainJWKConsensusConfig::V1(ConfigV1 { oidc_providers: vec![] })

// Keyless transactions fail - no OIDC providers configured
```

**Reproduction:** Compare genesis output between `encode_genesis_change_set` (testnet) and `encode_aptos_mainnet_genesis_transaction` (mainnet) - mainnet will lack `JWKConsensusConfig`, `SupportedOIDCProviders`, `ObservedJWKs`, `Patches`, and `PatchedJWKs` resources at `@aptos_framework`.

## Notes

While this is a deployment-time bug rather than a runtime exploit, it constitutes a significant protocol violation affecting all mainnet users. The override mechanism creates a false sense of security - operators believe they can configure JWK consensus via `genesis_config`, but their configuration is silently discarded. This would require emergency governance intervention post-deployment to restore keyless functionality.

### Citations

**File:** aptos-move/vm-genesis/src/lib.rs (L135-213)
```rust
pub fn encode_aptos_mainnet_genesis_transaction(
    accounts: &[AccountBalance],
    employees: &[EmployeePool],
    validators: &[ValidatorWithCommissionRate],
    framework: &ReleaseBundle,
    chain_id: ChainId,
    genesis_config: &GenesisConfiguration,
) -> Transaction {
    assert!(!genesis_config.is_test, "This is mainnet!");
    validate_genesis_config(genesis_config);

    let mut state_view = GenesisStateView::new();
    for (module_bytes, module) in framework.code_and_compiled_modules() {
        state_view.add_module(&module.self_id(), module_bytes);
    }

    let genesis_runtime_builder = GenesisRuntimeBuilder::new(chain_id);
    let genesis_runtime_environment = genesis_runtime_builder.build_genesis_runtime_environment();

    let module_storage = state_view.as_aptos_code_storage(&genesis_runtime_environment);
    let resolver = state_view.as_move_resolver();

    let genesis_vm = genesis_runtime_builder.build_genesis_vm();
    let genesis_change_set_configs = genesis_vm.genesis_change_set_configs();
    let mut session = genesis_vm.new_genesis_session(&resolver, HashValue::zero());

    let traversal_storage = TraversalStorage::new();
    let mut traversal_context = TraversalContext::new(&traversal_storage);

    // On-chain genesis process.
    let consensus_config = OnChainConsensusConfig::default_for_genesis();
    let execution_config = OnChainExecutionConfig::default_for_genesis();
    let gas_schedule = default_gas_schedule();
    initialize(
        &mut session,
        &module_storage,
        &mut traversal_context,
        chain_id,
        genesis_config,
        &consensus_config,
        &execution_config,
        &gas_schedule,
    );
    initialize_features(
        &mut session,
        &module_storage,
        &mut traversal_context,
        genesis_config
            .initial_features_override
            .clone()
            .map(Features::into_flag_vec),
    );
    initialize_aptos_coin(&mut session, &module_storage, &mut traversal_context);
    initialize_on_chain_governance(
        &mut session,
        &module_storage,
        &mut traversal_context,
        genesis_config,
    );
    create_accounts(
        &mut session,
        &module_storage,
        &mut traversal_context,
        accounts,
    );
    create_employee_validators(
        &mut session,
        &module_storage,
        &mut traversal_context,
        employees,
        genesis_config,
    );
    create_and_initialize_validators_with_commission(
        &mut session,
        &module_storage,
        &mut traversal_context,
        validators,
    );
    set_genesis_end(&mut session, &module_storage, &mut traversal_context);
```

**File:** aptos-move/vm-genesis/src/lib.rs (L354-363)
```rust
    let jwk_consensus_config = genesis_config
        .jwk_consensus_config_override
        .clone()
        .unwrap_or_else(OnChainJWKConsensusConfig::default_for_genesis);
    initialize_jwk_consensus_config(
        &mut session,
        &module_storage,
        &mut traversal_context,
        &jwk_consensus_config,
    );
```

**File:** crates/aptos-genesis/src/mainnet.rs (L145-145)
```rust
                jwk_consensus_config_override: self.jwk_consensus_config_override.clone(),
```

**File:** consensus/src/epoch_manager.rs (L1223-1226)
```rust
        let jwk_consensus_config = onchain_jwk_consensus_config.unwrap_or_else(|_| {
            // `jwk_consensus_config` not yet initialized, falling back to the old configs.
            Self::equivalent_jwk_consensus_config_from_deprecated_resources(&payload)
        });
```

**File:** types/src/on_chain_config/jwk_consensus_config.rs (L61-67)
```rust
    pub fn default_for_genesis() -> Self {
        // Here it is supposed to use `default_enabled()`.
        // Using an empty list instead to avoid DDoSing the CI infra or the actual providers.
        Self::V1(ConfigV1 {
            oidc_providers: vec![],
        })
    }
```

**File:** types/src/on_chain_config/jwk_consensus_config.rs (L116-124)
```rust
        if let Some(features) = features {
            if features.is_enabled(FeatureFlag::JWK_CONSENSUS) {
                let oidc_providers = supported_oidc_providers
                    .unwrap_or_default()
                    .providers
                    .into_iter()
                    .filter_map(|deprecated| OIDCProvider::try_from(deprecated).ok())
                    .collect();
                OnChainJWKConsensusConfig::V1(ConfigV1 { oidc_providers })
```

**File:** aptos-move/framework/aptos-framework/sources/jwks.move (L434-440)
```text
    public fun initialize(fx: &signer) {
        system_addresses::assert_aptos_framework(fx);
        move_to(fx, SupportedOIDCProviders { providers: vector[] });
        move_to(fx, ObservedJWKs { jwks: AllProvidersJWKs { entries: vector[] } });
        move_to(fx, Patches { patches: vector[] });
        move_to(fx, PatchedJWKs { jwks: AllProvidersJWKs { entries: vector[] } });
    }
```

**File:** crates/aptos/src/genesis/mod.rs (L262-262)
```rust
            jwk_consensus_config_override: None,
```
