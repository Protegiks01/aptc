# Audit Report

## Title
InternalError (600) Response Leaks Filesystem Paths and Internal Database Structure

## Summary
The Aptos REST API's `InternalError` (error code 600) exposes sensitive internal system information including filesystem paths, database structure details, and RocksDB error messages to external API clients. This occurs because error messages from the storage layer are propagated without sanitization through the API error handling chain.

## Finding Description

The vulnerability exists in the error handling mechanism where internal errors from the storage layer are directly exposed to API clients through the `AptosError` response structure.

**Error Flow:**

1. The `AptosError::new_with_error_code()` function creates error responses using alternate display formatting (`{:#}`): [1](#0-0) 

2. Storage errors from RocksDB, including IOError types that contain file paths, are converted to `AptosDbError` variants with full error strings: [2](#0-1) 

3. These errors propagate through the API layer with additional context but no sanitization: [3](#0-2) 

4. Additional examples show context strings being added to database operation failures: [4](#0-3) 

**Information Disclosed:**
- Absolute filesystem paths (e.g., `/var/lib/aptos/db/000123.sst`)
- RocksDB column family names and internal structure
- Database operation details
- System-level I/O error messages
- Internal state keys and resource identifiers

## Impact Explanation

This issue qualifies as **Low Severity** according to Aptos bug bounty criteria - specifically "Minor information leaks" (up to $1,000). While the disclosure of internal system details aids attacker reconnaissance, it does not directly enable:
- Loss of funds or token minting
- Consensus or safety violations
- Network partitioning or liveness failures
- State manipulation or corruption
- Validator node compromise

The information could theoretically assist in planning more sophisticated attacks by revealing the internal architecture, but this requires chaining with other vulnerabilities to achieve meaningful impact.

## Likelihood Explanation

**High Likelihood** - This information disclosure occurs naturally during normal error conditions:
- Accessing pruned ledger versions
- Database I/O errors or disk failures
- Invalid state queries
- Resource deserialization failures

Any unauthenticated API client can trigger these errors through normal API usage without special privileges or insider access.

## Recommendation

Implement error message sanitization before returning InternalError responses to clients: [1](#0-0) 

**Recommended Fix:**
```rust
pub fn new_with_error_code<ErrorType: std::fmt::Display>(
    error: ErrorType,
    error_code: AptosErrorCode,
) -> AptosError {
    Self {
        message: sanitize_error_message(format!("{:#}", error)),
        error_code,
        vm_error_code: None,
    }
}

fn sanitize_error_message(msg: String) -> String {
    // Remove absolute paths
    let msg = regex::Regex::new(r"/[^\s]+").unwrap()
        .replace_all(&msg, "[PATH_REDACTED]").to_string();
    // Remove internal structure details while keeping user-facing context
    msg
}
```

## Proof of Concept

**Scenario:** Trigger a RocksDB I/O error through the accounts API

```bash
# 1. Query an account resource at a pruned version to trigger database error
curl -X GET "http://localhost:8080/v1/accounts/0x1/resource/0x1::coin::CoinStore<0x1::aptos_coin::AptosCoin>?ledger_version=1" \
  -H "Accept: application/json"

# Expected Response (vulnerable):
{
  "message": "Failed to query DB to check for StateKey(AccessPath { address: 0x1, path: ... })
              Caused by: AptosDB RocksDB Error: IO error: Permission denied: /var/lib/aptos/db/state_merkle/000456.sst",
  "error_code": "internal_error",
  "vm_error_code": null
}

# Expected Response (after fix):
{
  "message": "Internal database error occurred while processing request",
  "error_code": "internal_error", 
  "vm_error_code": null
}
```

**Notes:**
- While this is a genuine information disclosure issue, it does **not** meet the Critical/High/Medium severity thresholds defined in the bug bounty program
- The issue falls under Low Severity per bounty criteria ("Minor information leaks")
- No critical blockchain invariants are violated (consensus, state integrity, funds safety remain intact)
- This represents a defense-in-depth improvement rather than a critical security flaw

### Citations

**File:** api/types/src/error.rs (L29-38)
```rust
    pub fn new_with_error_code<ErrorType: std::fmt::Display>(
        error: ErrorType,
        error_code: AptosErrorCode,
    ) -> AptosError {
        Self {
            message: format!("{:#}", error),
            error_code,
            vm_error_code: None,
        }
    }
```

**File:** storage/schemadb/src/lib.rs (L389-407)
```rust
fn to_db_err(rocksdb_err: rocksdb::Error) -> AptosDbError {
    match rocksdb_err.kind() {
        ErrorKind::Incomplete => AptosDbError::RocksDbIncompleteResult(rocksdb_err.to_string()),
        ErrorKind::NotFound
        | ErrorKind::Corruption
        | ErrorKind::NotSupported
        | ErrorKind::InvalidArgument
        | ErrorKind::IOError
        | ErrorKind::MergeInProgress
        | ErrorKind::ShutdownInProgress
        | ErrorKind::TimedOut
        | ErrorKind::Aborted
        | ErrorKind::Busy
        | ErrorKind::Expired
        | ErrorKind::TryAgain
        | ErrorKind::CompactionTooLarge
        | ErrorKind::ColumnFamilyDropped
        | ErrorKind::Unknown => AptosDbError::OtherRocksDbError(rocksdb_err.to_string()),
    }
```

**File:** api/src/context.rs (L164-168)
```rust
        self.db
            .latest_state_checkpoint_view()
            .context("Failed to read latest state checkpoint from DB")
            .map_err(|e| E::internal_with_code(e, AptosErrorCode::InternalError, ledger_info))
    }
```

**File:** api/src/state.rs (L345-354)
```rust
        let bytes = state_view
            .get_state_value_bytes(&state_key)
            .context(format!("Failed to query DB to check for {:?}", state_key))
            .map_err(|err| {
                BasicErrorWith404::internal_with_code(
                    err,
                    AptosErrorCode::InternalError,
                    &ledger_info,
                )
            })?
```
