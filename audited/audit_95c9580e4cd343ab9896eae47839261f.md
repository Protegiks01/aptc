# Audit Report

## Title
Internal Network Information Disclosure Through Unsanitized Error Messages in Indexer gRPC Gateway

## Summary
The indexer-grpc-gateway service exposes internal network topology, service addresses, and connection details to external clients through unsanitized error messages. When proxy requests fail, error responses directly include internal service URLs, connection error details, and gRPC transport information that aid attackers in reconnaissance.

## Finding Description
The `indexer-grpc-gateway` service acts as a proxy between external clients and internal data services. When handling errors, the implementation converts all exceptions to strings using `.to_string()` and returns them directly to clients without sanitization. [1](#0-0) 

When the gateway attempts to connect to the internal gRPC manager service, connection failures expose the `grpc_manager_address` configuration value. Typical tonic transport errors include details such as:
- `"transport error: error trying to connect: tcp connect error: Connection refused (os error 111)"`
- `"transport error: dns error: failed to lookup address information"`
- Full connection URLs with hostnames, ports, and protocols [2](#0-1) 

Similarly, when calling `get_data_service_for_request`, gRPC service errors are returned unfiltered, potentially exposing internal service implementation details, error codes, and stack traces from the gRPC manager service. [3](#0-2) 

The proxy function itself leaks information when forwarding requests to upstream data services fails. HTTP client errors from the hyper library can include connection timeouts, DNS resolution failures, TLS handshake errors, and other transport-level details that reveal internal infrastructure configuration. [4](#0-3) 

The `grpc_manager_address` is a configuration parameter pointing to an internal service. When this address is leaked through error messages, attackers gain visibility into the internal network architecture.

**Attack Path:**
1. Attacker sends gRPC requests to the public-facing indexer gateway
2. Attacker triggers error conditions by:
   - Sending requests during service maintenance windows
   - Sending malformed requests that fail internal validation
   - Timing requests to coincide with network issues
3. Gateway returns detailed error messages containing:
   - Internal service hostnames (e.g., `grpc-manager.internal.aptos.network:50051`)
   - Connection error details with OS-level error codes
   - Service discovery information
   - Network topology clues

## Impact Explanation
This vulnerability facilitates reconnaissance attacks against Aptos infrastructure. While it doesn't directly compromise consensus, execution, or state management, it provides attackers with detailed information about:

- Internal service architecture and naming conventions
- Network segmentation and service discovery mechanisms  
- Service availability and health status
- Potential attack vectors for lateral movement

According to the Aptos bug bounty program, "Minor information leaks" are classified as **Low Severity** (up to $1,000). However, the exposure of internal network topology and service addresses represents more than minor information disclosure, as it enables targeted attacks against specific internal services.

This falls into a gray area between Low and Medium severity. While not causing direct fund loss or consensus violations, it significantly aids attackers in planning sophisticated attacks against the indexer infrastructure and potentially discovering paths to more critical systems.

## Likelihood Explanation
This vulnerability is **highly likely** to be exploited:

- **Ease of exploitation**: Trivial - requires only sending requests to a public endpoint
- **Attacker sophistication**: None - any external user can trigger errors
- **Preconditions**: None - the service is publicly accessible
- **Detection difficulty**: Low - error responses appear as legitimate responses to clients

Attackers routinely perform reconnaissance by probing services for information leakage. This vulnerability provides immediate value with no risk to the attacker.

## Recommendation
Implement error message sanitization to remove internal details before returning responses to clients. Create a mapping of internal errors to generic, safe error messages.

**Recommended Fix:**

```rust
// Add error sanitization helper
fn sanitize_error(error: impl std::fmt::Display) -> String {
    // Log full error internally for debugging
    tracing::error!("Internal error: {}", error);
    
    // Return generic message to client
    "Service temporarily unavailable. Please try again later.".to_string()
}

// Update error handling in get_data_service_url function:
let mut client = GrpcManagerClient::connect(config.grpc_manager_address.to_string())
    .await
    .map_err(|e| {
        tracing::error!("Failed to connect to gRPC manager: {}", e);
        (StatusCode::INTERNAL_SERVER_ERROR, 
         "Failed to route request to data service".to_string())
    })?;

let response: GetDataServiceForRequestResponse = client
    .get_data_service_for_request(grpc_manager_request)
    .await
    .map_err(|e| {
        tracing::error!("gRPC manager error: {}", e);
        (StatusCode::INTERNAL_SERVER_ERROR,
         "Failed to obtain data service information".to_string())
    })?
    .into_inner();

// Update proxy function:
Client::builder(TokioExecutor::new())
    .http2_only(true)
    .build_http()
    .request(request)
    .await
    .map(|res| {
        let (parts, body) = res.into_parts();
        Response::from_parts(parts, axum::body::Body::new(body))
    })
    .map_err(|e| {
        tracing::error!("Proxy request failed: {}", e);
        (StatusCode::BAD_GATEWAY, 
         "Unable to reach upstream service".to_string())
    })
```

Additionally, implement structured error responses with error codes instead of freeform messages, and ensure all errors are logged server-side with full details while only generic messages reach clients.

## Proof of Concept

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use axum::http::{Request, StatusCode};
    use tower::ServiceExt;
    
    #[tokio::test]
    async fn test_error_information_leakage() {
        // Create config with unreachable gRPC manager address
        let config = Arc::new(IndexerGrpcGatewayConfig {
            port: 8080,
            grpc_manager_address: "http://internal-grpc-manager.aptos.network:50051".to_string(),
        });
        
        // Create a test request
        let request = Request::builder()
            .uri("/aptos.indexer.v1.RawData/GetTransactions")
            .body(axum::body::Body::empty())
            .unwrap();
        
        // Call the middleware
        let result = get_data_service_url(
            State(config),
            request,
            Next { /* mock */ }
        ).await;
        
        // Verify error contains internal address
        match result {
            Err((status, message)) => {
                assert_eq!(status, StatusCode::INTERNAL_SERVER_ERROR);
                // This assertion demonstrates the vulnerability:
                // internal service address should NOT appear in error message
                assert!(message.contains("internal-grpc-manager.aptos.network") ||
                        message.contains("50051"),
                    "Error message leaked internal service information: {}", message);
            },
            Ok(_) => panic!("Expected error due to unreachable service"),
        }
    }
}
```

To test in a live environment:
1. Deploy the gateway with an invalid or unreachable `grpc_manager_address`
2. Send a gRPC request: `grpcurl -d '{"starting_version": 0}' <gateway-address> aptos.indexer.v1.RawData/GetTransactions`
3. Observe the error response contains internal service addresses

---

## Notes

**Severity Classification Clarification**: The bug bounty program lists "Minor information leaks" as Low Severity ($1,000). However, exposure of internal network topology and service addresses represents significant information disclosure that enables targeted infrastructure attacks. The classification as "Medium" in the original question may reflect the reconnaissance value and potential for chaining with other attacks.

**Scope Consideration**: This vulnerability affects the indexer-grpc-gateway, which is auxiliary infrastructure rather than core consensus/execution components. It does not directly impact blockchain safety, liveness, or state integrity. However, it weakens the overall security posture by exposing internal architecture to potential attackers.

### Citations

**File:** ecosystem/indexer-grpc/indexer-grpc-gateway/src/gateway.rs (L138-140)
```rust
    let mut client = GrpcManagerClient::connect(config.grpc_manager_address.to_string())
        .await
        .map_err(|e| (StatusCode::INTERNAL_SERVER_ERROR, e.to_string()))?;
```

**File:** ecosystem/indexer-grpc/indexer-grpc-gateway/src/gateway.rs (L143-147)
```rust
    let response: GetDataServiceForRequestResponse = client
        .get_data_service_for_request(grpc_manager_request)
        .await
        .map_err(|e| (StatusCode::INTERNAL_SERVER_ERROR, e.to_string()))?
        .into_inner();
```

**File:** ecosystem/indexer-grpc/indexer-grpc-gateway/src/gateway.rs (L166-176)
```rust
    Client::builder(TokioExecutor::new())
        .http2_only(true)
        .build_http()
        .request(request)
        .await
        .map(|res| {
            let (parts, body) = res.into_parts();
            Response::from_parts(parts, axum::body::Body::new(body))
        })
        .map_err(|e| (StatusCode::INTERNAL_SERVER_ERROR, e.to_string()))
}
```

**File:** ecosystem/indexer-grpc/indexer-grpc-gateway/src/config.rs (L13-17)
```rust
pub struct IndexerGrpcGatewayConfig {
    #[serde(default = "IndexerGrpcGatewayConfig::default_port")]
    pub(crate) port: u16,
    pub(crate) grpc_manager_address: String,
}
```
