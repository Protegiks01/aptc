# Audit Report

## Title
Insecure File Permissions in Genesis Configuration Creation Allow Unauthorized Access to Validator Infrastructure Data

## Summary
The `Client::put()` function in the genesis git client creates files and directories without setting explicit permissions, resulting in world-readable files (mode 0o644) and directories (mode 0o755) on Unix systems. This exposes sensitive validator configuration data including network topology, consensus keys, and stake amounts to any local user on the system.

## Finding Description
When validator operators use the genesis setup commands (specifically `SetValidatorConfiguration`), the system writes sensitive configuration files to disk using `Client::put()`. [1](#0-0) 

The `put()` method delegates file creation to `write_to_file()`: [2](#0-1) 

This function uses default `OpenOptions` without setting file permissions: [3](#0-2) 

Similarly, directory creation uses `create_dir_if_not_exist()` without permission controls: [4](#0-3) 

On Unix systems, files created with default `OpenOptions` inherit umask-based permissions (typically 0o644 = rw-r--r--), and directories created with `create_dir_all()` get mode 0o755 (rwxr-xr-x). This makes all genesis configuration files and directories readable by any local user.

The exposed data includes: [5](#0-4) [6](#0-5) 

This configuration data is written via `git_client.put()`: [7](#0-6) 

The codebase already has a secure alternative function that properly sets permissions: [8](#0-7) 

This function is correctly used when writing private key files, but not for genesis configuration files.

## Impact Explanation
**High Severity** - This vulnerability qualifies as a significant protocol violation under the Aptos bug bounty program. The exposed information enables reconnaissance attacks against validator infrastructure:

1. **Network Topology Exposure**: Validator and full node network addresses reveal the infrastructure layout
2. **Cryptographic Key Intelligence**: Public keys and proofs of possession can be collected for correlation attacks
3. **Economic Information**: Stake amounts and commission rates reveal validator economic profiles
4. **Chain Configuration**: Genesis parameters expose network configuration details

An attacker with local user access on a shared server can passively collect this data to plan targeted attacks against specific validators, including network-level attacks, social engineering, or coordinated exploits.

## Likelihood Explanation
**High Likelihood** - This vulnerability manifests in every genesis setup using local repositories on Unix systems:

1. Validator operators commonly use shared cloud instances or development servers
2. The insecure behavior is the default - no special conditions required
3. Multi-tenant environments (cloud VMs, development servers) are standard practice
4. The issue persists until files are manually chmod'd (which operators typically don't do)

The vulnerability occurs automatically whenever `aptos genesis set-validator-configuration` is run with `--local-repository-dir` on a system with multiple users.

## Recommendation
Replace `write_to_file()` with `write_to_user_only_file()` in the `Client::put()` method, and set directory permissions explicitly:

```rust
pub fn put<T: Serialize + ?Sized>(&self, name: &Path, input: &T) -> CliTypedResult<()> {
    match self {
        Client::Local(local_repository_path) => {
            let path = local_repository_path.join(name);
            
            if let Some(dir) = path.parent() {
                self.create_dir(dir)?;
            } else {
                return Err(CliError::UnexpectedError(format!(
                    "Path should always have a parent {}",
                    path.display()
                )));
            }
            // Use secure file creation with 0o600 permissions
            write_to_user_only_file(
                path.as_path(),
                &path.display().to_string(),
                to_yaml(input)?.as_bytes(),
            )?;
        },
        Client::Github(client) => {
            client.put(&name.display().to_string(), &to_base64_encoded_yaml(input)?)?;
        },
    }
    Ok(())
}
```

Additionally, update `create_dir_if_not_exist()` to set secure directory permissions:

```rust
pub fn create_dir_if_not_exist(dir: &Path) -> CliTypedResult<()> {
    if !dir.exists() || !dir.is_dir() {
        #[cfg(unix)]
        {
            use std::fs::DirBuilder;
            use std::os::unix::fs::DirBuilderExt;
            let mut builder = DirBuilder::new();
            builder.mode(0o700).recursive(true);
            builder.create(dir).map_err(|e| CliError::IO(dir.display().to_string(), e))?;
        }
        #[cfg(not(unix))]
        {
            std::fs::create_dir_all(dir).map_err(|e| CliError::IO(dir.display().to_string(), e))?;
        }
        debug!("Created {} folder", dir.display());
    } else {
        debug!("{} folder already exists", dir.display());
    }
    Ok(())
}
```

## Proof of Concept

```bash
#!/bin/bash
# Proof of Concept: Demonstrate insecure file permissions

# Setup: Run as validator operator (user1)
sudo -u user1 bash << 'EOF'
cd /tmp
mkdir genesis-test && cd genesis-test

# Generate validator keys
aptos genesis generate-keys --output-dir .

# Setup genesis with local repository
echo "root_key: ~
users: [\"alice\"]
chain_id: 99
allow_new_validators: true
epoch_duration_secs: 7200
is_test: true
min_stake: 100000000000000
min_voting_threshold: 100000000000000
max_stake: 100000000000000000
recurring_lockup_duration_secs: 86400
required_proposer_stake: 100000000000000
rewards_apy_percentage: 10
voting_duration_secs: 43200
voting_power_increase_limit: 50" > layout.yaml

# Set validator configuration - creates world-readable files
aptos genesis set-validator-configuration \
  --username alice \
  --validator-host 127.0.0.1:6180 \
  --full-node-host 127.0.0.1:6181 \
  --local-repository-dir . \
  --layout-file layout.yaml

# Check file permissions
ls -la alice/
EOF

# Attack: Read configuration as different user (user2)
sudo -u user2 bash << 'EOF'
cd /tmp/genesis-test

# Any local user can read sensitive validator configuration
echo "=== ATTACKER CAN READ OPERATOR CONFIG ==="
cat alice/operator.yaml

echo "=== ATTACKER CAN READ OWNER CONFIG ==="
cat alice/owner.yaml

echo "=== Directory permissions allow access ==="
ls -ld alice/
EOF

# Expected output shows:
# - Files have permissions -rw-r--r-- (644) - readable by all users
# - Directories have permissions drwxr-xr-x (755) - accessible by all users
# - Attacker (user2) can read validator network addresses, public keys, stake amounts
```

**Expected Output:**
```
drwxr-xr-x 2 user1 user1 4096 Jan 1 12:00 alice/
-rw-r--r-- 1 user1 user1  512 Jan 1 12:00 operator.yaml
-rw-r--r-- 1 user1 user1  423 Jan 1 12:00 owner.yaml

=== ATTACKER CAN READ OPERATOR CONFIG ===
operator_account_address: "0x..."
consensus_public_key: "0x..."
validator_network_public_key: "0x..."
validator_host: "127.0.0.1:6180"
[... full configuration visible to attacker ...]
```

This demonstrates that any local user can read sensitive validator infrastructure configuration due to insecure default file permissions.

### Citations

**File:** crates/aptos/src/genesis/git.rs (L187-213)
```rust
    pub fn put<T: Serialize + ?Sized>(&self, name: &Path, input: &T) -> CliTypedResult<()> {
        match self {
            Client::Local(local_repository_path) => {
                let path = local_repository_path.join(name);

                // Create repository path and any sub-directories
                if let Some(dir) = path.parent() {
                    self.create_dir(dir)?;
                } else {
                    return Err(CliError::UnexpectedError(format!(
                        "Path should always have a parent {}",
                        path.display()
                    )));
                }
                write_to_file(
                    path.as_path(),
                    &path.display().to_string(),
                    to_yaml(input)?.as_bytes(),
                )?;
            },
            Client::Github(client) => {
                client.put(&name.display().to_string(), &to_base64_encoded_yaml(input)?)?;
            },
        }

        Ok(())
    }
```

**File:** crates/aptos/src/common/utils.rs (L219-221)
```rust
pub fn write_to_file(path: &Path, name: &str, bytes: &[u8]) -> CliTypedResult<()> {
    write_to_file_with_opts(path, name, bytes, &mut OpenOptions::new())
}
```

**File:** crates/aptos/src/common/utils.rs (L224-229)
```rust
pub fn write_to_user_only_file(path: &Path, name: &str, bytes: &[u8]) -> CliTypedResult<()> {
    let mut opts = OpenOptions::new();
    #[cfg(unix)]
    opts.mode(0o600);
    write_to_file_with_opts(path, name, bytes, &mut opts)
}
```

**File:** crates/aptos/src/common/utils.rs (L232-246)
```rust
pub fn write_to_file_with_opts(
    path: &Path,
    name: &str,
    bytes: &[u8],
    opts: &mut OpenOptions,
) -> CliTypedResult<()> {
    let mut file = opts
        .write(true)
        .create(true)
        .truncate(true)
        .open(path)
        .map_err(|e| CliError::IO(name.to_string(), e))?;
    file.write_all(bytes)
        .map_err(|e| CliError::IO(name.to_string(), e))
}
```

**File:** crates/aptos/src/common/utils.rs (L416-425)
```rust
pub fn create_dir_if_not_exist(dir: &Path) -> CliTypedResult<()> {
    // Check if the directory exists, if it's not a dir, it will also fail here
    if !dir.exists() || !dir.is_dir() {
        std::fs::create_dir_all(dir).map_err(|e| CliError::IO(dir.display().to_string(), e))?;
        debug!("Created {} folder", dir.display());
    } else {
        debug!("{} folder already exists", dir.display());
    }
    Ok(())
}
```

**File:** crates/aptos-genesis/src/config.rs (L348-359)
```rust
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct OwnerConfiguration {
    pub owner_account_address: AccountAddressWithChecks,
    pub owner_account_public_key: Ed25519PublicKey,
    pub voter_account_address: AccountAddressWithChecks,
    pub voter_account_public_key: Ed25519PublicKey,
    pub operator_account_address: AccountAddressWithChecks,
    pub operator_account_public_key: Ed25519PublicKey,
    pub stake_amount: u64,
    pub commission_percentage: u64,
    pub join_during_genesis: bool,
}
```

**File:** crates/aptos-genesis/src/config.rs (L361-371)
```rust
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct OperatorConfiguration {
    pub operator_account_address: AccountAddressWithChecks,
    pub operator_account_public_key: Ed25519PublicKey,
    pub consensus_public_key: bls12381::PublicKey,
    pub consensus_proof_of_possession: bls12381::ProofOfPossession,
    pub validator_network_public_key: x25519::PublicKey,
    pub validator_host: HostAndPort,
    pub full_node_network_public_key: Option<x25519::PublicKey>,
    pub full_node_host: Option<HostAndPort>,
}
```

**File:** crates/aptos/src/genesis/keys.rs (L258-261)
```rust
        let git_client = self.git_options.get_client()?;
        git_client.put(operator_file.as_path(), &operator_config)?;
        git_client.put(owner_file.as_path(), &owner_config)
    }
```
