# Audit Report

## Title
Faucet Health Check Endpoint Leaks Sensitive Funder Account Information

## Summary
The `BasicApi::root()` health check endpoint at `/` exposes sensitive operational details about the faucet's funder accounts in error responses, including account addresses, exact balances, configuration thresholds, and detailed internal error messages. This information disclosure assists attackers in reconnaissance and timing of potential attacks.

## Finding Description

The health check endpoint directly includes funder health messages in HTTP error responses without sanitization. [1](#0-0) 

**TransferFunder Information Disclosure:**

When `TransferFunder` has insufficient funds, it returns a message containing:
- The funder account address
- The exact current balance in OCTAs
- The minimum required funds threshold [2](#0-1) 

Additionally, detailed API error messages are exposed with full error context: [3](#0-2) 

**MintFunder Information Disclosure:**

The `MintFunder` exposes:
- Default asset configuration details
- Funder account addresses  
- Detailed API errors with full context [4](#0-3) [5](#0-4) 

An attacker can periodically poll the `/` endpoint to:
1. Identify funder account addresses for blockchain monitoring
2. Track exact balance levels to time attacks when funds are low
3. Learn operational configurations (minimum thresholds)
4. Gather implementation details from error messages

## Impact Explanation

This is a **Low Severity** issue per Aptos Bug Bounty criteria: "Minor information leaks."

While the exposed information doesn't directly enable fund theft or consensus attacks, it provides valuable reconnaissance data:
- Account addresses enable targeted on-chain monitoring
- Balance information reveals when the faucet is vulnerable (low funds)
- Configuration details expose operational parameters
- Error messages may reveal implementation specifics useful for crafting attacks

The impact is limited because blockchain data is inherently public, but the endpoint unnecessarily aggregates sensitive operational information in one easily accessible location.

## Likelihood Explanation

**Likelihood: High**

Exploitation requires only a simple HTTP GET request to a public endpoint. No authentication or special conditions are needed. Attackers can trivially automate polling to continuously monitor funder health and gather intelligence. The vulnerability is always present when funders enter an unhealthy state.

## Recommendation

Sanitize health check error messages to remove sensitive details:

```rust
async fn root(&self) -> poem::Result<PlainText<String>> {
    // Confirm that we haven't hit the max concurrent requests.
    if let Some(ref semaphore) = self.concurrent_requests_semaphore {
        if semaphore.available_permits() == 0 {
            return Err(poem::Error::from((
                StatusCode::SERVICE_UNAVAILABLE,
                anyhow::anyhow!("Server is overloaded"),
            )));
        }
    }

    // Confirm that the Funder is healthy.
    let funder_health = self.funder.is_healthy().await;
    if !funder_health.can_process_requests {
        // Return generic message without sensitive details
        return Err(poem::Error::from((
            StatusCode::SERVICE_UNAVAILABLE,
            anyhow::anyhow!("Service temporarily unavailable"),
        )));
    }

    Ok(PlainText("tap:ok".to_string()))
}
```

Additionally, modify funder implementations to log detailed errors internally rather than returning them in health messages, or add a flag to distinguish between internal diagnostic messages and public-facing messages.

## Proof of Concept

```bash
# When TransferFunder is unhealthy (balance below minimum):
curl -i http://faucet-endpoint/

# Expected vulnerable response:
HTTP/1.1 503 Service Unavailable
Content-Type: text/plain

Funder account 0x123abc... has insufficient funds. It has 50000000, but the minimum is 100000000

# When MintFunder has issues:
curl -i http://faucet-endpoint/

# Expected vulnerable response:
HTTP/1.1 503 Service Unavailable
Content-Type: text/plain

Failed to read account information for 0x456def..., it may not exist or the fullnode might not be fully synced: [detailed error trace]
```

This information enables attackers to:
1. Identify the exact funder account address
2. Monitor the account's balance on-chain
3. Time attacks for when balance approaches minimum threshold
4. Understand internal architecture from error details

## Notes

- While blockchain data is public, this endpoint unnecessarily aggregates sensitive operational details
- The exposure is particularly concerning for TransferFunder which reveals exact real-time balances
- Sequence numbers are not directly exposed in health checks, though the question mentioned them
- This is a design-level information disclosure rather than a critical exploit
- Consider implementing separate diagnostic endpoints with authentication for detailed health information

### Citations

**File:** crates/aptos-faucet/core/src/endpoints/basic.rs (L57-69)
```rust
        // Confirm that the Funder is healthy.
        let funder_health = self.funder.is_healthy().await;
        if !funder_health.can_process_requests {
            return Err(poem::Error::from((
                StatusCode::SERVICE_UNAVAILABLE,
                anyhow::anyhow!(
                    "{}",
                    funder_health
                        .message
                        .unwrap_or_else(|| "Funder is unhealthy".to_string())
                ),
            )));
        }
```

**File:** crates/aptos-faucet/core/src/funder/transfer.rs (L355-361)
```rust
            Err(e) => return FunderHealthMessage {
                can_process_requests: false,
                message: Some(format!(
                    "Failed to get account balance to determine whether tap account has sufficient funds: {:#}",
                    e
                )),
            },
```

**File:** crates/aptos-faucet/core/src/funder/transfer.rs (L367-373)
```rust
            FunderHealthMessage {
                can_process_requests: false,
                message: Some(format!(
                    "Funder account {} has insufficient funds. It has {}, but the minimum is {}",
                    account_address, funder_balance, self.minimum_funds.0
                )),
            }
```

**File:** crates/aptos-faucet/core/src/funder/mint.rs (L557-563)
```rust
                return FunderHealthMessage {
                    can_process_requests: false,
                    message: Some(format!(
                        "Default asset '{}' not found: {}",
                        self.default_asset, e
                    )),
                };
```

**File:** crates/aptos-faucet/core/src/funder/mint.rs (L572-578)
```rust
            Err(e) => return FunderHealthMessage {
                can_process_requests: false,
                message: Some(format!(
                    "Failed to read account information for {}, it may not exist or the fullnode might not be fully synced: {:#}",
                    account_address, e
                )),
            },
```
