# Audit Report

## Title
Seed Configuration Bypass via Empty Map Allows Network Isolation of Fullnodes

## Summary
The `.is_null()` check at line 203 of `config_optimizer.rs` fails to distinguish between "unset" and "explicitly set to empty map," allowing configurations with `seeds: {}` to bypass automatic seed peer population for mainnet/testnet fullnodes, resulting in complete network isolation. [1](#0-0) 

## Finding Description

The `optimize_public_network_config` function uses `.is_null()` to determine whether seed peers should be auto-populated for public fullnode networks on mainnet and testnet: [2](#0-1) 

The YAML check only returns true for actual null values or missing fields. When a configuration contains `seeds: {}` (an empty HashMap), the check returns false, causing the optimizer to skip adding the hardcoded seed peers defined in `TESTNET_SEED_PEERS` and `MAINNET_SEED_PEERS`: [3](#0-2) 

**Attack Vector:**
1. Attacker distributes a configuration template with `seeds: {}` for public networks
2. The empty map deserializes successfully as `PeerSet` (type `HashMap<PeerId, Peer>`)
3. The optimizer check `.is_null()` returns false, skipping default seed addition
4. The `verify_seeds()` validation passes because empty maps iterate zero times: [4](#0-3) 

5. If `discovery_method` is not explicitly set to "onchain" (defaults to `DiscoveryMethod::None`): [5](#0-4) 

6. The node starts with zero seed peers and no discovery mechanism
7. Complete network isolation occurs - the node cannot bootstrap or sync

The `ConnectivityManager` accepts empty seed sets without error: [6](#0-5) 

## Impact Explanation

This issue meets **Medium Severity** criteria under "State inconsistencies requiring intervention":

- **Loss of Availability**: Affected fullnodes cannot connect to the network, sync blocks, or serve API requests
- **Eclipse Attack Susceptibility**: Nodes without trusted seed peers are vulnerable to network-level isolation attacks
- **Manual Intervention Required**: Node operators must manually fix configurations and restart nodes
- **Scope**: Only affects misconfigured nodes, not network-wide

While no funds are at risk and consensus is unaffected, this represents a significant availability failure requiring operator intervention.

## Likelihood Explanation

**Likelihood: Medium**

This vulnerability requires specific misconfiguration but has realistic attack vectors:

1. **Supply Chain Attack**: Malicious actors distribute "optimized" Docker images, Helm charts, or configuration templates containing `seeds: {}`
2. **Documentation Error**: Unclear documentation could lead operators to use empty maps thinking they represent "default values"
3. **Configuration Management**: Automated config generation scripts might produce empty maps as placeholders

The configuration is syntactically valid YAML and passes all current validation checks, making it plausible for operators to inadvertently deploy affected configurations.

## Recommendation

Replace the `.is_null()` check with a more robust validation that treats empty collections as "unset":

```rust
if local_network_config_yaml["seeds"].is_null() || 
   (local_network_config_yaml["seeds"].is_mapping() && 
    local_network_config_yaml["seeds"].as_mapping().unwrap().is_empty()) {
    // Add default seeds
}
```

Additionally, add validation in the sanitizer to enforce that public fullnodes on mainnet/testnet must have either:
- Non-empty seeds configured, OR
- Onchain discovery explicitly enabled

This prevents accidentally deploying isolated nodes.

## Proof of Concept

```rust
#[test]
fn test_empty_seeds_map_bypass() {
    use crate::config::{NodeConfig, NetworkConfig};
    use crate::network_id::NetworkId;
    use aptos_types::chain_id::ChainId;
    use std::collections::HashMap;
    
    // Create a public fullnode config with initially empty seeds
    let mut node_config = NodeConfig {
        storage: setup_storage_config_with_temp_dir().0,
        full_node_networks: vec![NetworkConfig {
            network_id: NetworkId::Public,
            seeds: HashMap::new(),
            ..Default::default()
        }],
        ..Default::default()
    };
    
    // Simulate user config with explicit empty seeds map
    let local_config_yaml = serde_yaml::from_str(
        r#"
        full_node_networks:
            - network_id: "Public"
              seeds: {}
        "#,
    ).unwrap();
    
    // Optimize config for testnet PFN
    let modified_config = optimize_public_network_config(
        &mut node_config,
        &local_config_yaml,
        NodeType::PublicFullnode,
        Some(ChainId::testnet()),
    ).unwrap();
    
    // BUG: No modifications made because empty map is not null
    assert!(!modified_config);
    
    // BUG: Seeds remain empty despite being on testnet
    let public_network_config = &node_config.full_node_networks[0];
    assert_eq!(public_network_config.seeds.len(), 0);
    
    // Node cannot bootstrap without seeds or discovery
    // This configuration passes all current validation but results in isolation
}
```

## Notes

This vulnerability specifically affects public fullnodes on mainnet and testnet where the optimizer is designed to auto-populate seed peers. The issue stems from semantic ambiguity: an empty map `{}` could mean "I explicitly want no seeds" or "I haven't configured seeds yet." The current implementation treats both cases identically, respecting the "explicit" configuration per the optimizer's design philosophy, but this creates a footgun for operators and an attack vector for malicious template distributors.

### Citations

**File:** config/src/config/config_optimizer.rs (L32-61)
```rust
const MAINNET_SEED_PEERS: [(&str, &str, &str); 1] = [(
    "568fdb6acf26aae2a84419108ff13baa3ebf133844ef18e23a9f47b5af16b698",
    "0x003cc2ed36e7d486539ac2c411b48d962f1ef17d884c3a7109cad43f16bd5008",
    "/dns/node1.cloud-b.mainnet.aptoslabs.com/tcp/6182/noise-ik/0x003cc2ed36e7d486539ac2c411b48d962f1ef17d884c3a7109cad43f16bd5008/handshake/0",
)];

// Testnet seed peers. Each seed peer entry is a tuple
// of (account address, public key, network address).
const TESTNET_SEED_PEERS: [(&str, &str, &str); 4] = [
    (
        "31e55012a7d439dcd16fee0509cd5855c1fbdc62057ba7fac3f7c88f5453dd8e",
        "0x87bb19b02580b7e2a91a8e9342ec77ffd8f3ad967f54e77b22aaf558c5c11755",
        "/dns/seed0.testnet.aptoslabs.com/tcp/6182/noise-ik/0x87bb19b02580b7e2a91a8e9342ec77ffd8f3ad967f54e77b22aaf558c5c11755/handshake/0",
    ),
    (
        "116176e2af223a8b7f8db80dc52f7a423b4d7f8c0553a1747e92ef58849aff4f",
        "0xc2f24389f31c9c18d2ceb69d153ad9299e0ea7bbd66f457e0a28ef41c77c2b64",
        "/dns/seed1.testnet.aptoslabs.com/tcp/6182/noise-ik/0xc2f24389f31c9c18d2ceb69d153ad9299e0ea7bbd66f457e0a28ef41c77c2b64/handshake/0",
    ),
    (
        "12000330d7cd8a748f46c25e6ce5d236a27e13d0b510d4516ac84ecc5fddd002",
        "0x171c661e5b785283978a74eafc52a906e68c73ae78119737b92f93507c753933",
        "/dns/seed2.testnet.aptoslabs.com/tcp/6182/noise-ik/0x171c661e5b785283978a74eafc52a906e68c73ae78119737b92f93507c753933/handshake/0",
    ),
    (
        "03c04549114877c55f45649aba48ac0a4ff086ab7bdce3b8cc8d3d9947bc0d99",
        "0xafc38bf177bd825326a1c314748612137d2b35dae6472932806806a32c23174a",
        "/dns/seed3.testnet.aptoslabs.com/tcp/6182/noise-ik/0xafc38bf177bd825326a1c314748612137d2b35dae6472932806806a32c23174a/handshake/0",
    ),
];
```

**File:** config/src/config/config_optimizer.rs (L203-215)
```rust
            if local_network_config_yaml["seeds"].is_null() {
                if let Some(chain_id) = chain_id {
                    if chain_id.is_testnet() {
                        fullnode_network_config.seeds =
                            create_seed_peers(TESTNET_SEED_PEERS.into())?;
                        modified_config = true;
                    } else if chain_id.is_mainnet() {
                        fullnode_network_config.seeds =
                            create_seed_peers(MAINNET_SEED_PEERS.into())?;
                        modified_config = true;
                    }
                }
            }
```

**File:** config/src/config/network_config.rs (L138-138)
```rust
            discovery_method: DiscoveryMethod::None,
```

**File:** config/src/config/network_config.rs (L319-340)
```rust
    pub fn verify_seeds(&self) -> Result<(), Error> {
        for (peer_id, addrs) in self.seed_addrs.iter() {
            for addr in addrs {
                Self::verify_address(peer_id, addr)?;
            }
        }

        for (peer_id, seed) in self.seeds.iter() {
            for addr in seed.addresses.iter() {
                Self::verify_address(peer_id, addr)?;
            }

            // Require there to be a pubkey somewhere, either in the address (assumed by `is_aptosnet_addr`)
            if seed.keys.is_empty() && seed.addresses.is_empty() {
                return Err(Error::InvariantViolation(format!(
                    "Seed peer {} has no pubkeys",
                    peer_id.short_str(),
                )));
            }
        }
        Ok(())
    }
```

**File:** network/framework/src/connectivity_manager/mod.rs (L401-401)
```rust
        connmgr.handle_update_discovered_peers(DiscoverySource::Config, seeds);
```
