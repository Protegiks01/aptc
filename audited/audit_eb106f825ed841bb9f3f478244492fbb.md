# Audit Report

## Title
P2P Network Ports Exposed on All Interfaces in ManagedNode Test Environment

## Summary
The `ManagedNode::start()` function fails to properly isolate test nodes by not overriding the P2P network listen addresses (validator_network and full_node_networks), which remain bound to `0.0.0.0` instead of `127.0.0.1`, exposing local network services to unauthorized access.

## Finding Description

When `ManagedNode::start()` initializes a test node for the indexer-transaction-generator, it attempts to bind all services to localhost by passing `Ipv4Addr::LOCALHOST` to `NodeManager::new_with_config()`. [1](#0-0) 

However, `NodeManager::new_with_config()` only overrides the bind addresses for HTTP-based services (API, indexer gRPC, admin service, inspection service) but completely misses the P2P network listen addresses: [2](#0-1) 

The P2P networks (validator_network and full_node_networks) use their default configuration, which binds to all interfaces: [3](#0-2) 

This creates an inconsistency where HTTP services are properly isolated to localhost, but P2P network ports (default TCP 6180, 6181, etc.) remain exposed on `0.0.0.0`, accepting connections from any network interface. The underlying node configuration created by `create_single_node_test_config()` also sets the API to bind to `0.0.0.0`, which gets properly overridden: [4](#0-3) 

But the validator and fullnode network configurations are never touched by the override logic, leaving them exposed.

## Impact Explanation

This vulnerability qualifies as **Medium severity** under the Aptos bug bounty program because it:

1. **Exposes local network services**: P2P protocol endpoints become accessible to any device on the local network, exposing the Aptos network protocol stack (consensus messages, state sync, transaction propagation) to unauthorized parties.

2. **Potential interference with production nodes**: If a production node runs on the same network, the test node could:
   - Receive connection attempts from production validators
   - Send malformed messages that could affect production node stability
   - Create confusion in peer discovery mechanisms

3. **Attack surface expansion**: Malicious actors on the local network can:
   - Attempt to exploit vulnerabilities in the P2P protocol implementation
   - Send crafted consensus messages to test the node's robustness
   - Perform reconnaissance on the test setup
   - Launch DoS attacks against the P2P ports

4. **Violates security expectations**: Developers using this testing tool expect complete localhost isolation, but unknowingly expose P2P services to their network.

## Likelihood Explanation

This vulnerability has **high likelihood** of exposure because:

1. The indexer-transaction-generator is designed for development and testing environments where developers may be on shared networks (corporate LANs, co-working spaces, cloud development environments).

2. Every invocation of `ManagedNode::start()` creates this exposure - it's not conditional or dependent on specific configurations.

3. The bind address `0.0.0.0` is the hardcoded default in `NetworkConfig::network_with_id()`, making it persistent across all default configurations.

4. Developers are unlikely to notice this exposure because the tool appears to work correctly - only security-conscious users checking with `netstat` or similar tools would detect the open ports.

## Recommendation

Override the P2P network listen addresses in `NodeManager::new_with_config()` to bind to localhost when `bind_to` is set to localhost:

```rust
pub fn new_with_config(
    mut node_config: NodeConfig,
    bind_to: Ipv4Addr,
    test_dir: PathBuf,
    run_txn_stream: bool,
    txn_stream_port: u16,
    no_node: bool,
) -> Result<Self> {
    eprintln!();

    // Enable the grpc stream on the node if we will run a txn stream service.
    node_config.indexer_grpc.enabled = run_txn_stream;
    node_config.indexer_grpc.use_data_service_interface = run_txn_stream;
    node_config.indexer_grpc.address.set_port(txn_stream_port);

    node_config.indexer_table_info.table_info_service_mode = match run_txn_stream {
        true => aptos_config::config::TableInfoServiceMode::IndexingOnly,
        false => aptos_config::config::TableInfoServiceMode::Disabled,
    };

    // Bind to the requested address.
    node_config.api.address.set_ip(IpAddr::V4(bind_to));
    node_config.indexer_grpc.address.set_ip(IpAddr::V4(bind_to));
    node_config.admin_service.address = bind_to.to_string();
    node_config.inspection_service.address = bind_to.to_string();
    
    // FIX: Also bind P2P network addresses to the requested address
    if let Some(ref mut validator_network) = node_config.validator_network {
        let current_addr = validator_network.listen_address.clone();
        if let Ok(((_ip, port), remaining)) = aptos_types::network_address::parse_ip_tcp(current_addr.as_slice()) {
            validator_network.listen_address = format!("/ip4/{}/tcp/{}", bind_to, port)
                .parse()
                .expect("Failed to parse validator network address");
        }
    }
    
    for full_node_network in node_config.full_node_networks.iter_mut() {
        let current_addr = full_node_network.listen_address.clone();
        if let Ok(((_ip, port), remaining)) = aptos_types::network_address::parse_ip_tcp(current_addr.as_slice()) {
            full_node_network.listen_address = format!("/ip4/{}/tcp/{}", bind_to, port)
                .parse()
                .expect("Failed to parse fullnode network address");
        }
    }
    
    node_config.indexer_db_config.enable_event = true;
    node_config.indexer_db_config.enable_statekeys = true;
    node_config.indexer_db_config.enable_transaction = true;

    Ok(NodeManager {
        config: node_config,
        test_dir,
        no_node,
    })
}
```

## Proof of Concept

To demonstrate this vulnerability:

1. Start the indexer-transaction-generator with Script mode:
```bash
cargo run -p aptos-indexer-grpc-indexer-transaction-generator -- \
    --testing-folder ./test_data \
    --output-folder ./output \
    --mode script
```

2. While the managed node is running, check listening ports from another terminal:
```bash
netstat -an | grep LISTEN | grep -E '6180|6181'
```

Expected vulnerable output:
```
tcp4       0      0  0.0.0.0.6180          *.*                    LISTEN
tcp4       0      0  0.0.0.0.6181          *.*                    LISTEN
```

Expected secure output (after fix):
```
tcp4       0      0  127.0.0.1.6180        *.*                    LISTEN
tcp4       0      0  127.0.0.1.6181        *.*                    LISTEN
```

3. Confirm exposure by attempting connection from another machine on the same network:
```bash
# From another machine on the network
telnet <test-machine-ip> 6180
```

This will successfully connect to the vulnerable configuration, demonstrating the P2P port is accessible from the network rather than being isolated to localhost.

## Notes

This vulnerability is specific to the test/development tooling (`indexer-transaction-generator` and `local_testnet`) and does not affect production validator or fullnode deployments that explicitly configure their network addresses. However, it represents a significant security gap in the testing infrastructure that could lead to unexpected exposure in development environments.

### Citations

**File:** ecosystem/indexer-grpc/indexer-transaction-generator/src/managed_node.rs (L56-64)
```rust
        let node_manager = NodeManager::new_with_config(
            node,
            Ipv4Addr::LOCALHOST,
            node_dir.clone(),
            true,
            DEFAULT_GRPC_STREAM_PORT,
            false,
        )
        .context("Failed to start node service manager")?;
```

**File:** crates/aptos/src/node/local_testnet/node.rs (L162-166)
```rust
        // Bind to the requested address.
        node_config.api.address.set_ip(IpAddr::V4(bind_to));
        node_config.indexer_grpc.address.set_ip(IpAddr::V4(bind_to));
        node_config.admin_service.address = bind_to.to_string();
        node_config.inspection_service.address = bind_to.to_string();
```

**File:** config/src/config/network_config.rs (L141-141)
```rust
            listen_address: "/ip4/0.0.0.0/tcp/6180".parse().unwrap(),
```

**File:** aptos-node/src/lib.rs (L571-574)
```rust
    // Enable the REST API
    node_config.api.address = format!("0.0.0.0:{}", node_config.api.address.port())
        .parse()
        .expect("Unable to set the REST API address!");
```
