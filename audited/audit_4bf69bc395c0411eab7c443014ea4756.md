# Audit Report

## Title
Insufficient gRPC Message Size Limits in Indexer Data Service (Low Severity)

## Summary
The indexer-grpc-data-service accepts compressed gRPC requests without explicitly setting message size limits, relying only on tonic's default 4MB limit for decoded messages. While this creates a best-practice concern, it does not constitute a High Severity vulnerability as claimed.

## Finding Description

The service configuration enables compressed request handling without explicit size constraints: [1](#0-0) 

The service does not call `.max_decoding_message_size()` or `.max_encoding_message_size()`, unlike the newer data-service-v2: [2](#0-1) 

Tonic's default limit for decoded messages is 4MB: [3](#0-2) 

The `GetTransactionsRequest` contains a recursive `BooleanTransactionFilter` structure: [4](#0-3) [5](#0-4) 

## Impact Explanation

**This does NOT meet High Severity criteria** because:

1. **4MB Default Protection Exists**: Tonic enforces a 4MB limit on decoded messages, preventing "enormous" expansion as claimed
2. **Non-Critical Service**: This is an indexer API service, not a validator node or consensus component
3. **Bounded Impact**: Maximum resource consumption is capped at 4MB of parsed protobuf data
4. **No Consensus/Validator Impact**: Does not affect blockchain safety, liveness, or validator operations

Per Aptos Bug Bounty criteria:
- High Severity requires "Validator node slowdowns" or "API crashes"
- This service is an indexer API (non-validator)
- The 4MB cap makes even API crashes unlikely

At most, this represents a **Low Severity** best-practice violation.

## Likelihood Explanation

The attack is theoretically possible but practically limited:
- Attacker can send compressed requests with nested filter structures
- Maximum expansion is capped at 4MB by tonic defaults
- Would require many concurrent requests to cause noticeable service degradation
- Modern protobuf libraries have recursion depth limits

## Recommendation

While not a High Severity vulnerability, explicit limits should be set for defense-in-depth:

```rust
let svc = aptos_protos::indexer::v1::raw_data_server::RawDataServer::new(server)
    .send_compressed(CompressionEncoding::Zstd)
    .accept_compressed(CompressionEncoding::Zstd)
    .accept_compressed(CompressionEncoding::Gzip)
    .max_decoding_message_size(MAX_MESSAGE_SIZE)  // Add this
    .max_encoding_message_size(MAX_MESSAGE_SIZE); // Add this
```

Additionally, validate transaction filter sizes: [6](#0-5) 

## Proof of Concept

Cannot provide a PoC demonstrating High Severity impact because the 4MB default limit prevents "enormous" expansion. A PoC would only demonstrate bounded resource consumption within the 4MB cap, which is expected behavior for API services handling complex queries.

---

**Notes:**

The claim that this is a **High Severity decompression bomb vulnerability** is **NOT VALID** because:

1. The 4MB default limit prevents expansion to "enormous size"
2. The service is an indexer API, not a consensus/validator component
3. Impact is bounded and does not affect blockchain security
4. Does not meet Aptos Bug Bounty criteria for High Severity

This represents a best-practice concern (explicit limits should be set), not an exploitable High Severity vulnerability. The indexer-grpc-data-service is not part of the critical consensus/execution path and its degradation does not compromise blockchain safety or validator operations.

### Citations

**File:** ecosystem/indexer-grpc/indexer-grpc-data-service/src/config.rs (L188-191)
```rust
        let svc = aptos_protos::indexer::v1::raw_data_server::RawDataServer::new(server)
            .send_compressed(CompressionEncoding::Zstd)
            .accept_compressed(CompressionEncoding::Zstd)
            .accept_compressed(CompressionEncoding::Gzip);
```

**File:** ecosystem/indexer-grpc/indexer-grpc-data-service-v2/src/config.rs (L240-241)
```rust
                .max_decoding_message_size(MAX_MESSAGE_SIZE)
                .max_encoding_message_size(MAX_MESSAGE_SIZE);
```

**File:** protos/rust/src/pb/aptos.indexer.v1.tonic.rs (L186-188)
```rust
        /// Limits the maximum size of a decoded message.
        ///
        /// Default: `4MB`
```

**File:** protos/rust/src/pb/aptos.indexer.v1.rs (L104-105)
```rust
        #[prost(message, tag="4")]
        LogicalNot(::prost::alloc::boxed::Box<super::BooleanTransactionFilter>),
```

**File:** protos/rust/src/pb/aptos.indexer.v1.rs (L133-135)
```rust
    /// If provided, only transactions that match the filter will be included.
    #[prost(message, optional, tag="4")]
    pub transaction_filter: ::core::option::Option<BooleanTransactionFilter>,
```

**File:** ecosystem/indexer-grpc/transaction-filter/src/boolean_transaction_filter.rs (L96-106)
```rust
        max_filter_size: Option<usize>,
    ) -> Result<Self> {
        if let Some(max_filter_size) = max_filter_size {
            ensure!(
                proto_filter.encoded_len() <= max_filter_size,
                format!(
                    "Filter is too complicated. Max size: {} bytes, Actual size: {} bytes",
                    max_filter_size,
                    proto_filter.encoded_len()
                )
            );
```
