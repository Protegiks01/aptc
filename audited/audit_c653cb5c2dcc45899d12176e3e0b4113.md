# Audit Report

## Title
Rosetta API Silent Operation Drop for Unsupported Fungible Assets Causes State Desynchronization

## Summary
The Rosetta API’s transaction conversion logic in Aptos Core silently drops operations (such as deposit and withdraw) for fungible assets that are not present in the server’s static currency configuration. This results in inaccurate representation of on-chain state for clients relying on Rosetta queries, causing sync discrepancies and potentially misleading external systems.

## Finding Description
The vulnerability is rooted in the logic where Rosetta parses state changes to generate its canonical operation list. Two critical hashmaps (`object_to_owner`, `store_to_currency`) are used to associate assets with accounts and currencies, respectively. When a new fungible asset (FA) is deployed, unless its metadata address is in the static set of configured currencies, `store_to_currency` is not populated during parsing.

This leads to the following exploitable path:
1. The function parsing changes, such as `parse_fungible_store_metadata`, attempts to resolve an asset’s currency via its metadata address. If not found in the pre-loaded currency set, the mapping is omitted.
2. When generating the operation list, if the currency mapping is missing, the function simply omits withdraw/deposit operations for that FA, returning an empty result without any log or error.
3. As the static currency list is only loaded at startup, newly created in-production FAs are excluded until a manual server reconfiguration and restart occurs.

Thus, any transaction involving unregistered FAs is silently excluded in Rosetta’s transaction output—breaking the external consistency guarantee central to Rosetta and enabling incorrect downstream accounting.

## Impact Explanation
This qualifies as **Medium Severity** per Aptos’s bug bounty program: "State inconsistencies requiring intervention." Specifically:
- **Incorrect Balance Tracking:** Wallets and exchanges relying on Rosetta display stale or wrong balances for new FAs.
- **Silent Data Loss:** Transactions are dropped from view with no indication or error, complicating detection and reconciliation.
- **Manual Mitigation:** The only remediation for affected currencies is out-of-band server maintenance, adding operational risk and downtime.

On-chain consensus and internal Aptos state remain correct, but externally-facing data invariants crucial for financial and compliance infrastructure are violated, requiring explicit operator intervention.

## Likelihood Explanation
**Likelihood: High**

This issue can and will occur any time:
- A new fungible asset is deployed on-chain;
- The Rosetta API’s currency set is not updated and server not restarted;
- Subsequent transfers involving the FA occur.

Given how frequently new FAs are launched, high-frequency users and external integrators will experience this problem regularly unless they manually synchronize Rosetta’s configuration. No malicious activity is required—this occurs under normal and expected use.

## Recommendation
- Implement dynamic currency discovery, or at a minimum, return an explicit error (not an empty operation set) if a fungible asset is not recognized. This prevents silent data loss and alerts operators to the root cause.
- Consider auto-refreshing the currency registry from on-chain asset registry resources at regular intervals.

## Proof of Concept
**Scenario-based demonstration:**
1. Deploy and mint a new FA not present in Rosetta’s static config.
2. Execute a cross-account transfer.
3. Query the transaction via Rosetta API; note the absence of any deposit/withdraw operation for the FA, with no errors returned.
4. Update Rosetta config for the FA. Restart server; system now reports operations, but all prior history is lost unless explicitly reindexed.

---

**Citations Supporting the Report:** [1](#0-0) [2](#0-1) [3](#0-2) [4](#0-3) [5](#0-4)   

---

## Notes
- The issue does not affect consensus, validator safety, or fund custody, but does result in *state desynchronization* between Rosetta-using applications and Aptos chain state.
- Impact is limited to off-chain system correctness, but the silent nature significantly raises operational, accounting, and reconciliation risk.
- This is not a DoS or consensus-critical bug, but is fully in-scope as a Medium severity state inconsistency.

### Citations

**File:** api/rosetta-api/src/data_parser/withdrawal.rs (L121-184)
```rust

```

**File:** api/rosetta-api/src/data_parser/withdrawal.rs (L201-236)
```rust

```

**File:** api/rosetta-api/src/data_parser/mod.rs (L218-249)
```rust

```

**File:** api/rosetta-api/src/currency.rs (L46-78)
```rust

```

**File:** api/rosetta-api/src/currency.rs (L79-138)
```rust

```
