Audit Report

## Title
Trust Anchor Bypass: Waypoint Verification Skipped When Storage Already Synced

## Summary
Aptos Core state sync bootstrapper’s waypoint verification implementation allows the configured trust anchor (waypoint) to be marked as "verified" without cryptographically validating its hash if the node’s database already contains a ledger info at or beyond the configured waypoint version. This creates a trust-anchoring bypass and allows a maliciously-crafted database snapshot to be adopted as the root of trust by new node operators.

## Finding Description
Waypoints provide a cryptographic trust anchor for node bootstrapping in Aptos. For a node to be sure it is on the correct canonical chain, checkpoint ledger infos must match the hash and version in the operator-configured waypoint, which is a signed guarantee of chain state at a given version.

In standard syncing, the protocol ensures waypoint validation by verifying both signatures and matching the hash of the ledger info at the waypoint version to the configured value.

In the function responsible for checking waypoint satisfiability, `verify_waypoint_is_satisfiable()`, if the latest committed ledger info’s version is at least as great as the waypoint version, the code marks the waypoint as verified by calling `set_verified_waypoint()` **without calling** the cryptographic `waypoint.verify()` method that checks the hash. This bypass means the node never actually validates the cryptographic witness specified by the operator’s waypoint value.

**Execution Path:**
- On node start, if a local database exists, state sync reads the latest ledger info.
- If the version of the latest ledger info is >= the waypoint version, the node marks the waypoint as "satisfied" and verified, regardless of whether the database (ledger info’s hash) matches the true waypoint.
- This occurs in code where only a version check is performed.

**Exploitation:**
- An attacker can create a snapshot on a malicious chain fork, bring it to a version greater than or equal to an official waypoint, then publish/distribute the snapshot.
- A validator operator uses the snapshot and configures the official trusted waypoint version+hash from Aptos documentation.
- On node start, Aptos skips the cryptographic verification of the waypoint. The validator, believing itself anchored to the official chain, is actually following the attacker's fork.

This allows the complete defeat of the intended trust anchor concept in scenarios where a validator is started from a database restored from a snapshot whose chain fork is unknown.

## Impact Explanation
This is a **High Severity** vulnerability, potentially **Critical** if exploited at scale:

- **Bypasses the Core Security Property of Waypoints**: Nodes can start from an untrusted, unchecked database that does not correspond to the operator’s configured trust anchor. 
- **Undermines State Consistency**: Different nodes, running on malicious forks, can believe themselves to be correctly anchored and participate in network activity, risking chain splits or partitions.
- **Consensus Safety Violation Risk**: If multiple validators are tricked into using different malicious snapshots, the network may diverge, requiring manual recovery or hardfork.

Per Aptos’s defined bounty scope, this is a valid protocol violation, with loss of state consistency and consensus safety possible.

## Likelihood Explanation
**Medium-High likelihood** due to:
- Increasing adoption of database snapshots in web3 ecosystems for speed and convenience.
- Realistic threat model where attackers compromise snapshot services or convince node operators to use unvetted sources.
- No additional defense against the hash-mismatch scenario beyond the skipped verification; exploitation requires only distribution of a prepared DB file.

Attack **does not depend** on trusted role compromise, on >1/3 voting power, or on network-level attacks. While it does require social engineering or a supply chain compromise for snapshot distribution, this is a recognized threat vector (hence why cryptographic verification should be enforced).

Subsequent network syncing may fail due to validator signature mismatch, but by that stage the node has already loaded a malicious initial validator set and history.

## Recommendation
Enforce mandatory cryptographic verification of the ledger info hash against the configured waypoint value, even if the database is ahead of the configured waypoint version.

**Fix Example:**  
In `verify_waypoint_is_satisfiable()`, require a hash and signature match with the ledger info at waypoint version, regardless of database state. Abort node startup if this cannot be proven.

## Proof of Concept
1. Create a forked Aptos network.
2. Drive the fork’s database to a block height ≥ official chain’s published waypoint.
3. Export the database state.
4. On a fresh node, restore from the malicious snapshot, providing the official waypoint version/hash in configuration.
5. The node will mark the waypoint as verified without checking the hash against the ledger info in the database.

This sequence is enabled in code at: [1](#0-0) [2](#0-1) 

## Notes
- Verified in core protocol (consensus, storage, and sync) component – all within scope.
- Does not depend on social engineering for exploitation per se—the cryptographic bypass is the defect, not how snapshots are distributed.
- This is a logic bug in state sync/consensus bootstrap, not an external or user interface weakness.
- The bypass can result in nodes unilaterally anchoring to malicious forks without detection, meeting "protocol violation" and "possible consensus split" criteria for severity.
- No evidence this is an already-resolved/known issue in current repo context.
- Fix must include strict matching of both the version and hash of the configured waypoint to ledger info in local storage, regardless of ahead-lagging state.

If the above pathway is remediated and the cryptographic check enforced, such a class of attacks would be impossible.

### Citations

**File:** crates/aptos-state-sync-driver/src/bootstrapper.rs (L870-892)
```rust

```
