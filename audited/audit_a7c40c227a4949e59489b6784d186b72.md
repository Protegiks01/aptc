# Audit Report

## Title
P2P Network Services Exposed to Network Interfaces in Workspace Server Creating Remote Attack Surface for Dependency Vulnerabilities

## Summary
The aptos-workspace-server binds P2P network services to all network interfaces (0.0.0.0) instead of localhost only (127.0.0.1), enabling remote exploitation of potential vulnerabilities in network handling dependencies by attackers on the same network.

## Finding Description
The `aptos-workspace-server` is a local development tool designed to run an Aptos test network on a developer's machine. However, the `zero_all_ports` function in `node.rs` configures P2P network services to listen on all network interfaces rather than localhost only. [1](#0-0) 

While API and indexer services are correctly bound to localhost: [2](#0-1) 

The validator and fullnode P2P networks remain exposed to all interfaces. Fullnode networks use `mutual_authentication = false` by default for non-validator network IDs: [3](#0-2) 

This means unauthenticated peers on the same network can connect to the P2P services. If vulnerabilities exist in network handling dependencies (`aptos-network`, `aptos-types`, protocol message deserialization, etc.), they become remotely exploitable rather than requiring local access.

**Attack Path:**
1. Developer runs workspace-server on shared network (coffee shop, corporate network, university campus)
2. OS assigns random ports to P2P services, but binds to 0.0.0.0
3. Attacker scans network and discovers open Aptos node ports
4. Attacker connects to fullnode network (no authentication required)
5. Attacker sends malicious P2P protocol messages
6. Vulnerabilities in network protocol handling code are exploited remotely

## Impact Explanation
This is a **Medium severity** issue per the bug bounty criteria. While it doesn't directly cause funds loss or consensus violations, it transforms a local development tool into a remotely exploitable service, significantly expanding the attack surface for any vulnerabilities in network handling dependencies.

The impact depends on the existence of exploitable bugs in dependencies, but the unnecessary network exposure violates the principle of least privilege and defense-in-depth security practices for a tool explicitly designed for local development.

## Likelihood Explanation
**Likelihood: Medium**

Developers frequently work on shared networks (coffee shops, coworking spaces, corporate networks, university campuses). An attacker on the same network can:
- Easily discover the services through port scanning
- Connect without authentication to fullnode networks
- Send crafted P2P protocol messages

The exploitation requires that vulnerabilities exist in the network handling code, but the exposure is unnecessary and preventable.

## Recommendation
Bind P2P network services to localhost (127.0.0.1) instead of all interfaces (0.0.0.0) for the workspace-server, consistent with how API and indexer services are configured.

**Fix:** Modify the `zero_all_ports` function to use `127.0.0.1` instead of `0.0.0.0`: [4](#0-3) 

Replace `"0.0.0.0"` with `"127.0.0.1"` in the Protocol::Ip4 constructors on lines 27 and 34.

## Proof of Concept
1. Start the workspace-server on a shared network
2. From another machine on the same network, run: `nmap -p 1-65535 <target-ip>`
3. Identify open ports assigned to the Aptos node
4. Use `netcat` or custom client to connect to the fullnode network port
5. Observe successful connection to P2P network from remote machine

This demonstrates the remote accessibility of services intended for local development only.

## Notes
While this finding identifies a security concern in the workspace-server's network configuration, it's important to note that:
1. The workspace-server is explicitly a development tool, not production software
2. The actual exploitability depends on the existence of vulnerabilities in network handling dependencies
3. The issue violates defense-in-depth principles by exposing unnecessary remote attack surface
4. Production Aptos nodes are expected to have proper network configuration and authentication

The recommendation to bind to localhost eliminates this attack surface for a tool designed for local development.

### Citations

**File:** aptos-move/aptos-workspace-server/src/services/node.rs (L16-39)
```rust
fn zero_all_ports(config: &mut NodeConfig) {
    // TODO: Double check if all ports are covered.

    config.admin_service.port = 0;
    config.api.address.set_port(0);
    config.inspection_service.port = 0;
    config.storage.backup_service_address.set_port(0);
    config.indexer_grpc.address.set_port(0);

    if let Some(network) = config.validator_network.as_mut() {
        network.listen_address = NetworkAddress::from_protocols(vec![
            Protocol::Ip4("0.0.0.0".parse().unwrap()),
            Protocol::Tcp(0),
        ])
        .unwrap();
    }
    for network in config.full_node_networks.iter_mut() {
        network.listen_address = NetworkAddress::from_protocols(vec![
            Protocol::Ip4("0.0.0.0".parse().unwrap()),
            Protocol::Tcp(0),
        ])
        .unwrap();
    }
}
```

**File:** aptos-move/aptos-workspace-server/src/services/node.rs (L80-84)
```rust
    node_config.api.address.set_ip(IP_LOCAL_HOST);
    node_config.indexer_grpc.address.set_ip(IP_LOCAL_HOST);

    node_config.admin_service.address = IP_LOCAL_HOST.to_string();
    node_config.inspection_service.address = IP_LOCAL_HOST.to_string();
```

**File:** config/src/config/network_config.rs (L135-142)
```rust
    pub fn network_with_id(network_id: NetworkId) -> NetworkConfig {
        let mutual_authentication = network_id.is_validator_network();
        let mut config = Self {
            discovery_method: DiscoveryMethod::None,
            discovery_methods: Vec::new(),
            identity: Identity::None,
            listen_address: "/ip4/0.0.0.0/tcp/6180".parse().unwrap(),
            mutual_authentication,
```
