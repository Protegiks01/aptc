# Audit Report

## Title
IPFS Authentication Token Leakage Through Application Logging

## Summary
The NFT metadata crawler logs complete IPFS URIs including the Pinata gateway authentication token (`pinataGatewayToken`) in plain text. This exposes sensitive credentials to anyone with access to application logs, monitoring dashboards, or log aggregation systems, enabling unauthorized IPFS access and potential cost abuse.

## Finding Description

The vulnerability exists in the URI handling flow of the NFT metadata crawler component. When processing NFT metadata, the system constructs IPFS URIs with authentication tokens appended as query parameters, then logs these complete URIs.

**Flow:**

1. The `URIParser::parse` function constructs URIs with the authentication token appended: [1](#0-0) 

2. These parsed URIs (containing `?pinataGatewayToken=<secret>`) are passed to downstream functions for processing.

3. `JSONParser::parse` logs the complete URI including the token: [2](#0-1) 

4. `ImageOptimizer::optimize` also logs the complete URI with the token: [3](#0-2) 

The authentication token constant is defined here: [4](#0-3) 

These logs are emitted during normal operation for every JSON file and image processed, creating numerous opportunities for token extraction. The logs are typically exported to centralized logging systems (Google Cloud Logging, Elasticsearch, Splunk, etc.) where they may be accessible to:
- System administrators
- Cloud platform users with log viewer permissions
- DevOps personnel with monitoring dashboard access
- Attackers who compromise logging infrastructure
- Anyone with access to log exports or backups

## Impact Explanation

This vulnerability qualifies as **Medium severity** according to the Aptos bug bounty criteria, falling under credential exposure with potential for limited financial impact:

1. **Unauthorized IPFS Access**: Attackers can use the stolen token to access IPFS content through the Pinata gateway, potentially including private or gated content.

2. **Cost Abuse**: The compromised token can be used to generate requests against the victim's Pinata account, incurring unexpected costs and potentially exhausting account quotas.

3. **Rate Limit Exhaustion**: Malicious actors can abuse the token to exhaust rate limits, causing denial of service for legitimate NFT metadata operations.

4. **Service Disruption**: If token abuse is detected, the credentials may be revoked, disrupting the NFT metadata crawler service.

While this does not directly impact consensus, state management, or validator operations, it represents a significant operational security vulnerability that can lead to financial loss and service disruption.

## Likelihood Explanation

The likelihood of this vulnerability being exploited is **HIGH**:

1. **Automatic Exposure**: The vulnerability triggers automatically during normal operation—no special conditions or edge cases are required. Every processed JSON file and image results in token exposure.

2. **Wide Access Surface**: Application logs are typically accessible to many individuals and systems within an organization, significantly increasing the attack surface compared to validator-only access.

3. **Common Attack Vector**: Log access is a well-known attack vector. Attackers frequently target logging systems, and insider threats with log access are realistic concerns.

4. **Persistent Exposure**: Once logged, tokens may persist in log archives, backups, and aggregation systems for extended periods, providing multiple opportunities for extraction.

5. **Easy Exploitation**: No sophisticated techniques are required—a simple grep or log query can extract the tokens.

## Recommendation

**Immediate Fix**: Remove logging of complete URIs that contain authentication credentials. Instead, log only non-sensitive portions of the URI or use redacted versions.

**For `json_parser.rs`**, replace: [2](#0-1) 

With a redacted version that removes query parameters:
```rust
let uri_without_query = uri.split('?').next().unwrap_or(&uri);
info!(asset_uri = uri_without_query, "Sending request for asset_uri");
```

**For `image_optimizer.rs`**, replace: [3](#0-2) 

With:
```rust
let uri_without_query = uri.split('?').next().unwrap_or(uri);
info!(image_uri = uri_without_query, "Sending request for image");
```

**Additional Recommendations**:
1. Audit all logging statements to ensure no other credential leakage exists
2. Implement log scrubbing/sanitization for sensitive data before export to centralized systems
3. Review access controls for logging systems and minimize permissions
4. Consider using secret management systems to rotate tokens regularly
5. Monitor logs for unusual access patterns that might indicate token compromise

## Proof of Concept

**Steps to Reproduce**:

1. Configure the NFT metadata crawler with a Pinata gateway token
2. Process any NFT with IPFS metadata URIs
3. Check the application logs (stdout, log files, or cloud logging service)
4. Search for log entries containing "Sending request for asset_uri" or "Sending request for image"
5. Observe that the logged URIs contain the complete authentication token in the query string

**Expected Log Output**:
```
INFO ... asset_uri="https://gateway.pinata.cloud/ipfs/Qm...?pinataGatewayToken=SECRET_TOKEN_HERE" "Sending request for asset_uri"
INFO ... image_uri="https://gateway.pinata.cloud/ipfs/Qm...?pinataGatewayToken=SECRET_TOKEN_HERE" "Sending request for image"
```

**Exploitation**:
```bash
# Extract token from logs
grep "pinataGatewayToken" application.log | grep -oP 'pinataGatewayToken=\K[^&\s"]+'

# Use extracted token for unauthorized access
curl "https://gateway.pinata.cloud/ipfs/QmExampleCID?pinataGatewayToken=EXTRACTED_TOKEN"
```

---

## Notes

This vulnerability is specific to the NFT metadata crawler ecosystem component and does not directly affect core blockchain consensus, execution, or state management. However, it represents a valid operational security issue within the Aptos Core repository that can lead to credential compromise, unauthorized access, and financial impact through cost abuse. The security question explicitly identified this as a Medium severity concern, and the finding confirms that authentication tokens are indeed exposed through logging mechanisms.

### Citations

**File:** ecosystem/nft-metadata-crawler/src/utils/uri_parser.rs (L33-34)
```rust
        let ipfs_auth_param = if ipfs_auth_key.is_some() {
            Some(format!("?{}={}", IPFS_AUTH_KEY, ipfs_auth_key.unwrap()))
```

**File:** ecosystem/nft-metadata-crawler/src/utils/json_parser.rs (L53-53)
```rust
                info!(asset_uri = uri, "Sending request for asset_uri");
```

**File:** ecosystem/nft-metadata-crawler/src/utils/image_optimizer.rs (L54-54)
```rust
                info!(image_uri = uri, "Sending request for image");
```

**File:** ecosystem/nft-metadata-crawler/src/utils/constants.rs (L31-32)
```rust
/// Default IPFS gateway auth param key
pub const IPFS_AUTH_KEY: &str = "pinataGatewayToken";
```
