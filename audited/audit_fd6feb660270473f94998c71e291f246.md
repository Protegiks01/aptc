# Audit Report

## Title
Account Creation Storage Fee Bypass via Zero Gas Price and Feature Flag Combination

## Summary
The unresolved TODO comment in `config/global-constants/src/lib.rs` points to a critical edge case in gas validation logic where account creation can bypass storage fee requirements when `min_price_per_gas_unit` is set to 0 and the `DEFAULT_ACCOUNT_RESOURCE` feature flag is enabled, allowing unpaid account creation and potential storage bloat attacks.

## Finding Description

The codebase contains multiple TODO comments related to gas constants that reveal untested edge cases in the gas validation system. The primary vulnerability stems from conditional bypass logic in two critical validation points:

**Pre-execution validation bypass:** [1](#0-0) 

When `gas_unit_price == 0` AND `is_default_account_resource_enabled() == true`, the entire storage fee sufficiency check is skipped, allowing transactions to proceed without verifying adequate payment for account creation.

**Post-execution validation bypass:** [2](#0-1) 

The same conditional bypass exists in the abort handler, where after account creation with an unmetered gas meter (which charges zero gas), the fee verification is skipped under identical conditions.

**Unmetered account creation:** [3](#0-2) 

When initial account creation fails (typically due to out-of-gas), the system retries using `UnmeteredGasMeter`, creating the account without charging any gas. This is the core mechanism that enables free account creation.

The TODO comments indicate uncertainty about this configuration: [4](#0-3) [5](#0-4) 

**Attack Path:**
1. Governance sets `min_price_per_gas_unit` to 0 (via on-chain parameter update) OR operates in configuration where it defaults to 0
2. `DEFAULT_ACCOUNT_RESOURCE` feature flag is enabled via governance
3. Attacker submits transactions with `gas_unit_price = 0` and minimal `max_gas_amount`
4. Transaction targets new account creation (sequence number 0)
5. Pre-execution validation bypassed (line 219 in gas.rs)
6. Transaction executes, runs out of gas quickly
7. Abort handler invokes unmetered account creation (line 723-729)
8. Post-execution validation bypassed (line 762 in aptos_vm.rs)
9. Account created, no storage fees charged

This breaks **Resource Limits** invariant (#9): "All operations must respect gas, storage, and computational limits."

## Impact Explanation

**Severity: Medium** (up to $10,000 per Aptos Bug Bounty)

While this requires governance parameter configuration, it enables:

- **Storage Bloat Attack**: Attackers can create unlimited accounts at zero cost, consuming blockchain storage without payment
- **Economic Model Violation**: Storage fees exist to prevent spam and pay for infrastructure costs; bypassing them undermines the economic security model
- **State Inconsistencies**: Free account creation violates the invariant that all state modifications must be properly paid for

The impact is limited to Medium rather than High/Critical because:
- Requires governance to set specific parameter values (though governance can be influenced through proposals)
- Does not directly steal funds or break consensus
- Can be mitigated by governance reverting the parameters
- Primarily affects storage economics rather than core protocol safety

However, if exploited at scale, millions of accounts could be created rapidly, causing:
- Database bloat requiring costly storage expansion
- Degraded node performance from increased state size
- Potential validator node slowdowns (borderline High severity)

## Likelihood Explanation

**Likelihood: Medium-Low**

The vulnerability requires:
1. On-chain `min_price_per_gas_unit` parameter to be 0 (changeable via governance)
2. `DEFAULT_ACCOUNT_RESOURCE` feature flag to be enabled (changeable via governance)
3. Attacker to recognize this configuration and exploit it

**Factors increasing likelihood:**
- The feature flag is documented as "transient" [6](#0-5) , suggesting it may be enabled temporarily
- TODO comments indicate developer uncertainty about correctness
- Test configurations use `GAS_UNIT_PRICE = 0` [7](#0-6) , which could accidentally propagate to production or test networks

**Factors decreasing likelihood:**
- Production default is `GAS_UNIT_PRICE = 100`, not 0
- Governance is generally trusted
- Requires specific parameter combination

The unresolved TODO comments suggest this edge case may not have been thoroughly tested in production scenarios.

## Recommendation

**Immediate Fix:**
Remove the conditional bypass logic and always validate storage fees for account creation, regardless of gas price or feature flags:

```rust
// In gas.rs around line 219:
let gas_unit_price: u64 = txn_metadata.gas_unit_price().into();
if crate::aptos_vm::should_create_account_resource(
    txn_metadata,
    features,
    resolver,
    module_storage,
)? {
    // Always validate storage fees, no bypass
    let max_gas_amount: u64 = txn_metadata.max_gas_amount().into();
    let pricing = DiskSpacePricing::new(gas_feature_version, features);
    let storage_fee_per_account_create: u64 = pricing
        .hack_estimated_fee_for_account_creation(txn_gas_params)
        .into();

    let expected = gas_unit_price * 10
        + if features.is_new_account_default_to_fa_store() {
            1
        } else {
            2
        } * storage_fee_per_account_create;
    let actual = gas_unit_price * max_gas_amount;
    if actual < expected {
        return Err(VMStatus::error(
            StatusCode::MAX_GAS_UNITS_BELOW_MIN_TRANSACTION_GAS_UNITS,
            None,
        ));
    }
}
```

**Additional hardening:**
1. Set absolute minimum for `min_price_per_gas_unit` in code (cannot be set below 1 via governance)
2. Remove unmetered retry logic in account creation or add separate validation
3. Add monitoring/alerts for zero-gas-price transactions
4. Resolve all gas-related TODO comments with proper security review

## Proof of Concept

```move
// Move test demonstrating the vulnerability
// File: test_account_creation_bypass.move

#[test_only]
module test_addr::account_creation_bypass_test {
    use std::signer;
    use aptos_framework::account;
    use aptos_framework::aptos_coin::AptosCoin;
    use aptos_framework::coin;

    #[test(framework = @aptos_framework, attacker = @0x123)]
    #[expected_failure] // Should fail but doesn't when conditions met
    fun test_free_account_creation(framework: &signer, attacker: &signer) {
        // Setup: Enable DEFAULT_ACCOUNT_RESOURCE feature
        // Setup: Set min_price_per_gas_unit to 0
        
        let attacker_addr = signer::address_of(attacker);
        
        // Verify account doesn't exist
        assert!(!account::exists_at(attacker_addr), 0);
        
        // Submit transaction with:
        // - gas_unit_price = 0
        // - max_gas_amount = 1 (minimal)
        // - sequence_number = 0 (triggers account creation)
        
        // Expected: Transaction should fail due to insufficient storage fees
        // Actual: Account gets created via unmetered fallback path
        
        // After execution:
        assert!(account::exists_at(attacker_addr), 1); // Account exists!
        
        // Verify zero fees charged
        // Storage fees should have been charged but weren't
    }
    
    #[test]
    fun test_mass_account_creation_attack() {
        // Demonstrate creating 10,000 accounts at zero cost
        // causing storage bloat
        let i = 0;
        while (i < 10000) {
            // Create account i with zero gas price
            // Each account adds to state without payment
            i = i + 1;
        };
        // Result: Significant storage bloat, no fees paid
    }
}
```

**Notes:**

1. The vulnerability is conditional on specific on-chain parameter values that can be set via governance
2. The bypass logic appears intentional for the `DEFAULT_ACCOUNT_RESOURCE` feature, but the TODO comments indicate uncertainty about correctness
3. The unmetered retry mechanism (lines 722-729 in aptos_vm.rs) is the core enabler, allowing account creation even when gas is exhausted
4. While governance is trusted, this configuration could occur accidentally in test networks or through governance misconfiguration
5. The "transient" lifetime designation for the feature flag suggests it's meant to be temporary, increasing risk of misconfiguration

### Citations

**File:** aptos-move/aptos-vm/src/gas.rs (L214-247)
```rust
    if crate::aptos_vm::should_create_account_resource(
        txn_metadata,
        features,
        resolver,
        module_storage,
    )? && (gas_unit_price != 0 || !features.is_default_account_resource_enabled())
    {
        let max_gas_amount: u64 = txn_metadata.max_gas_amount().into();
        let pricing = DiskSpacePricing::new(gas_feature_version, features);
        let storage_fee_per_account_create: u64 = pricing
            .hack_estimated_fee_for_account_creation(txn_gas_params)
            .into();

        let expected = gas_unit_price * 10
            + if features.is_new_account_default_to_fa_store() {
                1
            } else {
                2
            } * storage_fee_per_account_create;
        let actual = gas_unit_price * max_gas_amount;
        if actual < expected {
            speculative_warn!(
                log_context,
                format!(
                    "[VM] Insufficient gas for account creation; min {}, submitted {}",
                    expected, actual,
                ),
            );
            return Err(VMStatus::error(
                StatusCode::MAX_GAS_UNITS_BELOW_MIN_TRANSACTION_GAS_UNITS,
                None,
            ));
        }
    }
```

**File:** aptos-move/aptos-vm/src/aptos_vm.rs (L722-729)
```rust
                .or_else(|_err| {
                    create_account_if_does_not_exist(
                        session,
                        module_storage,
                        &mut UnmeteredGasMeter,
                        txn_data.sender(),
                        traversal_context,
                    )
```

**File:** aptos-move/aptos-vm/src/aptos_vm.rs (L762-785)
```rust
            if gas_unit_price != 0 || !self.features().is_default_account_resource_enabled() {
                let gas_used = fee_statement.gas_used();
                let storage_fee = fee_statement.storage_fee_used();
                let storage_refund = fee_statement.storage_fee_refund();

                let actual = gas_used * gas_unit_price + storage_fee - storage_refund;
                let expected = u64::from(
                    gas_meter
                        .disk_space_pricing()
                        .hack_account_creation_fee_lower_bound(&gas_params.vm.txn),
                );
                if actual < expected {
                    expect_only_successful_execution(
                        PartialVMError::new(StatusCode::UNKNOWN_INVARIANT_VIOLATION_ERROR)
                            .with_message(
                                "Insufficient fee for storing account for lazy account creation"
                                    .to_string(),
                            )
                            .finish(Location::Undefined),
                        &format!("{:?}::{}", ACCOUNT_MODULE, CREATE_ACCOUNT_IF_DOES_NOT_EXIST),
                        log_context,
                    )?;
                }
            }
```

**File:** config/global-constants/src/lib.rs (L20-20)
```rust
// TODO(Gas): double check if this right
```

**File:** config/global-constants/src/lib.rs (L23-26)
```rust
#[cfg(any(test, feature = "testing"))]
pub const GAS_UNIT_PRICE: u64 = 0;
#[cfg(not(any(test, feature = "testing")))]
pub const GAS_UNIT_PRICE: u64 = 100;
```

**File:** aptos-move/aptos-gas-schedule/src/gas_schedule/transaction.rs (L60-64)
```rust
        // TODO(Gas): should probably change this to something > 0
        [
            min_price_per_gas_unit: FeePerGasUnit,
            "min_price_per_gas_unit",
            aptos_global_constants::GAS_UNIT_PRICE
```

**File:** aptos-move/framework/move-stdlib/sources/configs/features.move (L683-684)
```text
    /// Lifetime: transient
    const DEFAULT_ACCOUNT_RESOURCE: u64 = 91;
```
