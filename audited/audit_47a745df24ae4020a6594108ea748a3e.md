# Audit Report

## Title
Path Traversal Vulnerability in AptosDB Debugger Tool - Insufficient Directory Path Validation

## Summary
The `DbDir` struct used across multiple db_debugger commands lacks any validation for path traversal sequences or sensitive system directories, allowing arbitrary file system access when operators run debugging commands.

## Finding Description

The `DbDir` struct accepts a `PathBuf` from command-line arguments without any validation for path traversal or sensitive directory access. [1](#0-0) 

This unvalidated path is then used in multiple dangerous operations:

1. **Database Opening (Read-Write Mode)**: The path is passed to `open_state_merkle_db()` which opens RocksDB databases in read-write mode with `create_if_missing` enabled. [2](#0-1) 

2. **RocksDB Auto-Creation**: When readonly is false, RocksDB is configured to create directories and files automatically. [3](#0-2) 

3. **Checkpoint Directory Creation**: The checkpoint command creates output directories recursively using `fs::create_dir_all()`. [4](#0-3) 

4. **Truncate Backup Creation**: The truncate command similarly creates backup directories without validation. [5](#0-4) 

**Attack Scenarios**:
- Operator runs: `aptos-db-tool debug checkpoint --db-dir /valid/db --output-dir ../../etc/malicious`
- System creates directories in `/etc/malicious` and all parent directories
- RocksDB files (LOCK, MANIFEST, SST) are created in arbitrary locations
- Existing files could be corrupted or overwritten

## Impact Explanation

**Severity: Medium** (as indicated in the security question)

However, upon strict validation against bug bounty criteria, this issue has **limited exploitability**:

1. **Requires Operator Access**: This is a command-line debugging tool accessible only to validator operators (trusted role)
2. **Local Execution Only**: Cannot be exploited remotely
3. **No Direct Blockchain Impact**: Does not affect consensus, state consistency, or funds
4. **Permission Constraints**: Impact limited by file system permissions of the executing user

The vulnerability could manifest in:
- **Scripting Errors**: Automated maintenance scripts with incorrect path variables
- **Configuration Mistakes**: Operators accidentally providing wrong paths
- **Accidental Damage**: Creating files in unintended locations

This does NOT meet the criteria for:
- Exploitable by unprivileged attacker (requires operator access)
- Breaking blockchain invariants (consensus, state, governance)
- Clear security harm per bounty categories

## Likelihood Explanation

**Low likelihood** of malicious exploitation:
- Requires trusted operator to make a mistake or be compromised
- Cannot be exploited without local system access
- Protected by file system permissions
- Would be detected quickly through system monitoring

**Higher likelihood** of accidental misuse:
- Operators may accidentally use wrong paths in scripts
- No safeguards against common mistakes like `../` sequences

## Recommendation

Add path validation in the `DbDir` implementation:

```rust
impl DbDir {
    fn validate_path(&self) -> Result<()> {
        // Canonicalize to resolve symlinks and relative paths
        let canonical = self.db_dir.canonicalize()
            .map_err(|e| AptosDbError::Other(format!("Invalid path: {}", e)))?;
        
        // Check for sensitive directories
        let sensitive_paths = ["/etc", "/var", "/usr", "/boot", "/sys", "/proc"];
        for sensitive in &sensitive_paths {
            if canonical.starts_with(sensitive) {
                return Err(AptosDbError::Other(
                    format!("Cannot use sensitive system directory: {:?}", canonical)
                ));
            }
        }
        
        // Ensure path doesn't escape intended directory
        if canonical.components().any(|c| c == std::path::Component::ParentDir) {
            return Err(AptosDbError::Other("Path traversal detected".to_string()));
        }
        
        Ok(())
    }
}
```

Call `validate_path()` before using the directory in any operations.

## Proof of Concept

```bash
# Demonstrate path traversal (requires operator access)
# Create a test database
mkdir -p /tmp/test_db

# Attempt path traversal in checkpoint command
aptos-db-tool debug checkpoint \
    --db-dir /tmp/test_db \
    --output-dir ../../tmp/traversal_test

# Observe that /tmp/traversal_test is created
# demonstrating successful path traversal

# Clean up
rm -rf /tmp/traversal_test /tmp/test_db
```

---

**Notes**: While this finding identifies a genuine lack of input validation, it **does not meet the strict criteria for a valid bug bounty submission** because:
1. It requires operator/trusted role access (not exploitable by unprivileged attackers)
2. Exploitation requires insider threat or social engineering (both excluded from scope)
3. No impact on blockchain invariants, consensus, or funds
4. Classified as defensive programming issue rather than critical security vulnerability

The code should still be fixed as a best practice, but this would not qualify for the Aptos bug bounty program under the strict validation criteria provided.

### Citations

**File:** storage/aptosdb/src/db_debugger/common/mod.rs (L17-25)
```rust
#[derive(Parser, Clone)]
pub struct DbDir {
    // TODO(grao): Support path override here.
    #[clap(long, value_parser)]
    db_dir: PathBuf,

    #[clap(flatten)]
    pub sharding_config: ShardingConfig,
}
```

**File:** storage/aptosdb/src/db_debugger/common/mod.rs (L28-44)
```rust
    pub fn open_state_merkle_db(&self) -> Result<StateMerkleDb> {
        let env = None;
        let block_cache = None;
        StateMerkleDb::new(
            &StorageDirPaths::from_path(&self.db_dir),
            RocksdbConfigs {
                enable_storage_sharding: self.sharding_config.enable_storage_sharding,
                ..Default::default()
            },
            env,
            block_cache,
            /* read_only = */ false,
            /* max_nodes_per_lru_cache_shard = */ 0,
            /* is_hot = */ false,
            /* delete_on_restart = */ false,
        )
    }
```

**File:** storage/rocksdb-options/src/lib.rs (L38-41)
```rust
    if !readonly {
        db_opts.create_if_missing(true);
        db_opts.create_missing_column_families(true);
    }
```

**File:** storage/aptosdb/src/db_debugger/checkpoint/mod.rs (L19-29)
```rust
impl Cmd {
    pub fn run(self) -> Result<()> {
        ensure!(!self.output_dir.exists(), "Output dir already exists.");
        fs::create_dir_all(&self.output_dir)?;
        let sharding_config = self.db_dir.sharding_config.clone();
        AptosDB::create_checkpoint(
            self.db_dir,
            self.output_dir,
            sharding_config.enable_storage_sharding,
        )
    }
```

**File:** storage/aptosdb/src/db_debugger/truncate/mod.rs (L49-62)
```rust
        if !self.opt_out_backup_checkpoint {
            let backup_checkpoint_dir = self.backup_checkpoint_dir.unwrap();
            ensure!(
                !backup_checkpoint_dir.exists(),
                "Backup dir already exists."
            );
            println!("Creating backup at: {:?}", &backup_checkpoint_dir);
            fs::create_dir_all(&backup_checkpoint_dir)?;
            AptosDB::create_checkpoint(
                &self.db_dir,
                backup_checkpoint_dir,
                self.sharding_config.enable_storage_sharding,
            )?;
            println!("Done!");
```
