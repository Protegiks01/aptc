# Audit Report

## Title
Unbounded Vector Growth in VestingAdminStore Causes View Function Gas Exhaustion and API Service Degradation

## Summary
The `vesting_contracts` view function in the Aptos vesting module can fail when an admin has created a large number of vesting contracts, causing the view function to exceed the 2,000,000 gas limit enforced by the API. This results in API query failures and service degradation for legitimate users attempting to retrieve vesting contract information.

## Finding Description
The vulnerability exists in the design of the `AdminStore` resource and its associated view function. When an admin creates a vesting contract via `create_vesting_contract()`, the contract address is appended to the `vesting_contracts` vector without any bounds checking: [1](#0-0) 

The vesting module defines no maximum limit on the number of vesting contracts per admin: [2](#0-1) 

Note that `MAXIMUM_SHAREHOLDERS` limits shareholders per contract, not contracts per admin.

The `vesting_contracts` view function retrieves this entire vector when queried: [3](#0-2) 

When executed via the API, view functions are subject to a gas limit: [4](#0-3) [5](#0-4) 

The gas consumption for loading the `AdminStore` resource includes:
- Per-item read cost: 300,000 gas units (base cost for `borrow_global`)
- Per-byte read cost: 300 gas units per byte [6](#0-5) 

Each `AccountAddress` is 32 bytes: [7](#0-6) 

**Gas Calculation:**
- Available gas: 2,000,000 units
- Base read cost: 300,000 units
- Remaining for bytes: 1,700,000 units
- Bytes affordable: 1,700,000 / 300 ≈ 5,666 bytes
- Addresses that fit: 5,666 / 32 ≈ 177 addresses

Accounting for struct overhead (nonce, event handle, vector length encoding), the practical limit is approximately **150-200 vesting contracts** before gas exhaustion occurs.

## Impact Explanation
This vulnerability qualifies as **Medium Severity** per the Aptos bug bounty criteria:
- **API Service Degradation**: Legitimate API queries fail when admins have created moderate numbers of vesting contracts
- **Tooling Breakage**: Wallets, explorers, and analytics tools cannot retrieve vesting contract lists
- **User Impact**: Admins cannot view their own vesting contracts through standard APIs
- **No Workaround**: Users cannot paginate or limit the query through the existing API

This falls under "State inconsistencies requiring intervention" and affects API availability, which are documented Medium severity impacts in the bug bounty program.

## Likelihood Explanation
**High Likelihood:**
- The attack requires no special privileges - any admin with sufficient APT can create vesting contracts
- Each vesting contract creation is a legitimate operation (requires locking real funds)
- An admin managing multiple vesting schedules (e.g., for employees, investors, partners) could easily reach 200+ contracts over time
- The issue manifests naturally through normal protocol usage without malicious intent
- The cost barrier is high but realistic for institutional users

## Recommendation
Implement one or both of the following mitigations:

**Option 1: Add Pagination to View Function**
```move
#[view]
public fun vesting_contracts_paginated(
    admin: address, 
    offset: u64, 
    limit: u64
): vector<address> acquires AdminStore {
    if (!exists<AdminStore>(admin)) {
        return vector::empty<address>()
    };
    
    let admin_store = borrow_global<AdminStore>(admin);
    let all_contracts = &admin_store.vesting_contracts;
    let total = vector::length(all_contracts);
    
    if (offset >= total) {
        return vector::empty<address>()
    };
    
    let end = min(offset + limit, total);
    let result = vector::empty<address>();
    let i = offset;
    
    while (i < end) {
        vector::push_back(&mut result, *vector::borrow(all_contracts, i));
        i = i + 1;
    };
    
    result
}
```

**Option 2: Enforce Maximum Contract Limit**
```move
const MAX_VESTING_CONTRACTS_PER_ADMIN: u64 = 100;

// In create_vesting_contract():
let admin_store = borrow_global_mut<AdminStore>(admin_address);
assert!(
    vector::length(&admin_store.vesting_contracts) < MAX_VESTING_CONTRACTS_PER_ADMIN,
    error::resource_exhausted(ETOO_MANY_VESTING_CONTRACTS)
);
vector::push_back(&mut admin_store.vesting_contracts, contract_address);
```

**Recommended Approach:** Implement both - pagination for querying and a reasonable upper bound (e.g., 500-1000 contracts) to prevent unbounded growth while maintaining flexibility.

## Proof of Concept
```move
#[test(aptos_framework = @0x1, admin = @0x123)]
public entry fun test_gas_exhaustion_with_many_contracts(
    aptos_framework: &signer,
    admin: &signer,
) acquires AdminStore, VestingContract {
    let admin_address = signer::address_of(admin);
    setup(aptos_framework, &vector[admin_address]);
    
    // Create 200 vesting contracts
    let i = 0;
    while (i < 200) {
        let shareholder = @0x1000 + i; // Unique shareholder addresses
        create_account(shareholder);
        
        setup_vesting_contract(
            admin,
            &vector[shareholder],
            &vector[GRANT_AMOUNT],
            admin_address,
            0
        );
        i = i + 1;
    };
    
    // Verify contracts were created
    let contracts = vesting_contracts(admin_address);
    assert!(vector::length(&contracts) == 200, 0);
    
    // When called via API with 2M gas limit, this would fail
    // Approximate gas cost: 300,000 + (200 * 32 * 300) = 2,220,000 gas
    // Exceeds the DEFAULT_MAX_VIEW_GAS of 2,000,000
}
```

To test via API (requires running node):
```bash
# Create 200+ vesting contracts as admin
# Then query via API:
curl -X POST https://fullnode.mainnet.aptoslabs.com/v1/view \
  -H "Content-Type: application/json" \
  -d '{
    "function": "0x1::vesting::vesting_contracts",
    "type_arguments": [],
    "arguments": ["0x123"]
  }'
# Expected: Gas exhaustion error after ~150-200 contracts
```

## Notes
This vulnerability demonstrates a common pattern in blockchain systems where unbounded data structures can cause resource exhaustion at the API layer even when the underlying Move code executes correctly. The issue is exacerbated by the separation between on-chain gas limits (which are much higher for transactions) and view function gas limits (capped at 2M for API performance).

The vulnerability affects service availability rather than consensus or fund security, placing it firmly in the Medium severity category. While not exploitable for financial gain, it represents a significant usability and availability issue for legitimate protocol users.

### Citations

**File:** aptos-move/framework/aptos-framework/sources/vesting.move (L97-98)
```text
    /// Maximum number of shareholders a vesting pool can support.
    const MAXIMUM_SHAREHOLDERS: u64 = 30;
```

**File:** aptos-move/framework/aptos-framework/sources/vesting.move (L410-418)
```text
    #[view]
    /// Return all the vesting contracts a given address is an admin of.
    public fun vesting_contracts(admin: address): vector<address> acquires AdminStore {
        if (!exists<AdminStore>(admin)) {
            vector::empty<address>()
        } else {
            borrow_global<AdminStore>(admin).vesting_contracts
        }
    }
```

**File:** aptos-move/framework/aptos-framework/sources/vesting.move (L603-606)
```text
        // Add the newly created vesting contract's address to the admin store.
        let contract_address = signer::address_of(&contract_signer);
        let admin_store = borrow_global_mut<AdminStore>(admin_address);
        vector::push_back(&mut admin_store.vesting_contracts, contract_address);
```

**File:** config/src/config/api_config.rs (L102-102)
```rust
const DEFAULT_MAX_VIEW_GAS: u64 = 2_000_000; // We keep this value the same as the max number of gas allowed for one single transaction defined in aptos-gas.
```

**File:** api/src/view_function.rs (L154-161)
```rust
    let output = AptosVM::execute_view_function(
        &state_view,
        view_function.module.clone(),
        view_function.function.clone(),
        view_function.ty_args.clone(),
        view_function.args.clone(),
        context.node_config.api.max_gas_view_function,
    );
```

**File:** aptos-move/framework/aptos-framework/sources/storage_gas.move (L420-427)
```text
        move_to(aptos_framework, StorageGas {
            per_item_read: 300 * k,
            per_item_create: 5 * m,
            per_item_write: 300 * k,
            per_byte_read: 300,
            per_byte_create: 5 * k,
            per_byte_write: 5 * k,
        });
```

**File:** third_party/move/move-core/types/src/account_address.rs (L23-24)
```rust
    /// The number of bytes in an address.
    pub const LENGTH: usize = 32;
```
