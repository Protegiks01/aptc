# Audit Report

## Title
Information Disclosure: GCS Service Account Key Path Leaked via Debug Trait in Indexer GRPC Components

## Summary
The `IndexerGrpcFileStoreConfig` enum and its `GcsFileStore` variant have automatically derived `Debug` trait implementations that expose the `gcs_file_store_service_account_key_path` field in logs and panic messages. This path is explicitly logged during normal operation and error conditions, creating an information disclosure vulnerability.

## Finding Description

The `IndexerGrpcFileStoreConfig` enum uses `#[derive(Debug)]` which automatically implements debug formatting for all its fields, including the sensitive `gcs_file_store_service_account_key_path` in the `GcsFileStore` variant. [1](#0-0) 

The `GcsFileStore` struct also derives `Debug` and contains the sensitive path field: [2](#0-1) 

This configuration is explicitly logged in multiple locations:

1. **Panic Message with Debug Output**: When file store uploader creation fails, the entire config (including the service account key path) is included in the panic message: [3](#0-2) 

2. **Info-Level Logging**: The config is logged at info level during successful initialization: [4](#0-3) 

3. **Debug Struct Implementation**: The `RawDataServerWrapper` custom Debug implementation also includes the file store config: [5](#0-4) 

While the struct stores only the **path** to the credential file (not the actual credentials), this path disclosure aids attackers in several ways:
- Reveals internal filesystem structure
- Identifies exact credential file locations
- In containerized/shared environments, helps locate targets for privilege escalation
- Combined with other vulnerabilities (path traversal, LFI), enables credential theft

## Impact Explanation

This issue falls under **Low Severity** per Aptos bug bounty criteria: "Minor information leaks." 

The leaked information is the filesystem path to GCS service account credentials, not the credentials themselves. An attacker would need:
1. Access to application logs (typically restricted to operators)
2. Separate filesystem access to read the actual credentials

This does not directly lead to:
- Fund loss or theft
- Consensus violations
- State inconsistencies
- Validator compromise

However, it violates defense-in-depth principles by unnecessarily exposing sensitive infrastructure details.

## Likelihood Explanation

**Likelihood: Medium to High**

The vulnerability is triggered in multiple scenarios:
1. **Guaranteed on startup**: Info-level logs are written during normal initialization (line 46 of grpc_manager.rs)
2. **On configuration errors**: Any filestore creation failure triggers a panic with the full config
3. **Potential debug scenarios**: If `RawDataServerWrapper` is ever debug-printed

Operators commonly aggregate and analyze logs, which may have broader access than the running service itself. In cloud environments, logs are often collected by centralized logging systems where access controls may be weaker than the production environment.

## Recommendation

Implement custom `Debug` traits that redact sensitive fields:

```rust
impl std::fmt::Debug for GcsFileStore {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_struct("GcsFileStore")
            .field("gcs_file_store_bucket_name", &self.gcs_file_store_bucket_name)
            .field("gcs_file_store_bucket_sub_dir", &self.gcs_file_store_bucket_sub_dir)
            .field("gcs_file_store_service_account_key_path", &"<REDACTED>")
            .field("enable_compression", &self.enable_compression)
            .finish()
    }
}

impl std::fmt::Debug for IndexerGrpcFileStoreConfig {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        match self {
            IndexerGrpcFileStoreConfig::GcsFileStore(gcs) => {
                f.debug_tuple("GcsFileStore").field(gcs).finish()
            }
            IndexerGrpcFileStoreConfig::LocalFileStore(local) => {
                f.debug_tuple("LocalFileStore").field(local).finish()
            }
        }
    }
}
```

Remove the derived `Debug` traits from lines 9 and 30 in config.rs.

## Proof of Concept

Create a simple Rust program demonstrating the leakage:

```rust
use aptos_indexer_grpc_utils::config::{GcsFileStore, IndexerGrpcFileStoreConfig};

fn main() {
    let gcs_config = IndexerGrpcFileStoreConfig::GcsFileStore(GcsFileStore {
        gcs_file_store_bucket_name: "my-bucket".to_string(),
        gcs_file_store_bucket_sub_dir: None,
        gcs_file_store_service_account_key_path: "/secret/path/to/service-account.json".to_string(),
        enable_compression: false,
    });
    
    // This will print the sensitive path
    println!("Config: {:?}", gcs_config);
    
    // This simulates the panic in grpc_manager.rs line 38
    panic!("Failed to create filestore uploader, config: {:?}", gcs_config);
}
```

Expected output will include the full path: `/secret/path/to/service-account.json`

## Notes

While this is a valid information disclosure issue that should be fixed, it falls under **Low Severity** rather than the Medium severity suggested in the security question. The issue does not directly compromise credentials, funds, consensus, or blockchain operations. It is a defense-in-depth concern that aids reconnaissance but requires additional vulnerabilities to exploit meaningfully.

### Citations

**File:** ecosystem/indexer-grpc/indexer-grpc-utils/src/config.rs (L9-17)
```rust
#[derive(Serialize, Deserialize, Debug, Clone)]
pub struct GcsFileStore {
    pub gcs_file_store_bucket_name: String,
    pub gcs_file_store_bucket_sub_dir: Option<PathBuf>,
    // Required to operate on GCS.
    pub gcs_file_store_service_account_key_path: String,
    #[serde(default = "default_enable_compression")]
    pub enable_compression: bool,
}
```

**File:** ecosystem/indexer-grpc/indexer-grpc-utils/src/config.rs (L30-35)
```rust
#[derive(Serialize, Deserialize, Debug, Clone)]
#[serde(tag = "file_store_type")]
pub enum IndexerGrpcFileStoreConfig {
    GcsFileStore(GcsFileStore),
    LocalFileStore(LocalFileStore),
}
```

**File:** ecosystem/indexer-grpc/indexer-grpc-manager/src/grpc_manager.rs (L36-41)
```rust
                .unwrap_or_else(|e| {
                    panic!(
                        "Failed to create filestore uploader, config: {:?}, error: {e:?}",
                        config.file_store_config
                    )
                }),
```

**File:** ecosystem/indexer-grpc/indexer-grpc-manager/src/grpc_manager.rs (L44-47)
```rust
        info!(
            chain_id = chain_id,
            "FilestoreUploader is created, config: {:?}.", config.file_store_config
        );
```

**File:** ecosystem/indexer-grpc/indexer-grpc-data-service/src/service.rs (L85-98)
```rust
impl std::fmt::Debug for RawDataServerWrapper {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_struct("RawDataServerWrapper")
            .field("redis_client", &"Arc<redis::Client>")
            .field("file_store_config", &self.file_store_config)
            .field(
                "data_service_response_channel_size",
                &self.data_service_response_channel_size,
            )
            .field("txns_to_strip_filter", &self.txns_to_strip_filter)
            .field("cache_storage_format", &self.cache_storage_format)
            .finish()
    }
}
```
