# Audit Report

## Title
Stack Exhaustion Vulnerability in ReleaseConfig YAML Deserialization

## Summary
The `ReleaseConfig::load_config()` function uses `serde_yaml` 0.8.24 to deserialize YAML configuration files without any recursion depth limits, allowing an attacker to cause stack exhaustion through deeply nested YAML structures.

## Finding Description
The Aptos release builder tool deserializes release configuration files through `ReleaseConfig::load_config()` [1](#0-0) , which internally calls `Self::parse()` that uses `serde_yaml::from_str()` [2](#0-1) . 

The codebase uses `serde_yaml` version 0.8.24 [3](#0-2) , which lacks built-in recursion depth limits. This version performs recursive deserialization of nested YAML structures without bounds checking, making it vulnerable to stack exhaustion attacks.

The vulnerability is triggered when the tool processes a malicious YAML file containing deeply nested maps or sequences (e.g., `[[[[...thousands of levels...]]]]`). The recursive parser will continue allocating stack frames until the stack is exhausted, causing the process to crash.

This function is called in two CLI commands:
- `GenerateProposals` command [4](#0-3) 
- `ValidateProposals` command [5](#0-4) 

## Impact Explanation
**Severity: Low to Medium**

While this vulnerability allows denial-of-service of the release builder tool, it does not directly affect:
- Blockchain consensus or safety
- On-chain state or funds
- Running validator nodes
- Network availability

However, the impact includes:
- **Disruption of governance proposal generation**: The release builder is used to create on-chain governance proposals. A crash would prevent proposal generation.
- **CI/CD pipeline disruption**: If automated systems use this tool, malicious configs could halt release processes.
- **Social engineering vector**: Attackers could distribute malicious config files disguised as legitimate release configurations.

Per the Aptos bug bounty criteria, this falls between Low ("Non-critical implementation bugs") and Medium severity, as it doesn't cause funds loss or state inconsistencies but could disrupt critical governance infrastructure.

## Likelihood Explanation
**Likelihood: Medium**

The attack requires:
- Social engineering to convince someone to use a malicious YAML config file
- OR compromising a system where config files are processed
- OR injecting malicious configs into a CI/CD pipeline

The likelihood is elevated because:
- Config files are commonly shared in development/operations contexts
- The attack is trivial to execute (simple deeply-nested YAML)
- There's no validation or sanitization before deserialization
- The tool is used for critical governance operations

## Recommendation
Upgrade to `serde_yaml` version 0.9 or later, which includes built-in recursion depth limits. Alternatively, implement custom depth checking during deserialization.

**Recommended fix in `Cargo.toml`:**
```toml
serde_yaml = "0.9"  # or latest stable version
```

Alternatively, implement a custom deserializer with depth limits or add input validation before parsing.

## Proof of Concept

```rust
// Create a test demonstrating stack exhaustion
#[test]
#[should_panic(expected = "stack overflow")]
fn test_deeply_nested_yaml_stack_exhaustion() {
    use std::iter::repeat;
    
    // Generate deeply nested YAML structure
    let depth = 10000;
    let mut yaml = String::from("name: test\nproposals: ");
    yaml.push_str(&repeat("[").take(depth).collect::<String>());
    yaml.push_str("{}");
    yaml.push_str(&repeat("]").take(depth).collect::<String>());
    
    // This will cause stack overflow with serde_yaml 0.8.24
    let _result = aptos_release_builder::ReleaseConfig::parse(&yaml);
}
```

To demonstrate:
1. Create a YAML file with ~5000+ levels of nesting
2. Run: `aptos-release-builder generate-proposals --release-config malicious.yaml --output-dir /tmp/out`
3. Observe process crash due to stack exhaustion

## Notes
While this is a genuine security vulnerability in the deserialization logic, its practical impact is limited because:
- The tool is not part of the blockchain consensus or on-chain execution
- It requires local access or social engineering to exploit
- It causes DoS of a development tool rather than the blockchain itself

The vulnerability is most concerning in automated environments (CI/CD pipelines) where untrusted config files might be processed. Organizations using this tool should validate the source of all release configuration files and consider implementing additional input validation layers.

### Citations

**File:** aptos-move/aptos-release-builder/src/components/mod.rs (L718-739)
```rust
    pub fn load_config<P: AsRef<Path>>(path: P) -> Result<Self> {
        // Open the file and read it into a string
        let config_path_string = path.as_ref().to_str().unwrap().to_string();
        let mut file = File::open(&path).map_err(|error| {
            anyhow!(
                "Failed to open config file: {:?}. Error: {:?}",
                config_path_string,
                error
            )
        })?;
        let mut contents = String::new();
        file.read_to_string(&mut contents).map_err(|error| {
            anyhow!(
                "Failed to read the config file into a string: {:?}. Error: {:?}",
                config_path_string,
                error
            )
        })?;

        // Parse the file string
        Self::parse(&contents)
    }
```

**File:** aptos-move/aptos-release-builder/src/components/mod.rs (L751-753)
```rust
    pub fn parse(serialized: &str) -> Result<Self> {
        serde_yaml::from_str(serialized).map_err(|e| anyhow!("Failed to parse the config: {:?}", e))
    }
```

**File:** Cargo.toml (L799-799)
```text
serde_yaml = "0.8.24"
```

**File:** aptos-move/aptos-release-builder/src/main.rs (L233-234)
```rust
            aptos_release_builder::ReleaseConfig::load_config(release_config.as_path())
                .with_context(|| "Failed to load release config".to_string())?
```

**File:** aptos-move/aptos-release-builder/src/main.rs (L281-282)
```rust
            let config =
                aptos_release_builder::ReleaseConfig::load_config(release_config.as_path())?;
```
