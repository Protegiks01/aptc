# Audit Report

## Title
Sensitive Configuration Data Logged via Debug Formatter in Faucet Service

## Summary
The `validate_config()` function and `run()` function in the aptos-faucet service log the entire `RunConfig` structure using the Debug formatter, exposing sensitive information including API keys, additional authentication headers, file paths to private keys, and internal network topology to log files.

## Finding Description

The vulnerability exists at two locations: [1](#0-0) [2](#0-1) 

The `RunConfig` structure contains nested configuration that includes: [3](#0-2) 

Specifically, the `ApiConnectionConfig` derives the standard `Debug` trait without any redaction: [4](#0-3) [5](#0-4) 

While the actual Ed25519 private key material IS protected by `SilentDebug`: [6](#0-5) [7](#0-6) 

The wrapper structures expose:
1. **API keys** (`api_key: Option<String>`) - plaintext credentials for node API access
2. **Additional headers** (`additional_headers: Option<HashMap<String, String>>`) - may contain bearer tokens
3. **Private key file paths** (`key_file_path: PathBuf`) - filesystem location of sensitive key material
4. **Network topology** (`node_url: Url`) - internal infrastructure details

## Impact Explanation

This is a **Low Severity** information disclosure vulnerability. While it exposes sensitive configuration data, it does not:
- Directly expose private key material (protected by `SilentDebug`)
- Cause consensus violations or blockchain state corruption
- Enable direct loss of funds or token minting without additional exploitation
- Violate any of the 10 critical Aptos blockchain invariants

The exposed information could facilitate further attacks if an attacker gains access to log files, but requires pre-existing system compromise or insider access to exploit.

## Likelihood Explanation

**High likelihood of occurrence** (logging happens automatically on every startup and validation), but **low likelihood of exploitation** (requires log file access, which implies existing system compromise or insider threat).

The faucet service is not a consensus-critical component. An attacker with access to faucet logs likely already has broader system access that would enable more direct attack vectors.

## Recommendation

Implement custom `Debug` implementations or use redaction for sensitive fields:

```rust
// Option 1: Custom Debug for ApiConnectionConfig
impl fmt::Debug for ApiConnectionConfig {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        f.debug_struct("ApiConnectionConfig")
            .field("node_url", &self.node_url)
            .field("api_key", &"<redacted>")
            .field("additional_headers", &"<redacted>")
            .field("chain_id", &self.chain_id)
            .finish()
    }
}

// Option 2: Custom Debug for AssetConfig
impl fmt::Debug for AssetConfig {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        f.debug_struct("AssetConfig")
            .field("key_file_path", &"<redacted>")
            .field("key", &"<redacted>")
            .finish()
    }
}
```

## Proof of Concept

Create a test configuration file `test_config.yaml`:
```yaml
server_config:
  listen_address: "0.0.0.0"
  listen_port: 8081
  api_path_base: ""
metrics_server_config:
  disable: true
bypasser_configs: []
checker_configs: []
funder_config:
  type: MintFunder
  node_url: "https://internal-node.example.com:8080"
  api_key: "secret-api-key-12345"
  additional_headers:
    Authorization: "Bearer sensitive-token"
  chain_id: 1
  # ... rest of config
```

Run: `cargo run --bin aptos-faucet -- validate-config -c test_config.yaml`

The log output will contain:
```
INFO Config is valid: RunConfig {
    ...
    funder_config: MintFunder(MintFunderConfig {
        api_connection_config: ApiConnectionConfig {
            node_url: "https://internal-node.example.com:8080",
            api_key: Some("secret-api-key-12345"),  // <-- EXPOSED
            additional_headers: Some({"Authorization": "Bearer sensitive-token"}),  // <-- EXPOSED
            ...
```

## Notes

After rigorous validation against the Aptos bug bounty criteria, this issue does **NOT** meet the threshold for Critical, High, or Medium severity as defined in the program rules. It is classified as **Low Severity** (minor information leak) because:

1. It requires log file access (insider or compromised system)
2. Does not violate critical blockchain invariants
3. Does not enable direct exploitation of consensus, funds, or availability
4. Private key material itself is protected
5. The faucet is not a consensus-critical component

Per the validation checklist requirement for "unprivileged attacker" exploitation and the extremely high bar set for valid findings, this represents a defense-in-depth improvement rather than a directly exploitable vulnerability in the Aptos blockchain core.

### Citations

**File:** crates/aptos-faucet/core/src/server/validate_config.rs (L32-32)
```rust
        info!("Config is valid: {:#?}", run_config);
```

**File:** crates/aptos-faucet/core/src/server/run.rs (L86-86)
```rust
        info!("Running with config: {:#?}", self);
```

**File:** crates/aptos-faucet/core/src/funder/common.rs (L54-75)
```rust
#[derive(Clone, Debug, Deserialize, Parser, Serialize)]
pub struct ApiConnectionConfig {
    /// Aptos node (any node type with an open API) server URL.
    /// Include the port in this if not using the default for the scheme.
    #[clap(long, default_value = "https://fullnode.testnet.aptoslabs.com/")]
    pub node_url: Url,

    /// API key for talking to the node API.
    #[clap(long)]
    pub api_key: Option<String>,

    /// Any additional headers to send with the request. We don't accept this on the
    /// CLI.
    #[clap(skip)]
    pub additional_headers: Option<HashMap<String, String>>,

    /// Chain ID of the network this client is connecting to. For example, for mainnet:
    /// "MAINNET" or 1, testnet: "TESTNET" or 2. If there is no predefined string
    /// alias (e.g. "MAINNET"), just use the number. Note: Chain ID of 0 is not allowed.
    #[clap(long, default_value_t = ChainId::testnet())]
    pub chain_id: ChainId,
}
```

**File:** crates/aptos-crypto/src/ed25519/ed25519_keys.rs (L23-24)
```rust
#[derive(DeserializeKey, SerializeKey, SilentDebug, SilentDisplay)]
pub struct Ed25519PrivateKey(pub(crate) ed25519_dalek::SecretKey);
```

**File:** crates/aptos-crypto-derive/src/lib.rs (L128-143)
```rust
#[proc_macro_derive(SilentDebug)]
pub fn silent_debug(source: TokenStream) -> TokenStream {
    let ast: DeriveInput = syn::parse(source).expect("Incorrect macro input");
    let name = &ast.ident;
    let (impl_generics, ty_generics, where_clause) = ast.generics.split_for_impl();

    quote! {
        // In order to ensure that secrets are never leaked, Debug is elided
        impl #impl_generics ::std::fmt::Debug for #name #ty_generics #where_clause {
            fn fmt(&self, f: &mut ::std::fmt::Formatter<'_>) -> ::std::fmt::Result {
                write!(f, "<elided secret for {}>", stringify!(#name))
            }
        }
    }
    .into()
}
```
