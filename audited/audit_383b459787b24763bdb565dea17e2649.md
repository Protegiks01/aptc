# Audit Report

## Title
API Key Exposure Through Debug Trait Implementation in CLI Structures

## Summary
The `node_api_key` used for rate-limiting API requests is stored in `RestOptions` and `TransactionOptions` structs that derive the `Debug` trait, potentially exposing the API key in plain text if these structures are debug-formatted in logs, error messages, or panic output.

## Finding Description
The `RestOptions` struct stores the `node_api_key` as a plain `Option<String>` and derives the `Debug` trait, which causes the API key to be printed in plain text when debug-formatted. [1](#0-0) 

This propagates through `TransactionOptions`, which also derives `Debug` and contains `RestOptions` as a field: [2](#0-1) 

The API key is used to set an Authorization Bearer header for authenticated API requests: [3](#0-2) 

While I did not find explicit debug-printing of these structures in the current codebase, the derived `Debug` implementation creates a latent vulnerability where:
- Future code additions could inadvertently log these structures
- Panic handlers or crash reports could capture these values
- Debugging sessions or error contexts could expose the key
- Third-party integrations or forks might introduce logging

## Impact Explanation
This is a **Low Severity** information disclosure issue. The `node_api_key` provides authenticated access for rate-limiting purposes but is not a critical credential for consensus, validator operations, or fund control. According to Aptos Bug Bounty criteria, this falls under "Minor information leaks" (Low Severity - up to $1,000).

## Likelihood Explanation
The likelihood is **Low** because:
- No current code path explicitly debug-prints these structures
- Error handling uses Display trait (via `to_string()`), not Debug
- reqwest's error types don't expose headers by default

However, the risk is non-zero due to common debugging practices and potential future code changes.

## Recommendation
Implement a custom `Debug` trait that redacts the `node_api_key`:

```rust
impl std::fmt::Debug for RestOptions {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_struct("RestOptions")
            .field("url", &self.url)
            .field("connection_timeout_secs", &self.connection_timeout_secs)
            .field("node_api_key", &self.node_api_key.as_ref().map(|_| "<redacted>"))
            .finish()
    }
}
```

Alternatively, use a wrapper type like `Secret<String>` that automatically redacts in debug output.

## Proof of Concept
```rust
use aptos::common::types::RestOptions;

fn main() {
    let opts = RestOptions {
        url: None,
        connection_timeout_secs: 30,
        node_api_key: Some("secret_api_key_12345".to_string()),
    };
    
    // This will print: RestOptions { url: None, connection_timeout_secs: 30, node_api_key: Some("secret_api_key_12345") }
    println!("{:?}", opts);
}
```

**Notes**
This is a defensive security improvement rather than an actively exploitable vulnerability. While no current exploitation path exists in the codebase, the derived `Debug` trait on credential-containing structures violates security best practices and creates unnecessary risk.

### Citations

**File:** crates/aptos/src/common/types.rs (L1093-1110)
```rust
#[derive(Debug, Parser)]
pub struct RestOptions {
    /// URL to a fullnode on the network
    ///
    /// Defaults to the URL in the `default` profile
    #[clap(long)]
    pub(crate) url: Option<reqwest::Url>,

    /// Connection timeout in seconds, used for the REST endpoint of the fullnode
    #[clap(long, default_value_t = DEFAULT_EXPIRATION_SECS, alias = "connection-timeout-s")]
    pub connection_timeout_secs: u64,

    /// Key to use for ratelimiting purposes with the node API. This value will be used
    /// as `Authorization: Bearer <key>`. You may also set this with the NODE_API_KEY
    /// environment variable.
    #[clap(long, env)]
    pub node_api_key: Option<String>,
}
```

**File:** crates/aptos/src/common/types.rs (L1781-1797)
```rust
#[derive(Debug, Default, Parser)]
pub struct TransactionOptions {
    /// Sender account address
    ///
    /// This allows you to override the account address from the derived account address
    /// in the event that the authentication key was rotated or for a resource account
    #[clap(long, value_parser = crate::common::types::load_account_arg)]
    pub(crate) sender_account: Option<AccountAddress>,

    #[clap(flatten)]
    pub(crate) private_key_options: PrivateKeyInputOptions,
    #[clap(flatten)]
    pub(crate) encoding_options: EncodingOptions,
    #[clap(flatten)]
    pub(crate) profile_options: ProfileOptions,
    #[clap(flatten)]
    pub(crate) rest_options: RestOptions,
```

**File:** crates/aptos-rest-client/src/client_builder.rs (L82-88)
```rust
    pub fn api_key(mut self, api_key: &str) -> Result<Self> {
        self.headers.insert(
            header::AUTHORIZATION,
            HeaderValue::from_str(&format!("Bearer {}", api_key))?,
        );
        Ok(self)
    }
```
