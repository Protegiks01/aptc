# Audit Report

## Title
Incorrect Transaction Rejection Due to Hardcoded Gas Estimate in Account Creation Check

## Summary
The `check_gas()` function in `gas.rs` uses a hardcoded value of 10 gas units as the execution cost estimate for account creation transactions, but the actual intrinsic gas cost can be significantly lower (minimum ~2.76 gas units). This causes legitimate transactions with sufficient gas to be incorrectly rejected with the error code `MAX_GAS_UNITS_BELOW_MIN_TRANSACTION_GAS_UNITS`, violating transaction validation invariants.

## Finding Description

The vulnerability exists in the account creation validation logic within the `check_gas()` function. The function performs two separate checks using the same error code:

**First Check (Intrinsic Gas):** Correctly validates that `max_gas_amount >= intrinsic_gas` where `intrinsic_gas` is accurately calculated based on transaction size, keyless authentication, and signature type. [1](#0-0) 

**Second Check (Account Creation):** Uses a hardcoded value of 10 gas units instead of the actual `intrinsic_gas` value calculated earlier. [2](#0-1) 

The minimum transaction gas is defined as 2,760,000 internal gas units, which equals approximately 2.76 external gas units (with the scaling factor of 1,000,000). [3](#0-2) 

**Exploitation Path:**

1. User submits a transaction to create a new account with:
   - `gas_unit_price = 100` octas/gas
   - `storage_fee_per_account_create = 700` octas
   - `intrinsic_gas = 3` gas units (actual calculated value)
   - `max_gas_amount = 13` gas units

2. First check passes: `13 >= 3` ✓

3. Second check fails:
   - `expected = 100 * 10 + 700 = 1700` octas
   - `actual = 100 * 13 = 1300` octas
   - Transaction rejected with `MAX_GAS_UNITS_BELOW_MIN_TRANSACTION_GAS_UNITS`

4. However, during actual execution (if allowed):
   - Available gas after intrinsic: `13 - 3 = 10` gas units
   - Storage fee in gas units: `ceil(700 / 100) = 7` gas units
   - Remaining gas: `10 - 7 = 3` gas units ✓ SUFFICIENT

The transaction has adequate gas to succeed but is incorrectly rejected due to the hardcoded 10 gas unit assumption that doesn't match the actual intrinsic gas cost of 3 units.

## Impact Explanation

**Severity: Medium** per Aptos bug bounty criteria.

This vulnerability causes:
1. **Incorrect Transaction Rejection**: Valid transactions with sufficient gas are rejected, violating the "Transaction Validation" and "Resource Limits" invariants
2. **User Impact**: Cost-conscious users attempting to minimize gas fees for account creation are disproportionately affected
3. **Error Code Confusion**: The same status code `MAX_GAS_UNITS_BELOW_MIN_TRANSACTION_GAS_UNITS` is used for two semantically different validation failures, making debugging difficult
4. **Availability Issue**: Legitimate account creation transactions are denied service

The vulnerability affects all transaction status codes returned from the validation check. [4](#0-3) 

Validation errors result in transaction discard without gas charges. [5](#0-4) 

## Likelihood Explanation

**Likelihood: High**

This issue occurs whenever:
- A user attempts to create a new account (common operation)
- The user provides a gas budget that is sufficient for actual execution but fails the overly conservative hardcoded check
- The gap between actual intrinsic gas (~3 units) and hardcoded estimate (10 units) represents ~7 gas units of unnecessary margin

The code even contains a TODO comment acknowledging this is temporary legacy code. [6](#0-5) 

The condition for triggering this check includes all account creation scenarios when gas price is non-zero. [7](#0-6) 

## Recommendation

Replace the hardcoded `10` gas units with the actual calculated `total_rounded` value from the first intrinsic gas check:

```rust
// Lines 221-246 should be changed from:
let expected = gas_unit_price * 10 + storage_fee_multiplier * storage_fee_per_account_create;

// To:
let expected = gas_unit_price * u64::from(total_rounded) + storage_fee_multiplier * storage_fee_per_account_create;
```

This ensures the account creation check uses the same intrinsic gas calculation as the first validation, eliminating the discrepancy.

Alternatively, consider using a distinct error code for insufficient account creation fees (e.g., `INSUFFICIENT_BALANCE_FOR_ACCOUNT_CREATION`) to avoid semantic confusion with the intrinsic gas check.

## Proof of Concept

```rust
// Test case demonstrating incorrect rejection
#[test]
fn test_account_creation_incorrect_rejection() {
    use aptos_gas_schedule::{AptosGasParameters, VMGasParameters};
    use aptos_types::on_chain_config::Features;
    
    // Setup test parameters
    let gas_params = AptosGasParameters::initial();
    let features = Features::default();
    let gas_unit_price = 100u64;
    let max_gas_amount = 13u64; // Should be sufficient
    let transaction_size = 200u64; // Small transaction
    
    // Calculate actual intrinsic gas (will be ~3 gas units)
    let intrinsic_gas = gas_params.vm.txn
        .calculate_intrinsic_gas(transaction_size.into())
        .evaluate(gas_feature_version, &gas_params.vm);
    let total_rounded = intrinsic_gas.to_unit_round_up_with_params(&gas_params.vm.txn);
    
    // Verify intrinsic check passes
    assert!(max_gas_amount >= total_rounded.into()); // ~13 >= 3 ✓
    
    // Calculate account creation check
    let storage_fee = 700u64; // Estimated storage fee in octas
    let expected = gas_unit_price * 10 + storage_fee; // 1700 octas
    let actual = gas_unit_price * max_gas_amount; // 1300 octas
    
    // This check FAILS, rejecting the transaction
    assert!(actual < expected); // Bug: transaction rejected
    
    // But actual execution would succeed:
    let gas_after_intrinsic = max_gas_amount - u64::from(total_rounded); // ~10 gas units
    let storage_fee_in_gas = (storage_fee + gas_unit_price - 1) / gas_unit_price; // ceil(7)
    
    // Verify sufficient gas remains
    assert!(gas_after_intrinsic >= storage_fee_in_gas); // 10 >= 7 ✓
    
    // Conclusion: Transaction has sufficient gas but is incorrectly rejected
}
```

## Notes

This vulnerability demonstrates how the reuse of the same error code (`MAX_GAS_UNITS_BELOW_MIN_TRANSACTION_GAS_UNITS`) for two semantically different checks creates both user confusion and incorrect validation logic. The hardcoded estimate doesn't account for the actual calculated intrinsic gas, leading to availability issues for legitimate users attempting account creation with optimized gas budgets.

### Citations

**File:** aptos-move/aptos-vm/src/gas.rs (L154-172)
```rust
    let intrinsic_gas = txn_gas_params
        .calculate_intrinsic_gas(raw_bytes_len)
        .evaluate(gas_feature_version, &gas_params.vm);
    let total_rounded: Gas =
        (intrinsic_gas + keyless + slh_dsa_sha2_128s).to_unit_round_up_with_params(txn_gas_params);
    if txn_metadata.max_gas_amount() < total_rounded {
        speculative_warn!(
            log_context,
            format!(
                "[VM] Gas unit error; min {}, submitted {}",
                total_rounded,
                txn_metadata.max_gas_amount()
            ),
        );
        return Err(VMStatus::error(
            StatusCode::MAX_GAS_UNITS_BELOW_MIN_TRANSACTION_GAS_UNITS,
            None,
        ));
    }
```

**File:** aptos-move/aptos-vm/src/gas.rs (L210-212)
```rust
    // If this is for a potentially new account, ensure there's enough gas to cover storage, execution, and IO costs.
    // TODO: This isn't the cleaning code, thus we localize it just here and will remove it
    // once accountv2 is available and we no longer need to create accounts.
```

**File:** aptos-move/aptos-vm/src/gas.rs (L214-220)
```rust
    if crate::aptos_vm::should_create_account_resource(
        txn_metadata,
        features,
        resolver,
        module_storage,
    )? && (gas_unit_price != 0 || !features.is_default_account_resource_enabled())
    {
```

**File:** aptos-move/aptos-vm/src/gas.rs (L227-245)
```rust
        let expected = gas_unit_price * 10
            + if features.is_new_account_default_to_fa_store() {
                1
            } else {
                2
            } * storage_fee_per_account_create;
        let actual = gas_unit_price * max_gas_amount;
        if actual < expected {
            speculative_warn!(
                log_context,
                format!(
                    "[VM] Insufficient gas for account creation; min {}, submitted {}",
                    expected, actual,
                ),
            );
            return Err(VMStatus::error(
                StatusCode::MAX_GAS_UNITS_BELOW_MIN_TRANSACTION_GAS_UNITS,
                None,
            ));
```

**File:** aptos-move/aptos-gas-schedule/src/gas_schedule/transaction.rs (L33-36)
```rust
            min_transaction_gas_units: InternalGas,
            "min_transaction_gas_units",
            2_760_000
        ],
```

**File:** third_party/move/move-core/types/src/vm_status.rs (L292-297)
```rust
                match code.status_type() {
                    // Any unknown error should be discarded
                    StatusType::Unknown => Err(code),
                    // Any error that is a validation status (i.e. an error arising from the prologue)
                    // causes the transaction to not be included.
                    StatusType::Validation => Err(code),
```

**File:** third_party/move/move-core/types/src/vm_status.rs (L600-611)
```rust
    // Max gas units submitted with transaction exceeds max gas units bound
    // in VM
    MAX_GAS_UNITS_EXCEEDS_MAX_GAS_UNITS_BOUND = 13,
    // Max gas units submitted with transaction not enough to cover the
    // intrinsic cost of the transaction.
    MAX_GAS_UNITS_BELOW_MIN_TRANSACTION_GAS_UNITS = 14,
    // Gas unit price submitted with transaction is below minimum gas price
    // set in the VM.
    GAS_UNIT_PRICE_BELOW_MIN_BOUND = 15,
    // Gas unit price submitted with the transaction is above the maximum
    // gas price set in the VM.
    GAS_UNIT_PRICE_ABOVE_MAX_BOUND = 16,
```
