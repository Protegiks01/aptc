# Audit Report

## Title
Missing ValidatorTransaction Handling Causes Indexer State Inconsistency for Staking Pool Voter Data

## Summary
The `from_transaction()` function in `staking_pool_voter.rs` does not explicitly handle `ValidatorTransaction` types, causing stake pool voter data updates from validator transactions to be silently dropped. This results in the indexer's `current_staking_pool_voter` table becoming inconsistent with on-chain state during epoch transitions.

## Finding Description

The `from_transaction()` function only explicitly handles three transaction types (UserTransaction, GenesisTransaction, BlockMetadataTransaction), while ValidatorTransaction falls into the catch-all pattern that uses empty write set changes. [1](#0-0) 

However, ValidatorTransactions **do modify StakePool resources** during epoch transitions. The test data confirms that ValidatorTransactions contain TYPE_WRITE_RESOURCE changes for StakePool, including updates to the `delegated_voter` field: [2](#0-1) 

The API ValidatorTransaction type provides a `transaction_info()` method that returns the TransactionInfo containing write set changes: [3](#0-2) 

**Impact:** When a ValidatorTransaction modifies StakePool resources (which occurs during reward distribution and stake transitions at epoch boundaries), the indexer's voter extraction logic:
1. Falls into the catch-all pattern `_` returning `(0, &empty_change)`
2. The iteration over `changes` processes zero items
3. Returns an empty HashMap with no voter data extracted
4. The `current_staking_pool_voter` table misses legitimate updates

This breaks the **State Consistency** invariant for the indexer, as the indexed voter data diverges from actual on-chain state.

## Impact Explanation

**Medium Severity** - State inconsistencies requiring intervention.

While this is an indexer data quality issue (not a consensus vulnerability), it causes:
- Incorrect/outdated staking pool voter information in the indexer database
- Applications relying on the indexer for governance queries will have stale voting power data
- Requires manual database reconciliation or reindexing to fix

This meets the "State inconsistencies requiring intervention" criteria for Medium severity ($10,000 range).

## Likelihood Explanation

**High Likelihood** - This occurs naturally during every epoch transition when ValidatorTransactions execute the `update_stake_pool` function to distribute rewards. The system itself generates these transactions as part of normal operation, making this a guaranteed occurrence rather than requiring attacker action.

## Recommendation

Add explicit handling for ValidatorTransaction in the match statement:

```rust
let (txn_version, changes) = match transaction {
    APITransaction::UserTransaction(txn) => (txn.info.version.0 as i64, &txn.info.changes),
    APITransaction::GenesisTransaction(txn) => (txn.info.version.0 as i64, &txn.info.changes),
    APITransaction::BlockMetadataTransaction(txn) => (txn.info.version.0 as i64, &txn.info.changes),
    APITransaction::ValidatorTransaction(txn) => {
        let info = txn.transaction_info();
        (info.version.0 as i64, &info.changes)
    },
    _ => (0, &empty_change),
};
```

Additionally, explicitly list StateCheckpointTransaction and BlockEpilogueTransaction in the catch-all for code clarity, since they legitimately produce empty write sets.

## Proof of Concept

To reproduce:
1. Index a block containing a ValidatorTransaction with StakePool modifications (epoch boundary)
2. Query the `current_staking_pool_voter` table for affected stake pool addresses
3. Compare with on-chain state using the REST API
4. Observe that voter data from the ValidatorTransaction is missing from the indexer

The test transaction file demonstrates this scenario: [4](#0-3) 

## Notes

**Important Clarification:** This is an **indexer data quality issue**, not a blockchain consensus vulnerability. The indexer is a separate off-chain component that reads blockchain data. This bug does not:
- Affect consensus safety or liveness
- Allow theft or manipulation of on-chain funds
- Enable validator set manipulation
- Compromise cryptographic security

The bug should be fixed to maintain indexer data integrity, but it does not represent an exploitable attack vector against the Aptos blockchain itself.

### Citations

**File:** crates/indexer/src/models/stake_models/staking_pool_voter.rs (L31-40)
```rust
        let (txn_version, changes) = match transaction {
            APITransaction::UserTransaction(txn) => (txn.info.version.0 as i64, &txn.info.changes),
            APITransaction::GenesisTransaction(txn) => {
                (txn.info.version.0 as i64, &txn.info.changes)
            },
            APITransaction::BlockMetadataTransaction(txn) => {
                (txn.info.version.0 as i64, &txn.info.changes)
            },
            _ => (0, &empty_change),
        };
```

**File:** ecosystem/indexer-grpc/indexer-test-transactions/src/json_transactions/imported_testnet_txns/5523474016_validator_txn.json (L1-112)
```json
{
  "timestamp": {
    "seconds": "1722211338",
    "nanos": 84277000
  },
  "version": "5523474016",
  "info": {
    "hash": "+Ftu+XCNzPRDRRQDv8DUJTdisKMpDNUyQIX8MQ+MqtQ=",
    "stateChangeHash": "jJAK8lBojSjjeQsKW7MjX2i7vrp+GGS+bS19krcO2BY=",
    "eventRootHash": "geIOeit4uWzbS9NEbRxoLZ3kGXZFFitaNW6psHi6UIk=",
    "stateCheckpointHash": "rwJ7hCUSjBFA225Ckti1ZQ1E13fKcmwEGe4k92o20+4=",
    "success": true,
    "vmStatus": "Executed successfully",
    "accumulatorRootHash": "siQxd+mKOr9y6pN60CozZWY9qOcTjrfLXH9XqiMiBFI=",
    "changes": [
      {
        "type": "TYPE_WRITE_RESOURCE",
        "writeResource": {
          "address": "0x1",
          "stateKeyHash": "RYJb5g2RL7r6a70Czs9zQi5lvAxOlpC8vb7ga5nKuiA=",
          "type": {
            "address": "0x1",
            "module": "dkg",
            "name": "DKGState"
          },
          "typeStr": "0x1::dkg::DKGState",
          "data": "{\"in_progress\":{\"vec\":[]},\"last_completed\":{\"vec\":[{\"metadata\":{\"dealer_epoch\":\"16643\",\"dealer_validator_set\":[{\"addr\":\"0xa4113560d0b18ba38797f2a899c4b27e0c5b0476be5d8f6be68fba8b1861ed0\",\"pk_bytes\":\"0x98c5004e890ae58d0a5e79fb2d5fb1b703e265fc3774c39a461d3061c0ed05688a672c2d3005ad78e8dd1b932c802e66\",\"voting_power\":\"100299542666483\"},{\"addr\":\"0x286e8af6717ef6b1e361aae8ab28dd6664bf562c2805dd9a53432246ec66566e\",\"pk_bytes\":\"0xb419f16a07af02aaf47892223c9dc3de349cf1414133481d9311c0bb531d0b450cb86919aa0a8c78fef2d78369ed26eb\",\"voting_power\":\"2436329103109955\"},{\"addr\":\"0x116176e2af223a8b7f8db80dc52f7a423b4d7f8c0553a1747e92ef58849aff4f\",\"pk_bytes\":\"0xb110af328ed5be9e515c15ac5e7fa49e0ddc805f0f1ac278cba3a5be1a4495fa421624162242420e58e19d ... (truncated)
        }
      },
      {
        "type": "TYPE_WRITE_RESOURCE",
        "writeResource": {
          "address": "0x1",
          "stateKeyHash": "/Oyrha7CwSRSnRt+eAL3NETP1PqiBLXYcvFVFj0aRbk=",
          "type": {
            "address": "0x1",
            "module": "stake",
            "name": "ValidatorSet"
          },
          "typeStr": "0x1::stake::ValidatorSet",
          "data": "{\"active_validators\":[{\"addr\":\"0xa4113560d0b18ba38797f2a899c4b27e0c5b0476be5d8f6be68fba8b1861ed0\",\"config\":{\"consensus_pubkey\":\"0x98c5004e890ae58d0a5e79fb2d5fb1b703e265fc3774c39a461d3061c0ed05688a672c2d3005ad78e8dd1b932c802e66\",\"fullnode_addresses\":\"0x01630402396170746f732d746573746e65742d6669676d656e742d76666e2d312e7374616b696e672e70726f64756374696f6e2e6669676d656e742e696f052618072087cd3dce1649d889d0f5909acc7208d9940ef485c41992cc42102c4d38a7386a0800\",\"network_addresses\":\"0x01620402386170746f732d746573746e65742d6669676d656e742d64702d312e7374616b696e672e70726f64756374696f6e2e6669676d656e742e696f052418072057a5cd66f86cc022897bcf146917fcb3da2fd5c4dac7a3bfb4e75afd0416e8390800\",\"validator_index\":\"0\"},\"voting_power\":\"100300332038139\"},{\"addr\":\"0x2 ... (truncated)
        }
      },
      {
        "type": "TYPE_WRITE_RESOURCE",
        "writeResource": {
          "address": "0x1",
          "stateKeyHash": "gEjJVCIYFLBFM6nwqZRsOo1HKsYt9azLn0fAl+JW6LY=",
          "type": {
            "address": "0x1",
            "module": "stake",
            "name": "ValidatorPerformance"
          },
          "typeStr": "0x1::stake::ValidatorPerformance",
          "data": "{\"validators\":[{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_proposals\":\"0\"},{\"failed_proposals\":\"0\",\"successful_pro ... (truncated)
        }
      },
      {
        "type": "TYPE_WRITE_RESOURCE",
        "writeResource": {
          "address": "0x1",
          "stateKeyHash": "vPyIQN37f7xdn+qUp/dlcMNvfH1ff/qCAv6n5b4rOkI=",
          "type": {
            "address": "0x1",
            "module": "storage_gas",
            "name": "StorageGas"
          },
          "typeStr": "0x1::storage_gas::StorageGas",
          "data": "{\"per_byte_create\":\"1029\",\"per_byte_read\":\"41\",\"per_byte_write\":\"205\",\"per_item_create\":\"2099000\",\"per_item_read\":\"83960\",\"per_item_write\":\"419800\"}"
        }
      },
      {
        "type": "TYPE_WRITE_RESOURCE",
        "writeResource": {
          "address": "0x1",
          "stateKeyHash": "IodpLBeQApgaj+Gfbe8ZftX/RShIZZ4uCR6tMY1xkFA=",
          "type": {
            "address": "0x1",
            "module": "reconfiguration",
            "name": "Configuration"
          },
          "typeStr": "0x1::reconfiguration::Configuration",
          "data": "{\"epoch\":\"16644\",\"events\":{\"counter\":\"16644\",\"guid\":{\"id\":{\"addr\":\"0x1\",\"creation_num\":\"2\"}}},\"last_reconfiguration_time\":\"1722211338084277\"}"
        }
      },
      {
        "type": "TYPE_WRITE_RESOURCE",
        "writeResource": {
          "address": "0x1",
          "stateKeyHash": "NeMtTQEE7LAF+smHTELMBiadlApYgPH0s+P/BANfDLs=",
          "type": {
            "address": "0x1",
            "module": "reconfiguration_state",
            "name": "State"
          },
          "typeStr": "0x1::reconfiguration_state::State",
          "data": "{\"variant\":{\"data\":\"0x00\",\"type_name\":\"0x1::reconfiguration_state::StateInactive\"}}"
        }
      },
      {
        "type": "TYPE_WRITE_RESOURCE",
        "writeResource": {
          "address": "0x3c04549114877c55f45649aba48ac0a4ff086ab7bdce3b8cc8d3d9947bc0d99",
          "stateKeyHash": "DB6vtC0XXNRnP5esRAXud+aB868UlH05R7IE227edeQ=",
          "type": {
            "address": "0x1",
            "module": "stake",
            "name": "StakePool"
          },
          "typeStr": "0x1::stake::StakePool",
          "data": "{\"active\":{\"value\":\"2437735169013423\"},\"add_stake_events\":{\"counter\":\"1\",\"guid\":{\"id\":{\"addr\":\"0x3c04549114877c55f45649aba48ac0a4ff086ab7bdce3b8cc8d3d9947bc0d99\",\"creation_num\":\"6\"}}},\"delegated_voter\":\"0x3c04549114877c55f45649aba48ac0a4ff086ab7bdce3b8cc8d3d9947bc0d99\",\"distribute_rewards_events\":{\"counter\":\"9830\",\"guid\":{\"id\":{\"addr\":\"0x3c04549114877c55f45649aba48ac0a4ff086ab7bdce3b8cc8d3d9947bc0d99\",\"creation_num\":\"12\"}}},\"inactive\":{\"value\":\"0\"},\"increase_lockup_events\":{\"counter\":\"0\",\"guid\":{\"id\":{\"addr\":\"0x3c04549114877c55f45649aba48ac0a4ff086ab7bdce3b8cc8d3d9947bc0d99\",\"creation_num\":\"10\"}}},\"initialize_validator_events\":{\"counter\":\"0\",\"guid\":{\"id\":{\"addr\":\"0x3c04549114877c55f45649ab ... (truncated)
        }
```

**File:** api/types/src/transaction.rs (L693-698)
```rust
    pub fn transaction_info(&self) -> &TransactionInfo {
        match self {
            ValidatorTransaction::ObservedJwkUpdate(t) => &t.info,
            ValidatorTransaction::DkgResult(t) => &t.info,
        }
    }
```
