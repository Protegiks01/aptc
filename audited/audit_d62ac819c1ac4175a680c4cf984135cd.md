# Audit Report

## Title
Test Environment Validator Exposes Unauthenticated Fullnode Network Endpoint to Untrusted Peers

## Summary
The `start_test_environment_node()` function creates a validator node that exposes a fullnode network endpoint listening on all interfaces (0.0.0.0) with `MaybeMutual` authentication mode, allowing any network peer to connect without being in the trusted peer set. While consensus protocols are properly isolated to the validator network, this exposes mempool, storage service, and peer monitoring service to potential abuse from untrusted actors if the test node is run on an internet-accessible machine.

## Finding Description

When a developer runs `aptos-node --test`, the `start_test_environment_node()` function initializes a validator with fullnode networks that accept connections from any peer.

The vulnerability chain is as follows:

1. **Genesis Builder Creates Unauthenticated Fullnode Networks**: In `generate_validator_config()`, the fullnode network is configured with default settings: [1](#0-0) 

The `..Default::default()` critically leaves `mutual_authentication` unset, which defaults to `false` for non-validator networks: [2](#0-1) 

2. **Listen Address Binds to All Interfaces**: The `get_available_port_in_multiaddr()` function explicitly binds to 0.0.0.0: [3](#0-2) 

3. **MaybeMutual Authentication Accepts Unknown Peers**: When `mutual_authentication` is false, the network builder configures `AuthenticationMode::MaybeMutual`: [4](#0-3) 

This authentication mode allows connections from unknown peers: [5](#0-4) 

4. **Services Exposed to Unknown Peers**: While consensus, DKG, and JWK consensus are properly restricted to the validator network, mempool and storage services are registered on ALL networks including fullnode networks: [6](#0-5) 

5. **No Rate Limiting by Default**: The default configuration provides no inbound rate limiting: [7](#0-6) 

**Attack Scenario**: An attacker on the same network as a developer running a test node (or if the test node is on a cloud VM with public IP) can:
- Connect to the fullnode endpoint (printed at startup on line 364-366)
- Send a flood of transactions to the mempool
- Query the storage service repeatedly
- Potentially cause resource exhaustion and validator slowdown

## Impact Explanation

This meets **High Severity** criteria per the Aptos Bug Bounty program:
- **"Validator node slowdowns"**: Attackers can flood the mempool with transactions, causing the validator to consume CPU/memory processing and validating transactions
- **"Significant protocol violations"**: The security model expects only trusted peers to connect to validators, but test mode violates this by accepting arbitrary connections

While consensus safety is not directly compromised (consensus protocols are isolated to the validator network), the validator's availability and performance can be significantly degraded.

## Likelihood Explanation

**High Likelihood** if test nodes are run on internet-accessible machines:
- Developers may run test nodes on cloud VMs for remote testing
- Corporate networks may have inadequate firewall rules
- Developers on public WiFi expose their test nodes

**Low Likelihood** in proper development environments:
- Local testing on localhost is safe
- The WARNING message alerts developers this is test-only

However, the current warning does not explicitly mention the network exposure risk.

## Recommendation

Add explicit network exposure warnings and consider defaulting to localhost binding in test mode:

**Option 1: Enhanced Warning**
```rust
if self.test {
    println!("WARNING: Entering test mode! This should never be used in production!");
    println!("WARNING: Test mode exposes fullnode network endpoints to ALL network interfaces!");
    println!("WARNING: Ensure proper firewall rules are in place or run on localhost only!");
    // ... existing code
}
```

**Option 2: Bind to Localhost by Default**
In `config/src/utils.rs`, add a parameter to control binding:
```rust
pub fn get_available_port_in_multiaddr(is_ipv4: bool, bind_localhost: bool) -> NetworkAddress {
    let ip_proto = if is_ipv4 {
        if bind_localhost {
            Protocol::Ip4("127.0.0.1".parse().unwrap())
        } else {
            Protocol::Ip4("0.0.0.0".parse().unwrap())
        }
    } else {
        Protocol::Ip6("::1".parse().unwrap())
    };
    NetworkAddress::from_protocols(vec![ip_proto, Protocol::Tcp(get_available_port())]).unwrap()
}
```

Then modify the genesis builder to use localhost binding for test environments unless explicitly overridden.

**Option 3: Enable Mutual Authentication for VFN Network**
In the genesis builder, set `mutual_authentication: true` for the VFN network to require peer authentication.

## Proof of Concept

```rust
// PoC: Connecting to and flooding a test validator's fullnode network
use aptos_network::ProtocolId;
use tokio::net::TcpStream;

#[tokio::main]
async fn main() {
    // Start a test node with: aptos-node --test
    // Note the printed "AptosNet fullnode network endpoint" address
    
    let target = "127.0.0.1:6181"; // Example from test node output
    
    // Connect to the exposed fullnode network
    match TcpStream::connect(target).await {
        Ok(_stream) => {
            println!("Successfully connected to validator fullnode network!");
            println!("Can now send mempool transactions, query storage, etc.");
            
            // In a real attack, would:
            // 1. Complete Noise handshake (publicly known protocol)
            // 2. Send mempool DirectSend messages
            // 3. Flood with invalid/spam transactions
            // 4. Cause validator resource exhaustion
        }
        Err(e) => println!("Connection failed: {}", e),
    }
}
```

**Demonstration Steps**:
1. Run `cargo run --bin aptos-node -- --test --test-dir /tmp/aptos-test`
2. Note the printed fullnode network endpoint (e.g., `/ip4/0.0.0.0/tcp/6181`)
3. From another machine on the same network, run the PoC to establish connection
4. Send repeated mempool transactions to cause resource consumption

**Notes**

This vulnerability exists specifically in test mode and is partially mitigated by the existing WARNING message. However, the warning does not explicitly mention the network exposure risk. In production deployments, validators should:
- Use proper firewall rules restricting fullnode network access to trusted VFN nodes only
- Enable mutual authentication on VFN networks
- Configure rate limiting on public-facing endpoints

The issue demonstrates that security-critical defaults should assume hostile network environments even in test/development modes, as developers may not always run test nodes in isolated environments.

### Citations

**File:** crates/aptos-genesis/src/builder.rs (L597-604)
```rust
        let fullnode_network = NetworkConfig {
            listen_address: fullnode_network_listen_address,
            network_id: NetworkId::Public,
            max_outbound_connections: 0,
            discovery_method: DiscoveryMethod::Onchain,
            identity: Identity::from_file(vfn_identity_path.clone()),
            ..Default::default()
        };
```

**File:** config/src/config/network_config.rs (L117-119)
```rust
    pub inbound_rate_limit_config: Option<RateLimitConfig>,
    /// Outbound rate limiting configuration, if not specified, no rate limiting
    pub outbound_rate_limit_config: Option<RateLimitConfig>,
```

**File:** config/src/config/network_config.rs (L135-136)
```rust
    pub fn network_with_id(network_id: NetworkId) -> NetworkConfig {
        let mutual_authentication = network_id.is_validator_network();
```

**File:** config/src/utils.rs (L211-218)
```rust
pub fn get_available_port_in_multiaddr(is_ipv4: bool) -> NetworkAddress {
    let ip_proto = if is_ipv4 {
        Protocol::Ip4("0.0.0.0".parse().unwrap())
    } else {
        Protocol::Ip6("::1".parse().unwrap())
    };
    NetworkAddress::from_protocols(vec![ip_proto, Protocol::Tcp(get_available_port())]).unwrap()
}
```

**File:** network/builder/src/builder.rs (L171-175)
```rust
        let authentication_mode = if config.mutual_authentication {
            AuthenticationMode::Mutual(identity_key)
        } else {
            AuthenticationMode::MaybeMutual(identity_key)
        };
```

**File:** network/framework/src/peer_manager/builder.rs (L37-46)
```rust
pub enum AuthenticationMode {
    /// Inbound connections will first be checked against the known peers set, and
    /// if the `PeerId` is known it will be authenticated against it's `PublicKey`
    /// Otherwise, the incoming connections will be allowed through in the common
    /// pool of unknown peers.
    MaybeMutual(x25519::PrivateKey),
    /// Both dialer and listener will verify public keys of each other in the
    /// handshake.
    Mutual(x25519::PrivateKey),
}
```

**File:** aptos-node/src/network.rs (L360-388)
```rust
        // Register mempool (both client and server) with the network
        let mempool_network_handle = register_client_and_service_with_network(
            &mut network_builder,
            network_id,
            &network_config,
            mempool_network_configuration(node_config),
            true,
        );
        mempool_network_handles.push(mempool_network_handle);

        // Register the peer monitoring service (both client and server) with the network
        let peer_monitoring_service_network_handle = register_client_and_service_with_network(
            &mut network_builder,
            network_id,
            &network_config,
            peer_monitoring_network_configuration(node_config),
            true,
        );
        peer_monitoring_service_network_handles.push(peer_monitoring_service_network_handle);

        // Register the storage service (both client and server) with the network
        let storage_service_network_handle = register_client_and_service_with_network(
            &mut network_builder,
            network_id,
            &network_config,
            storage_service_network_configuration(node_config),
            true,
        );
        storage_service_network_handles.push(storage_service_network_handle);
```
