# Audit Report

## Title
Workspace Isolation Bypass via Environment Variable Enables Arbitrary File Read and Information Disclosure

## Summary
The hidden Workspace command fails to properly isolate file operations. An attacker can exploit the `INSTALL_KEYLESS_GROTH16_VK_FROM_PATH` environment variable to force the workspace to read arbitrary files from the filesystem, bypassing intended workspace directory restrictions. For files containing valid JSON, the entire content is printed to stdout, enabling information disclosure of sensitive files.

## Finding Description

The Workspace command is designed to operate within an isolated temporary directory for running local Aptos network services. However, during node initialization, the system checks for environment variables that control keyless verification key loading without validating that file paths remain within the workspace boundaries.

**Attack Flow:**

1. The hidden Workspace command is invoked via `aptos workspace run` [1](#0-0) 

2. The workspace creates a secure temporary directory and starts a node [2](#0-1) 

3. Node initialization calls `create_single_node_test_config` which builds genesis configuration [3](#0-2) 

4. During genesis initialization, the code unconditionally checks the `INSTALL_KEYLESS_GROTH16_VK_FROM_PATH` environment variable and reads any file path specified without validation [4](#0-3) 

5. If the file content is valid JSON, it is printed in its entirety to stdout via `println!` [5](#0-4) 

**Security Guarantees Broken:**

- **Workspace Isolation**: Operations should be confined to the temporary workspace directory, but arbitrary filesystem reads occur outside this boundary
- **Access Control**: Unauthorized access to files that should not be accessible to the workspace process
- **Information Disclosure**: File contents are exposed through stdout when they contain valid JSON

## Impact Explanation

This vulnerability qualifies as **HIGH severity** under the Aptos bug bounty program for the following reasons:

1. **Significant Protocol Violation**: The workspace isolation guarantee is completely bypassed, allowing operations outside intended boundaries

2. **Unauthorized File Access**: Attackers can read any file on the system that the Aptos CLI process has permissions to access, including:
   - Configuration files containing credentials
   - Private keys and certificates
   - Database files
   - Other sensitive system files

3. **Information Disclosure**: For files containing valid JSON (common for configuration files), the complete file contents are printed to stdout, enabling direct exfiltration

4. **Low Attack Complexity**: Exploitation requires only:
   - Setting an environment variable (standard capability for CLI users)
   - Running a single CLI command
   - No special privileges or validator access needed

While this does not directly lead to consensus violations or fund theft, it represents a serious security boundary violation that could facilitate other attacks or expose sensitive operational data.

## Likelihood Explanation

**Likelihood: HIGH**

The vulnerability is highly likely to be exploited for several reasons:

1. **Trivial Exploitation**: Only requires setting an environment variable and running a command
2. **No Authentication Required**: Any user with CLI access can exploit it
3. **Hidden Command**: While marked as hidden, the command is still accessible and could be discovered through help text or code inspection
4. **Common Attack Vector**: Environment variable manipulation is a well-known attack technique
5. **Useful for Reconnaissance**: Attackers often seek configuration files and credentials as first-stage attacks

The main limiting factor is that the workspace command may not be widely used in production environments, but in development or testing scenarios where it's more common, the risk is significant.

## Recommendation

**Immediate Fix:**

1. **Remove environment variable file reading** or implement strict path validation:

```rust
if let Ok(path) = env::var("INSTALL_KEYLESS_GROTH16_VK_FROM_PATH") {
    // Validate that path is within allowed directories
    let canonical_path = std::fs::canonicalize(&path)
        .context("Failed to resolve verification key path")?;
    
    // Ensure path doesn't escape workspace boundaries
    if !canonical_path.starts_with("/allowed/base/path") {
        anyhow::bail!("Verification key path outside allowed directory: {:?}", canonical_path);
    }
    
    let file_content = fs::read_to_string(&canonical_path)
        .context("Failed to read verification key file")?;
    // ... rest of code
}
```

2. **Remove the debug println** that exposes file contents [5](#0-4) 

Replace with appropriate logging that doesn't expose sensitive data:
```rust
// Instead of printing full JSON, just log that VK was loaded
info!("Loaded Groth16 verification key from environment variable");
```

3. **Restrict workspace command usage**: Consider removing the workspace command entirely or requiring explicit opt-in flags to reduce attack surface

4. **Implement workspace sandbox**: Use proper sandboxing mechanisms (chroot, containers, etc.) to enforce filesystem isolation at the OS level

## Proof of Concept

```bash
#!/bin/bash
# PoC: Arbitrary File Read via Workspace Command

# Create a test JSON file to read (simulating sensitive config)
echo '{
  "data": {
    "alpha_g1": "0x1234",
    "beta_g2": "0x5678",
    "gamma_g2": "0x9abc",
    "delta_g2": "0xdef0",
    "gamma_abc_g1": ["0x1111", "0x2222"]
  }
}' > /tmp/sensitive_config.json

# Set environment variable to point to the file
export INSTALL_KEYLESS_GROTH16_VK_FROM_PATH=/tmp/sensitive_config.json

# Run the workspace command - file contents will be printed to stdout
aptos workspace run --timeout 5

# Expected output will include:
# "Loading verification key from JSON:"
# followed by the complete contents of /tmp/sensitive_config.json

# Cleanup
rm /tmp/sensitive_config.json
```

**Attack Scenario for Real Target:**
```bash
# Attempt to read SSH private key (if it happens to be in JSON format)
export INSTALL_KEYLESS_GROTH16_VK_FROM_PATH=/home/user/.ssh/config_as_json

# Or read database credentials
export INSTALL_KEYLESS_GROTH16_VK_FROM_PATH=/etc/aptos/db_config.json

# Or read other configuration files
export INSTALL_KEYLESS_GROTH16_VK_FROM_PATH=/var/aptos/node_config.json

aptos workspace run --timeout 5
# Contents are printed to stdout if valid JSON
```

## Notes

- The vulnerability exists in the node initialization code that is shared between the workspace command and regular node startup
- The environment variables `ENABLE_KEYLESS_DEFAULT` and `INSTALL_KEYLESS_GROTH16_VK_FROM_URL` also exist but pose less direct risk (URL loading and hardcoded devnet endpoint respectively)
- The issue could affect any code path that calls `create_single_node_test_config`, not just the workspace command
- Mitigation should ensure all file operations respect workspace boundaries and don't expose sensitive data through logging or error messages

### Citations

**File:** crates/aptos/src/lib.rs (L55-56)
```rust
    #[clap(subcommand, hide(true))]
    Workspace(WorkspaceCommand),
```

**File:** aptos-move/aptos-workspace-server/src/lib.rs (L93-95)
```rust
    let test_dir = tempfile::tempdir()?;
    let test_dir = test_dir.path();
    no_panic_println!("Created test directory: {}", test_dir.display());
```

**File:** aptos-node/src/lib.rs (L294-303)
```rust
pub fn load_node_config<R>(
    config_path: &Option<PathBuf>,
    test_config_override_path: &Option<PathBuf>,
    test_dir: &Path,
    random_ports: bool,
    enable_lazy_mode: bool,
    enable_performance_mode: bool,
    framework: &ReleaseBundle,
    rng: R,
) -> anyhow::Result<NodeConfig>
```

**File:** aptos-node/src/lib.rs (L609-613)
```rust
            if let Ok(path) = env::var("INSTALL_KEYLESS_GROTH16_VK_FROM_PATH") {
                let file_content = fs::read_to_string(&path).unwrap_or_else(|_| panic!("Failed to read verification key file: {}", path));
                let json: Value = serde_json::from_str(&file_content).expect("Failed to parse JSON");
                configure_keyless_with_vk(genesis_config, json).unwrap();
            };
```

**File:** aptos-node/src/lib.rs (L652-655)
```rust
    println!(
        "Loading verification key from JSON:\n{}",
        serde_json::to_string_pretty(&json).unwrap()
    );
```
