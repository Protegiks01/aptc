# Audit Report

## Title
Gas Metering Bypass in View Function Argument Construction with Eager Loading

## Summary
View functions fail to properly meter gas for constructor function executions during argument construction when the lazy loading feature flag is disabled, allowing expensive operations to execute without gas accounting.

## Finding Description

The `execute_view_function` in `aptos_vm.rs` creates a production gas meter with a specified `max_gas_amount` limit to prevent resource exhaustion from view function calls. However, argument construction for view functions with complex struct parameters bypasses gas metering under specific conditions. [1](#0-0) 

When the lazy loading feature flag is disabled (eager loading mode), the `validate_view_function` uses an `UnmeteredGasMeter` for argument construction instead of the production gas meter. This means constructor functions executed during argument parsing consume zero gas. [2](#0-1) 

Constructor functions are executed via `session.execute_loaded_function` during the `validate_and_construct` process. When called with `UnmeteredGasMeter`, these constructor executions bypass all gas accounting, allowing arbitrary Move bytecode to execute without consuming gas from the view function's limit.

**Attack Path:**
1. Attacker crafts a view function call with complex struct arguments requiring constructor functions
2. When lazy loading is disabled (non-default configuration), argument construction uses `UnmeteredGasMeter`
3. Constructor functions execute expensive operations (loops, cryptographic operations, storage reads) without gas metering
4. The `max_invocations` limit of 10 constrains recursion depth but not computational cost per constructor
5. Attacker can repeatedly call view functions to exhaust node resources [3](#0-2) 

## Impact Explanation

**Severity: High** (under non-default configuration)

This breaks the **Resource Limits** invariant: "All operations must respect gas, storage, and computational limits."

Impact includes:
- **Validator node slowdowns**: Unmetered constructor execution can consume excessive CPU
- **API crashes**: Resource exhaustion from repeated malicious view function calls
- **DoS on view function endpoints**: Attackers can make legitimate queries fail

The vulnerability affects view function execution, which does not modify blockchain state but is critical for querying data. While it cannot cause fund loss or consensus violations, it can degrade network accessibility.

## Likelihood Explanation

**Likelihood: LOW** in production

The lazy loading feature flag is **enabled by default** as confirmed in the default features list: [4](#0-3) 

When lazy loading is enabled (default), the production gas meter IS used for argument construction: [5](#0-4) 

**Exploitation requires:**
- Governance vote to disable the lazy loading feature flag (requires significant voting power/stake)
- OR deployment on private/test networks with lazy loading disabled

This does NOT meet the criterion of "exploitable by unprivileged attacker" in production configurations.

## Recommendation

Remove the conditional gas metering in `validate_view_function`. Always use the provided gas meter regardless of lazy loading configuration:

```rust
pub(crate) fn validate_view_function(
    session: &mut SessionExt<impl AptosMoveResolver>,
    loader: &impl Loader,
    gas_meter: &mut impl GasMeter,
    traversal_context: &mut TraversalContext,
    args: Vec<Vec<u8>>,
    fun_name: &IdentStr,
    func: &LoadedFunction,
    module_metadata: Option<&RuntimeModuleMetadataV1>,
    struct_constructors_feature: bool,
) -> PartialVMResult<Vec<Vec<u8>>> {
    // ... validation code ...
    
    // Always use the provided gas_meter, remove the conditional
    let result = transaction_arg_validation::construct_args(
        session,
        loader,
        gas_meter,  // Always meter, regardless of loading strategy
        traversal_context,
        func.param_tys(),
        args,
        func.ty_args(),
        allowed_structs,
        true,
    );
    
    result.map_err(|e| PartialVMError::new(e.status_code()))
}
```

## Proof of Concept

```rust
// PoC: Expensive constructor that would bypass gas metering with eager loading
module 0x1::attack {
    struct ExpensiveData has drop {
        value: u64
    }
    
    // Constructor that performs expensive computation
    public fun create_expensive(iterations: u64): ExpensiveData {
        let i = 0;
        let sum = 0;
        // Expensive loop that would not be metered with UnmeteredGasMeter
        while (i < iterations) {
            sum = sum + i * i;
            i = i + 1;
        };
        ExpensiveData { value: sum }
    }
    
    #[view]
    public fun view_with_expensive_arg(data: ExpensiveData): u64 {
        data.value
    }
}

// Attacker calls: view_with_expensive_arg with create_expensive(1000000)
// With eager loading + UnmeteredGasMeter: constructor executes without gas cost
// With lazy loading (default): constructor is properly metered
```

**Note:** This vulnerability FAILS the validation checklist requirement of "Exploitable by unprivileged attacker" because lazy loading is enabled by default in production. Exploitation requires governance action to disable the feature flag.

Given the strict validation criteria and the requirement for privileged governance action to enable exploitation, this finding may not qualify for the bug bounty program despite being a legitimate code flaw.

### Citations

**File:** aptos-move/aptos-vm/src/verifier/view_function.rs (L64-89)
```rust
    let result = if loader.is_lazy_loading_enabled() {
        transaction_arg_validation::construct_args(
            session,
            loader,
            gas_meter,
            traversal_context,
            func.param_tys(),
            args,
            func.ty_args(),
            allowed_structs,
            true,
        )
    } else {
        let traversal_storage = TraversalStorage::new();
        transaction_arg_validation::construct_args(
            session,
            loader,
            // No metering with eager loading.
            &mut UnmeteredGasMeter,
            &mut TraversalContext::new(&traversal_storage),
            func.param_tys(),
            args,
            func.ty_args(),
            allowed_structs,
            true,
        )
```

**File:** aptos-move/aptos-vm/src/verifier/transaction_arg_validation.rs (L289-289)
```rust
            let mut max_invocations = 10; // Read from config in the future
```

**File:** aptos-move/aptos-vm/src/verifier/transaction_arg_validation.rs (L503-511)
```rust
    let serialized_result = session.execute_loaded_function(
        function,
        args,
        gas_meter,
        traversal_context,
        loader,
        // No need to record the trace for argument construction.
        &mut NoOpTraceRecorder,
    )?;
```

**File:** types/src/on_chain_config/aptos_features.rs (L266-266)
```rust
            FeatureFlag::ENABLE_LAZY_LOADING,
```
