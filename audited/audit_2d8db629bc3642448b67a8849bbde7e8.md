# Audit Report

## Title
VFN Network Bypass: Malicious Full Nodes Can Directly Connect to Validators Due to Weak Authentication

## Summary
Validators expose VFN (Validator Full Node) networks without mutual authentication by default, allowing arbitrary full nodes to discover validator addresses on-chain and connect directly to validators. This bypasses the intended VFN intermediary architecture, enabling malicious actors to overwhelm validators with connection requests and potentially deny service to legitimate VFNs.

## Finding Description

The Aptos network architecture is designed with a three-tier model: Public Full Nodes → Validator Full Nodes (VFNs) → Validators. The VFN layer is intended to act as an intermediary that shields validators from direct connections by arbitrary nodes. However, multiple design flaws in the network configuration and authentication logic allow this security boundary to be bypassed.

**Vulnerability Chain:**

1. **Weak Default Authentication**: VFN networks default to `mutual_authentication = false` because `NetworkId::Vfn` is not classified as a validator network. [1](#0-0) 

2. **Permissive Connection Policy**: When `mutual_authentication = false`, the network uses `MaybeMutual` authentication mode, which accepts **all inbound connections from any peer**. [2](#0-1) 

3. **Public Address Discovery**: Validator VFN addresses are published on-chain in the `ValidatorSet` resource via `fullnode_network_addresses()`, making them discoverable by any actor. [3](#0-2) 

4. **Direct Dial Permission**: The `upstream_roles()` function returns `[PeerRole::Validator]` for `RoleType::FullNode` on `NetworkId::Vfn`, explicitly allowing full nodes on VFN networks to dial validators. [4](#0-3) 

5. **Role Assignment Bypass**: Inbound connections to validators on the VFN network are automatically assigned `PeerRole::ValidatorFullNode` regardless of whether they are trusted. [5](#0-4) 

6. **No Eviction of Untrusted Peers**: The connectivity manager explicitly does **not** evict inbound `ValidatorFullNode` peers on non-mutual-authentication networks, even if they are not in the trusted peers set. [6](#0-5) 

**Attack Scenario:**

An attacker can:
1. Query the on-chain `ValidatorSet` to retrieve all validators' `fullnode_network_addresses`
2. Configure multiple malicious full nodes with `network_id: { private: "vfn" }`
3. Set seed addresses pointing to validator VFN endpoints
4. Launch these nodes, which will attempt direct connections to validators
5. Validators accept these connections (MaybeMutual mode) and assign them `ValidatorFullNode` role
6. Connections persist because they are not evicted from the non-mutual-auth network
7. Repeat with many malicious nodes to fill connection slots (max 100 inbound by default) [7](#0-6) 

This breaks the fundamental security invariant that validators should only accept connections from their authorized VFNs, not arbitrary network participants.

## Impact Explanation

This vulnerability qualifies as **High Severity** under the Aptos bug bounty program criteria:

- **Validator Node Slowdowns**: Malicious connections consume validator resources through connection establishment overhead, handshake processing, and ongoing connection maintenance. Each connection attempt requires cryptographic operations and network I/O.

- **Significant Protocol Violations**: The three-tier network architecture (PFN → VFN → Validator) is a fundamental security design. This bypass allows direct connections that were explicitly meant to be prevented, undermining the security model.

- **Denial of Service to Legitimate VFNs**: With a default limit of 100 inbound connections, attackers can occupy all connection slots, preventing legitimate VFNs from connecting. This could impact validator operations if VFNs are used for state sync or other critical functions.

- **Validator Performance Degradation**: Connection churn from repeated malicious connection attempts creates unnecessary load on validators, potentially affecting their ability to participate effectively in consensus.

While this does not directly compromise consensus safety (validators can still participate), it significantly degrades network availability and validator performance, meeting the High severity threshold.

## Likelihood Explanation

This vulnerability is **highly likely** to occur:

- **Trivial to Exploit**: Requires only standard node configuration changes (setting `network_id: { private: "vfn" }` and seed addresses)
- **No Special Permissions Required**: Any actor can spin up full nodes with arbitrary configurations
- **Public Information**: Validator VFN addresses are published on-chain for legitimate discovery
- **No Detection Required**: Attackers don't need to discover a vulnerability; the system is designed to accept these connections
- **Scalable Attack**: Can be automated and distributed across many nodes
- **Low Cost**: Running multiple lightweight nodes that only maintain connections requires minimal resources

The only barrier is that attackers need to understand the network configuration format, which is documented in public configuration files.

## Recommendation

Implement defense-in-depth measures to restore the VFN intermediary security layer:

**Primary Fix**: Enable mutual authentication by default for VFN networks:

```rust
// In config/src/config/network_config.rs, line ~136:
pub fn network_with_id(network_id: NetworkId) -> NetworkConfig {
    // VFN networks should also require mutual authentication
    let mutual_authentication = network_id.is_validator_network() 
        || network_id.is_vfn_network();
    // ... rest of configuration
}
```

**Secondary Fix**: Update the connectivity manager to evict untrusted peers on VFN networks:

```rust
// In network/framework/src/connectivity_manager/mod.rs, line ~492:
if !self.mutual_authentication
    && metadata.origin == ConnectionOrigin::Inbound
    && metadata.role == PeerRole::Unknown  // Only allow Unknown, not VFN
{
    None  // Don't evict Unknown peers
} else {
    Some(*peer_id)  // Evict untrusted peers including VFNs
}
```

**Additional Hardening**:
1. Add explicit checks to prevent untrusted peers from being assigned `PeerRole::ValidatorFullNode`
2. Implement connection rate limiting per source IP on VFN networks
3. Add monitoring/alerting for suspicious connection patterns on VFN networks
4. Document that VFN network addresses should be treated as semi-private (shared only with authorized VFNs)

## Proof of Concept

**Setup:**
1. Deploy a test validator with VFN network exposed
2. Configure a malicious full node with VFN network settings

**Malicious Node Configuration** (`malicious_node.yaml`):
```yaml
base:
  role: "full_node"

full_node_networks:
  - network_id:
      private: "vfn"  # Claim to be on VFN network
    discovery_method: "none"
    seeds:
      # Seed with validator's VFN address (obtained from on-chain data)
      <VALIDATOR_PEER_ID>:
        addresses:
          - "/ip4/<VALIDATOR_IP>/tcp/6181/noise-ik/<VALIDATOR_VFN_PUBKEY>/handshake/0"
        keys: [<VALIDATOR_VFN_PUBKEY>]
        role: "validator"  # Claim validator is upstream
    max_outbound_connections: 1
```

**Exploitation Steps:**
```bash
# 1. Query on-chain validator set to get VFN addresses
aptos node get-validator-set --profile mainnet

# 2. Extract fullnode_network_addresses for target validators

# 3. Launch malicious nodes
for i in {1..150}; do
    # Spawn nodes to exceed the 100 connection limit
    ./aptos-node -f malicious_node_${i}.yaml &
done

# 4. Monitor validator logs - will show:
# - Accepted connections from malicious peers
# - Malicious peers assigned ValidatorFullNode role
# - Connections NOT evicted despite not being in trusted peers

# 5. Legitimate VFNs will experience connection failures
# when attempting to connect to the validator
```

**Expected Observable Impact:**
- Validator connection slots fill up with malicious peers
- Legitimate VFN connection attempts fail or timeout
- Validator CPU usage increases from connection handling
- Validator logs show many unknown ValidatorFullNode connections

This PoC demonstrates that the vulnerability is exploitable with standard node configuration and publicly available information, requiring no special privileges or insider knowledge.

---

**Notes:**

The vulnerability stems from a mismatch between the intended security architecture (VFNs as trusted intermediaries) and the implementation (VFN networks accepting arbitrary connections). The comment at line 493 of `connectivity_manager/mod.rs` acknowledges this: `"TODO: We should prevent Unknown from discovery sources"`, suggesting the developers were aware of the broader issue but may not have fully addressed it for VFN networks specifically.

### Citations

**File:** config/src/config/network_config.rs (L44-44)
```rust
pub const MAX_INBOUND_CONNECTIONS: usize = 100;
```

**File:** config/src/config/network_config.rs (L136-136)
```rust
        let mutual_authentication = network_id.is_validator_network();
```

**File:** network/framework/src/noise/handshake.rs (L95-98)
```rust
    /// In `MaybeMutual` mode, the dialer authenticates the server and the server will allow all
    /// inbound connections from any peer but will mark connections as `Trusted` if the incoming
    /// connection is apart of its trusted peers set.
    MaybeMutual(Arc<PeersAndMetadata>),
```

**File:** network/framework/src/noise/handshake.rs (L408-410)
```rust
                                if network_id.is_vfn_network() {
                                    // Inbound connections to validators on the VFN network must be VFNs
                                    Ok(PeerRole::ValidatorFullNode)
```

**File:** network/discovery/src/validator_set.rs (L121-129)
```rust
            let addrs = if is_validator {
                config
                    .validator_network_addresses()
                    .map_err(anyhow::Error::from)
            } else {
                config
                    .fullnode_network_addresses()
                    .map_err(anyhow::Error::from)
            }
```

**File:** config/src/network_id.rs (L181-185)
```rust
            NetworkId::Vfn => match role {
                RoleType::Validator => &[],
                RoleType::FullNode => &[PeerRole::Validator],
            },
        }
```

**File:** network/framework/src/connectivity_manager/mod.rs (L492-499)
```rust
                    // If we're using server only auth, we need to not evict unknown peers
                    // TODO: We should prevent `Unknown` from discovery sources
                    if !self.mutual_authentication
                        && metadata.origin == ConnectionOrigin::Inbound
                        && (metadata.role == PeerRole::ValidatorFullNode
                            || metadata.role == PeerRole::Unknown)
                    {
                        None
```
