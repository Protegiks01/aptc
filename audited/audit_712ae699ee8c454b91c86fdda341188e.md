# Audit Report

## Title
Indexer GraphQL API: Missing Documentation and Enforcement for Deleted Resource Filtering

## Summary
The Aptos Indexer's `move_resources` table stores both active (`is_deleted=false`) and deleted (`is_deleted=true`) resources without providing documented guidance or enforced filtering mechanisms for applications querying active resources. This creates a data quality issue where applications may inadvertently include deleted resources in their results.

## Finding Description

The `from_delete_resource()` function in the indexer marks deleted resources with `is_deleted=true`: [1](#0-0) 

These records are inserted into the `move_resources` table alongside active resources: [2](#0-1) 

The GraphQL API (Hasura) exposes this table with minimal column permissions for anonymous users, exposing only `address` and `transaction_version` - not even including `is_deleted`: [3](#0-2) 

The `move_resources_view` includes the `is_deleted` field but provides no automatic filtering: [4](#0-3) 

Similarly, the `address_version_from_move_resources` view does not filter deleted resources: [5](#0-4) 

No documentation warns developers to filter `WHERE is_deleted = false` when querying for active resources.

## Impact Explanation

This issue is correctly classified as **Low Severity** because:

1. **No Consensus or VM Impact**: The blockchain's core consensus, execution, and state management remain unaffected. This is purely an indexer API data presentation issue.

2. **No Direct Financial Loss**: Applications cannot lose funds or manipulate balances through this issue. The primary REST API (which queries live blockchain state) returns only current resources and is unaffected.

3. **Limited to Data Quality**: The impact is confined to applications potentially displaying stale or deleted resources to users, causing confusion rather than security harm.

4. **No Invariant Violations**: None of the 10 critical Aptos invariants (deterministic execution, consensus safety, Move VM safety, state consistency, etc.) are violated.

This falls under the bug bounty's "Low Severity" category as a "Non-critical implementation bug" affecting data presentation quality rather than security.

## Likelihood Explanation

**High Likelihood of Occurrence** but **Low Security Impact**:

- Developers using the indexer GraphQL API without blockchain expertise may naturally assume all returned resources are active
- No code examples or API documentation demonstrate proper filtering
- The Hasura permissions don't even expose `is_deleted` to anonymous users, preventing proper filtering in some contexts
- However, sophisticated applications typically use multiple data sources and would notice discrepancies

## Recommendation

**Short-term fixes:**

1. **Add comprehensive documentation** to the indexer README and API documentation explicitly stating that `move_resources` contains historical data including deleted resources, with query examples showing proper filtering:

```markdown
### Querying Active Move Resources

The `move_resources` table contains both active and deleted resources. 
Always filter by `is_deleted = false` to retrieve only active resources:

```graphql
query GetActiveResources($address: String!) {
  move_resources(
    where: {
      address: {_eq: $address},
      is_deleted: {_eq: false}
    }
  ) {
    address
    type
    module
    name
    data
  }
}
```
```

2. **Update Hasura permissions** to expose the `is_deleted` column to anonymous users, allowing them to filter properly.

3. **Create a convenience view** `current_move_resources` that automatically filters out deleted resources, similar to how `current_objects` and `current_coin_balances` work.

**Long-term architectural improvement:**

Create a materialized view or separate table for current resources:

```sql
CREATE MATERIALIZED VIEW current_move_resources AS
SELECT DISTINCT ON (address, module, name)
  address,
  module, 
  name,
  type_,
  data,
  generic_type_params,
  state_key_hash,
  transaction_version as last_transaction_version,
  transaction_block_height as last_transaction_block_height
FROM move_resources
WHERE is_deleted = false
ORDER BY address, module, name, transaction_version DESC;

CREATE INDEX current_mr_lookup ON current_move_resources(address, module, name);
```

## Proof of Concept

This is a documentation and API design gap rather than an exploitable vulnerability, so a traditional "exploit" PoC is not applicable. However, the issue can be demonstrated with a GraphQL query:

**Query that returns deleted resources (incorrect usage):**
```graphql
query GetAllResources($address: String!) {
  move_resources(where: {address: {_eq: $address}}) {
    address
    transaction_version
  }
}
```

**Correct query with proper filtering:**
```graphql  
query GetActiveResources($address: String!) {
  move_resources(
    where: {
      address: {_eq: $address},
      is_deleted: {_eq: false}
    }
  ) {
    address
    transaction_version
    is_deleted
  }
}
```

The first query will return both active and deleted resources without warning, potentially confusing applications into treating deleted resources as active.

---

## Notes

**Why this is Low severity and not higher:**

- The REST API at `/accounts/{address}/resources` queries live blockchain state and is unaffected
- The indexer is explicitly documented as a historical data source for complex queries
- Applications using the indexer for critical financial decisions should (and typically do) validate against the primary REST API
- Similar patterns exist elsewhere (e.g., `current_objects` table has `is_deleted` field requiring manual filtering)
- No blockchain consensus, state consistency, or fund security is compromised

This issue represents a **documentation and API usability gap** rather than a critical security vulnerability. It aligns with the original question's Low severity classification.

### Citations

**File:** crates/indexer/src/models/move_resources.rs (L58-78)
```rust
    pub fn from_delete_resource(
        delete_resource: &DeleteResource,
        write_set_change_index: i64,
        transaction_version: i64,
        transaction_block_height: i64,
    ) -> Self {
        let parsed_data = Self::convert_move_struct_tag(&delete_resource.resource);
        Self {
            transaction_version,
            transaction_block_height,
            write_set_change_index,
            type_: delete_resource.resource.to_string(),
            name: parsed_data.name.clone(),
            address: standardize_address(&delete_resource.address.to_string()),
            module: parsed_data.module.clone(),
            generic_type_params: parsed_data.generic_type_params,
            data: None,
            is_deleted: true,
            state_key_hash: standardize_address(delete_resource.state_key_hash.as_str()),
        }
    }
```

**File:** crates/indexer/migrations/2022-08-08-043603_core_tables/up.sql (L262-279)
```sql
CREATE TABLE move_resources (
  transaction_version BIGINT NOT NULL,
  write_set_change_index BIGINT NOT NULL,
  transaction_block_height BIGINT NOT NULL,
  name TEXT NOT NULL,
  address VARCHAR(66) NOT NULL,
  type TEXT NOT NULL,
  module TEXT NOT NULL,
  generic_type_params jsonb,
  data jsonb,
  is_deleted BOOLEAN NOT NULL,
  inserted_at TIMESTAMP NOT NULL DEFAULT NOW(),
  -- Constraints
  PRIMARY KEY (transaction_version, write_set_change_index),
  CONSTRAINT fk_transaction_versions FOREIGN KEY (transaction_version) REFERENCES transactions (version)
);
CREATE INDEX mr_addr_mod_name_ver_index ON move_resources (address, module, name, transaction_version);
CREATE INDEX mr_insat_index ON move_resources (inserted_at);
```

**File:** crates/aptos-localnet/src/hasura_metadata.json (L555-568)
```json
            "select_permissions": [
              {
                "role": "anonymous",
                "permission": {
                  "columns": [
                    "address",
                    "transaction_version"
                  ],
                  "filter": {},
                  "limit": 100,
                  "allow_aggregations": true
                }
              }
            ]
```

**File:** crates/indexer/migrations/2022-10-04-073529_add_coin_tables/up.sql (L2-14)
```sql
CREATE VIEW move_resources_view AS
SELECT transaction_version,
  write_set_change_index,
  transaction_block_height,
  name,
  address,
  "type",
  "module",
  generic_type_params,
  data#>>'{}' as json_data,
  is_deleted,
  inserted_at
FROM move_resources;
```

**File:** crates/indexer/migrations/2023-04-14-033932_optimize_queries/up.sql (L10-15)
```sql
CREATE OR REPLACE VIEW address_version_from_move_resources AS
SELECT address,
  transaction_version
FROM move_resources
GROUP BY 1,
  2;
```
