# Audit Report

## Title
Account Creation Fee Bypass Through Zero Gas Price Configuration

## Summary
The `hack_account_creation_fee_lower_bound()` validation can be completely bypassed when `gas_unit_price = 0` and the `DEFAULT_ACCOUNT_RESOURCE` feature flag is enabled, allowing free account creation without paying storage fees. However, this vulnerability is only exploitable in testing/development environments or if governance explicitly sets `min_price_per_gas_unit` to 0.

## Finding Description

A three-layer bypass mechanism exists that circumvents account creation fees:

**Layer 1: Storage Fee Charging Bypass** [1](#0-0) 

When `gas_unit_price` is zero, storage fees are never chargedâ€”the function returns immediately with 0 fees. The inline comment acknowledges this is a "hack" for tests.

**Layer 2: Prologue Validation Bypass** [2](#0-1) 

The condition at line 219 skips account creation fee validation when `gas_unit_price == 0` AND `is_default_account_resource_enabled()` returns true (enabled by default).

**Layer 3: Epilogue Validation Bypass** [3](#0-2) 

The same bypass condition at line 762 allows the `hack_account_creation_fee_lower_bound()` check to be skipped entirely in `finish_aborted_transaction()`.

**Attack Flow:**
1. Attacker sets `gas_unit_price = 0` in transaction
2. Transaction passes prologue validation (bypass at gas.rs:219)
3. Transaction executes and aborts
4. `finish_aborted_transaction()` is invoked
5. Account is created via `create_account_if_does_not_exist` (aptos_vm.rs:713-739)
6. `charge_change_set()` returns `storage_fee = 0` due to bypass in traits.rs:171-173
7. Fee validation is skipped due to bypass at aptos_vm.rs:762
8. Account created without paying required storage fees

**Critical Dependency:** [4](#0-3) 

In production, `min_price_per_gas_unit = 100`, preventing users from setting `gas_unit_price = 0`. In testing mode, it's set to 0, making this vulnerability exploitable.

## Impact Explanation

**Current Impact: Low/None in Production**
- Not exploitable in production due to `min_price_per_gas_unit = 100`
- Unprivileged users cannot submit transactions with zero gas price

**Potential Impact if Configuration Changes: Critical**
If governance sets `min_price_per_gas_unit = 0`:
- Unlimited free account creation without storage fees
- State bloat through mass account creation
- Economic model violation (breaks invariant: "All operations must respect gas, storage, and computational limits")
- Potential consensus issues if storage exhaustion affects validator nodes

This would qualify as **Critical Severity** per Aptos bounty criteria due to economic protocol violation and potential network impact.

## Likelihood Explanation

**Current Likelihood: Very Low**
- Requires governance to set `min_price_per_gas_unit = 0` 
- Production default is 100, which blocks this attack
- No evidence governance would intentionally set this to 0

**Exploitable in:**
- Testing/development environments (where `min_price_per_gas_unit = 0` by default)
- Any network where governance misconfigures gas parameters

The TODO comment in the codebase acknowledges this is a testing hack that should be revisited, indicating developers are aware of the risk.

## Recommendation

**Option 1: Remove the Zero Gas Price Bypass (Recommended)**
Remove the early return in `process_storage_fee_for_all`:

```rust
// In aptos-move/aptos-gas-meter/src/traits.rs
fn process_storage_fee_for_all(...) -> VMResult<Fee> {
    if self.feature_version() < 7 {
        return Ok(0.into());
    }
    
    // REMOVE THIS BLOCK:
    // if gas_unit_price.is_zero() {
    //     return Ok(0.into());
    // }
    
    let pricing = self.disk_space_pricing();
    // ... continue with normal fee processing
}
```

And enforce the validation checks unconditionally:

```rust
// In aptos-move/aptos-vm/src/aptos_vm.rs, line 762
// Change from:
if gas_unit_price != 0 || !self.features().is_default_account_resource_enabled() {

// To:
if true {  // Always perform validation
    // ... validation logic
}
```

**Option 2: Enforce Minimum Gas Price**
Ensure `min_price_per_gas_unit` can never be set below a safe threshold (e.g., 1) through governance, adding validation in gas schedule updates.

## Proof of Concept

```rust
// Test case demonstrating the bypass (would pass in testing environment)
#[test]
fn test_free_account_creation_with_zero_gas_price() {
    // Setup: testing environment where min_price_per_gas_unit = 0
    let mut harness = MoveHarness::new();
    
    // Create sender account with some funds
    let sender = AccountAddress::random();
    harness.new_account_at(sender);
    
    // Create transaction with ZERO gas price
    let new_account = AccountAddress::random();
    let txn = harness
        .create_entry_function(
            &sender,
            str::parse("0x1::account::create_account").unwrap(),
            vec![],
            vec![bcs::to_bytes(&new_account).unwrap()],
        )
        .gas_unit_price(0)  // Zero gas price
        .max_gas_amount(1000)
        .sequence_number(0);
    
    // Execute and abort (or succeed)
    let result = harness.run(txn);
    
    // Verify: Account was created without paying storage fees
    assert!(harness.read_account_resource(&new_account).is_some());
    
    // Verify: No storage fees were charged
    let fee_statement = result.fee_statement();
    assert_eq!(fee_statement.storage_fee_used(), 0);
}
```

## Notes

This vulnerability demonstrates a defense-in-depth failure where security relies solely on a configuration parameter (`min_price_per_gas_unit`). While not currently exploitable in production, it represents:

1. **Technical Debt**: The TODO comment acknowledges this is a hack
2. **Configuration Risk**: Single parameter change enables the vulnerability  
3. **Testing Environment Risk**: Exploitable wherever `min_price_per_gas_unit = 0`

The bypass logic should be removed to ensure account creation fees are enforced unconditionally, regardless of gas price configuration.

### Citations

**File:** aptos-move/aptos-gas-meter/src/traits.rs (L168-173)
```rust
        // TODO(Gas): right now, some of our tests use a unit price of 0 and this is a hack
        // to avoid causing them issues. We should revisit the problem and figure out a
        // better way to handle this.
        if gas_unit_price.is_zero() {
            return Ok(0.into());
        }
```

**File:** aptos-move/aptos-vm/src/gas.rs (L214-246)
```rust
    if crate::aptos_vm::should_create_account_resource(
        txn_metadata,
        features,
        resolver,
        module_storage,
    )? && (gas_unit_price != 0 || !features.is_default_account_resource_enabled())
    {
        let max_gas_amount: u64 = txn_metadata.max_gas_amount().into();
        let pricing = DiskSpacePricing::new(gas_feature_version, features);
        let storage_fee_per_account_create: u64 = pricing
            .hack_estimated_fee_for_account_creation(txn_gas_params)
            .into();

        let expected = gas_unit_price * 10
            + if features.is_new_account_default_to_fa_store() {
                1
            } else {
                2
            } * storage_fee_per_account_create;
        let actual = gas_unit_price * max_gas_amount;
        if actual < expected {
            speculative_warn!(
                log_context,
                format!(
                    "[VM] Insufficient gas for account creation; min {}, submitted {}",
                    expected, actual,
                ),
            );
            return Err(VMStatus::error(
                StatusCode::MAX_GAS_UNITS_BELOW_MIN_TRANSACTION_GAS_UNITS,
                None,
            ));
        }
```

**File:** aptos-move/aptos-vm/src/aptos_vm.rs (L759-785)
```rust
            // Verify we charged sufficiently for creating an account slot
            let gas_params = self.gas_params(log_context)?;
            let gas_unit_price = u64::from(txn_data.gas_unit_price());
            if gas_unit_price != 0 || !self.features().is_default_account_resource_enabled() {
                let gas_used = fee_statement.gas_used();
                let storage_fee = fee_statement.storage_fee_used();
                let storage_refund = fee_statement.storage_fee_refund();

                let actual = gas_used * gas_unit_price + storage_fee - storage_refund;
                let expected = u64::from(
                    gas_meter
                        .disk_space_pricing()
                        .hack_account_creation_fee_lower_bound(&gas_params.vm.txn),
                );
                if actual < expected {
                    expect_only_successful_execution(
                        PartialVMError::new(StatusCode::UNKNOWN_INVARIANT_VIOLATION_ERROR)
                            .with_message(
                                "Insufficient fee for storing account for lazy account creation"
                                    .to_string(),
                            )
                            .finish(Location::Undefined),
                        &format!("{:?}::{}", ACCOUNT_MODULE, CREATE_ACCOUNT_IF_DOES_NOT_EXIST),
                        log_context,
                    )?;
                }
            }
```

**File:** config/global-constants/src/lib.rs (L23-26)
```rust
#[cfg(any(test, feature = "testing"))]
pub const GAS_UNIT_PRICE: u64 = 0;
#[cfg(not(any(test, feature = "testing")))]
pub const GAS_UNIT_PRICE: u64 = 100;
```
