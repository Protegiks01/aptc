# Audit Report

## Title
Unauthenticated Validator Set Enumeration via Inspection Service Enables Coordinated Network Partitioning Attacks

## Summary
The Aptos inspection service exposes a `/peer_information` endpoint that, by default configuration, publicly reveals the complete validator set topology including peer IDs, network addresses, public keys, and node roles without any authentication. This enables attackers to enumerate all validators, distinguish them from fullnodes, and plan coordinated network partitioning attacks such as targeted DDoS or eclipse attacks against specific validators.

## Finding Description

The vulnerability stems from three critical configuration weaknesses:

**1. Default Configuration Exposure:**
The `InspectionServiceConfig` defaults enable public exposure of sensitive peer information: [1](#0-0) 

The service binds to `0.0.0.0:9101` by default, making it accessible from any network interface, and both `expose_identity_information` and `expose_peer_information` are set to `true` by default.

**2. Config Sanitizer Gap:**
The configuration sanitizer only prevents mainnet validators from exposing the `/configuration` endpoint, but does NOT prevent them from exposing the more sensitive `/peer_information` or `/identity_information` endpoints: [2](#0-1) 

This means mainnet validators can run with `expose_peer_information: true` (the default) and pass all validation checks.

**3. Complete Validator Set Disclosure:**
The `/peer_information` endpoint explicitly exposes the entire trusted peer set (validator set) with complete topology information: [3](#0-2) 

For each trusted peer (validator), the endpoint reveals:
- Peer ID (unique identifier)
- Network addresses (IP addresses and ports)
- Public keys (x25519::PublicKey)
- **Node role** (Validator, ValidatorFullNode, etc.)

The `Peer` struct contains all this information: [4](#0-3) 

The `PeerRole` enum explicitly identifies validators: [5](#0-4) 

**4. No Authentication Required:**
The inspection service has no authentication mechanism. Access control is purely configuration-based with no runtime authentication: [6](#0-5) 

**Attack Scenario:**

An attacker can:
1. Send `HTTP GET http://<validator-ip>:9101/peer_information` (no credentials needed)
2. Receive complete list of all validators with their network addresses and roles
3. Identify critical validators (by role: `PeerRole::Validator`)
4. Map the network topology and connectivity patterns
5. Launch coordinated attacks:
   - **Targeted DDoS**: Attack specific validators to degrade consensus performance
   - **Eclipse Attacks**: Partition validators from each other by targeting network paths
   - **Sybil Attacks**: Create fake peers mimicking discovered validator identities
   - **Connection Exhaustion**: Open connections to all validators simultaneously

This breaks the network security invariant that validator topology should not be publicly enumerable, enabling attackers to plan sophisticated network-layer attacks without requiring any insider knowledge.

## Impact Explanation

This vulnerability qualifies as **High Severity** under the Aptos bug bounty program criteria:

- **Validator node slowdowns**: Enables attackers to identify and target specific validators with DDoS attacks, causing consensus degradation
- **Significant protocol violations**: Exposes sensitive network topology that should be protected, violating defense-in-depth principles
- **Network partition enablement**: While not directly causing partition, this information disclosure is a prerequisite for coordinated partitioning attacks

The impact is amplified because:
- **Default configuration** means many validators may be exposed without operators realizing it
- **No authentication** means any internet user can enumerate the validator set
- **Complete information** provided (addresses, keys, roles) enables sophisticated targeted attacks
- **Mainnet applicability** due to the sanitizer gap

## Likelihood Explanation

**Likelihood: HIGH**

The vulnerability is highly likely to be exploitable because:

1. **Default Configuration**: Validators using default configuration are immediately vulnerable
2. **No Operator Action Required**: Simply accepting defaults enables the vulnerability
3. **Trivial Exploitation**: Attack requires only a single HTTP GET request
4. **No Special Skills**: No cryptographic knowledge or validator privileges needed
5. **Sanitizer Gap**: Mainnet validators can run with exposed endpoints and pass config validation
6. **Discovery**: Port 9101 can be easily discovered via port scanning
7. **No Rate Limiting**: The inspection service has no application-level rate limiting, allowing repeated enumeration

## Recommendation

Implement multiple defense layers:

**1. Update Config Sanitizer (CRITICAL):**
Extend the sanitizer to prevent mainnet validators from exposing sensitive endpoints:

```rust
impl ConfigSanitizer for InspectionServiceConfig {
    fn sanitize(
        node_config: &NodeConfig,
        node_type: NodeType,
        chain_id: Option<ChainId>,
    ) -> Result<(), Error> {
        let sanitizer_name = Self::get_sanitizer_name();
        let inspection_service_config = &node_config.inspection_service;

        // Verify that mainnet validators do not expose sensitive endpoints
        if let Some(chain_id) = chain_id {
            if node_type.is_validator() && chain_id.is_mainnet() {
                if inspection_service_config.expose_configuration {
                    return Err(Error::ConfigSanitizerFailed(
                        sanitizer_name,
                        "Mainnet validators should not expose the node configuration!".to_string(),
                    ));
                }
                
                // ADD THESE CHECKS:
                if inspection_service_config.expose_peer_information {
                    return Err(Error::ConfigSanitizerFailed(
                        sanitizer_name,
                        "Mainnet validators should not expose peer information!".to_string(),
                    ));
                }
                
                if inspection_service_config.expose_identity_information {
                    return Err(Error::ConfigSanitizerFailed(
                        sanitizer_name,
                        "Mainnet validators should not expose identity information!".to_string(),
                    ));
                }
            }
        }

        Ok(())
    }
}
```

**2. Change Default Configuration:**
Set safer defaults for production environments:

```rust
impl Default for InspectionServiceConfig {
    fn default() -> InspectionServiceConfig {
        InspectionServiceConfig {
            address: "127.0.0.1".to_string(), // Bind to localhost only
            port: 9101,
            expose_configuration: false,
            expose_identity_information: false, // Disable by default
            expose_peer_information: false,     // Disable by default
            expose_system_information: false,
        }
    }
}
```

**3. Add Authentication Layer:**
Implement authentication for sensitive endpoints (similar to the admin service's PasscodeSha256 authentication).

**4. Add Rate Limiting:**
Implement per-IP rate limiting on the inspection service to prevent enumeration attacks.

**5. Documentation:**
Update documentation to explicitly warn operators about the security implications of enabling these endpoints.

## Proof of Concept

**Step 1: Start a default-configured Aptos validator node**

The inspection service will bind to `0.0.0.0:9101` with `expose_peer_information: true` by default.

**Step 2: Enumerate the validator set**

```bash
# From any external machine with network access
curl http://<validator-ip>:9101/peer_information

# Expected output (excerpt):
# Trusted peers (validator set & seeds):
#   - Network: Validator
#       - Peer: <peer_id_1>, peer information: Peer { 
#           addresses: [/ip4/10.0.1.5/tcp/6180, ...], 
#           keys: {PublicKey(...)}, 
#           role: Validator 
#         }
#       - Peer: <peer_id_2>, peer information: Peer { 
#           addresses: [/ip4/10.0.1.6/tcp/6180, ...], 
#           keys: {PublicKey(...)}, 
#           role: Validator 
#         }
#   - Network: Public
#       - Peer: <peer_id_3>, peer information: Peer { 
#           addresses: [/ip4/10.0.2.1/tcp/6182, ...], 
#           keys: {PublicKey(...)}, 
#           role: ValidatorFullNode 
#         }
```

**Step 3: Parse and identify validators**

```python
import requests
import re

response = requests.get('http://<validator-ip>:9101/peer_information')
data = response.text

# Extract all Peer entries with role: Validator
validators = re.findall(r'Peer: (\w+).*?role: Validator[^F]', data, re.DOTALL)
validator_addresses = re.findall(r'/ip4/([\d.]+)/tcp/(\d+)', data)

print(f"Found {len(validators)} validators")
print(f"Validator addresses: {validator_addresses}")

# Now attacker can:
# - Launch coordinated DDoS against all identified validators
# - Plan eclipse attacks by targeting network paths
# - Monitor validator set changes over time
```

**Notes**
This vulnerability represents a critical information disclosure that breaks the defense-in-depth principle. While network-level DDoS attacks are out of scope per bug bounty rules, the information disclosure itself constitutes a significant protocol violation that enables attackers to plan targeted attacks. The combination of default-enabled exposure, lack of authentication, and config sanitizer gap makes this a high-severity issue requiring immediate remediation on mainnet validators.

### Citations

**File:** aptos-core-070/config/src/config/inspection_service_config.rs (L26-37)
```rust

```

**File:** aptos-core-070/config/src/config/inspection_service_config.rs (L45-68)
```rust

```

**File:** aptos-core-070/crates/aptos-inspection-service/src/server/peer_information.rs (L20-37)
```rust

```

**File:** aptos-core-070/crates/aptos-inspection-service/src/server/peer_information.rs (L273-300)
```rust

```

**File:** aptos-core-070/config/src/config/network_config.rs (L405-414)
```rust

```

**File:** aptos-core-070/config/src/config/network_config.rs (L458-464)
```rust

```
