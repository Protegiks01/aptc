# Audit Report

## Title
Critical Unit Conversion Error in Node Hardware Validator Allows Severely Under-Resourced Nodes to Pass Validation

## Summary
The hardware checker in `ecosystem/node-checker/src/checker/hardware.rs` contains a unit conversion bug that allows nodes with only 1/1000th of the required RAM (e.g., 31 MB instead of 31 GB) to pass validation checks. This occurs because the code assumes the `sysinfo` crate returns memory in kilobytes, but version 0.28.4 returns memory in bytes.

## Finding Description
The node hardware checker validates that nodes meet minimum resource requirements before joining the Aptos network. [1](#0-0) 

The configuration specifies RAM requirements in GB (not GiB). [2](#0-1) 

Memory information is collected via the `sysinfo` crate's `total_memory()` method. [3](#0-2) 

The codebase uses sysinfo version 0.28.4. [4](#0-3) 

**The critical bug occurs here:** [5](#0-4) 

The code multiplies `min_ram_gb` by `1_000_000` with a comment claiming this "converts from GB to KB", displaying the result as "KB". However, in sysinfo 0.20.0 and later (including 0.28.4), the `total_memory()` method returns memory in **bytes**, not kilobytes. This is a breaking change from earlier versions.

**The correct conversion should be:**
- GB to bytes: multiply by 1,000,000,000 (one billion)
- Current (incorrect): multiply by 1,000,000 (one million)

**Exploitation scenario:**
1. An attacker runs a validator node with only 31 MB of RAM
2. The node reports: `memory_total` = 31,000,000 bytes
3. Required minimum: 31 GB * 1,000,000 = 31,000,000 (treated as bytes in comparison)
4. Check: 31,000,000 >= 31,000,000 ✓ PASSES
5. The node joins the network despite having 1/1000th of required RAM
6. The severely under-resourced node crashes, hangs, or causes validator slowdowns

## Impact Explanation
This qualifies as **High Severity** under the Aptos bug bounty program category "Validator node slowdowns." 

Allowing validators with grossly insufficient RAM to join the network causes:
- **Validator Performance Degradation**: Nodes with 31 MB instead of 31 GB RAM will experience constant memory pressure, thrashing, and OOM kills
- **Network Reliability Impact**: Multiple under-resourced validators reduce overall network performance and consensus efficiency
- **Liveness Risks**: Validators that crash or become unresponsive due to insufficient resources can impact block production
- **Resource Limits Invariant Violation**: The system fails to enforce "all operations must respect computational limits" (Invariant #9)

While this doesn't directly cause consensus violations or fund loss, it significantly impacts network health and validator availability, meeting the High severity threshold.

## Likelihood Explanation
**Likelihood: High**

This bug will trigger automatically whenever:
1. Anyone runs the node-checker tool on a machine with insufficient RAM
2. The misconfigured node would pass validation despite not meeting requirements
3. No special privileges or insider access is required
4. The bug is deterministic and will consistently affect all node operators

The likelihood of exploitation (intentional or accidental) is high because:
- The hardware checker is commonly used for node setup
- Operators may not realize their nodes are under-resourced if the checker reports success
- Budget-constrained operators might deliberately use minimal hardware if it passes validation
- The 1000x discrepancy is large enough that even accidental misconfiguration will be accepted

## Recommendation
Fix the unit conversion to properly convert GB to bytes for comparison with `sysinfo` 0.28.4's byte-based memory reporting:

```rust
self.check_single_item(
    &target_information,
    MEMORY_TOTAL_KEY,
    self.config.min_ram_gb * 1_000_000_000, // Convert from GB to bytes
    "bytes",
),
```

Alternatively, if displaying KB is desired for readability, convert the reported bytes to KB before comparison:

```rust
// In check_single_item, convert the value_from_target from bytes to KB
let value_from_target_kb = value_from_target / 1_000;
// Then use the existing GB to KB conversion
self.config.min_ram_gb * 1_000_000
```

**Recommended approach:** Update to use bytes throughout for consistency with sysinfo 0.28.4 API, or add explicit documentation about expected units and conversion factors.

## Proof of Concept

**Test scenario demonstrating the bug:**

1. Create a mock system with 31 MB of RAM (31,000,000 bytes)
2. Configure hardware checker with default min_ram_gb = 31 (expecting 31 GB)
3. The check incorrectly passes because:
   - Actual: 31,000,000 bytes
   - Expected: 31 * 1,000,000 = 31,000,000 (should be 31,000,000,000)
   - Comparison: 31,000,000 >= 31,000,000 ✓ PASS (incorrect)

**Rust test case:**

```rust
#[test]
fn test_memory_validation_unit_bug() {
    // Simulate a system reporting 31 MB (in bytes, as sysinfo 0.28 does)
    let actual_memory_bytes = 31_000_000u64; // 31 MB
    
    // Current buggy conversion: GB to "KB" with 1_000_000 multiplier
    let min_ram_gb = 31u64;
    let buggy_minimum = min_ram_gb * 1_000_000; // = 31,000,000
    
    // This passes incorrectly!
    assert!(actual_memory_bytes >= buggy_minimum);
    
    // Correct conversion: GB to bytes with 1_000_000_000 multiplier
    let correct_minimum = min_ram_gb * 1_000_000_000; // = 31,000,000,000
    
    // This should fail (and does with correct conversion)
    assert!(actual_memory_bytes < correct_minimum);
    
    println!("Bug demonstrated: 31 MB passes as 31 GB due to 1000x unit error");
}
```

**Manual verification:**
1. Run a node with ~31 MB available RAM
2. Execute the node-checker hardware validation
3. Observe that it incorrectly reports sufficient RAM
4. The node will subsequently crash or perform poorly under load

### Citations

**File:** aptos-core-085/ecosystem/node-checker/src/checker/hardware.rs (L34-36)
```rust

```

**File:** aptos-core-085/ecosystem/node-checker/src/checker/hardware.rs (L44-46)
```rust

```

**File:** aptos-core-085/ecosystem/node-checker/src/checker/hardware.rs (L160-165)
```rust

```

**File:** aptos-core-085/crates/aptos-telemetry/src/system_information.rs (L148-148)
```rust

```

**File:** aptos-core-085/Cargo.toml (L810-810)
```text

```
