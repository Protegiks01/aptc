# Audit Report

## Title
Path Traversal Vulnerability in Backup Verification Tool - Arbitrary File Write via output_transaction_analysis Parameter

## Summary
The `output_transaction_analysis` parameter in the backup verification tool accepts user-provided file paths without any validation, sanitization, or canonicalization. This allows an attacker to write CSV analysis files to arbitrary locations on the file system, potentially compromising validator nodes or other systems running the backup verification tool.

## Finding Description
The vulnerability exists in the data flow from CLI argument parsing to file system operations: [1](#0-0) 

The `output_transaction_analysis` parameter is defined as an `Option<PathBuf>` that accepts any user-provided path without validation. This path is passed through the verification coordinator: [2](#0-1) 

And ultimately used in `TransactionAnalysis::new()` where it performs file system operations without any security checks: [3](#0-2) 

The critical security flaw is at line 46 where `std::fs::create_dir_all(output_dir)` is called directly on the user-provided path, and at line 62 where files are created using `output_dir.join(filename)`: [4](#0-3) 

An attacker can provide malicious paths containing traversal sequences like `../../../etc/malicious_dir` or absolute paths like `/tmp/attacker_controlled`. The tool will:
1. Create the specified directory structure (including all parent directories)
2. Write three CSV files (transaction.csv, event.csv, write_op.csv) to that location

**Comparison with Secure Code**: Other parts of the Aptos codebase properly validate paths. For example, in storage configuration: [5](#0-4) 

This validation pattern is completely absent from the `output_transaction_analysis` handling.

## Impact Explanation
This vulnerability qualifies as **High Severity** under the Aptos bug bounty program criteria:

1. **Validator Node Compromise**: If the backup verification tool runs with elevated privileges on validator nodes (common for operational tooling), an attacker could:
   - Write files to system directories
   - Overwrite configuration files by targeting predictable locations
   - Create directories in sensitive locations that could be used in subsequent attacks

2. **File System Manipulation**: The vulnerability allows:
   - Arbitrary directory creation anywhere the process has write permissions
   - Writing CSV files containing transaction analysis data to attacker-controlled locations
   - Potential data exfiltration by writing to network-mounted or shared file systems

3. **Attack Surface Expansion**: While the immediate write is limited to CSV files, the ability to create arbitrary directories could be chained with other vulnerabilities or misconfigurations.

This meets the **High Severity** criteria of "Validator node slowdowns" and "Significant protocol violations" as compromising the file system of validator infrastructure could lead to operational disruptions.

## Likelihood Explanation
**Likelihood: Medium to High**

- **Attack Complexity**: Low - requires only access to run the db-tool backup verify command with a malicious path parameter
- **Attacker Requirements**: Local or remote access to run the backup verification tool (common for operators, administrators, or automated systems)
- **Detection Difficulty**: High - path traversal in CLI tools is often overlooked, and the tool provides no warnings about dangerous paths
- **Exploitation Feasibility**: Immediate - no special conditions or race conditions required

The likelihood increases significantly if:
- The tool runs as part of automated backup verification scripts
- Multiple users have access to run the tool
- The tool runs with elevated privileges (sudo/root)

## Recommendation
Implement comprehensive path validation before using the `output_transaction_analysis` parameter:

```rust
// In storage/backup/backup-cli/src/backup_types/transaction/analysis.rs
// Add validation function:

fn validate_output_directory(path: &Path) -> Result<PathBuf> {
    // Require absolute paths
    ensure!(
        path.is_absolute(),
        "Output path must be an absolute path. Got: {:?}",
        path
    );
    
    // Canonicalize to resolve any symlinks or .. sequences
    let canonical_path = path.canonicalize()
        .or_else(|_| {
            // If path doesn't exist, canonicalize parent and join last component
            let parent = path.parent()
                .ok_or_else(|| anyhow!("Invalid path: no parent directory"))?;
            let filename = path.file_name()
                .ok_or_else(|| anyhow!("Invalid path: no filename"))?;
            Ok(parent.canonicalize()?.join(filename))
        })?;
    
    // Optional: Add allowlist validation
    // Ensure the path is within approved directories (e.g., /var/lib/aptos/backup)
    // if !canonical_path.starts_with("/var/lib/aptos/backup") {
    //     bail!("Output path must be within approved directory");
    // }
    
    Ok(canonical_path)
}

// Modify TransactionAnalysis::new() to use validation:
pub fn new(output_dir: &Path) -> Result<Self> {
    let validated_dir = validate_output_directory(output_dir)?;
    std::fs::create_dir_all(&validated_dir)?;
    let txn_writer = Self::open_csv_writer(&validated_dir, "transaction.csv")?;
    let event_writer = Self::open_csv_writer(&validated_dir, "event.csv")?;
    let write_op_writer = Self::open_csv_writer(&validated_dir, "write_op.csv")?;

    Ok(Self {
        txn_writer,
        event_writer,
        write_op_writer,
    })
}
```

## Proof of Concept

**Setup:**
```bash
# Create a test environment
mkdir -p /tmp/aptos_test/working_dir
cd /tmp/aptos_test/working_dir
```

**Exploit Command:**
```bash
# Attempt to write files outside intended directory using path traversal
aptos-node-db-tool backup verify \
  --metadata-cache-dir /tmp/aptos_test/cache \
  --storage-backend local \
  --local-fs-dir /path/to/backup/storage \
  --output-transaction-analysis "../../../tmp/attacker_controlled"
```

**Expected Result (Vulnerable):**
- Directory `/tmp/attacker_controlled` is created
- Files `transaction.csv`, `event.csv`, `write_op.csv` are written to `/tmp/attacker_controlled`

**Expected Result (After Fix):**
- Error: "Output path must be an absolute path"
- No files written outside intended directory

**Alternative PoC with Absolute Path:**
```bash
aptos-node-db-tool backup verify \
  --metadata-cache-dir /tmp/aptos_test/cache \
  --storage-backend local \
  --local-fs-dir /path/to/backup/storage \
  --output-transaction-analysis "/etc/aptos_malicious"
```

This would create `/etc/aptos_malicious` and write CSV files there if the process has sufficient permissions.

## Notes
- This vulnerability affects any deployment where the backup verification tool is accessible to potentially malicious users
- The impact is amplified if the tool runs with elevated privileges, which is common for system administration tools
- The lack of path validation is inconsistent with security patterns used elsewhere in the Aptos codebase (e.g., storage_config.rs)
- Defense-in-depth measures such as running the tool with minimal privileges and using filesystem restrictions (chroot, containers) would mitigate but not eliminate the vulnerability

### Citations

**File:** storage/db-tool/src/backup.rs (L160-165)
```rust
    #[clap(
        long,
        value_parser,
        help = "Optionally, while verifying transactions, output analysis files to specified dir."
    )]
    output_transaction_analysis: Option<PathBuf>,
```

**File:** storage/backup/backup-cli/src/coordinators/verify.rs (L49-61)
```rust
        output_transaction_analysis: Option<PathBuf>,
    ) -> Result<Self> {
        Ok(Self {
            storage,
            metadata_cache_opt,
            trusted_waypoints_opt,
            concurrent_downloads,
            start_version,
            end_version,
            state_snapshot_before_version,
            skip_epoch_endings,
            validate_modules,
            output_transaction_analysis,
```

**File:** storage/backup/backup-cli/src/backup_types/transaction/analysis.rs (L45-56)
```rust
    pub fn new(output_dir: &Path) -> Result<Self> {
        std::fs::create_dir_all(output_dir)?;
        let txn_writer = Self::open_csv_writer(output_dir, "transaction.csv")?;
        let event_writer = Self::open_csv_writer(output_dir, "event.csv")?;
        let write_op_writer = Self::open_csv_writer(output_dir, "write_op.csv")?;

        Ok(Self {
            txn_writer,
            event_writer,
            write_op_writer,
        })
    }
```

**File:** storage/backup/backup-cli/src/backup_types/transaction/analysis.rs (L58-65)
```rust
    fn open_csv_writer(output_dir: &Path, filename: &str) -> Result<csv::Writer<File>> {
        let file = OpenOptions::new()
            .write(true)
            .create_new(true)
            .open(output_dir.join(filename))?;

        Ok(csv::Writer::from_writer(file))
    }
```

**File:** config/src/config/storage_config.rs (L60-63)
```rust
            ensure!(
                path.is_absolute(),
                "Path ({path:?}) is not an absolute path."
            );
```
