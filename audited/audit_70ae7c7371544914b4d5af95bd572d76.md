# Audit Report

## Title
BCS Gas Estimation Response Omits Prioritized and Deprioritized Price Tiers

## Summary
The `/estimate_gas_price` endpoint returns incomplete gas estimation data when clients request BCS format via the `Accept: application/x-bcs` header. While JSON responses include all three gas price tiers (deprioritized, regular, and prioritized), BCS responses only return the regular market price, depriving BCS clients of critical information needed to optimize transaction costs and inclusion speed.

## Finding Description

The gas estimation endpoint is designed to provide three distinct gas price estimates as documented in the API specification [1](#0-0) :

The `GasEstimation` struct contains all three price tiers [2](#0-1) 

However, the `GasEstimationBcs` struct used for BCS responses contains only one field [3](#0-2) 

The `estimate_gas_price()` function computes all three values in the estimation algorithm [4](#0-3) 

But when returning BCS responses, only the regular estimate is included [5](#0-4) 

**Attack Path:**
1. A client application uses BCS format for efficiency (setting `Accept: application/x-bcs` header)
2. The client calls `/estimate_gas_price` to determine appropriate gas prices
3. The client receives only the `gas_estimate` field in `GasEstimationBcs`
4. The client lacks information about:
   - `deprioritized_gas_estimate`: Lower price for cost optimization during low network congestion
   - `prioritized_gas_estimate`: Higher price for faster inclusion during high demand
5. The client cannot make informed decisions about gas price vs. transaction urgency tradeoffs

## Impact Explanation

This qualifies as **Low Severity** per Aptos bug bounty criteria as a "minor information leak" because:

- **No direct fund loss**: Clients can still submit transactions, they just lack optimization data
- **No consensus violation**: This is purely an API information disclosure issue
- **No liveness impact**: Network operation continues normally
- **Information asymmetry**: Creates an unfair advantage for JSON clients over BCS clients
- **Usability degradation**: BCS clients may overpay for gas or experience slower transaction inclusion

The issue does not meet Medium/High/Critical severity thresholds as it doesn't cause fund loss, consensus breaks, or network availability issues.

## Likelihood Explanation

**Likelihood: High** for BCS clients using this endpoint:

- Any client can trigger this by setting the Accept header to `application/x-bcs`
- The official REST client defaults to JSON [6](#0-5) , but custom clients may prefer BCS for bandwidth efficiency
- BCS is a supported format throughout the API for performance reasons
- The documentation advertises three price tiers but BCS clients only receive one
- No attacker sophistication required - this is a normal API usage pattern

## Recommendation

Modify the BCS response to include all three gas estimation fields. Change the `GasEstimationBcs` struct to match `GasEstimation`:

```rust
#[derive(Clone, Debug, PartialEq, Eq, Serialize, Deserialize, Object)]
pub struct GasEstimationBcs {
    /// The deprioritized estimate for the gas unit price
    pub deprioritized_gas_estimate: Option<u64>,
    /// The current estimate for the gas unit price
    pub gas_estimate: u64,
    /// The prioritized estimate for the gas unit price
    pub prioritized_gas_estimate: Option<u64>,
}
```

Then update the BCS response path to use the full estimation:

```rust
AcceptType::Bcs => {
    let gas_estimation_bcs = GasEstimationBcs {
        deprioritized_gas_estimate: gas_estimation.deprioritized_gas_estimate,
        gas_estimate: gas_estimation.gas_estimate,
        prioritized_gas_estimate: gas_estimation.prioritized_gas_estimate,
    };
    BasicResponse::try_from_bcs((
        gas_estimation_bcs,
        &latest_ledger_info,
        BasicResponseStatus::Ok,
    ))
}
```

## Proof of Concept

```rust
// Add to api/src/tests/transactions_test.rs

#[tokio::test(flavor = "multi_thread", worker_threads = 2)]
async fn test_gas_estimation_bcs_missing_fields() {
    let mut node_config = NodeConfig::default();
    node_config.api.gas_estimation.enabled = true;
    node_config.api.gas_estimation.static_override = Some(
        aptos_config::config::gas_estimation_config::GasEstimationStaticOverride {
            low: 100,
            market: 150,
            aggressive: 200,
        }
    );
    
    let mut context = new_test_context_with_config(
        current_function_name!(),
        node_config,
        false,
        false,
    );

    // Get JSON response
    let json_resp = context.get("/estimate_gas_price").await;
    assert_eq!(json_resp["deprioritized_gas_estimate"], 100);
    assert_eq!(json_resp["gas_estimate"], 150);
    assert_eq!(json_resp["prioritized_gas_estimate"], 200);

    // Get BCS response
    let bcs_resp = warp::test::request()
        .method("GET")
        .path(&context.prepend_path("/estimate_gas_price"))
        .header("Accept", "application/x-bcs")
        .reply(&context.get_routes())
        .await;
    
    let bcs_data: GasEstimationBcs = bcs::from_bytes(&bcs_resp.body()).unwrap();
    
    // BUG: BCS response only contains gas_estimate
    assert_eq!(bcs_data.gas_estimate, 150);
    // These fields are missing in BCS response:
    // assert_eq!(bcs_data.deprioritized_gas_estimate, Some(100));
    // assert_eq!(bcs_data.prioritized_gas_estimate, Some(200));
}
```

This test demonstrates that BCS clients receive incomplete gas estimation data compared to JSON clients, confirming the information disclosure vulnerability.

## Notes

This issue creates an information asymmetry between API response formats. While the primary Aptos REST client uses JSON by default, the BCS format is explicitly supported and documented for bandwidth efficiency. Any client or SDK choosing BCS format for performance reasons will lack the prioritized and deprioritized gas estimates needed for optimal transaction submission strategies. The fix is straightforward: include all computed fields in the BCS response structure to maintain feature parity with JSON responses.

### Citations

**File:** api/src/transactions.rs (L807-810)
```rust
    /// The estimation is given in three values: de-prioritized (low), regular, and prioritized
    /// (aggressive). Using a more aggressive value increases the likelihood that the transaction
    /// will make it into the next block; more aggressive values are computed with a larger history
    /// and higher percentile statistics. More details are in AIP-34.
```

**File:** api/src/transactions.rs (L834-842)
```rust
                AcceptType::Bcs => {
                    let gas_estimation_bcs = GasEstimationBcs {
                        gas_estimate: gas_estimation.gas_estimate,
                    };
                    BasicResponse::try_from_bcs((
                        gas_estimation_bcs,
                        &latest_ledger_info,
                        BasicResponseStatus::Ok,
                    ))
```

**File:** api/types/src/transaction.rs (L2485-2488)
```rust
pub struct GasEstimationBcs {
    /// The current estimate for the gas unit price
    pub gas_estimate: u64,
}
```

**File:** api/types/src/transaction.rs (L2492-2499)
```rust
pub struct GasEstimation {
    /// The deprioritized estimate for the gas unit price
    pub deprioritized_gas_estimate: Option<u64>,
    /// The current estimate for the gas unit price
    pub gas_estimate: u64,
    /// The prioritized estimate for the gas unit price
    pub prioritized_gas_estimate: Option<u64>,
}
```

**File:** api/src/context.rs (L1441-1445)
```rust
        let estimation = GasEstimation {
            deprioritized_gas_estimate: Some(low_price),
            gas_estimate: market_price,
            prioritized_gas_estimate: Some(aggressive_price),
        };
```

**File:** crates/aptos-rest-client/src/lib.rs (L1620-1624)
```rust
    pub async fn estimate_gas_price(&self) -> AptosResult<Response<GasEstimation>> {
        let url = self.build_path("estimate_gas_price")?;
        let response = self.inner.get(url).send().await?;
        self.json(response).await
    }
```
