# Audit Report

## Title
TypeTag Address Mismatch in Token Event V2 Types Breaks Event Filtering and Translation

## Summary
Multiple token event V2 types (CollectionDescriptionMutate, DefaultPropertyMutate, RoyaltyMutate, etc.) in `types/src/account_config/events/` implement `MoveStructType` without overriding the `ADDRESS` constant, causing `create_event_v2()` to generate events with incorrect TypeTags (address 0x1 instead of 0x3). This breaks event filtering, routing, and translation in the indexer.

## Finding Description

The token event store module (`aptos_token::token_event_store`) is deployed at address `0x3` (TOKEN_ADDRESS), but all associated Rust event types fail to override the `ADDRESS` constant in their `MoveStructType` implementation, defaulting to `CORE_CODE_ADDRESS` (0x1). [1](#0-0) [2](#0-1) 

The Move module is at address 0x3: [3](#0-2) [4](#0-3) 

When `create_event_v2()` is called, it uses `Self::struct_tag()` which constructs the TypeTag with the default address: [5](#0-4) [6](#0-5) 

This produces TypeTag `0x1::token_event_store::CollectionDescriptionMutate` instead of the correct `0x3::token_event_store::CollectionDescriptionMutate`.

However, the static TypeTag constant is correctly defined with TOKEN_ADDRESS (0x3): [7](#0-6) 

The EventV2TranslationEngine uses these correct static constants for mapping: [8](#0-7) 

Events with the wrong TypeTag (0x1) would fail to match the translator mapping (which expects 0x3) and would not be translated from V2 to V1 format.

The same issue affects all token event types: DefaultPropertyMutate, RoyaltyMutate, CollectionUriMutate, CollectionMaximumMutate, OptInTransfer, UriMutation, DescriptionMutate, MaximumMutate, and others. [9](#0-8) [10](#0-9) 

## Impact Explanation

**Severity: Medium**

While this is a clear implementation bug, the actual security impact is limited because:

1. **Current Production Path is Safe**: Events emitted from Move code use the native function which correctly derives the TypeTag from the VM's type system, producing the correct address (0x3). [11](#0-10) 

2. **Limited Usage**: The `create_event_v2()` Rust method is not currently called on these types in production code, only on `FeeStatement` in benchmarks.

3. **Impact if Used**: If this method were used incorrectly, it would cause:
   - Events to be dropped by the translator (no matching TypeTag)
   - Event filtering to fail in indexers and APIs
   - State inconsistencies between V1 and V2 event views
   - Breaking change for event consumers

This qualifies as Medium severity under "State inconsistencies requiring intervention" because incorrect usage would silently corrupt the event indexing system.

## Likelihood Explanation

**Likelihood: Low (currently), Medium (if API is used)**

The bug is dormant in production because the affected Rust API is not called on token event types. However:

- The public API invites incorrect usage
- Future tools, tests, or refactoring could trigger this bug
- No compile-time checks prevent misuse
- The bug affects 10+ event types systematically

## Recommendation

Override the `ADDRESS` constant in all token event store V2 types:

```rust
impl MoveStructType for CollectionDescriptionMutate {
    const ADDRESS: AccountAddress = TOKEN_ADDRESS;
    const MODULE_NAME: &'static IdentStr = ident_str!("token_event_store");
    const STRUCT_NAME: &'static IdentStr = ident_str!("CollectionDescriptionMutate");
}
```

Apply this fix to all affected types: CollectionDescriptionMutate, DefaultPropertyMutate, RoyaltyMutate, CollectionUriMutate, CollectionMaximumMutate, OptInTransfer, UriMutation, DescriptionMutate, MaximumMutate, TokenDataCreation, CreateCollection, and all other types in `0x3::token_event_store`.

Alternatively, remove the `create_event_v2()` implementation from these types if it should not be used directly in Rust code.

## Proof of Concept

```rust
#[test]
fn test_token_event_type_tag_mismatch() {
    use aptos_types::account_config::CollectionDescriptionMutate;
    use move_core_types::{
        account_address::AccountAddress,
        language_storage::{StructTag, TypeTag, TOKEN_ADDRESS},
        move_resource::MoveStructType,
        ident_str,
    };
    
    // Create event using Rust API
    let event = CollectionDescriptionMutate::new(
        AccountAddress::random(),
        "collection".to_string(),
        "old".to_string(),
        "new".to_string(),
    );
    
    // Get TypeTag from create_event_v2() path
    let struct_tag_from_trait = CollectionDescriptionMutate::struct_tag();
    let type_tag_from_trait = TypeTag::Struct(Box::new(struct_tag_from_trait));
    
    // Expected TypeTag (from static constant)
    let expected = TypeTag::Struct(Box::new(StructTag {
        address: TOKEN_ADDRESS,  // 0x3
        module: ident_str!("token_event_store").to_owned(),
        name: ident_str!("CollectionDescriptionMutate").to_owned(),
        type_args: vec![],
    }));
    
    // This assertion FAILS - demonstrating the mismatch
    assert_eq!(type_tag_from_trait, expected, 
        "TypeTag mismatch: got {:?}, expected {:?}", 
        type_tag_from_trait, expected);
    
    // The trait produces 0x1::token_event_store::CollectionDescriptionMutate
    // But should produce 0x3::token_event_store::CollectionDescriptionMutate
}
```

This test demonstrates that `MoveStructType::struct_tag()` returns address 0x1 instead of 0x3, causing events created via `create_event_v2()` to have incorrect TypeTags that won't match the translator mappings.

## Notes

This vulnerability is **currently dormant** in production because events are emitted from Move code (which correctly derives TypeTags from the VM) rather than using the Rust `create_event_v2()` API. However, the bug represents a **systematic implementation error** across 10+ event types that creates a maintenance hazard and potential for future incidents if the API is used incorrectly.

### Citations

**File:** types/src/account_config/events/collection_description_mutate.rs (L60-63)
```rust
impl MoveStructType for CollectionDescriptionMutate {
    const MODULE_NAME: &'static IdentStr = ident_str!("token_event_store");
    const STRUCT_NAME: &'static IdentStr = ident_str!("CollectionDescriptionMutate");
}
```

**File:** types/src/account_config/events/collection_description_mutate.rs (L67-74)
```rust
pub static COLLECTION_DESCRIPTION_MUTATE_TYPE: Lazy<TypeTag> = Lazy::new(|| {
    TypeTag::Struct(Box::new(StructTag {
        address: TOKEN_ADDRESS,
        module: ident_str!("token_event_store").to_owned(),
        name: ident_str!("CollectionDescriptionMutate").to_owned(),
        type_args: vec![],
    }))
});
```

**File:** third_party/move/move-core/types/src/move_resource.rs (L12-14)
```rust
pub trait MoveStructType {
    const ADDRESS: AccountAddress = crate::language_storage::CORE_CODE_ADDRESS;
    const MODULE_NAME: &'static IdentStr;
```

**File:** third_party/move/move-core/types/src/move_resource.rs (L29-36)
```rust
    fn struct_tag() -> StructTag {
        StructTag {
            address: Self::ADDRESS,
            name: Self::struct_identifier(),
            module: Self::module_identifier(),
            type_args: Self::type_args(),
        }
    }
```

**File:** aptos-move/framework/aptos-token/sources/token_event_store.move (L1-2)
```text
/// This module provides utils to add and emit new token events that are not in token.move
module aptos_token::token_event_store {
```

**File:** third_party/move/move-core/types/src/language_storage.rs (L27-29)
```rust
/// Hex address: 0x1
pub const CORE_CODE_ADDRESS: AccountAddress = AccountAddress::ONE;
pub const TOKEN_ADDRESS: AccountAddress = AccountAddress::THREE;
```

**File:** types/src/move_utils/move_event_v2.rs (L8-14)
```rust
pub trait MoveEventV2Type: MoveStructType + Serialize {
    fn create_event_v2(&self) -> anyhow::Result<ContractEvent> {
        ContractEvent::new_v2(
            TypeTag::Struct(Box::new(Self::struct_tag())),
            bcs::to_bytes(self)?,
        )
    }
```

**File:** storage/indexer/src/event_v2_translator.rs (L119-122)
```rust
            (
                COLLECTION_DESCRIPTION_MUTATE_TYPE.clone(),
                Box::new(CollectionDescriptionMutateTranslator),
            ),
```

**File:** types/src/account_config/events/default_property_mutate.rs (L85-88)
```rust
impl MoveStructType for DefaultPropertyMutate {
    const MODULE_NAME: &'static IdentStr = ident_str!("token_event_store");
    const STRUCT_NAME: &'static IdentStr = ident_str!("DefaultPropertyMutate");
}
```

**File:** types/src/account_config/events/royalty_mutate.rs (L95-98)
```rust
impl MoveStructType for RoyaltyMutate {
    const MODULE_NAME: &'static IdentStr = ident_str!("token_event_store");
    const STRUCT_NAME: &'static IdentStr = ident_str!("RoyaltyMutate");
}
```

**File:** aptos-move/framework/src/natives/event.rs (L247-263)
```rust
fn native_write_module_event_to_store(
    context: &mut SafeNativeContext,
    ty_args: &[Type],
    mut arguments: VecDeque<Value>,
) -> SafeNativeResult<SmallVec<[Value; 1]>> {
    debug_assert!(ty_args.len() == 1);
    debug_assert!(arguments.len() == 1);

    let ty = &ty_args[0];
    let msg = arguments.pop_back().unwrap();

    context.charge(
        EVENT_WRITE_TO_EVENT_STORE_BASE
            + EVENT_WRITE_TO_EVENT_STORE_PER_ABSTRACT_VALUE_UNIT * context.abs_val_size(&msg)?,
    )?;

    let type_tag = context.type_to_type_tag(ty)?;
```
