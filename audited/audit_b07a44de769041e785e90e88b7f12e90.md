# Audit Report

## Title
Indexer-grpc Version Overflow Causes Service Panic Without Migration Strategy

## Summary
The Aptos indexer-grpc ecosystem uses unchecked integer arithmetic for version increments, violating the project's Rust coding guidelines. When the blockchain version approaches `u64::MAX`, the indexer-grpc service will panic due to integer overflow, requiring manual intervention with no automated migration strategy.

## Finding Description

The indexer-grpc system tracks blockchain versions using `u64` type and performs unchecked arithmetic operations throughout the codebase. The Aptos project mandates checked arithmetic operations in its coding guidelines [1](#0-0) , yet the indexer-grpc violates this standard.

**Key Vulnerable Locations:**

1. **File Store Uploader** - Updates metadata with unchecked addition: [2](#0-1) 

2. **Processor** - Increments batch version without overflow protection: [3](#0-2) 

3. **File Store Operator** - Multiple unchecked operations: [4](#0-3) [5](#0-4) [6](#0-5) 

The project's release profile has overflow checks enabled: [7](#0-6) 

This means when version reaches `u64::MAX`, any increment operation will panic rather than wrap around.

**Contrast with Core Storage Layer:**

The core AptosDB storage layer properly uses `checked_add` with error handling: [8](#0-7) [9](#0-8) 

The Version type is defined as a simple u64 alias: [10](#0-9) 

## Impact Explanation

**Severity: Medium** per Aptos bug bounty criteria - "State inconsistencies requiring intervention"

However, this issue fails critical validation criteria:

1. **Not Exploitable by Attackers**: No unprivileged actor can force the blockchain version to approach `u64::MAX`. The version increments sequentially with each transaction.

2. **Unrealistic Timeline**: At 10,000 TPS, reaching `u64::MAX` would require approximately 58 million years.

3. **Limited Blast Radius**: The indexer-grpc is NOT part of core consensus, execution, or state management. If it crashes:
   - Blockchain consensus continues unaffected
   - Block production continues
   - Transaction execution continues  
   - No funds are at risk
   - Only indexer API availability is impacted

4. **No Security Invariant Violated**: This doesn't break any of the 10 critical blockchain invariants (consensus safety, deterministic execution, state consistency, etc.)

## Likelihood Explanation

**Likelihood: Negligible** - Requires 58 million years of continuous operation at 10K TPS to manifest naturally. Cannot be triggered by an attacker.

## Recommendation

Despite the negligible likelihood, the code should follow project guidelines and use checked arithmetic:

```rust
// In file_store_uploader.rs:254
self.update_file_store_metadata(
    last_version.checked_add(1)
        .ok_or_else(|| anyhow::anyhow!("Version overflow"))?
).await?;

// In processor.rs:247  
batch_start_version = last_version.checked_add(1)
    .ok_or_else(|| anyhow::anyhow!("Version overflow"))?;

// In file_store_operator.rs:58
self.version = self.version.checked_add(1)
    .ok_or_else(|| anyhow::anyhow!("Version overflow"))?;
```

## Proof of Concept

```rust
#[test]
fn test_version_overflow_panic() {
    use std::panic;
    
    // This test demonstrates the panic behavior
    let version: u64 = u64::MAX;
    
    let result = panic::catch_unwind(|| {
        let _next_version = version + 1; // Will panic with overflow-checks enabled
    });
    
    assert!(result.is_err(), "Expected panic on overflow");
}
```

---

**CRITICAL ASSESSMENT:** While this represents a code quality issue and violates coding guidelines, it **fails the validation checklist** for a reportable security vulnerability:

- ❌ Not exploitable by unprivileged attacker
- ❌ Attack path is not realistic  
- ❌ Does not affect core blockchain security
- ❌ Indexer-grpc is not a consensus/execution component

**The indexer-grpc service crashing does not constitute a blockchain security vulnerability** - it's an auxiliary indexing service. The core blockchain remains fully operational and secure even if all indexer services fail.

Per the strict validation requirements: **This is a code quality/architectural issue, not an exploitable security vulnerability meeting bug bounty criteria.**

### Citations

**File:** RUST_CODING_STYLE.md (L222-224)
```markdown
As every integer operation (`+`, `-`, `/`, `*`, etc.) implies edge-cases (e.g. overflow `u64::MAX + 1`, underflow `0u64 -1`, division by zero, etc.),
we use checked arithmetic instead of directly using math symbols.
It forces us to think of edge-cases, and handle them explicitly.
```

**File:** ecosystem/indexer-grpc/indexer-grpc-manager/src/file_store_uploader.rs (L254-254)
```rust
            self.update_file_store_metadata(last_version + 1).await?;
```

**File:** ecosystem/indexer-grpc/indexer-grpc-file-store/src/processor.rs (L247-247)
```rust
            batch_start_version = last_version + 1;
```

**File:** ecosystem/indexer-grpc/indexer-grpc-utils/src/file_store_operator_v2/file_store_operator.rs (L48-48)
```rust
        let end_batch = (transaction.version + 1) % self.num_txns_per_folder == 0;
```

**File:** ecosystem/indexer-grpc/indexer-grpc-utils/src/file_store_operator_v2/file_store_operator.rs (L58-58)
```rust
        self.version += 1;
```

**File:** ecosystem/indexer-grpc/indexer-grpc-utils/src/file_store_operator_v2/file_store_operator.rs (L75-75)
```rust
            last_version: first_version + transactions.len() as u64,
```

**File:** Cargo.toml (L921-923)
```text
[profile.release]
debug = true
overflow-checks = true
```

**File:** storage/aptosdb/src/utils/iterators.rs (L97-99)
```rust
            end_version: first_version
                .checked_add(limit as u64)
                .ok_or(AptosDbError::TooManyRequested(first_version, limit as u64))?,
```

**File:** storage/aptosdb/src/utils/iterators.rs (L280-283)
```rust
        self.expected_next_version = self
            .expected_next_version
            .checked_add(1)
            .ok_or_else(|| AptosDbError::Other("expected version overflowed.".to_string()))?;
```

**File:** types/src/transaction/mod.rs (L98-98)
```rust
pub type Version = u64; // Height - also used for MVCC in StateDB
```
