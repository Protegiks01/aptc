# Audit Report

## Title
Tokio-Console Remote Information Disclosure via Unauthenticated Network Exposure on Validator Nodes

## Summary
The `console-subscriber` integration in the Aptos logger binds to all network interfaces (`0.0.0.0`) without any authentication mechanism, exposing detailed validator runtime instrumentation data to any network attacker when the `tokio-console` feature is enabled. While no Remote Code Execution (RCE) vulnerabilities were identified in `console-subscriber` 0.3.0 itself, the lack of authentication combined with exposure on all network interfaces creates a High severity information disclosure vulnerability. [1](#0-0) 

## Finding Description

When the `tokio-console` feature is compiled into an Aptos validator node and the `tokio_console_port` configuration parameter is set, the logger initialization code binds a `console-subscriber` gRPC server to `0.0.0.0` (all network interfaces) on the specified port. [1](#0-0) 

The `console-subscriber` library, by design, does not implement any authentication or authorization mechanism. Any network client capable of reaching the configured port can connect and access detailed runtime instrumentation data about the validator process, including:
- Async task execution patterns and timing information
- Resource allocation and usage statistics  
- Call stacks and execution traces
- Task spawn patterns that could reveal consensus behavior

While the configuration comment describes this as "for local debugging" [2](#0-1) , the implementation contradicts this intent by binding to all interfaces rather than localhost (`127.0.0.1`).

The default configuration safely disables this feature by setting `tokio_console_port` to `None`. [3](#0-2)  However, if a validator operator enables this feature for debugging purposes and fails to properly firewall the port, remote attackers gain unauthorized access to sensitive operational data.

## Impact Explanation

This vulnerability is classified as **High Severity** based on the Aptos bug bounty criteria for "Validator node slowdowns / API crashes / Significant protocol violations."

The information disclosure enables sophisticated reconnaissance attacks against validator nodes:

1. **Timing Analysis**: Attackers can observe task execution patterns to infer consensus round timing, block proposal behavior, and network communication patterns
2. **Resource Exhaustion Identification**: Detailed metrics reveal resource bottlenecks that could be exploited for targeted DoS attacks
3. **Validator Behavior Profiling**: Execution traces expose internal state machine behavior useful for planning consensus-level attacks
4. **Attack Surface Mapping**: Call stacks and task hierarchies reveal validator implementation details

While this does not directly cause consensus safety violations or fund loss, the intelligence gathered significantly lowers the barrier for more sophisticated attacks. The lack of authentication constitutes a complete authentication bypass—not a CVE in `console-subscriber` itself, but a security configuration flaw in how Aptos integrates it.

**Note**: No evidence of RCE vulnerabilities in `console-subscriber` 0.3.0 was found during this analysis. The vulnerability is limited to authentication bypass and information disclosure.

## Likelihood Explanation

**Likelihood: LOW to MEDIUM** depending on deployment practices.

The vulnerability requires:
1. Validator operator explicitly enables the `tokio-console` feature at compile time
2. Operator sets `tokio_console_port` configuration parameter (not default)
3. Network firewall rules fail to restrict access to the console port
4. Attacker has network reachability to the validator node

The default configuration is secure (feature disabled). However, operators may enable this for debugging without understanding the security implications, especially since the configuration comment suggests it's "for local debugging" while the implementation allows remote access.

If enabled on a production validator with an exposed network port, exploitation is trivial—no authentication is required, making it immediately exploitable.

## Recommendation

**Immediate Fix**: Bind `console-subscriber` to localhost only (`127.0.0.1`) instead of all interfaces (`0.0.0.0`):

```rust
let console_layer = console_subscriber::ConsoleLayer::builder()
    .server_addr(([127, 0, 0, 1], tokio_console_port))  // localhost only
    .spawn();
```

**Additional Recommendations**:

1. **Security Warning**: Add explicit documentation warning that enabling `tokio-console` on production validators creates security risks
2. **Configuration Validation**: Add a config sanitizer check that warns/errors if `tokio_console_port` is enabled on production validator nodes
3. **Feature Gate**: Consider making this feature only available in debug/development builds, not production releases
4. **Network Controls**: Document required firewall rules if operators must enable this feature

## Proof of Concept

**Step 1**: Build Aptos node with tokio-console feature enabled:
```bash
cargo build --release --features tokio-console
```

**Step 2**: Configure validator with tokio-console enabled (validator_config.yaml):
```yaml
logger:
  tokio_console_port: 6669
```

**Step 3**: Start the validator node (binds to 0.0.0.0:6669)

**Step 4**: From a remote machine with network access to the validator:
```bash
# Install tokio-console client
cargo install tokio-console

# Connect to the validator (no authentication required)
tokio-console http://<validator-ip>:6669
```

**Expected Result**: The attacker gains full access to the validator's runtime instrumentation data without any authentication challenge, demonstrating the authentication bypass and information disclosure vulnerability.

## Notes

- The vulnerability is **not** an RCE despite the security question's focus on RCE. No evidence of remote code execution capabilities exists in `console-subscriber` 0.3.0
- The authentication bypass is inherent to `console-subscriber`'s design—it was never designed with authentication. The vulnerability arises from Aptos's insecure integration (binding to 0.0.0.0)
- Default configuration is secure; this only affects operators who explicitly enable the feature
- The severity escalates from Low to High when deployed on production validators with network-exposed ports
- This represents a violation of defense-in-depth principles—debugging features should not be network-accessible without authentication

### Citations

**File:** crates/aptos-logger/src/logger.rs (L57-59)
```rust
            let console_layer = console_subscriber::ConsoleLayer::builder()
                .server_addr(([0, 0, 0, 0], tokio_console_port))
                .spawn();
```

**File:** config/src/config/logger_config.rs (L36-37)
```rust
    /// Tokio console port for local debugging
    pub tokio_console_port: Option<u16>,
```

**File:** config/src/config/logger_config.rs (L54-54)
```rust
            tokio_console_port: None,
```
