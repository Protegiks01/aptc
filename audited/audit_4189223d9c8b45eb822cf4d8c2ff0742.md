# Audit Report

## Title
Doc Comment Code Injection via Unescaped Rust Code Blocks in SDK Builder

## Summary
The Aptos SDK builder does not properly escape or sanitize Move documentation strings before inserting them into generated Rust code. A malicious Move module developer can inject executable Rust code through doc comment code blocks (````rust`), which will execute during `cargo test --doc` when developers build or test the generated SDK.

## Finding Description

The vulnerability exists in the SDK builder's code generation pipeline, which extracts documentation from Move source code and inserts it into generated Rust files without proper escaping.

**Attack Flow:**

1. **Injection Point**: A malicious Move module developer writes a function with specially crafted documentation containing a Rust code block: [1](#0-0) 

2. **ABI Extraction**: During framework compilation, the ABI generator extracts the documentation string without sanitization: [2](#0-1) 

3. **Insufficient Sanitization**: The `prepare_doc_string` function only performs minimal whitespace normalization, leaving code block syntax intact: [3](#0-2) 

4. **Code Generation**: The SDK builder inserts the unsanitized documentation into generated Rust files via two paths:
   - Direct comment output: [4](#0-3) 
   - Via serde-generate library: [5](#0-4) 

5. **Code Execution**: When developers run `cargo test`, Rust's doc test runner extracts and executes code from ````rust` blocks in doc comments, allowing arbitrary code execution.

**Proof of Malicious Injection**: The generated SDK already contains unescaped code blocks from legitimate Move documentation: [6](#0-5) 

An attacker could replace ````move` with ````rust` and insert malicious code that would execute during testing.

## Impact Explanation

This vulnerability represents a **Medium severity** supply chain attack vector per the Aptos bug bounty classification. While it does not directly compromise blockchain consensus or runtime security, it enables:

- **Arbitrary code execution** on developer machines during SDK build/test cycles
- **Credential theft** of developer keys, tokens, or secrets
- **Source code manipulation** to inject backdoors or vulnerabilities
- **Lateral movement** in development infrastructure

The vulnerability affects the integrity of the development pipeline, which could indirectly lead to blockchain compromise if attackers use it to inject runtime vulnerabilities through compromised developer environments.

## Likelihood Explanation

**Moderate Likelihood** - Exploitation requires:

1. **Access**: Ability to contribute Move modules to the framework (via governance approval or merged PR)
2. **Trigger**: Developers running `cargo test` on generated SDK code (common during development)
3. **Detection Evasion**: Malicious Rust code must pass code review, but could be obfuscated within large documentation examples or JSON data

The attack is realistic because:
- Framework contributions go through review, but reviewers may focus on Move code rather than documentation
- Doc comments with code examples are common and expected
- The injected code only executes during testing, not in production deployments

## Recommendation

**Immediate Fix**: Implement proper escaping of documentation strings before code generation.

```rust
// In aptos-move/aptos-sdk-builder/src/common.rs
pub(crate) fn prepare_doc_string(doc: &str) -> String {
    doc.replace("\n ", "\n")
        .trim()
        .replace("```", "```text") // Escape all code blocks
        .to_string()
}
```

**Better Solution**: Use a dedicated markdown sanitization library to:
- Escape or remove executable code block syntax
- Preserve formatting while preventing code execution
- Whitelist only safe markdown constructs

**Additional Safeguards**:
1. Add security warnings in code review guidelines about doc comment injection
2. Implement automated scanning for suspicious code blocks in Move documentation
3. Consider generating SDK documentation without executable doc tests

## Proof of Concept

**Step 1**: Create a malicious Move module with injected doc comment:

```move
module 0x1::malicious {
    /// Test function that demonstrates code injection
    /// ```rust
    /// use std::fs;
    /// // This code executes during cargo test --doc
    /// fs::write("/tmp/pwned.txt", "SDK builder vulnerability").unwrap();
    /// ```
    public entry fun test() {}
}
```

**Step 2**: Run framework build to generate SDK:
```bash
cd aptos-move/framework
cargo run --release -p framework
```

**Step 3**: The generated SDK at `cached-packages/src/aptos_framework_sdk_builder.rs` will contain:
```rust
/// Test function that demonstrates code injection
/// ```rust
/// use std::fs;
/// fs::write("/tmp/pwned.txt", "SDK builder vulnerability").unwrap();
/// ```
pub fn test(...) -> TransactionPayload { ... }
```

**Step 4**: Run tests to trigger execution:
```bash
cd cached-packages
cargo test --doc
```

**Expected Result**: File `/tmp/pwned.txt` is created, proving arbitrary code execution.

## Notes

This vulnerability is classified as **Medium severity** because it affects the development/build pipeline rather than blockchain runtime. However, it represents a significant supply chain security risk that could enable more severe attacks through compromised developer environments. The vulnerability is present in the current codebase and exploitable with no special privileges beyond the ability to contribute Move modules to the framework.

### Citations

**File:** aptos-move/framework/aptos-framework/sources/jwks.move (L240-253)
```text
    /// ```move
    /// use std::string::utf8;
    /// aptos_framework::jwks::update_federated_jwk_set(
    ///     jwk_owner,
    ///     b"https://accounts.google.com",
    ///     vector[utf8(b"d7b939771a7800c413f90051012d975981916d71"), utf8(b"b2620d5e7f132b52afe8875cdf3776c064249d04")],
    ///     vector[utf8(b"RS256"), utf8(b"RS256")],
    ///     vector[utf8(b"AQAB"), utf8(b"AQAB")],
    ///     vector[
    ///         utf8(b"wNHgGSG5B5xOEQNFPW2p_6ZxZbfPoAU5VceBUuNwQWLop0ohW0vpoZLU1tAsq_S9s5iwy27rJw4EZAOGBR9oTRq1Y6Li5pDVJfmzyRNtmWCWndR-bPqhs_dkJU7MbGwcvfLsN9FSHESFrS9sfGtUX-lZfLoGux23TKdYV9EE-H-NDASxrVFUk2GWc3rL6UEMWrMnOqV9-tghybDU3fcRdNTDuXUr9qDYmhmNegYjYu4REGjqeSyIG1tuQxYpOBH-tohtcfGY-oRTS09kgsSS9Q5BRM4qqCkGP28WhlSf4ui0-norS0gKMMI1P_ZAGEsLn9p2TlYMpewvIuhjJs1thw"),
    ///         utf8(b"pi22xDdK2fz5gclIbDIGghLDYiRO56eW2GUcboeVlhbAuhuT5mlEYIevkxdPOg5n6qICePZiQSxkwcYMIZyLkZhSJ2d2M6Szx2gDtnAmee6o_tWdroKu0DjqwG8pZU693oLaIjLku3IK20lTs6-2TeH-pUYMjEqiFMhn-hb7wnvH_FuPTjgz9i0rEdw_Hf3Wk6CMypaUHi31y6twrMWq1jEbdQNl50EwH-RQmQ9bs3Wm9V9t-2-_Jzg3AT0Ny4zEDU7WXgN2DevM8_FVje4IgztNy29XUkeUctHsr-431_Iu23JIy6U4Kxn36X3RlVUKEkOMpkDD3kd81JPW4Ger_w")
    ///     ]
    /// )
    /// ```
```

**File:** third_party/move/move-prover/move-abigen/src/abigen.rs (L181-181)
```rust
        let doc = func.get_doc().to_string();
```

**File:** aptos-move/aptos-sdk-builder/src/common.rs (L24-26)
```rust
/// Clean up doc comments extracted by the Move prover.
pub(crate) fn prepare_doc_string(doc: &str) -> String {
    doc.replace("\n ", "\n").trim().to_string()
```

**File:** aptos-move/aptos-sdk-builder/src/rust.rs (L172-198)
```rust
        let mut comments: BTreeMap<_, _> = abis
            .iter()
            .map(|abi| {
                (
                    vec![
                        "crate".to_string(),
                        if abi.is_transaction_script_abi() {
                            "ScriptCall"
                        } else {
                            "EntryFunctionCall"
                        }
                        .to_string(),
                        match abi {
                            EntryABI::EntryFunction(sf) => {
                                format!(
                                    "{}{}",
                                    sf.module_name().name().to_string().to_upper_camel_case(),
                                    abi.name().to_upper_camel_case()
                                )
                            },
                            _ => abi.name().to_upper_camel_case(),
                        },
                    ],
                    common::prepare_doc_string(abi.doc()),
                )
            })
            .collect();
```

**File:** aptos-move/aptos-sdk-builder/src/rust.rs (L434-439)
```rust
    fn output_comment(&mut self, indentation: usize, doc: &str) -> std::io::Result<()> {
        let prefix = " ".repeat(indentation) + "/// ";
        let empty_line = "\n".to_string() + &" ".repeat(indentation) + "///\n";
        let text = textwrap::indent(doc, &prefix).replace("\n\n", &empty_line);
        write!(self.out, "\n{}\n", text)
    }
```

**File:** aptos-move/framework/cached-packages/src/aptos_framework_sdk_builder.rs (L595-608)
```rust
    /// ```move
    /// use std::string::utf8;
    /// aptos_framework::jwks::update_federated_jwk_set(
    ///     jwk_owner,
    ///     b"https://accounts.google.com",
    ///     vector[utf8(b"d7b939771a7800c413f90051012d975981916d71"), utf8(b"b2620d5e7f132b52afe8875cdf3776c064249d04")],
    ///     vector[utf8(b"RS256"), utf8(b"RS256")],
    ///     vector[utf8(b"AQAB"), utf8(b"AQAB")],
    ///     vector[
    ///         utf8(b"wNHgGSG5B5xOEQNFPW2p_6ZxZbfPoAU5VceBUuNwQWLop0ohW0vpoZLU1tAsq_S9s5iwy27rJw4EZAOGBR9oTRq1Y6Li5pDVJfmzyRNtmWCWndR-bPqhs_dkJU7MbGwcvfLsN9FSHESFrS9sfGtUX-lZfLoGux23TKdYV9EE-H-NDASxrVFUk2GWc3rL6UEMWrMnOqV9-tghybDU3fcRdNTDuXUr9qDYmhmNegYjYu4REGjqeSyIG1tuQxYpOBH-tohtcfGY-oRTS09kgsSS9Q5BRM4qqCkGP28WhlSf4ui0-norS0gKMMI1P_ZAGEsLn9p2TlYMpewvIuhjJs1thw"),
    ///         utf8(b"pi22xDdK2fz5gclIbDIGghLDYiRO56eW2GUcboeVlhbAuhuT5mlEYIevkxdPOg5n6qICePZiQSxkwcYMIZyLkZhSJ2d2M6Szx2gDtnAmee6o_tWdroKu0DjqwG8pZU693oLaIjLku3IK20lTs6-2TeH-pUYMjEqiFMhn-hb7wnvH_FuPTjgz9i0rEdw_Hf3Wk6CMypaUHi31y6twrMWq1jEbdQNl50EwH-RQmQ9bs3Wm9V9t-2-_Jzg3AT0Ny4zEDU7WXgN2DevM8_FVje4IgztNy29XUkeUctHsr-431_Iu23JIy6U4Kxn36X3RlVUKEkOMpkDD3kd81JPW4Ger_w")
    ///     ]
    /// )
    /// ```
```
