# Audit Report

## Title
Percent-Encoded URL Canonicalization Bypass in Move Package Cache Enables Repository Identity Confusion

## Summary
The `CanonicalGitIdentity::new()` and `CanonicalNodeIdentity::new()` functions in the Move package cache system fail to decode percent-encoded characters before canonicalization. This allows URLs like `https://github.com/foo/bar` and `https://github.com/foo%2Fbar` to be treated as different repositories despite pointing to the same location, enabling cache pollution, lock file bypass, and potential dependency confusion attacks.

## Finding Description

The canonicalization functions extract the URL path directly using the Rust `url` crate's `path()` method, which returns paths with percent-encoding intact. [1](#0-0) [2](#0-1) 

The canonicalization process converts to lowercase but never decodes percent-encoded characters. This means:
- `https://github.com/foo/bar` → canonical identity: `github.com/foo/bar`  
- `https://github.com/foo%2Fbar` → canonical identity: `github.com/foo%2fbar` (note lowercase `f`)

These are treated as distinct repositories throughout the system.

**Propagation Path:**

1. A malicious actor creates a Move.toml file with a percent-encoded git dependency URL [3](#0-2) 

2. The URL is parsed and stored without decoding [4](#0-3) 

3. When resolving dependencies, `CanonicalGitIdentity::new()` is called to create a unique identifier [5](#0-4) 

4. The canonical identity is used to:
   - Create cache directory names [6](#0-5) 
   - Generate lock file keys [7](#0-6) 
   - Identify package sources [8](#0-7) 

5. The same physical repository can exist under multiple canonical identities in the cache [9](#0-8) 

## Impact Explanation

While this is a legitimate bug in URL canonicalization, **it does not meet the severity criteria for blockchain security impacts** as defined in the Aptos bug bounty program.

The Move package cache and resolver are **build-time development tools** used to compile Move source code into bytecode. They are not part of the validator runtime, consensus protocol, or on-chain execution engine. 

**Why this doesn't cause blockchain security issues:**

- Validators execute pre-compiled Move bytecode, not source packages
- The package cache is not used during transaction execution or consensus
- Different cached versions during development do not cause consensus divergence
- Each package deployment is independent with its own on-chain address
- No impact on funds, consensus safety, or network availability

The potential impacts are limited to:
- Cache disk space waste (same repo cached multiple times)
- Build reproducibility issues (lock files won't match across encodings)  
- Developer confusion
- Potential supply chain risk (requires developers to use malicious dependencies)

These are **development workflow issues**, not blockchain security vulnerabilities.

## Likelihood Explanation

The bug is trivially exploitable - any developer can create a Move.toml with percent-encoded URLs. However, the impact is limited to the development environment and does not affect the blockchain itself.

## Recommendation

Decode percent-encoded characters before canonicalization by using the url crate's `path_segments()` iterator or manually decoding the path:

```rust
let path = percent_encoding::percent_decode_str(git_url.path())
    .decode_utf8_lossy()
    .to_ascii_lowercase();
```

Apply the same fix to both `CanonicalGitIdentity::new()` and `CanonicalNodeIdentity::new()`.

## Proof of Concept

```rust
#[test]
fn test_percent_encoding_bypass() {
    use url::Url;
    
    let url1 = Url::parse("https://github.com/foo/bar").unwrap();
    let url2 = Url::parse("https://github.com/foo%2Fbar").unwrap();
    
    let id1 = CanonicalGitIdentity::new(&url1).unwrap();
    let id2 = CanonicalGitIdentity::new(&url2).unwrap();
    
    // These should be equal but are not
    assert_ne!(&*id1, &*id2);
    assert_eq!(&*id1, "github.com/foo/bar");
    assert_eq!(&*id2, "github.com/foo%2fbar");
}
```

---

**Note:** While this is a valid implementation bug that should be fixed, it does not constitute a blockchain security vulnerability per the strict criteria. It is a development tool issue with no direct impact on consensus, validator operations, or on-chain execution.

### Citations

**File:** third_party/move/tools/move-package-cache/src/canonical.rs (L34-34)
```rust
        let path = git_url.path().to_ascii_lowercase();
```

**File:** third_party/move/tools/move-package-cache/src/canonical.rs (L105-105)
```rust
        let path = node_url.path().to_ascii_lowercase();
```

**File:** third_party/move/tools/move-package/src/source_package/manifest_parser.rs (L365-367)
```rust
                    let git_url = git
                        .as_str()
                        .ok_or_else(|| anyhow::anyhow!("Git URL not a string"))?;
```

**File:** third_party/move/tools/move-package-manifest/src/manifest.rs (L132-140)
```rust
    Git {
        /// URL to the Git repository.
        url: Url,
        /// Optional Git revision to pin the dependency to.
        /// This can be a commit hash, a branch name or a tag name.
        rev: Option<String>,
        /// Optional subdirectory within the Git repository.
        subdir: Option<String>,
    },
```

**File:** third_party/move/tools/move-package-resolver/src/resolver.rs (L404-404)
```rust
                    repo: CanonicalGitIdentity::new(&url)?,
```

**File:** third_party/move/tools/move-package-cache/src/package_cache.rs (L97-97)
```rust
        let repo_dir_name = percent_encode_for_filename(&CanonicalGitIdentity::new(git_url)?);
```

**File:** third_party/move/tools/move-package-cache/src/package_cache.rs (L212-216)
```rust
        let repo_dir_name = percent_encode_for_filename(&CanonicalGitIdentity::new(git_url)?);
        let checkouts_path = self.root.join("git").join("checkouts");

        // Check if a checkout already exists for this commit.
        let checkout_path = checkouts_path.join(format!("{}@{}", repo_dir_name, oid));
```

**File:** third_party/move/tools/move-package-resolver/src/lock.rs (L71-73)
```rust
        let git_identity = CanonicalGitIdentity::new(git_url)?;

        let repo_loc_and_rev = format!("{}@{}", git_identity, rev);
```

**File:** third_party/move/tools/move-package-resolver/src/identity.rs (L23-27)
```rust
    Git {
        repo: CanonicalGitIdentity,
        commit_id: Oid,
        subdir: NormalizedPath,
    },
```
